/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../core/Error.js";import{i as s,b as o,u as i}from"../core/lang.js";import{M as r}from"../chunks/MultiOriginJSONSupport.js";import{aliasOf as n}from"../core/accessorSupport/decorators/aliasOf.js";import"../chunks/ensureType.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import{subclass as l}from"../core/accessorSupport/decorators/subclass.js";import p from"./Layer.js";import{B as m}from"../chunks/BlendLayer.js";import{C as c}from"../chunks/CustomParametersMixin.js";import{g as u,b as d,a as h,e as f,f as g,i as y,h as b,B as v,I as j}from"../chunks/xmlUtilities.js";import{O as x}from"../chunks/OperationalLayer.js";import{P as w}from"../chunks/PortalLayer.js";import{R as C}from"../chunks/RefreshableLayer.js";import{S}from"../chunks/ScaleRangeLayer.js";import{T as k}from"../chunks/TemporalLayer.js";import{p as I}from"../chunks/commonProperties.js";import L from"./support/Field.js";import"../geometry.js";import{isAbortError as D}from"../core/promiseUtils.js";import R from"./support/DimensionalDefinition.js";import{c as T}from"../chunks/wmsUtils.js";import O from"../geometry/Extent.js";import P from"../geometry/Polygon.js";import M from"./support/RasterInfo.js";import{n as E}from"../chunks/pixelUtils.js";import{createPopupTemplate as U}from"../support/popupUtils.js";import"../chunks/Logger.js";import"../config.js";import"../chunks/object.js";import"../chunks/string.js";import"../core/Accessor.js";import"../chunks/deprecate.js";import"../chunks/metadata.js";import"../chunks/handleUtils.js";import"../chunks/ArrayPool.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/JSONSupport.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../chunks/Evented.js";import"../chunks/Identifiable.js";import"../chunks/Loadable.js";import"../chunks/Promise.js";import"../geometry/SpatialReference.js";import"../chunks/writer.js";import"../geometry/Geometry.js";import"../chunks/reader.js";import"../geometry/Multipoint.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/Ellipsoid.js";import"../chunks/zmUtils.js";import"../chunks/extentUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../chunks/jsonMap.js";import"../geometry/support/jsonUtils.js";import"../chunks/jsonUtils.js";import"../chunks/parser.js";import"../chunks/colorUtils.js";import"../chunks/screenUtils.js";import"../chunks/mat4.js";import"../chunks/common.js";import"../chunks/_commonjsHelpers.js";import"../rasterRenderers.js";import"../renderers/AnimatedFlowRenderer.js";import"../Color.js";import"../chunks/mathUtils.js";import"../chunks/enumeration.js";import"../renderers/ClassBreaksRenderer.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"./support/fieldUtils.js";import"../chunks/arcadeOnDemand.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils2.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../chunks/aaBoundingRect.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../chunks/persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../chunks/shared.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../chunks/locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../chunks/Thumbnail.js";import"../chunks/Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../chunks/colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../chunks/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../chunks/LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../chunks/sizeVariableUtils.js";import"../chunks/visualVariableUtils.js";import"../Graphic.js";import"../PopupTemplate.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../chunks/date.js";import"../chunks/number.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../chunks/chartMediaInfoUtils.js";import"../chunks/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../chunks/compilerUtils.js";import"../chunks/lengthUtils.js";import"../chunks/unitUtils.js";import"../chunks/projectionEllipsoid.js";import"../renderers/support/ClassBreakInfo.js";import"../chunks/commonProperties2.js";import"../symbols/support/jsonUtils.js";import"../chunks/symbolConversion.js";import"../renderers/RasterColormapRenderer.js";import"../renderers/support/ColormapInfo.js";import"../chunks/colorRampUtils.js";import"../chunks/colorUtils2.js";import"../renderers/RasterShadedReliefRenderer.js";import"../renderers/RasterStretchRenderer.js";import"../renderers/UniqueValueRenderer.js";import"../chunks/diffUtils.js";import"../renderers/support/UniqueValueInfo.js";import"../chunks/styleUtils.js";import"../renderers/VectorFieldRenderer.js";import"../geometry/support/normalizeUtils.js";import"../chunks/normalizeUtilsCommon.js";import"../chunks/vectorFieldUtils.js";import"./support/PixelBlock.js";import"../chunks/utils4.js";import"../chunks/asyncUtils.js";import"../chunks/assets.js";import"../chunks/ItemCache.js";import"../chunks/MemCache.js";import"../symbols/support/cimSymbolUtils.js";import"../chunks/utils5.js";import"../chunks/arcgisLayerUrl.js";import"../chunks/RasterJobHandler.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"../chunks/messages.js";import"./support/TileInfo.js";import"./support/LOD.js";import"../chunks/rasterRendererHelper.js";import"../chunks/generateRendererUtils.js";import"../chunks/RasterSymbolizer.js";import"../chunks/LercCodec.js";import"../chunks/dataUtils.js";import"../chunks/RawBlockCache.js";import"../chunks/rasterProjectionHelper.js";import"../geometry/projection.js";import"../chunks/pe.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"../TimeInterval.js";import"./support/TimeInfo.js";import"../support/timeUtils.js";import"../chunks/ElevationInfo.js";import"../chunks/unitConversionUtils.js";import"../chunks/domains.js";import"./support/CodedValueDomain.js";import"./support/Domain.js";import"./support/InheritedDomain.js";import"./support/RangeDomain.js";import"../chunks/fieldType.js";function A(e){const t=function(e){var t,s;const o=null==(t=e.getHeader("Content-Type"))?void 0:t.split(";");if(!(null!=(s=null==o?void 0:o[0].trim())?s:"").startsWith("multipart/"))return null;const i={boundary:"",start:"",type:""};for(let e=1;e<o.length;e++){const t=o[e].split("="),s=t[1].trim();i[t[0].trim()]=s.startsWith('"')?s.slice(1,t[1].length-1):s}return i}(e);if(!t)return{isMultipart:!1,data:null};const s=t.boundary?function(e,t,s=0){const o="--"+t.boundary,i=[];for(let e=0;e<o.length;e++)i.push(o.charCodeAt(e));const r=[],n="\n--"+t.boundary+"--";for(let e=0;e<n.length;e++)r.push(n.charCodeAt(e));const a=[10],l=[13,10],p=[],m=i.length,c=new Uint8Array(e,s),u=Math.min(5e4,c.length-m);let d=0,h=0;for(let e=0;e<u;e++){for(h=0;h<m&&c[e+h]===i[h];h++);h===m&&(d&&p.push(F(c.subarray(d,e),t)),e+=m-1,c[e+1]===a[0]?e+=1:c[e+1]===l[0]&&c[e+2]===l[1]&&(e+=2),d=e+1)}const f=r.length;for(let e=c.length-f-10;e<c.length-f;e++){for(h=0;h<f&&c[e+h]===r[h];h++);if(h===f){p.push(F(c.subarray(d,e),t));break}}return p}(e.data,t,0):null;return{isMultipart:!0,data:s}}function F(e,t){const s=String.fromCharCode.apply(null,e.subarray(0,Math.min(300,e.length))).split("\n"),o=Math.min(s.length,7),i={contentDisposition:"inline"};let r=0;for(let a=0;a<o;a++){var n;if(s[a].length<4)r=r+s[a].length+1;else if("content"===s[a].slice(0,7).toLowerCase()){if(r=r+s[a].length+1,-1===s[a].indexOf(":"))continue;const e=s[a].substring(0,s[a].indexOf(":")).trim(),t=s[a].substring(s[a].indexOf(":")+1).trim();switch(e.toLowerCase()){case"content-type":i.contentType=t;break;case"content-description":i.contentDescription=t;break;case"content-transfer-encoding":i.contentTransferEncoding=t;break;case"content-id":i.contentID=t;break;case"content-disposition":i.contentDisposition=t;break;case"content-location":i.contentLocation=t}}else{if(i.contentDisposition.toLowerCase().indexOf("inline")>-1&&s[a].length>=4&&(null==(n=i.contentType)?void 0:n.toLowerCase().indexOf("image"))>-1){let t=!0;if(i.contentType.toLowerCase().indexOf("tif")>0&&(t=73===e[r]&&73===e[r+1]||77===e[r]&&77===e[r+1]),t){const t=new ArrayBuffer(e.length-r);new Uint8Array(t).set(e.subarray(r,e.length)),i.contentData=t}break}if((""===t.start||i.contentID===t.start)&&i.contentType){if(i.contentType.indexOf("text")>-1||i.contentType.indexOf("xml")>-1){i.contentData=String.fromCharCode.apply(null,e.subarray(r,e.length));break}i.contentData=e.subarray(r,e.length)}}}return i}function $(e){return e.indexOf("?")===e.length-1?e.substring(0,e.length-1):e}function V(e){const t={};for(let s=0;s<e.childNodes.length;s++){const o=e.childNodes[s];if(1!==o.nodeType)continue;const i=b(o).toLowerCase();switch(i){case"title":case"abstract":t[i]=u(o);break;case"identifier":t.id=u(o);break;case"wgs84boundingbox":{const e=f(o,"LowerCorner"),s=f(o,"UpperCorner");t.lonLatEnvelope=new O({xmin:e[0],ymin:e[1],xmax:s[0],ymax:s[1],spatialReference:{wkid:4326}})}break;case"coveragesummary":t.coverageSummaries=t.coverageSummaries||[],t.coverageSummaries.push(V(o))}}return t}function G(e,t){if(e.coverageSummaries)for(let s=0;s<e.coverageSummaries.length;s++)e.coverageSummaries[s].abstract=e.coverageSummaries[s].abstract||e.abstract,e.coverageSummaries[s].lonLatEnvelope=e.coverageSummaries[s].lonLatEnvelope||e.lonLatEnvelope,e.coverageSummaries[s].title=e.coverageSummaries[s].title||e.title,G(e.coverageSummaries[s],t);null!=e.id&&t.push(e)}function N(e){const t=d(e.querySelector("Operation[name=GetCapabilities]"),"Get").getAttribute("xlink:href")||"",s=d(e.querySelector("Operation[name=DescribeCoverage]"),"Get").getAttribute("xlink:href")||"",o=d(e.querySelector("Operation[name=GetCoverage]"),"Get").getAttribute("xlink:href")||"";return{getCapabilities:$(t),describeCoverage:$(s),getCoverage:$(o)}}function B(e,s=null){let o=null;if("string"==typeof e){o=(new DOMParser).parseFromString(e,"text/xml")}else o=e;const i=o.documentElement.getAttribute("version"),r=(i||s||"1.0.0").slice(0,3);let n;if("2.0"===r)n=function(e){const t=d(e,"ServiceIdentification"),s=u(t,"Title"),o=g(t,"ServiceTypeVersion"),i=g(t,"Profile"),r=N(d(e,"OperationsMetadata")),n=h(e,"Contents/CoverageSummary"),a=[];for(let e=0;e<n.length;e++){const t=n[e],s=u(t,"CoverageId"),o=d(t,"WGS84BoundingBox");let i;if(o){const e=f(o,"LowerCorner"),t=f(o,"UpperCorner");i=new O({xmin:e[0],ymin:e[1],xmax:t[0],ymax:t[1],spatialReference:{wkid:4326}})}a.push({id:s,lonLatEnvelope:i})}const l=d(e,"ServiceMetadata");return{name:s,supportedVersions:o,supportedFormats:g(l,"formatSupported"),supportedInterpolations:g(l,"interpolationSupported"),onlineResources:r,profiles:i,coverages:a}}(o);else if("1.1"===r)n=function(e){const t=u(e,"ServiceIdentification/Title"),s=g(e,"ServiceIdentification/ServiceTypeVersion"),o=N(d(e,"OperationsMetadata")),i=[],r=d(e,"Contents");for(let e=0;e<r.childNodes.length;e++){const t=r.childNodes[e];1===t.nodeType&&y(t,"CoverageSummary")&&G(V(t),i)}return{name:t,onlineResources:o,coverages:i,supportedVersions:s,supportedFormats:g(r,"SupportedFormat")}}(o);else{if("1.0"!==r)throw new t("wcsraster:parsecapabilities","the capabilities version is not supported");n=function(e){var t,s,o;const i=u(e,"Service/name"),r=d(e,"Capability"),n=null!=(t=d(r,"GetCapabilities/Get/OnlineResource").getAttribute("xlink:href"))?t:"",a=null!=(s=d(r,"DescribeCoverage/Get/OnlineResource").getAttribute("xlink:href"))?s:"",l=null!=(o=d(r,"GetCoverage/Get/OnlineResource").getAttribute("xlink:href"))?o:"",p={getCapabilities:$(n),describeCoverage:$(a),getCoverage:$(l)},m=h(e,"CoverageOfferingBrief"),c=[];for(let e=0;e<m.length;e++){const t=m[e],s=u(t,"name"),o=h(t,"pos"),i=f(o[0]),r=f(o[1]),n=new O({xmin:i[0],ymin:i[1],xmax:r[0],ymax:r[1],spatialReference:{wkid:4326}});c.push({id:s,lonLatEnvelope:n})}return{name:i,onlineResources:p,coverages:c,supportedVersions:["1.0.0"]}}(o)}return n.capabilitiesVersion=i,n}function _(e,t){const s=g(e,"1.0.0"===t?"interpolationMethod":"InterpolationMethod"),o="1.0.0"===t?e.getAttribute("default"):u(e,"InterpolationMethods/Default");return null!=o?[o].concat(s.filter((e=>e.toLowerCase()!==o.toLowerCase()))):s}function q(e){return null==e?["nearest"]:e.map((e=>{const t=e.toLowerCase();return t.indexOf("nearest")>-1?"nearest":t.indexOf("linear")>-1?"bilinear":t.indexOf("cubic")>-1?"cubic":null})).filter((e=>!!e))}function W(e){const t=h(e,"pos"),s=f(t[0]),o=f(t[1]);return new O({xmin:s[0],ymin:s[1],xmax:o[0],ymax:o[1],spatialReference:{wkid:4326}})}function z(e){const t=[],s=h(e,"RangeSet");let o=[];for(let e=0;e<s.length;e++){const i=u(s[e],"name"),r=u(s[e],"label"),n=[],a=h(s[e],"AxisDescription");for(let e=0;e<a.length;e++){const t=u(a[e],"name"),s=u(a[e],"label"),i=g(a[e],"singleValue");if(0===i.length){const t=u(a[e],"min"),s=u(a[e],"max"),o=Number(u(a[e],"res"))||1;if(null!==t&&null!==s)for(let e=parseInt(t,10);e<=parseInt(s,10);e+=o)i.push(e.toString())}"band"===t.toLowerCase()&&(o=i),n.push({name:t,label:s,values:i})}t.push({name:i,label:r,axis:n})}return{rangeSet:t,bandNames:o}}function H(e){const t=h(e,"timeposition");if(t.length>0){const e=[];for(let s=0;s<t.length;s++)e.push(new Date(u(t[s])));return{begin:e[0],end:e[e.length-1],values:e}}const s=d(e,"timePeriod")||d(e,"TimePeriod");if(s){return{begin:new Date(u(s,"beginPosition")||u(s,"BeginPosition")),end:new Date(u(s,"endPosition")||u(s,"EndPosition")),...function(e=null){if(!e)return{resolution:null,units:null};let t=e.toUpperCase();const s=["Y","M","D"],o=["H","M","S"],i=["Years","Months","Days","Hours","Minutes","Seconds"];let r,n,a;return-1===t.indexOf("PT")?(t=t.slice(1),a=s.findIndex((e=>t.indexOf(e)>-1)),a>-1&&(r=i[a]),n=parseFloat(t.substring(0,t.length-1))):(t=t.slice(2),a=o.findIndex((e=>t.indexOf(e)>-1)),r=i[3+a],n=parseFloat(t.substring(0,t.length-1))),{resolution:n,units:r}}(u(s,"timeResolution")||u(s,"TimeResolution"))}}return null}function J(e){const t=d(e,"spatialDomain"),s=d(t,"Envelope")||d(t,"EnvelopeWithTimePeriod"),o=s.getAttribute("srsName").split(":"),i=o[o.length-1],r=h(s,"pos"),n=f(r[0]),a=f(r[1]),l=parseInt(i,10),p=isNaN(l)?null:{wkid:l},m=new O({xmin:n[0],ymin:n[1],xmax:a[0],ymax:a[1],spatialReference:p}),c=d(t,"RectifiedGrid"),g=u(c,"low").split(" "),y=u(c,"high").split(" "),b=parseInt(y[0],10)-parseInt(g[0],10)+1,v=parseInt(y[1],10)-parseInt(g[1],10)+1,j=f(t,"origin/pos"),x=h(t,"offsetVector"),w={envelope:m,columns:b,rows:v,offset:{x:parseFloat(u(x[0]).split(" ")[0]),y:parseFloat(u(x[1]).split(" ")[1])},origin:{x:j[0],y:j[1]}},C=d(e,"temporalDomain")||d(e,"TemporalDomain");return{spatialDomain:w,temporalDomain:C?H(C):null}}function Y(e){const t=[],s=h(e,"Field");let o=[];for(let e=0;e<s.length;e++){const i=u(s[e],"Identifier"),r=u(s[e],"Description"),n=u(s[e],"Definition"),a=u(s[e],"Abstract"),l=u(s[e],"Title"),p=_(s[e],"1.1.0"),m=[],c=h(s[e],"Axis");for(let e=0;e<c.length;e++){const t=c[e].getAttribute("identifier"),s=u(c[e],"UOM"),i=u(c[e],"DataType"),r=g(c[e],"Key");"band"===t.toLowerCase()&&(o=r),m.push({identifier:t,uom:s,dataType:i,values:r})}t.push({identifier:i,description:r,definition:n,abstract:a,title:l,supportedInterpolations:p,axis:m})}return{rangeSet:t,bandNames:o}}function Q(e){var t;const s=d(e,"SpatialDomain"),o=d(s,"GridCRS"),i=u(o,"GridBaseCRS"),r=u(o,"GridOrigin"),n=null!=(t=null==r?void 0:r.split(" ").map((e=>parseFloat(e))))?t:[0,0],a=f(o,"GridOffsets"),l=h(s,"BoundingBox");let p,m,c,g;for(let e=0;e<l.length;e++){var y;const t=null==(y=l[e].getAttribute("crs"))?void 0:y.toLowerCase();if(null!=t)if(t.indexOf("imagecrs")>-1){const t=f(l[e],"LowerCorner"),s=f(l[e],"UpperCorner");p=s[0]-t[0]+1,m=s[1]-t[1]+1}else if(t.indexOf("epsg")>0){const s=t.split(":");c=parseInt(s[s.length-1],10);const o=f(l[e],"LowerCorner"),i=f(l[e],"UpperCorner");g=new O({xmin:o[0],ymin:o[1],xmax:i[0],ymax:i[1],spatialReference:{wkid:c}})}}const b=p>m,v=g.xmax-g.xmin>g.ymax-g.ymin;let j=!1;T(c)&&(b===v?j=!1:(j=!0,g=new O({xmin:g.ymin,ymin:g.xmin,xmax:g.ymax,ymax:g.xmax,spatialReference:{wkid:c}})));const x={columns:p,rows:m,origin:{x:n[0],y:n[1]},offset:{x:a[0],y:a[1]},gridBaseCRS:i,envelope:g,useEPSGAxis:j},w=d(e,"temporalDomain")||d(e,"TemporalDomain");return{spatialDomain:x,temporalDomain:w?H(w):null}}function K(e,t){const s=[],o=[],i={supportedFormats:s,supportedCRSs:o,version:"1.1"};let r;for(let t=0;t<e.childNodes.length;t++){const n=e.childNodes[t];if(1!==n.nodeType)continue;const a=b(n).toLowerCase();switch(a){case"title":case"abstract":case"identifier":i[a]=u(n);break;case"supportedformat":{const e=u(n);-1===s.indexOf(e)&&s.push(e)}break;case"supportedcrs":{const e=u(n);-1===o.indexOf(e)&&o.push(e)}break;case"range":{const e=Y(n);i.range=e.rangeSet,r=e.bandNames}break;case"domain":i.domain=Q(n)}}const n=q(i.range[0].supportedInterpolations),{identifier:a,abstract:l,title:p,domain:m,range:c}=i,d={x:Math.abs(m.spatialDomain.offset.x),y:Math.abs(m.spatialDomain.offset.y)},h=function(e,t){const s=e.filter((e=>-1===e.identifier.toLowerCase().indexOf("field_1")&&!e.axis.some((e=>"band"===e.identifier.toLowerCase())))),o=[];if(s.length&&s.forEach((e=>{var t,s;const i=e.axis.map((e=>{const t=e.values.map((t=>"ISO8601"===e.uom?-1===(t=t.trim()).toLowerCase().indexOf("z")?new Date(t+"Z").getTime():new Date(t).getTime():parseFloat(t.trim()))),s=[Math.min.apply(null,t),Math.max.apply(null,t)];return{name:e.identifier.trim(),description:"",field:e.identifier.trim(),unit:e.uom?e.uom.trim():"",hasRegularIntervals:!1,values:t,extent:s}}));o.push({name:e.identifier.trim(),description:null!=(t=null==(s=e.description)?void 0:s.trim())?t:"",unit:"",dimensions:i})})),t.temporalDomain){const{begin:e,end:s,values:i,units:r,resolution:n}=t.temporalDomain;o.some((e=>e.dimensions.some((e=>"stdtime"===e.name.toLowerCase()))))||o.forEach((t=>{t.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:null==i?void 0:i.map((e=>e.getTime())),hasRegularIntervals:!i,interval:n,intervalUnit:r,extent:[e.getTime(),s.getTime()]})}))}return o.length?{variables:o}:null}(c,m),f=new M({width:m.spatialDomain.columns,height:m.spatialDomain.rows,pixelSize:d,extent:m.spatialDomain.envelope,spatialReference:m.spatialDomain.envelope.spatialReference,bandCount:r.length||1,multidimensionalInfo:h});return{id:a,title:i.title,description:l||p,lonLatEnvelope:null,bandNames:r,rasterInfo:f,supportedFormats:s,supportedInterpolations:n,coverageDescription:i,version:t,useEPSGAxis:m.spatialDomain.useEPSGAxis}}function Z(e){const t=d(e,"Envelope")||d(e,"EnvelopeWithTimePeriod"),s=t.getAttribute("srsName"),o=s.slice(s.lastIndexOf("/")+1),i=t.getAttribute("axisLabels").split(" ").map((e=>e.trim())).filter((e=>""!==e.trim())),r=f(t,"lowerCorner"),n=f(t,"upperCorner"),a=!["y","lat","latitude","north","nor","n","b"].some((e=>e===i[0].toLowerCase()));let l;const p=parseInt(o,10),m=isNaN(p)?null:{wkid:p};l=new O(a?{xmin:r[0],ymin:r[1],xmax:n[0],ymax:n[1],spatialReference:m}:{xmin:r[1],ymin:r[0],xmax:n[1],ymax:n[0],spatialReference:m});const c={mins:r,maxs:n},h=t.getAttribute("uomLabels").trim().split(" ");let g,b;return y(t,"EnvelopeWithTimePeriod")&&(g=new Date(u(e,"beginPosition")||u(e,"BeginPosition")),b=new Date(u(e,"endPosition")||u(e,"EndPosition"))),{envelope:l,axisLabels:i,uomLabels:h.length?h:null,envelopeAllDims:c,beginPosition:g,endPosition:b,isEastFirst:a}}function X(e){const t=[],s=h(e,"DataRecord"),o=[];for(let e=0;e<s.length;e++){const r=h(s[e],"field"),n=[];for(let e=0;e<r.length;e++){var i;const t=r[e].getAttribute("name"),s=u(r[e],"description")||"",a=(null==(i=d(r[e],"uom"))?void 0:i.getAttribute("code"))||"",l=f(r[e],"interval");t.toLowerCase().indexOf("band")>-1&&o.push(t),n.push({name:t,description:s,uom:a,allowedValues:l})}t.push(n)}return{rangeType:t,bandNames:o}}function ee(e){let t=1,s="";const o=.01;return Math.abs(e-1/24)<1/24*o?s="Hours":Math.abs(e-1)<.01?s="Days":e<1?(t=Math.round(24*e),s="Hours"):e>27.99&&e<31.01||Math.round(e/30)<12?s="Months":e>364.99&&e<366.01&&(s="Years"),{interval:t,intervalUnit:s}}function te(e,t){const s=d(e,"RectifiedGrid"),o=f(s,"low"),i=f(s,"high"),r=[];for(let e=0;e<o.length;e++)r.push(i[e]-o[e]+1);const n=u(s,"axisLabels").split(" "),a=f(s,"origin/pos"),l=h(s,"offsetVector"),p=[];for(let e=0;e<l.length;e++){const t=f(l[e]),s=t.findIndex((e=>0!==e));p[s]=t[s]}const m=t||n;let c,g,y;return["y","lat","latitude","north","nor","n","b"].some((e=>e===m[0].toLowerCase()))?(c=r[1],g=r[0],y={y:Math.abs(p[0]),x:Math.abs(p[1])}):(c=r[0],g=r[1],y={x:Math.abs(p[0]),y:Math.abs(p[1])}),{columns:c,rows:g,origin:a,offset:p,resolution:y,gridSamples:r,axisLabels:n}}function se(e){const t=d(e,"EarthObservation");if(!t)return null;const s=d(t,"phenomenonTime"),o=s?H(s):null,i=d(t,"phenomenonTime"),r=i?H(i):null,n=u(t,"featureOfInterest/Footprint/multiExtentOf/MultiSurface/surfaceMembers/Polygon/exterior/LinearRing/posList");let a=null;if(n){const e=n.split(" ").map((e=>e.trim())).filter((e=>null!=e&&""!==e));if(e.length){const t=[];for(let s=0;s<e.length/2;s+=2)t.push(e[s],e[s+1]);a=new P({rings:[t],spatialReference:{wkid:4326}})}}return{observation:{phonomenonTime:o,resultTime:r,footprint:a,identifier:u(e,"metaDataProperty/EarthObservationMetaData/identifier"),acquisitionType:u(e,"metaDataProperty/EarthObservationMetaData/acquisitionType"),status:u(e,"metaDataProperty/EarthObservationMetaData/status")}}}function oe(e){const t={version:"2.0"};let s=[];for(let i=0;i<e.childNodes.length;i++){const r=e.childNodes[i];if(1===r.nodeType)if(y(r,"coverageId"))t.coverageId=u(r);else if(y(r,"ServiceParameters"))t.serviceParameters={supportedFormats:g(r,"nativeFormat")};else if(y(r,"boundedBy"))t.boundedBy=Z(r);else if(y(r,"rangeType")){const e=X(r);t.rangeType=e.rangeType,s=e.bandNames}else if(y(r,"domainSet")){var o;t.domainSet=te(r,null==(o=t.boundedBy)?void 0:o.axisLabels)}else if(y(r,"metadata")){const e=d(r,"EOMetadata");t.eoMetadata=e?se(e):null}}const{coverageId:i,boundedBy:r,domainSet:n,rangeType:a,serviceParameters:l}=t,p=function(e,t,s){const o=[];for(let t=0;t<e.length;t++){const s=e[t];for(let e=0;e<s.length;e++)-1===s[e].name.toLowerCase().indexOf("band")&&o.push(s[e])}const i=[];if(o.length){const e=[];for(let o=2;o<s.axisLabels.length;o++){const i=(t.uomLabels&&t.uomLabels.length)>o?t.uomLabels[o]:"",r=s.axisLabels[o].toLowerCase().indexOf("time")>-1||"iso8601"===i.toLowerCase()||"oledatetime"===i.toLowerCase();let n,a;if(r){const e=ee(s.offset[o]);n=e.interval,a=e.intervalUnit}else n=s.offset[o],a=i;const l=[];r?(l.push((new Date).setTime(24*(t.envelopeAllDims.mins[o]-25569)*3600*1e3)),l.push((new Date).setTime(24*(t.envelopeAllDims.maxs[o]-25569)*3600*1e3))):(l.push(t.envelopeAllDims.mins[o]),l.push(t.envelopeAllDims.maxs[o])),e.push({name:s.axisLabels[o].trim(),description:s.axisLabels[o].trim(),unit:t.uomLabels&&t.uomLabels.length>o?t.uomLabels[o].trim():"",hasRegularIntervals:!0,extent:l,interval:n,intervalUnit:a})}if(o.forEach((t=>{var s,o;return i.push({name:t.name.trim(),description:null!=(s=null==(o=t.description)?void 0:o.trim())?s:"",unit:t.uom.trim(),dimensions:e})})),i.length)return{variables:i}}return null}(a,r,n);return{id:i,title:i,description:i,lonLatEnvelope:null,bandNames:s,rasterInfo:new M({width:n.columns,height:n.rows,pixelSize:n.resolution,extent:r.envelope,spatialReference:r.envelope.spatialReference,bandCount:s.length||1,multidimensionalInfo:p}),supportedFormats:l.supportedFormats,supportedInterpolations:null,coverageDescription:t,version:"2.0.1",useEPSGAxis:!1}}function ie(e,t){let s=null;if("string"==typeof e){s=(new DOMParser).parseFromString(e,"text/xml")}else s=e;if("1.0.0"===t){return h(s,"CoverageOffering").map((e=>function(e){const t={version:"1.0"};let s=[];for(let i=0;i<e.childNodes.length;i++){const r=e.childNodes[i];if(1===r.nodeType)if(y(r,"description"))t.description=u(r);else if(y(r,"name"))t.name=u(r);else if(y(r,"label"))t.label=u(r);else if(y(r,"supportedFormats"))t.supportedFormats=g(r,"formats");else if(y(r,"supportedCRSs"))t.supportedCRSs={requestResponseCRSs:g(o=r,"requestResponseCRSs").map((e=>e.split(":")[1])),nativeCRSs:g(o,"nativeCRSs").map((e=>e.split(":")[1]))};else if(y(r,"supportedInterpolations"))t.supportedInterpolations=_(r,"1.0.0");else if(y(r,"lonLatEnvelope"))t.lonLatEnvelope=W(r);else if(y(r,"rangeSet")){const e=z(r);t.rangeSet=e.rangeSet,s=e.bandNames}else y(r,"domainSet")&&(t.domainSet=J(r))}var o;const i=q(t.supportedInterpolations),{name:r,description:n,label:a,lonLatEnvelope:l,supportedFormats:p}=t,{spatialDomain:m}=t.domainSet,c={x:Math.abs(m.offset.x),y:Math.abs(m.offset.y)},d=new M({width:m.columns,height:m.rows,pixelSize:c,extent:m.envelope,spatialReference:m.envelope.spatialReference,bandCount:s.length||1});return{id:r,title:t.name,description:n||a,lonLatEnvelope:l,rasterInfo:d,bandNames:s,supportedFormats:p,supportedInterpolations:i,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}(e)))}const o=h(s,"CoverageDescription");return"1.1.0"===t||"1.1.1"===t||"1.1.2"===t?o.map((e=>K(e,t))):o.map((e=>oe(e)))}const re=["nearest neighbor","bilinear","bicubic"],ne=["nearest","linear","cubic"];let ae=class extends v{constructor(){super(...arguments),this.datasetFormat="WCSServer"}async open(e){await this.init();const s=null==e?void 0:e.signal,o=await this._getCapabilities(s);if(this.capabilities=o,!this.version){var i;let e=null==(i=o.capabilitiesVersion)?void 0:i.slice(0,3);"2.0"===e||"1.1"===e||"1.0"===e?this.version=o.capabilitiesVersion:(e=o.supportedVersions.find((e=>"2.0.1"===e))||o.supportedVersions.find((e=>"2.0"===e.slice(0,3)))||o.supportedVersions.find((e=>"1.1"===e.slice(0,3)))||o.supportedVersions.find((e=>"1.0"===e.slice(0,3)))||"1.0.0",this.version=e)}null==this.coverageId&&(this.coverageId=o.coverages[0].id);const r=o.coverages.filter((e=>e.id===this.coverageId))[0];if(null==r)throw new t("wcsraster-open",`the coverageId ${this.coverageId} does not exist in capabilities`);const n=await this._describeCoverage(s);this.coverageInfo=n[0],"2.0"===this.version.slice(0,3)&&(this.coverageInfo.lonLatEnvelope=r.lonLatEnvelope,this.coverageInfo.supportedInterpolations=q(o.supportedInterpolations)),this.datasetName=this.coverageInfo.title;const{rasterInfo:a}=this.coverageInfo;if(this.createRemoteDatasetStorageInfo(a,512,512),this._set("rasterInfo",a),null==a.spatialReference)throw new t("wcsraster-open",`coverage without spatial referernce is not supported: ${this.coverageId}`);const{pixelType:l,bandCount:p}=await this._getPixelTypeAndBandCount(s);a.pixelType=l,1===a.bandCount&&p>1&&(a.bandCount=p),this.updateTileInfo()}async fetchRawTile(e,i,r,n={}){if(this.isBlockOutside(e,i,r))return null;const{nativePixelSize:a,spatialReference:l}=this.rasterInfo,p=2**e,m=a.x*p,c=a.y*p,{blockWidth:u,blockHeight:d}=this.getBlockWidthHeight(e),{origin:h}=this.rasterInfo.storageInfo.tileInfo,f=this.getTileExtent({x:m,y:c},i,r,h,l,[u,d]),g=this.rasterInfo.extent,y=f.xmax>g.xmax||f.ymin<g.ymin;let b=f,v=u,j=d;if(y&&(b=f.clone().intersection(g),s(b)&&(v=Math.floor((b.xmax-b.xmin)/m),j=Math.floor((b.ymax-b.ymin)/c),b.xmax=b.xmin+m*v,b.ymin=b.ymax-c*j)),o(b)||v<=1||j<=1)return null;const x=await this._getCoverage(b,v,j,p,n);if(!x)return null;const w=await this.decodePixelBlock(x,{width:v,height:j,planes:null,pixelType:null});if(w&&(w.width!==v||w.height!==j))throw new t("wcsraster-fetch",`the reponse has unexpected dimension width: ${w.width}, height: {pixelBlock.height}`);return y?E(w,{x:0,y:0},{width:d,height:d}):w}async _getCapabilities(e){const s={service:"WCS",request:"GetCapabilities"};this.version&&(s.version=this.version,s.acceptVersions=this.version);try{const{data:t}=await this.request(this.url,{query:s,responseType:"xml",signal:e});return B(t)}catch(e){if(!D(e))throw new t("wcslayer:open","wcs capabilities is not valid or supported");throw e}}async _describeCoverage(e){const s={service:"WCS",request:"DescribeCoverage",version:this.version},o=this.version.slice(0,3);"1.0"===o?s.coverage=this.coverageId:"1.1"===o?s.identifiers=this.coverageId:"2.0"===o&&(s.coverageId=this.coverageId);try{const{data:t}=await this.request(this.url,{query:s,responseType:"xml",signal:e});return ie(t,this.version)}catch(e){if(!D(e))throw new t("wcslayer:open","wcs coverage description is not valid or supported");throw e}}async _getPixelTypeAndBandCount(e){const{pixelSize:o,extent:r,multidimensionalInfo:n}=this.rasterInfo,a=r.center,l=new O({xmin:a.x-o.x,xmax:a.x+o.x,ymin:a.y-o.y,ymax:a.y+o.y,spatialReference:r.spatialReference});let p;if(s(n)){const e=n.variables[0];p=[],e.dimensions.forEach((t=>{p.push(new R({variableName:e.name,dimensionName:t.name,values:t.hasRegularIntervals?t.extent[0]:t.values[0],isSlice:!0}))}))}const m=await this._getCoverage(l,2,2,1,{multidimensionalDefinition:p,signal:i(e)});if(!m)throw new t("wcsraster-open","unable to determine pixel type");const c=await this.decodePixelBlock(m,{width:2,height:2,planes:null,pixelType:null});return{pixelType:c.pixelType,bandCount:c.getPlaneCount()}}async _getCoverage(e,s,o,i,r){const{coverageDescription:n}=this.coverageInfo,{version:a}=n,l="2.0"===n.version?this._getCoverage201Parameters(e,s,o,i,r,n):"1.1"===n.version?this._getCoverage110Parameters(e,s,o,r,n):this._getCoverage100Parameters(e,s,o,r),p="2.0"===n.version?await this.request(this._constructWCS201Url(l),{signal:r.signal,responseType:"array-buffer"}):await this.request(this.url,{query:l,signal:r.signal,responseType:"array-buffer"});if("1.0"===a)return p.data;const m=A(p);if(m.isMultipart&&m.data){const e=m.data.filter((e=>{var t;return(null==(t=e.contentType)?void 0:t.toLowerCase().includes("image"))&&null!=e.contentData}))[0];return null==e?void 0:e.contentData}if(this.ioConfig.allowAnyMediaType)return p.data;throw new t("wcsraster:getcoverage","response is not a valid coverage, multipart response is expected")}_getInterpolationIndex(e){return-1===this.coverageInfo.supportedInterpolations.indexOf(e)||"nearest"===e?0:"bilinear"===e?1:"cubic"===e?2:0}_getCoverage100Parameters(e,t,s,o){const i=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,r=e.spatialReference.wkid,n=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().indexOf("tiff")>-1))||"GEOTIFF",{bandIds:a,interpolation:l}=o,p=this._getInterpolationIndex(l),m=a?a.map((e=>this.coverageInfo.bandNames[e])):null,c=re[p];return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:n,crs:`EPSG:${r}`,bbox:i,width:t,height:s,interpolation:c,band:null==m?void 0:m.join(",")}}_getCoverage110Parameters(e,t,o,i,r){var n;const{multidimensionalDefinition:a,bandIds:l,interpolation:p}=i,m=e.spatialReference.wkid,c=`urn:ogc:def:crs:EPSG::${m}`,u=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().indexOf("tiff")>-1))||"image/tiff",d=this._getInterpolationIndex(p),h=ne[d],f=null==p||0===(null==(n=this.coverageInfo.supportedInterpolations)?void 0:n.indexOf(p)),g=r.domain.spatialDomain,y=g.origin.x<=g.envelope.xmin&&g.origin.y<=g.envelope.ymin,b=e.width/t,v=e.height/o*(y?1:-1),j=y?[e.xmin,e.ymin]:[e.xmin,e.ymax],x=g.useEPSGAxis&&T(m),w=x?`${j[1]},${j[0]}`:`${j[0]},${j[1]}`,C=x?`${v},0,0,${b}`:`${b},0,0,${v}`,S=b/2,k=e.xmin+S,I=e.xmax-S,L=Math.abs(v)/2,D=e.ymin+L,R=e.ymax-L,O=x?`${D},${k},${R},${I},${c}`:`${k},${D},${I},${R},${c}`,P=r.range.filter((e=>e.axis.some((e=>e.identifier.toLowerCase().indexOf("band")>-1))))[0];let M,E=P&&h&&l?f?`${P.identifier}[${P.axis[0].identifier}[${l.join(",")}]]`:`${P.identifier}:${h}[${P.axis[0].identifier}[${l.join(",")}]]`:null;if(s(a)&&a.length)for(let e=0;e<a.length;e++){let t=a[e].values;const s=a[e].dimensionName.toLowerCase(),o=a[e].variableName.toLowerCase();if(t.length>0)if(t[0]instanceof Array&&(t=t[0]),"stdtime"===s)M=t.map((e=>this._convertToISOTime(e))).join(",");else{const e=r.range.filter((e=>e.identifier.toLowerCase()===o))[0];if(e){const o=e.axis.filter((e=>e.identifier.toLowerCase()===s))[0];o&&(E=f?e.identifier+"["+o.identifier+"["+t.join(",")+"]]":e.identifier+":"+h+"["+o.identifier+"["+t.join(",")+"]]")}}}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:u,crs:`EPSG:${m}`,boundingbox:O,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:w,gridOffsets:C,gridBaseCRS:c,timeSequence:M,rangeSubset:E}}_convertToISOTime(e,t=!1){return(t?new Date(24*(e-25569)*60*60*1e3):new Date(e)).toISOString()}_getCoverage201Parameters(e,t,o,i,r,n){const{multidimensionalDefinition:a,interpolation:l}=r,p=this._getInterpolationIndex(l);let m=null;const{supportedInterpolations:c}=this.capabilities;if(null!=c&&c.length)switch(p){case 0:m=c.find((e=>e.includes("nearest")));break;case 1:m=c.find((e=>e.includes("linear")));break;case 2:m=c.find((e=>e.includes("cubic")||e.includes("quadratic")))}const u=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().indexOf("tiff")>-1))||"image/tiff",{bandNames:d}=this.coverageInfo,{boundedBy:h,domainSet:f,rangeType:g}=n,y=h.isEastFirst?0:1,b=1-y,{axisLabels:v}=h,j=v[y],x=v[b],w=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,C=w,S=[];S.push(`${j}(${e.xmin},${e.xmax})`),S.push(`${x}(${e.ymin},${e.ymax})`);const k=[];if(v.length>2)for(let e=2;e<v.length;e++){const t=f.origin[e];if(v[e].toLowerCase().indexOf("time")>-1){let s=t.toString();h.uomLabels[e].toLowerCase().indexOf("ole")>-1&&(k.push(v[e]),s=this._convertToISOTime(t,!0)),S.push(v[e]+",http://www.opengis.net("+s+")")}else S.push(v[e]+",http://www.opengis.net("+t+")")}let I=null;if(s(a)&&a.length){const e=[];g.forEach((t=>t.forEach((t=>e.push(t.name)))));const t=[];for(let s=0;s<a.length;s++){const o=v.find((e=>e===a[s].dimensionName)),i=e.find((e=>e===a[s].variableName));if(-1===t.indexOf(i)&&t.push(i),o){let e=a[s].values;if(e.length>0){Array.isArray(e[0])&&(e=e[0]);let t="";t=o.toLowerCase().indexOf("time")>-1?e.map((e=>this._convertToISOTime(e))).join(","):e.join(",");const s=S.findIndex((e=>0===e.indexOf(o+",http://www.opengis.net")));-1===s&&S.push(o+",http://www.opengis.net("+t+")"),-1!==s&&-1===S[s].indexOf("("+t+")")&&S.splice(s,1,o+",http://www.opengis.net("+t+")")}}}t.length&&(I=t.join(","))}else if(null!=d&&d.length){I=(r.bandIds?r.bandIds.map((e=>d[e])):d).join(",")}const L=S.join("&subset="),D=!(n.domainSet.axisLabels.join("")===n.boundedBy.axisLabels.join(""))&&!1!==this.ioConfig.allowScaleFactor,R=D?null:`${j}(${t}),${x}(${o})`,T=D?1/i:null;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:I,interpolation:m,scaleSize:R,scaleFactor:T,subset:L,format:u,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:w,subsettingcrs:C}}_constructWCS201Url(e){const t={...this.ioConfig.customFetchParameters,...e},s=[];Object.keys(t).forEach((e=>{const o=t[e];null!=o&&("subset"===e?o.split("&subset=").forEach((e=>{e&&s.push(`subset=${encodeURIComponent(e)}`)})):s.push(`${e}=${encodeURIComponent(o)}`))}));return`${encodeURI(this.url)}?${s.join("&")}`}};e([a({type:String,json:{write:!0}})],ae.prototype,"datasetFormat",void 0),e([a()],ae.prototype,"tileType",void 0),e([a({type:String,json:{write:!0}})],ae.prototype,"version",void 0),e([a({type:String,json:{write:!0}})],ae.prototype,"coverageId",void 0),ae=e([l("esri.layers.support.rasterDatasets.ImageServerRaster")],ae);const le=ae,pe=new Set(["milliseconds","seconds","minutes","hours","days","weeks","months","years","decades","centuries"]);let me=class extends(m(S(x(w(c(j(k(C(r(p)))))))))){constructor(...e){super(...e),this.coverageId=null,this.coverageInfo=null,this.version=null,this.isReference=null,this.type="wcs",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){const t=s(e)?e.signal:null;return this.addResolvingPromise(this._openRaster(t)),Promise.resolve(this)}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){return[new L({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"})]}createPopupTemplate(e){return U({fields:this.rasterFields,title:this.title},e)}async _openRaster(e){const o=new le({url:this.url,version:this.version,coverageId:this.coverageId,ioConfig:{sampling:"closest",...this.ioConfig,customFetchParameters:this.customParameters}});if(await o.open({signal:e}),!o.rasterInfo)throw o.destroy(),new t("wcs-layer:load","cannot load resources on "+this.url);null==this.title&&this.setAtOrigin("title",o.datasetName,"service"),null==this.coverageId&&this.setAtOrigin("coverageId",o.coverageInfo.id,"service");const{multidimensionalInfo:i}=o.rasterInfo;if(s(i)){const e=i.variables[0].dimensions.find((({name:e})=>"StdTime"===e));if(e){var r,n,a,l,p;let t=null!=(r=null==(n=e.extent)?void 0:n[0])?r:e.values[0];Array.isArray(t)&&(t=t[0]);let s=null!=(a=null==(l=e.extent)?void 0:l[1])?a:e.values[e.values.length-1];Array.isArray(s)&&(s=s[1]);const o=pe.has(null==(p=e.intervalUnit)?void 0:p.toLowerCase())?e.intervalUnit.toLowerCase():null;this.set("timeInfo",{startField:"StdTime",fullTimeExtent:{start:t,end:s},timeReference:null,interval:o?{value:e.interval,unit:o}:null})}}this.raster=o,this._configDefaultSettings(),this.watch("customParameters",(e=>this.raster.ioConfig.customFetchParameters=e))}};e([a({json:{write:!0}})],me.prototype,"coverageId",void 0),e([a({readOnly:!0}),n("raster.coverageInfo")],me.prototype,"coverageInfo",void 0),e([a()],me.prototype,"version",void 0),e([a()],me.prototype,"isReference",void 0),e([a({readOnly:!0})],me.prototype,"type",void 0),e([a(I)],me.prototype,"popupEnabled",void 0),e([a()],me.prototype,"popupTemplate",void 0),e([a({readOnly:!0})],me.prototype,"defaultPopupTemplate",null),e([a({readOnly:!0,type:[L]})],me.prototype,"fields",void 0),e([a({readOnly:!0,type:[L]})],me.prototype,"rasterFields",null),me=e([l("esri.layers.WCSLayer")],me);const ce=me;export{ce as default};
