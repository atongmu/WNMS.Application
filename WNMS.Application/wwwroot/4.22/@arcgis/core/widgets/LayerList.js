/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../core/Collection.js";import{e as i}from"../core/promiseUtils.js";import s from"../core/Handles.js";import{h as r}from"../core/lang.js";import{on as o,init as l}from"../core/watchUtils.js";import{aliasOf as n}from"../core/accessorSupport/decorators/aliasOf.js";import{cast as a}from"../core/accessorSupport/decorators/cast.js";import{property as c}from"../core/accessorSupport/decorators/property.js";import{subclass as d}from"../core/accessorSupport/decorators/subclass.js";import h from"./Widget.js";import u from"./LayerList/LayerListViewModel.js";import m from"./LayerList/ListItem.js";import{f as p,s as g,d as _,e as y}from"../chunks/layerListUtils.js";import{a as b}from"../chunks/accessibleHandler.js";import{m as v}from"../chunks/messageBundle.js";import"../chunks/Logger.js";import{v as f}from"../chunks/vmEvent.js";import{t as k}from"../chunks/jsxFactory.js";import"../chunks/widgetUtils.js";import{S as I}from"../chunks/sortable.esm.js";import"../chunks/ArrayPool.js";import"../chunks/Evented.js";import"../core/Accessor.js";import"../chunks/deprecate.js";import"../chunks/metadata.js";import"../chunks/handleUtils.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../core/Error.js";import"../chunks/object.js";import"../config.js";import"../chunks/string.js";import"../chunks/ensureType.js";import"../chunks/shared.js";import"../intl.js";import"../chunks/number.js";import"../chunks/jsonMap.js";import"../chunks/locale.js";import"../chunks/messages.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../chunks/assets.js";import"../chunks/domUtils.js";import"../chunks/Promise.js";import"../chunks/uuid.js";import"../chunks/projector.js";import"../chunks/jsxWidgetSupport.js";import"../core/HandleOwner.js";import"../chunks/reactiveUtils.js";import"../chunks/Identifiable.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../chunks/ActionSlider.js";import"../support/actions/ActionToggle.js";import"./LayerList/ListItemPanel.js";import"./support/widget.js";function A(e,t,i){e.splice(i,0,e.splice(t,1)[0])}const w=t.ofType(m),j="esri-layer-list esri-widget esri-widget--panel",C="esri-layer-list--new-ui",S="esri-layer-list__no-items",L="esri-layer-list__list",E="esri-layer-list__list--root",x="esri-layer-list__list--exclusive",M="esri-layer-list__list--inherited",U="esri-layer-list__list--independent",T="esri-layer-list__item",O="esri-layer-list__item--error",P="esri-layer-list__item--invisible",N="esri-layer-list__item--invisible-at-scale",$="esri-layer-list__item--updating",R="esri-layer-list__item--has-children",V="esri-layer-list__item--selectable",B="esri-layer-list__item-container",F="esri-layer-list__item-actions-menu",D="esri-layer-list__item-actions-menu-item",H="esri-layer-list__item-actions-menu-item--active",z="esri-layer-list__item-actions",K="esri-layer-list__item-actions-list",W="esri-layer-list__item-action",q="esri-layer-list__item-action-icon",G="esri-layer-list__item-action-image",J="esri-layer-list__item-action-title",Q="esri-layer-list__action-toggle",X="esri-layer-list__action-toggle--on",Y="esri-layer-list__item-label",Z="esri-layer-list__item-error-message",ee="esri-layer-list__item-title",te="esri-layer-list__item-toggle",ie="esri-layer-list__item-toggle-icon",se="esri-layer-list__item-toggle-icon",re="esri-layer-list__item-radio-icon",oe="esri-layer-list__child-toggle",le="esri-layer-list__child-toggle--open",ne="esri-layer-list__child-toggle-icon--opened",ae="esri-layer-list__child-toggle-icon--closed",ce="esri-layer-list__child-toggle-icon--closed-rtl",de="esri-layer-list--chosen",he="esri-disabled",ue="esri-disabled-element",me="esri-hidden",pe="esri-rotating",ge="esri-icon-handle-horizontal",_e="esri-icon-visible",ye="esri-icon-non-visible",be="esri-icon-radio-checked",ve="esri-icon-radio-unchecked",fe="esri-icon-notice-triangle",ke="esri-icon-down-arrow",Ie="esri-icon-right-triangle-arrow",Ae="esri-icon-left-triangle-arrow",we="esri-icon-loading-indicator",je="esri-icon-default-action",Ce="esri-icon-layers",Se="actions",Le="action-section",Ee="items",xe={exclusive:"exclusive",inherited:"inherited",independent:"independent"};function Me(e){const{actionsOpen:t,children:i}=e;t&&(e.actionsOpen=!1),i.forEach((e=>Me(e)))}const Ue={statusIndicators:!0};let Te=class extends h{constructor(e,t){super(e,t),this._handles=new s,this._sortableNodes=new Map,this._sortableMap=new Map,this._focusSortUid=null,this._newUI=r("esri-layerlist-new-ui"),this.visibleItems=null,this.iconClass=Ce,this.label=void 0,this.listItemCreatedFunction=null,this.messages=null,this.messagesCommon=null,this.multipleSelectionEnabled=!1,this.operationalItems=null,this.selectionEnabled=!1,this.selectedItems=new w,this.view=null,this.viewModel=new u,this.visibleElements={...Ue},this._onSortableSort=({to:e,from:t,item:i,newIndex:s})=>{t&&e&&(t===e?this._sortLayers(this._sortableMap.get(t.dataset.group)):this._moveLayerFromChildList({to:e,from:t,item:i,newIndex:s}))},this._sortableCanPut=(e,t,i)=>{var s,r;const o=e.el.dataset.group,l=t.el.dataset.group,n=e.el["data-item"],a=i["data-item"],c=null==a||null==(s=a.layer)?void 0:s.type,d=null==n||null==(r=n.layer)?void 0:r.type;return o&&l&&c&&!("group"===d&&"group"===c)},this._sortableCanPull=(e,t,i)=>{var s;const r=e.el.dataset.group,o=t.el.dataset.group,l=i["data-item"],n=null==l||null==(s=l.layer)?void 0:s.type;return r&&o&&!!n},this._onSortableEnd=({oldIndex:e,from:t,to:i,item:s})=>{t!==i&&t.insertBefore(s,t.children[e])}}initialize(){const e=this.operationalItems;this._setVisibleItems(e),this.own(o(this,"operationalItems","change",(()=>this._itemsChanged(e))),l(this,"selectionEnabled",(()=>this._toggleAllSorting())))}destroy(){this._destroySortables(),this._handles.destroy(),this._handles=null}castVisibleElements(e){return{...Ue,...e}}triggerAction(e,t){this.viewModel.triggerAction(e,t)}render(){var e;const{visibleItems:t,_newUI:i}=this,s=null==(e=this.viewModel)?void 0:e.state,r={[C]:i,[me]:"loading"===s,[he]:"disabled"===s};return k("div",{class:this.classes(j,r)},null!=t&&t.length?this.renderItems():this.renderNoItems())}renderNoItems(){return k("div",{class:S},this.messages.noItemsToDisplay)}renderItems(){const{visibleItems:e,selectionEnabled:t,messages:i}=this;return k("ul",{"aria-label":i.widgetLabel,role:t?"listbox":void 0,afterCreate:this._sortNodeCreated,afterUpdate:this._sortNodeCreated,afterRemoved:this._sortNodeRemoved,"data-group":"root",bind:this,class:this.classes(L,E,U)},null==e?void 0:e.map((e=>this.renderItem(e,null))).toArray())}renderActionsMenuIcon(e,t){const{messagesCommon:i}=this,s={[H]:e.actionsOpen};return k("div",{key:"actions-menu-toggle","data-item":e,bind:this,onclick:this._toggleActionsOpen,onkeydown:this._toggleActionsOpen,class:this.classes(D,s),tabindex:"0",role:"button","aria-controls":t,"aria-label":i.options,title:i.options},k("span",{"aria-hidden":"true",class:ge}))}renderActionsMenu(e,t,i,s){const{panel:r}=e,o=r&&r.visible?this.renderPanelButton(r):null,l=1===i&&this._getSingleActionButton(t),n=l?this.renderAction({item:e,action:l,singleAction:!0}):null,a=!l&&i?this.renderActionsMenuIcon(e,s):null;return a||o||l?k("div",{key:"actions-menu",class:F},o,n,a):null}renderChildList(e,t){var i;const{selectionEnabled:s}=this,{visibilityMode:r,children:o}=e,l=!!e.error,n=!!o.length&&!l,a=!n&&s&&"group"===(null==(i=e.layer)?void 0:i.type),{exclusive:c,inherited:d}=xe,h={[x]:r===c,[M]:r===d,[U]:r!==d&&r!==c};return n||a?k("ul",{bind:this,key:"list-items",id:t,"data-group":e.uid,"data-item":e,afterCreate:this._sortNodeCreated,afterUpdate:this._sortNodeCreated,afterRemoved:this._sortNodeRemoved,class:this.classes(L,h),"aria-expanded":e.open?"true":"false",role:s?"listbox":r===c?"radiogroup":"group",hidden:!e.open&&!a||null},null==o?void 0:o.map((t=>this.renderItem(t,e))).toArray()):null}renderChildrenToggle(e,t){const{messagesCommon:i}=this,{children:s}=e,r=!!e.error,o=!!s.length&&!r,l={[le]:e.open},n=e.open?i.collapse:i.expand;return o?k("span",{onclick:this._toggleChildrenClick,onkeydown:this._toggleChildrenClick,"data-item":e,key:"toggle-children",class:this.classes(oe,l),tabindex:"0",role:"button","aria-controls":t,"aria-label":n,title:n},k("span",{"aria-hidden":"true",class:this.classes(ae,Ie)}),k("span",{"aria-hidden":"true",class:this.classes(ne,ke)}),k("span",{"aria-hidden":"true",class:this.classes(ce,Ae)})):null}renderError(e){return e.error?k("div",{key:"esri-layer-list__error",class:Z,role:"alert"},k("span",null,this.messages.layerError)):null}renderItemContent(e,t,i){const{id:s}=this,r=`${s}_${e.uid}`,o=`${r}_actions`,l=`${r}__list`,{panel:n}=e,a=this._filterActions(e.actionsSections),c=this._countActions(a);return[k("div",{key:"list-item-container",class:B},this.renderChildrenToggle(e,l),this.renderLabel(e,t,i),this.renderActionsMenu(e,a,c,o)),this.renderError(e),c?this.renderActionsSections(e,a,o):null,n&&n.open?n.render():null,this.renderChildList(e,l)]}renderItem(e,t){const{_newUI:i,id:s,selectionEnabled:r,selectedItems:o,visibleElements:l}=this,{children:n}=e,a=`${`${s}_${e.uid}`}__title`,c=!!e.error,d=!!n.length&&!c,h={[R]:d,[O]:!!c,[$]:e.updating&&!t&&l.statusIndicators,[P]:i&&!e.visible,[N]:!e.visibleAtCurrentScale,[V]:r};if(r){var u;const i={"data-layer-uid":null==(u=e.layer)?void 0:u.uid,"data-sort-filter":(!e.sortable).toString()};return k("li",{key:`item-with-selection-${e.uid}`,bind:this,afterCreate:this._focusListItem,afterUpdate:this._focusListItem,class:this.classes(T,h),"aria-labelledby":a,onclick:this._toggleSelection,onkeydown:this._selectionKeydown,"data-item":e,"data-group":t?t.uid:"root",tabIndex:0,"aria-selected":p(e,o)?"true":"false",role:"option",...i},this.renderItemContent(e,t,a))}return k("li",{key:`item-no-selection-${e.uid}`,bind:this,afterCreate:this._focusListItem,afterUpdate:this._focusListItem,class:this.classes(T,h),"aria-labelledby":a},this.renderItemContent(e,t,a))}renderItemTitle(e,t){const{messages:i}=this,s=e.title||i.untitledLayer,r=e.visibleAtCurrentScale?s:`${s} (${i.layerInvisibleAtScale})`;return k("span",{key:"layer-title-container",id:t,title:r,"aria-label":r,class:ee},s)}renderItemToggleIcon(e,t){const{_newUI:i}=this,{exclusive:s}=xe,r=t&&t.visibilityMode,o={[ie]:i,[se]:i&&r!==s,[re]:i&&r===s,[be]:r===s&&e.visible,[ve]:r===s&&!e.visible,[_e]:r!==s&&e.visible,[ye]:r!==s&&!e.visible};return k("span",{key:"item-toggle-icon",class:this.classes(o),"aria-hidden":"true"})}renderItemToggle(e,t,i){const{selectionEnabled:s,messages:r}=this,{exclusive:o}=xe,l=t&&t.visibilityMode,n=l===o?"radio":"switch";return k("span",s?{key:"item-toggle-selection-enabled",class:te,bind:this,onclick:this._toggleVisibility,onkeydown:this._toggleVisibility,"data-item":e,"data-parent-visibility":l,tabIndex:0,title:e.visible?r.hideLayer:r.showLayer,"aria-checked":e.visible?"true":"false",role:n,"aria-labelledby":i}:{key:"item-toggle",class:te},this.renderItemToggleIcon(e,t))}renderItemError(e){return e.error?k("span",{key:"notice-triangle","aria-hidden":"true",class:fe}):null}renderLabel(e,t,i){const{selectionEnabled:s,_newUI:r,messages:o}=this,{inherited:l,exclusive:n}=xe,a=null==t?void 0:t.visibilityMode,c=a===n?"radio":"switch",d=[this.renderItemToggle(e,t,i),this.renderItemTitle(e,i)];r&&d.reverse();const h=k("div",s?{key:`item-label-no-selection-${e.uid}`,class:Y}:{key:`item-label-with-selection-${e.uid}`,class:Y,bind:this,onclick:this._toggleVisibility,onkeydown:this._toggleVisibility,"data-item":e,"data-parent-visibility":a,tabIndex:0,"aria-checked":e.visible?"true":"false",title:e.visible?o.hideLayer:o.showLayer,role:c,"aria-labelledby":i},d);return a===l||e.error?k("div",{key:`item-label-container-${e.uid}`,class:Y},this.renderItemError(e),this.renderItemTitle(e,i)):h}renderPanelButton(e){const{className:t,open:i,title:s,image:r}=e,o=r||t?t:je,l=this._getIconImageStyles(e),n={[H]:i},a={[G]:!!l["background-image"]};return o&&(a[o]=!!o),k("div",{key:`panel-${e.uid}`,bind:this,"data-panel":e,onclick:this._triggerPanel,onkeydown:this._triggerPanel,class:this.classes(D,n),role:"button",tabindex:"0",title:s,"aria-label":s},k("span",{class:this.classes(a),styles:l}))}renderActionsSections(e,t,i){const s=t.toArray().map(((t,i)=>k("ul",{key:`${e}-action-section-${i}`,class:K},this.renderActionSection(e,t))));return k("div",{role:"group","aria-expanded":e.actionsOpen?"true":"false",key:"actions-section",id:i,class:z,hidden:!e.actionsOpen||null},s)}renderActionSection(e,t){return(t&&t.toArray()).map((t=>this.renderAction({item:e,action:t})))}renderActionIcon(e){const{active:t,className:i}=e,s=this._getIconImageStyles(e),r="button"!==e.type||e.image||i?i:je,o={[G]:!t&&!!s["background-image"],[we]:t,[pe]:t};return r&&!t&&(o[r]=!0),k("span",{key:"action-icon","aria-hidden":"true",class:this.classes(q,o),styles:s})}renderActionTitle(e,t){return t?null:k("span",{key:"action-title",class:J},e)}renderAction(e){const{item:t,action:i,singleAction:s}=e,{active:r,disabled:o,title:l}=i,n={[D]:s&&"button"===i.type,[W]:r||!s&&"toggle"!==i.type,[Q]:!r&&"toggle"===i.type,[X]:!r&&"toggle"===i.type&&i.value,[ue]:o},a=[this.renderActionIcon(i),this.renderActionTitle(l,s)];return s?k("div",{bind:this,"data-item":t,"data-action":i,role:"button",key:`single-action-${i.uid}`,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:n,tabindex:"0",title:l,"aria-label":l},a):k("li",{bind:this,"data-item":t,"data-action":i,key:`action-${i.uid}`,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:n,tabindex:"0",role:"button",title:l,"aria-label":l},a)}_sortNodeRemoved(e){const{_sortableMap:t}=this,i=e.dataset.group,s=t.get(i);s&&s.destroy(),t.delete(i)}_destroySortables(){const{_sortableMap:e,_sortableNodes:t}=this;e.forEach((e=>e&&e.destroy())),e.clear(),t.clear()}_moveLayerFromChildList({to:e,from:t,item:i,newIndex:s}){const r=i["data-item"],o=e["data-item"],l=t["data-item"];this.viewModel.moveListItem(r,l,o,s)}_sortLayers(e){if(!e)return;const t=e.el["data-item"],i=e.toArray();var s,r;t?_(t,i):g(null==(s=this.view)||null==(r=s.map)?void 0:r.layers,i)}_toggleSorting(e,t){const{_sortableMap:i,selectionEnabled:s}=this,r=i.get(t),o=e["data-item"],l=("root"===t||o.childrenSortable&&y(o))&&s;if(r)r.option("disabled",!l);else if(l){const s=I.create(e,{dataIdAttr:"data-layer-uid",group:{name:t,pull:this._sortableCanPull,put:this._sortableCanPut},filter:'[data-sort-filter="true"]',fallbackTolerance:4,onSort:this._onSortableSort,onEnd:this._onSortableEnd,disabled:!l,chosenClass:de});i.set(t,s)}}_toggleAllSorting(){this._sortableNodes.forEach(((e,t)=>this._toggleSorting(e,t)))}_sortNodeCreated(e){const t=e.dataset.group;t&&(this._sortableNodes.set(t,e),this._toggleSorting(e,t))}_setVisibleItems(e){this.visibleItems=null==e?void 0:e.filter((e=>this.errorsVisible||!e.error))}_getSingleActionButton(e){return e.reduce((e=>e)).filter((e=>e&&"button"===e.type)).getItemAt(0)}_focusListItem(e){var t;const{_focusSortUid:i}=this;if(!e||!i)return;(null==(t=e["data-item"].layer)?void 0:t.uid)===i&&(e.focus(),this._focusSortUid=null)}_watchActionSectionChanges(e,t){const i=Le+t;this._handles.add(e.on("change",this.scheduleRender.bind(this)),i),e.forEach((e=>this._renderOnActionChanges(e,t)))}_renderOnActionChanges(e,t){const i=Se+t;"toggle"!==e.type?"slider"!==e.type?this._handles.add([l(e,["className","image","id","title","visible"],(()=>this.scheduleRender()))],i):this._handles.add([l(e,["className","id","title","visible","value","displayValueEnabled","max","min","step"],(()=>this.scheduleRender()))],i):this._handles.add([l(e,["className","image","id","title","visible","value"],(()=>this.scheduleRender()))],i)}_renderOnItemChanges(e){const t=e.uid,i=Ee+t;this._handles.add([l(e,["actionsOpen","visible","open","updating","title","visibleAtCurrentScale","error","visibilityMode","panel","panel.title","panel.content","panel.className","sortable","childrenSortable"],(()=>this.scheduleRender())),e.actionsSections.on("change",(()=>this.scheduleRender())),e.children.on("change",(()=>this.scheduleRender()))],i),e.children.forEach((e=>this._renderOnItemChanges(e))),e.actionsSections.forEach((e=>this._watchActionSectionChanges(e,t)))}_itemsChanged(e){this._handles.removeAll(),e.forEach((e=>this._renderOnItemChanges(e))),this._setVisibleItems(e),this.scheduleRender()}_filterActions(e){return e.map((e=>e.filter((e=>e.visible))))}_countActions(e){return e.reduce(((e,t)=>e+t.length),0)}_getIconImageStyles(e){const t="esri.widgets.LayerList.ListItemPanel"===e.declaredClass||"esri.support.Action.ActionButton"===e.declaredClass||"esri.support.Action.ActionToggle"===e.declaredClass?e.image:null;return{"background-image":t?`url("${t}")`:null}}_selectionKeydown(e){const t=i(e);if(-1===["ArrowDown","ArrowUp"].indexOf(t))return void this._toggleSelection(e);e.stopPropagation();const s=e.currentTarget,r=s["data-item"],{_sortableMap:o,selectedItems:l}=this,n=s.dataset.group,a=o.get(n);if(!a)return;const c=p(r,l),d=a.toArray(),h=e.target,u=d.indexOf(h.dataset.layerUid);if(-1!==u){if("ArrowDown"===t){const e=u+1;if(e>=d.length)return;var m,g;if(c)A(d,u,e),a.sort(d),this._sortLayers(a),this._focusSortUid=null==(m=r.layer)?void 0:m.uid;else this._focusSortUid=null==(g=r.layer)?void 0:g.uid,this.scheduleRender()}if("ArrowUp"===t){const e=u-1;if(e<=-1)return;var _,y;if(c)A(d,u,e),a.sort(d),this._sortLayers(a),this._focusSortUid=null==(_=r.layer)?void 0:_.uid;else this._focusSortUid=null==(y=r.layer)?void 0:y.uid,this.scheduleRender()}}}_toggleActionsOpen(e){const t=e.currentTarget["data-item"],{actionsOpen:i}=t,s=!i;s&&this.operationalItems.forEach((e=>Me(e))),t.actionsOpen=s,e.stopPropagation()}_triggerPanel(e){const t=e.currentTarget["data-panel"];t&&(t.open=!t.open),e.stopPropagation()}_triggerAction(e){const t=e.currentTarget,i=t["data-action"],s=t["data-item"];"toggle"===i.type&&(i.value=!i.value),this.triggerAction(i,s),e.stopPropagation()}_toggleVisibility(e){const t=e.currentTarget,i=t.getAttribute("data-parent-visibility"),s=t["data-item"];i===xe.exclusive&&s.visible||(s.visible=!s.visible),e.stopPropagation()}_toggleChildrenClick(e){const t=e.currentTarget["data-item"];t.open=!t.open,e.stopPropagation()}_toggleSelection(e){e.stopPropagation();const{multipleSelectionEnabled:t,selectedItems:i}=this,s=e.currentTarget["data-item"],r=p(s,i),{length:o}=i;if(!t)return o&&!(r&&1===o)?(i.removeAll(),void i.add(s)):void(r?null==i.remove||i.remove(r):i.add(s));r?null==i.remove||i.remove(r):i.add(s)}};e([c()],Te.prototype,"visibleItems",void 0),e([c()],Te.prototype,"iconClass",void 0),e([c()],Te.prototype,"errorsVisible",void 0),e([c({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Te.prototype,"label",void 0),e([n("viewModel.listItemCreatedFunction")],Te.prototype,"listItemCreatedFunction",void 0),e([c(),v("esri/widgets/LayerList/t9n/LayerList")],Te.prototype,"messages",void 0),e([c(),v("esri/t9n/common")],Te.prototype,"messagesCommon",void 0),e([c()],Te.prototype,"multipleSelectionEnabled",void 0),e([n("viewModel.operationalItems")],Te.prototype,"operationalItems",void 0),e([c()],Te.prototype,"selectionEnabled",void 0),e([c()],Te.prototype,"selectedItems",void 0),e([n("viewModel.view")],Te.prototype,"view",void 0),e([f("trigger-action"),c({type:u})],Te.prototype,"viewModel",void 0),e([c()],Te.prototype,"visibleElements",void 0),e([a("visibleElements")],Te.prototype,"castVisibleElements",null),e([n("viewModel.triggerAction")],Te.prototype,"triggerAction",null),e([b()],Te.prototype,"_toggleActionsOpen",null),e([b()],Te.prototype,"_triggerPanel",null),e([b()],Te.prototype,"_triggerAction",null),e([b()],Te.prototype,"_toggleVisibility",null),e([b()],Te.prototype,"_toggleChildrenClick",null),e([b()],Te.prototype,"_toggleSelection",null),Te=e([d("esri.widgets.LayerList")],Te);const Oe=Te;export{Oe as default};
