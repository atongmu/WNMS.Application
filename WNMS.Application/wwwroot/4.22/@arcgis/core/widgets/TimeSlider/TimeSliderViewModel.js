/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../TimeExtent.js";import i from"../../TimeInterval.js";import n from"../../core/Collection.js";import{a as s}from"../../chunks/deprecate.js";import{E as r}from"../../chunks/Evented.js";import{HandleOwnerMixin as o}from"../../core/HandleOwner.js";import{L as l}from"../../chunks/Logger.js";import{i as a,b as u,clone as m,u as p}from"../../core/lang.js";import{after as d,isAbortError as c,createTask as h}from"../../core/promiseUtils.js";import{o as f}from"../../chunks/timeUtils.js";import{init as v,watch as w,whenFalseOnce as g}from"../../core/watchUtils.js";import{property as T}from"../../core/accessorSupport/decorators/property.js";import{e as _}from"../../chunks/ensureType.js";import{subclass as x}from"../../core/accessorSupport/decorators/subclass.js";import{b as E,W as y}from"../../chunks/Widgets.js";import{getTimeExtentFromLayers as j}from"../../support/timeUtils.js";import"../../chunks/JSONSupport.js";import"../../core/Accessor.js";import"../../chunks/metadata.js";import"../../chunks/handleUtils.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../core/Error.js";import"../../chunks/object.js";import"../../config.js";import"../../chunks/string.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../chunks/jsonMap.js";import"../../chunks/shared.js";import"../../core/Handles.js";import"../../chunks/reactiveUtils.js";var b;function k(t){return a(t)&&void 0!==t.count}function S(t){return a(t)&&void 0!==t.interval}function C(t){return a(t)&&void 0!==t.dates}function A(t){return"esri.WebMap"===t.declaredClass}const W=l.getLogger("esri.widgets.Popup.PopupViewModel");let M=b=class extends(o(r.EventedAccessor)){constructor(t){super(t),this._animationController=null,this._loadingWebDocument=!1,this._timerId=null,this._updateTimeSliderTask=null,this.actions=new n,this.view=null}initialize(){this.handles.add([v(this,"effectiveStops",(()=>{u(this.timeExtent)&&this._set("timeExtent",this._getDefaultTimeExtent())})),v(this,"view.map",(t=>{a(this._updateTimeSliderTask)&&(this._updateTimeSliderTask.abort(),this._updateTimeSliderTask=null),this._updateTimeSliderTask=h((async e=>{this._loadingWebDocument=!0,await this._updateTimeSliderFromMap(t,e),this._loadingWebDocument=!1}))})),v(this,"view",((t,e)=>{this._unregisterWidget(e),this._registerWidget(t)}),!0),v(this,"timeExtent",(t=>{if(u(this.view))return;const e=this.view.timeExtent;(u(t)||t.isAllTime)&&(u(e)||e.isAllTime)||a(t)&&a(e)&&t.equals(e)||(this.view.timeExtent=p(t))})),w(this,"view.timeExtent",(t=>{(u(t)||t.isAllTime)&&(u(this.timeExtent)||this.timeExtent.isAllTime)||a(t)&&a(this.timeExtent)&&t.equals(this.timeExtent)||(this.timeExtent=t)}))])}destroy(){a(this._timerId)&&(clearInterval(this._timerId),this._timerId=null),this._unregisterWidget(this.view),this.view=null,a(this._animationController)&&(this._animationController.abort(),this._animationController=null),a(this._updateTimeSliderTask)&&(this._updateTimeSliderTask.abort(),this._updateTimeSliderTask=null)}get effectiveStops(){const{fullTimeExtent:t,stops:e}=this;if(C(e)){const{dates:i}=e;if(null==i||0===i.length)return null;const n=i.sort(((t,e)=>t.getTime()-e.getTime()));if(u(t))return n;const{start:s,end:r}=t;if(u(s)||u(r))return n;return n.filter((t=>!(t.getTime()<s.getTime()||t.getTime()>r.getTime())))}if(k(e)){var i;const n=null!=(i=e.timeExtent)?i:p(t);return this._divideTimeExtentByCount(n,e.count)}if(S(e)){var n;const i=null!=(n=e.timeExtent)?n:p(t);return this._divideTimeExtentByInterval(i,e.interval)}return[]}set fullTimeExtent(t){this._override("fullTimeExtent",t)}set loop(t){this._override("loop",t)}set mode(t){this._override("mode",t)}set playRate(t){t<=0||t>36e5||("playing"===this.state&&this._startAnimation(),this._override("playRate",t))}get state(){return u(this.fullTimeExtent)||this._loadingWebDocument?"disabled":a(this._animationController)?"playing":"ready"}set stops(t){this._override("stops",t)}set timeExtent(t){this._override("timeExtent",t)}get timeExtentValues(){const{mode:t,timeExtent:e}=this;if(u(e)||e.isAllTime||e.isEmpty)return null;const{start:i,end:n}=e;switch(t){case"cumulative-from-end":case"instant":return a(i)?[i.getTime()]:null;case"cumulative-from-start":return a(n)?[n.getTime()]:null;case"time-window":return a(i)&&a(n)?[i.getTime(),n.getTime()]:null}}get values(){s(W,"values",{replacement:"timeExtent",version:"4.20"});const{mode:t,timeExtent:e}=this;if(u(e))return null;if(e.isAllTime)return"time-window"===t?[null,null]:[null];if(e.isEmpty)return"time-window"===t?[void 0,void 0]:[void 0];const{start:i,end:n}=e;switch(t){case"time-window":return[i,n];case"instant":case"cumulative-from-end":return[i];case"cumulative-from-start":return[n]}}set values(t){if(s(W,"values",{replacement:"timeExtent",version:"4.20"}),u(t))return void(this.timeExtent=null);const i=t[0];if(u(i))return void(this.timeExtent=new e({start:i,end:i}));const n=t.length>1&&t[1];switch(this.mode){case"time-window":return void(this.timeExtent=new e({start:i,end:n}));case"instant":return void(this.timeExtent=new e({start:i,end:i}));case"cumulative-from-end":return void(this.timeExtent=new e({start:i,end:null}));case"cumulative-from-start":return void(this.timeExtent=new e({start:null,end:i}))}}static async getPropertiesFromWebMap(t,i){var n,s;if(!t||!A(t))return null;await t.load({signal:i});const r=null==t||null==(n=t.widgets)?void 0:n.timeSlider;if(!r)return null;const o=await async function(t,e){const{fullTimeExtent:i}=t.widgets.timeSlider;return i||j(t.allLayers,e)}(t,i),l=r.loop,p=function(t){var e;const i=null!=(e=t.numThumbs)?e:2,n=t.currentTimeExtent;if(n){const{start:t,end:e}=n;return a(t)&&a(e)&&t.getTime()===e.getTime()?"instant":2===i?"time-window":u(t)||0===t.getTime()?"cumulative-from-start":"cumulative-from-end"}return 2===i?"time-window":"cumulative-from-start"}(r),d=null!=(s=r.stopDelay)?s:2e3,c=function(t){const{numStops:e,stopInterval:i,stops:n}=t;return n?{dates:m(n)}:i?{interval:i.clone()}:{count:null!=e?e:5}}(r),h=function(t,i){var n;const s=t.currentTimeExtent;if(!s)return null;const{start:r,end:o}=s,l=null!=(n=null!=r?r:o)?n:null;switch(i){case"time-window":return new e({start:r,end:o});case"cumulative-from-start":return new e({start:null,end:l});case"cumulative-from-end":return new e({start:l,end:null});case"instant":return new e({start:l,end:l})}}(r,p);return{fullTimeExtent:o,loop:l,mode:p,playRate:d,stops:c,timeExtent:h}}next(){this._step({forward:!0,allowRestart:!1})}play(){this._startAnimation()}previous(){this._step({forward:!1,allowRestart:!1})}stop(){this._stopAnimation()}triggerAction(t){this.emit("trigger-action",{action:t})}updateWebDocument(t){if(A(t)){const e=new E({currentTimeExtent:this.timeExtent,fullTimeExtent:this.fullTimeExtent,loop:this.loop,numStops:k(this.stops)?this.stops.count:null,numThumbs:"time-window"===this.mode?2:1,stopDelay:this.playRate,stopInterval:S(this.stops)?this.stops.interval:null,stops:C(this.stops)?this.stops.dates:null});t.widgets?t.widgets.timeSlider=e:t.widgets=new y({timeSlider:e})}}valuesToTimeExtent(t){if(u(t))return null;const i=t.sort(((t,e)=>t-e)).map((t=>new Date(t))),n=i.length>0?i[0]:null,s=i.length>1?i[1]:null;switch(this.mode){case"time-window":return new e({start:n,end:s});case"instant":return new e({start:n,end:n});case"cumulative-from-start":return new e({start:null,end:n});case"cumulative-from-end":return new e({start:n,end:null});default:return e.allTime}}async _animate(){try{await Promise.all([d(this.playRate,null,a(this._animationController)&&this._animationController.signal),a(this.view)&&g(this.view,"updating",a(this._animationController)&&this._animationController.signal)])}catch(t){return c(t)||W.error(t),void(this._animationController=null)}this._step({forward:!0,allowRestart:!1}),u(this._animationController)||this._animate()}_divideTimeExtentByCount(t,e=10){if(!t||!e)return[];const{start:i,end:n}=t;if(u(i)||u(n))return[];if(e>1e4)return this._divideTimeExtentByCount(t);const s=[],r=i.getTime(),o=n.getTime()-r;for(let t=0;t<=e;t++)s.push(new Date(r+t/e*o));return s}_divideTimeExtentByInterval(t,e,i=1e4){if(!t||!e)return[];const{start:n,end:s}=t;if(u(n)||u(s))return[];if((s.getTime()-n.getTime())/e.toMilliseconds()>i)return this._divideTimeExtentByCount(t);const r=[],{value:o,unit:l}=e;let a=n;for(;a.getTime()<=s.getTime();)r.push(new Date(a.getTime())),a=f(a,o,l);return r}_getDefaultTimeExtent(){const{effectiveStops:t,mode:i}=this;if(u(t)||!i)return null;switch(i){case"time-window":return t.length>1?new e({start:t[0],end:t[1]}):null;case"cumulative-from-start":return t.length>0?new e({start:null,end:t[0]}):null;case"cumulative-from-end":return t.length>0?new e({start:t[0],end:null}):null;case"instant":return t.length>0?new e({start:t[0],end:t[0]}):null;default:return null}}_registerWidget(t){if(a(t)){t.persistableViewModels.some((t=>t===this))||t.persistableViewModels.add(this)}}_startAnimation(){this._stopAnimation(),this._animationController=new AbortController,this._step({forward:!0,allowRestart:!0}),this._animate()}_step(t){const{forward:e,allowRestart:i}=t,{effectiveStops:n}=this;if(u(this.timeExtentValues)||u(n))return;const s=n.map((t=>t.getTime())),r=this.timeExtentValues.map((t=>{const e=s.indexOf(t);if(-1!==e)return e;const i=s.reduce(((e,i)=>Math.abs(i-t)<Math.abs(e-t)?i:e));return s.indexOf(i)})),o=r.map((t=>t+(e?1:-1))),l=o.some((t=>t<0||t>s.length-1)),{loop:a,state:m}=this;if(l)if(a||i){const t=Math.min(...r),i=Math.max(...r),n=(e?r.map((e=>e-t)):r.map((t=>t+(s.length-1-i)))).map((t=>s[t]));this.timeExtent=this.valuesToTimeExtent(n)}else"playing"===m&&this.stop();else{const t=o.map((t=>s[t]));this.timeExtent=this.valuesToTimeExtent(t)}}_stopAnimation(){a(this._animationController)&&(this._animationController.abort(),this._animationController=null)}_unregisterWidget(t){a(t)&&t.persistableViewModels.remove(this)}async _updateTimeSliderFromMap(t,e){const i=await b.getPropertiesFromWebMap(t,e);if(!u(i))for(const t in i)this._isOverridden(t)||(this[t]=i[t])}};t([T()],M.prototype,"_animationController",void 0),t([T()],M.prototype,"_loadingWebDocument",void 0),t([T({type:n})],M.prototype,"actions",void 0),t([T({readOnly:!0})],M.prototype,"effectiveStops",null),t([T({type:e,value:null})],M.prototype,"fullTimeExtent",null),t([T({nonNullable:!0,value:!1})],M.prototype,"loop",null),t([T({nonNullable:!0,value:"time-window"})],M.prototype,"mode",null),t([T({nonNullable:!0,value:1e3})],M.prototype,"playRate",null),t([T({readOnly:!0})],M.prototype,"state",null),t([T({cast:t=>u(t)?null:(S(t)&&(t.interval=_(i,t.interval)),(S(t)||k(t))&&(t.timeExtent=_(e,t.timeExtent)),t),value:{count:10}})],M.prototype,"stops",null),t([T({type:e,value:null})],M.prototype,"timeExtent",null),t([T({readOnly:!0})],M.prototype,"timeExtentValues",null),t([T({value:null})],M.prototype,"values",null),t([T()],M.prototype,"view",void 0),t([T()],M.prototype,"next",null),t([T()],M.prototype,"play",null),t([T()],M.prototype,"previous",null),t([T()],M.prototype,"stop",null),t([T()],M.prototype,"updateWebDocument",null),M=b=t([x("esri.widgets.Popup.PopupViewModel")],M);const D=M;export{D as default};
