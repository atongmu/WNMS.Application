/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Collection.js";import s from"../../core/Handles.js";import{L as r}from"../../chunks/Loadable.js";import{watch as o,on as i}from"../../core/watchUtils.js";import{property as a}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import{cast as n}from"../../core/accessorSupport/decorators/cast.js";import{subclass as p}from"../../core/accessorSupport/decorators/subclass.js";import{b as m}from"../../chunks/basemapUtils.js";import c from"../../core/Error.js";import{throwIfAborted as l}from"../../core/promiseUtils.js";import{i as u}from"../../chunks/layerUtils.js";import{s as h}from"../../chunks/ViewingMode.js";import{c as j}from"../../chunks/terrainUtils.js";import{T as y}from"../../chunks/TerrainConst.js";import{i as f}from"../../chunks/spatialReferenceSupport.js";import d from"./support/BasemapGalleryItem.js";import b from"./support/LocalBasemapsSource.js";import g from"./support/PortalBasemapsSource.js";import"../../chunks/ArrayPool.js";import"../../chunks/Evented.js";import"../../core/Accessor.js";import"../../chunks/deprecate.js";import"../../chunks/Logger.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import"../../chunks/handleUtils.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/ensureType.js";import"../../chunks/shared.js";import"../../chunks/Promise.js";import"../../Basemap.js";import"../../chunks/collectionUtils.js";import"../../chunks/JSONSupport.js";import"../../chunks/loadAll.js";import"../../chunks/asyncUtils.js";import"../../core/urlUtils.js";import"../../chunks/writer.js";import"../../geometry/SpatialReference.js";import"../../portal/Portal.js";import"../../kernel.js";import"../../request.js";import"../../chunks/reader.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../geometry/Point.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../chunks/locale.js";import"../../portal/PortalQueryParams.js";import"../../chunks/jsonMap.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../portal/PortalItem.js";import"../../chunks/assets.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/messages.js";import"../../chunks/writeUtils.js";import"../../chunks/Util2.js";import"../../chunks/mathUtils.js";import"../../chunks/common.js";import"../../chunks/vec2.js";import"../../chunks/vec2f64.js";import"../../chunks/vec4f64.js";import"../../chunks/Scheduler.js";import"../../chunks/reactiveUtils.js";import"../../chunks/debugFlags.js";import"../../geometry/projection.js";import"../../chunks/unitUtils.js";import"../../chunks/projectionEllipsoid.js";import"../../chunks/mat4.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../chunks/pe.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../layers/support/TileInfo.js";import"../../layers/support/LOD.js";async function k(e,t={}){await async function(e,t){const{basemap:s,view:r}=e;if(await s.load(t),0===s.baseLayers.length)return;const o=function(e){const t=["ArcGISTiledImageServiceLayer","ArcGISTiledMapServiceLayer","OpenStreetMap","VectorTileLayer","WebTiledLayer"];return e.toArray().filter((e=>-1===t.indexOf(e.operationalLayerType))).map((e=>new c("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:e,operationalLayerType:e.operationalLayerType||"unknown"})))}(s.baseLayers.concat(s.referenceLayers));if(o.length)throw o[0];const i=s.baseLayers.getItemAt(0);try{await i.load(t)}catch(e){const t="basemap-compatibility:unknown-error",s="Unknown basemap compatibility error",{name:r=t,message:o=s,details:i}=e;throw new c(r,o,i)}!function(e,t){const s=e.tileInfo;if(!s)return;const r=t.state.viewingMode;if(!r)return;if(!f(s.spatialReference,r))throw new c(`basemapgalleryitem:spatial-reference-unsupported-${h(r)}`,`Basemap spatial reference is unsupported in ${h(r)} mode`);if(1===r){let t=j(s,e.fullExtent,null,1);if(t&&e.compatibleTileInfo256&&!j(e.compatibleTileInfo256,e.fullExtent,null,1)&&(t=null),t){const e=s.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new c(`basemapgalleryitem:tiling-scheme-unsupported-${e}-global`,"Basemap tiling scheme is unsupported in global mode",{error:t})}}else if(y.checkUnsupported(s))throw new c("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const o=t.get("basemapTerrain.tilingScheme");if(o&&!o.compatibleWith(s)&&(!e.compatibleTileInfo256||!o.compatibleWith(e.compatibleTileInfo256)))throw new c("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}(i,r)}(e,t),l(t)}async function w(e,t={}){const{basemap:s,view:r}=e;if(await s.load(t),l(t),0===s.baseLayers.length)return;const o=s.baseLayers.getItemAt(0);if(!u(o))return;if(s.spatialReference){if(r.spatialReference.equals(s.spatialReference))return;v()}await o.load(t),l(t);const i=(o.get("supportedSpatialReferences")||[o.get("tileInfo.spatialReference")]).filter(Boolean);0!==i.length&&i.every((e=>!r.spatialReference.equals(e)))&&v()}function v(){throw new c("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}const T=t.ofType(d);let U=class extends r{constructor(e){super(e),this._handles=new s,this.activeBasemap=null,this.items=new T,this.source=new g,this.view=null}initialize(){const e=()=>this._recreateItems();this._handles.add([o(this,["compatibilityFunction","state"],(()=>this._updateItems())),i(this,"source.basemaps","change",e,e)])}destroy(){this._handles.destroy(),this._handles=null}get compatibilityFunction(){if(void 0===this._get("compatibilityFunction")){return"3d"===this.get("view.type")?k:w}return this._get("compatibilityFunction")}set compatibilityFunction(e){this._set("compatibilityFunction",e)}castSource(e){return Array.isArray(e)||t.isCollection(e)?new b({basemaps:e}):function(e){return e&&"esri.portal.Portal"===e.declaredClass}(e)?new g({portal:e}):function(e){return e&&!(e instanceof g)&&(!!e.portal||!!e.query)}(e)?new g(e):function(e){return e&&"basemaps"in e&&"state"in e&&"refresh"in e}(e)?e:null}get state(){return this.get("view.ready")&&this.source?"ready":"disabled"}basemapEquals(e,t){return m(e,t)}refresh(){this._recreateItems()}load(e){return this.addResolvingPromise(r.isLoadable(this.source)?this.source.load(e):Promise.resolve()),Promise.resolve(this)}_recreateItems(){const e=this.get("source.basemaps"),{view:t,compatibilityFunction:s}=this;this.items.removeAll().forEach((e=>e.destroy())),this.items.addMany(e.map((e=>new d({basemap:e,compatibilityFunction:s,view:t}))))}_updateItems(){this.items.forEach((e=>{e.compatibilityFunction=this.compatibilityFunction,e.view=this.view}))}};e([a({aliasOf:"view.map.basemap"})],U.prototype,"activeBasemap",void 0),e([a()],U.prototype,"compatibilityFunction",null),e([a({readOnly:!0,type:T})],U.prototype,"items",void 0),e([a()],U.prototype,"source",void 0),e([n("source")],U.prototype,"castSource",null),e([a({readOnly:!0})],U.prototype,"state",null),e([a()],U.prototype,"view",void 0),U=e([p("esri.widgets.BasemapGallery.BasemapGalleryViewModel")],U);const I=U;export{I as default};
