/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../Graphic.js";import r from"../../core/Accessor.js";import s from"../../core/Handles.js";import{L as o}from"../../chunks/Logger.js";import{i}from"../../core/lang.js";import{eachAlways as n,all as a,isAbortError as l}from"../../core/promiseUtils.js";import{t as p}from"../../chunks/throttle.js";import{init as u}from"../../core/watchUtils.js";import{property as c}from"../../core/accessorSupport/decorators/property.js";import{cast as m}from"../../core/accessorSupport/decorators/cast.js";import{subclass as d}from"../../core/accessorSupport/decorators/subclass.js";import h from"../../popup/content/TextContent.js";import"../../chunks/ensureType.js";import f,{g as y,a as j,i as b,b as g,f as I,c as _,d as v,e as k,h as x,j as M,k as w,l as F,p as C,m as A,n as T,o as S,q as E,r as R,t as V,u as L,v as P}from"../Attachments/AttachmentsViewModel.js";import{HandleOwnerMixin as U}from"../../core/HandleOwner.js";import{c as O}from"../../chunks/languageUtils.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import D from"../../popup/content/FieldsContent.js";import N from"../../popup/content/MediaContent.js";import $ from"../../popup/ElementExpressionInfo.js";import q from"../../popup/ExpressionInfo.js";import Q from"../../popup/FieldInfo.js";import B from"../../popup/content/support/ChartMediaInfoValueSeries.js";import z from"../../request.js";import J from"../../core/Error.js";import{isNumericField as G}from"../../layers/support/fieldUtils.js";import H from"../../rest/support/Query.js";import W from"../../rest/support/RelationshipQuery.js";import K from"../../rest/support/StatisticDefinition.js";import Z from"../../tasks/QueryTask.js";import X from"../../layers/FeatureLayer.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../chunks/string.js";import"../../chunks/object.js";import"../../geometry/Geometry.js";import"../../chunks/JSONSupport.js";import"../../chunks/metadata.js";import"../../chunks/handleUtils.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/writer.js";import"../../chunks/deprecate.js";import"../../config.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../geometry/Point.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../chunks/jsonMap.js";import"../../geometry/support/jsonUtils.js";import"../../PopupTemplate.js";import"../../core/Collection.js";import"../../chunks/Evented.js";import"../../chunks/shared.js";import"../../popup/content.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/number.js";import"../../chunks/locale.js";import"../../popup/content/BarChartMediaInfo.js";import"../../chunks/chartMediaInfoUtils.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../support/actions/ActionBase.js";import"../../chunks/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../chunks/arcadeOnDemand.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../chunks/mathUtils.js";import"../../chunks/common.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils2.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/aaBoundingRect.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../kernel.js";import"../../chunks/Loadable.js";import"../../chunks/Promise.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../chunks/Thumbnail.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../rest/query/support/AttachmentInfo.js";import"../../rest/support/AttachmentQuery.js";import"../../intl.js";import"../../chunks/messages.js";import"../../chunks/assets.js";import"../../chunks/reactiveUtils.js";import"../../chunks/datetime.js";import"../../chunks/number3.js";import"../../TimeExtent.js";import"../../chunks/timeUtils.js";import"../../chunks/DataLayerSource.js";import"../../layers/support/Field.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../chunks/executeForTopCount.js";import"../../chunks/utils3.js";import"../../chunks/scaleUtils.js";import"../../chunks/unitUtils.js";import"../../chunks/projectionEllipsoid.js";import"../../chunks/floorFilterUtils.js";import"../../chunks/query.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/arcgisLayerUrl.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/pbf.js";import"../../chunks/OptimizedFeature.js";import"../../chunks/OptimizedFeatureSet.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../chunks/compilerUtils.js";import"../../chunks/featureConversionUtils.js";import"../../rest/support/FeatureSet.js";import"../../rest/support/TopFeaturesQuery.js";import"../../rest/support/TopFilter.js";import"../../chunks/executeQueryJSON.js";import"../../tasks/Task.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../chunks/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/lengthUtils.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties2.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/symbolConversion.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../renderers/DotDensityRenderer.js";import"../../core/accessorSupport/decorators/aliasOf.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../core/sql.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/support/elements.js";import"../../geometry/HeightModelInfo.js";import"../../layers/Layer.js";import"../../chunks/FeatureIndex.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../core/workers/RemoteClient.js";import"../../chunks/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../chunks/BlendLayer.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/mat4.js";import"../../chunks/_commonjsHelpers.js";import"../../chunks/CustomParametersMixin.js";import"../../chunks/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../chunks/OperationalLayer.js";import"../../chunks/commonProperties.js";import"../../support/timeUtils.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/OrderedLayer.js";import"../../chunks/PortalLayer.js";import"../../chunks/asyncUtils.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/RefreshableLayer.js";import"../../chunks/ScaleRangeLayer.js";import"../../chunks/TemporalLayer.js";import"../../TimeInterval.js";import"../../layers/support/TimeInfo.js";import"../../chunks/featureReductionUtils.js";import"../../layers/support/FeatureReductionSelection.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../chunks/defaultsJSON.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../layers/support/FieldsIndex.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../chunks/labelingInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";let Y=class extends f{constructor(t){super(t),this.description=null,this.title=null}};t([c()],Y.prototype,"description",void 0),t([c()],Y.prototype,"title",void 0),Y=t([d("esri.widgets.Feature.FeatureAttachments.FeatureAttachmentsViewModel")],Y);const tt=Y;let et=class extends(U(r)){constructor(t){super(t),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.handles.add(u(this,"creator",(t=>{this._destroyContent(),this._createContent(t)})))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:t,graphic:e,destroyer:r}=this;t&&(y(r,{graphic:e}).catch((()=>null)),this._set("created",null))}async _createContent(t){const{graphic:e}=this,r=y(t,{graphic:e}).catch((()=>null));this._loadingPromise=r,this.notifyChange("state");const s=await r;r===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",s))}};t([c({readOnly:!0})],et.prototype,"created",void 0),t([c()],et.prototype,"creator",void 0),t([c()],et.prototype,"destroyer",void 0),t([c({type:e})],et.prototype,"graphic",void 0),t([c({readOnly:!0})],et.prototype,"state",null),et=t([d("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],et);const rt=et;let st=class extends r{constructor(t){super(t),this.attributes=null,this.expressionInfos=null,this.description=null,this.fieldInfos=null,this.title=null}get formattedFieldInfos(){const{expressionInfos:t,fieldInfos:e}=this,r=[];return null==e||e.forEach((e=>{if(!(!e.hasOwnProperty("visible")||e.visible))return;const s=e.clone();s.label=j(s,t),r.push(s)})),r}};t([c()],st.prototype,"attributes",void 0),t([c({type:[q]})],st.prototype,"expressionInfos",void 0),t([c()],st.prototype,"description",void 0),t([c({type:[Q]})],st.prototype,"fieldInfos",void 0),t([c({readOnly:!0})],st.prototype,"formattedFieldInfos",null),t([c()],st.prototype,"title",void 0),st=t([d("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],st);const ot=st,it=o.getLogger("esri.widgets.Feature.support.relatedFeatureUtils"),nt=new Map;function at(t){if(!b(t))return null;const[e,r]=t.split("/").slice(1);return{layerId:e,fieldName:r}}function lt(t,e){const r=function(t,e){if(!e.relationships)return null;let r=null;const{relationships:s}=e;return s.some((e=>e.id===parseInt(t,10)&&(r=e,!0))),r}(t,e);if(!r)return;const s=`${e.url}/${r.relatedTableId}`;return{url:s,queryTask:new Z({url:s,sourceSpatialReference:e.spatialReference}),relation:r,relatedFields:[],outStatistics:[]}}async function pt(t,e,r,s){const o=r.layerId.toString(),{layerInfo:i,queryTask:a,relation:l,relatedFields:p,outStatistics:u}=e,c=function({originRelationship:t,relationships:e,layerId:r}){let s;return e&&e.some((e=>(`${e.relatedTableId}`===r&&e.id===t.id&&(s=e),!!s))),s}({originRelationship:l,relationships:i.relationships,layerId:o});if(c.relationshipTableId&&c.keyFieldInRelationshipTable){const e=await function(t,e,r,s){const o=new W;return o.outFields=["*"],o.relationshipId="number"==typeof e.id?e.id:parseInt(e.id,10),o.objectIds=[t.attributes[r.objectIdField]],r.queryRelatedFeatures(o,s)}(t,c,r,s),o=e[t.attributes[r.objectIdField]];if(!o)return null;const l=o.features.map((t=>t.attributes[i.objectIdField]));if((null==u?void 0:u.length)>0&&i.supportsStatistics){const t=new H;t.where=function(t,e,r){let s=0;const o=[];for(;s<e.length;)o.push(`${t} IN (${e.slice(s,r+s)})`),s+=r;return o.join(" OR ")}(i.objectIdField,l,1e3),t.outFields=p,t.outStatistics=u;const e={features:Promise.resolve(o),statsFeatures:a.execute(t)};return n(e)}}const m=null==c?void 0:c.keyField;if(m){const r=G(function(t,e){if(null!=t){e=e.toLowerCase();for(const r of t)if(r&&r.name.toLowerCase()===e)return r}return null}(i.fields,m)),o=function(t,e){const r=e.toLowerCase();for(const e in t)if(e.toLowerCase()===r)return t[e];return null}(t.attributes,l.keyField),p=r?`${m}=${o}`:`${m}='${o}'`,u=a.execute(new H({where:p,outFields:e.relatedFields}),s),c=e.outStatistics&&e.outStatistics.length>0&&i.supportsStatistics?a.execute(new H({where:p,outFields:e.relatedFields,outStatistics:e.outStatistics}),s):null,d={features:u};return c&&(d.statsFeatures=c),n(d)}return null}function ut({relatedInfos:t,layer:e},r){const s={};return t.forEach(((t,o)=>{const{relation:i}=t;if(!i){const t=new J("relation-required","A relation is required on a layer to retrieve related records.");throw it.error(t),t}const{relatedTableId:n}=i;if("number"!=typeof n){const t=new J("A related table ID is required on a layer to retrieve related records.");throw it.error(t),t}const a=`${e.url}/${n}`,l=nt.get(a),p=l||function(t,e){return z(t,{query:{f:"json"},signal:e&&e.signal})}(a,r);l||nt.set(a,p),s[o]=p})),n(s)}let ct=class extends r{constructor(t){super(t),this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(t){this._setContentElementMedia(t)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(t){const{formattedMediaInfoCount:e}=this,r=(t+e)%e;this.activeMediaInfoIndex=r}_pageContentElementMedia(t){const{activeMediaInfoIndex:e}=this,r=e+t;this._setContentElementMedia(r)}_formatMediaInfos(){const{attributes:t,mediaInfos:e,formattedAttributes:r,expressionAttributes:s,fieldInfoMap:o,layer:i}=this;return null==e?void 0:e.map((e=>{const n=null==e?void 0:e.clone();if(!n)return null;if(n.title=g({attributes:t,fieldInfoMap:o,globalAttributes:r,expressionAttributes:s,layer:i,text:n.title}),n.caption=g({attributes:t,fieldInfoMap:o,globalAttributes:r,expressionAttributes:s,layer:i,text:n.caption}),n.altText=g({attributes:t,fieldInfoMap:o,globalAttributes:r,expressionAttributes:s,layer:i,text:n.altText}),"image"===n.type){const{value:t}=n;return this._setImageValue({value:t,formattedAttributes:r,layer:i}),n.value.sourceURL?n:void 0}if("pie-chart"===n.type||"line-chart"===n.type||"column-chart"===n.type||"bar-chart"===n.type){const{value:e}=n;return this._setChartValue({value:e,chartType:n.type,attributes:t,formattedAttributes:r,layer:i}),n}return null})).filter(Boolean)}_setImageValue(t){const{fieldInfoMap:e}=this,{value:r,formattedAttributes:s,layer:o}=t,{linkURL:i,sourceURL:n}=r;if(n){const t=I(n,o);r.sourceURL=_({formattedAttributes:s,template:t,fieldInfoMap:e})}if(i){const t=I(i,o);r.linkURL=_({formattedAttributes:s,template:t,fieldInfoMap:e})}}_setChartValue(t){const{value:e,attributes:r,formattedAttributes:s,chartType:o,layer:i}=t,{popupTemplate:n,relatedInfos:a}=this,{fields:l,normalizeField:p}=e;e.fields=v(l,i),p&&(e.normalizeField=k(p,i));if(!l.some((t=>!!(null!=s[t]||b(t)&&a.size))))return;const u=null==n?void 0:n.fieldInfos;l.forEach((t=>{if(b(t))return void(e.series=[...e.series,...this._getRelatedChartInfos({fieldInfos:u,fieldName:t,formattedAttributes:s,chartType:o,value:e})]);const i=this._getChartOption({value:e,attributes:r,chartType:o,formattedAttributes:s,fieldName:t,fieldInfos:u});e.series.push(i)}))}_getRelatedChartInfos(t){var e;const{fieldInfos:r,fieldName:s,formattedAttributes:o,chartType:i,value:n}=t,a=[],l=at(s),{layerId:p,fieldName:u}=l,c=null==(e=this.relatedInfos)?void 0:e.get(p.toString());if(!c)return a;const{relatedFeatures:m,relation:d}=c;if(!d||!m)return a;const{cardinality:h}=d;m.forEach((t=>{const{attributes:e}=t;e&&Object.keys(e).forEach((t=>{t===u&&a.push(this._getChartOption({value:n,attributes:e,formattedAttributes:o,fieldName:s,chartType:i,relatedFieldName:t,fieldInfos:r}))}))}));return"one-to-many"===h||"many-to-many"===h?a:[a[0]]}_getTooltip({label:t,value:e,chartType:r}){return"pie-chart"===r?t:`${t}: ${e}`}_getChartOption(t){var e;const{value:r,attributes:s,formattedAttributes:o,fieldName:i,relatedFieldName:n,fieldInfos:a,chartType:l}=t,{layer:p}=this,{normalizeField:u,tooltipField:c}=r,m=u?b(u)?s[at(u).fieldName]:s[u]:null,d=n&&void 0!==s[n]?s[n]:void 0!==s[i]?s[i]:o[i],h=void 0===d?null:d&&m?d/m:d,f=new B({value:h});if(b(i)){const t=at(i),e=at(c),r=e?e.fieldName:null,o=x(h,{fieldInfos:a,fieldName:n,layer:p,preventPlacesFormatting:!!m}),u=t?t.label||t.fieldName:n,d=r&&void 0!==s[r]?s[r]:u;return f.tooltip=this._getTooltip({label:d,value:o,chartType:l}),f}const y=M(a,i),g=k(i,p),I=c&&void 0!==o[c]?o[c]:j(y||new Q({fieldName:g}),null==(e=this.popupTemplate)?void 0:e.expressionInfos),_=o[g];return f.tooltip=this._getTooltip({label:I,value:_,chartType:l}),f}};t([c()],ct.prototype,"activeMediaInfoIndex",void 0),t([c({readOnly:!0})],ct.prototype,"activeMediaInfo",null),t([c()],ct.prototype,"attributes",void 0),t([c()],ct.prototype,"description",void 0),t([c()],ct.prototype,"fieldInfoMap",void 0),t([c()],ct.prototype,"formattedAttributes",void 0),t([c()],ct.prototype,"expressionAttributes",void 0),t([c({readOnly:!0})],ct.prototype,"formattedMediaInfos",null),t([c()],ct.prototype,"layer",void 0),t([c({readOnly:!0})],ct.prototype,"formattedMediaInfoCount",null),t([c()],ct.prototype,"mediaInfos",void 0),t([c()],ct.prototype,"popupTemplate",void 0),t([c()],ct.prototype,"relatedInfos",void 0),t([c()],ct.prototype,"title",void 0),ct=t([d("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],ct);const mt=ct,dt=["$datastore","$map","$layer","$aggregatedfeatures"],ht=o.getLogger("esri.widgets.Feature.support.arcadeFeatureUtils");function ft(t){return"string"==typeof t?w(F(t)):Array.isArray(t)?function(t){return`<ul class="esri-widget__list">${t.map((t=>`<li>${"string"==typeof t?w(F(t)):t}</li>`)).join("")}</ul>`}(t):"esri.arcade.Dictionary"===(null==t?void 0:t.declaredClass)?function(t){const e=t.keys().map((e=>{const r=t.field(e);return`<tr><th>${e}</th><td>${"string"==typeof r?w(F(r)):r}</td></tr>`})).join("");return`<table class="esri-widget__table">${e}</table>`}(t):t}function yt(){return import("../../chunks/arcadeUtils.js").then((t=>t.R))}async function jt({graphic:t,view:e}){const{isAggregate:r,layer:s}=t;if(!r||!s||"2d"!==(null==e?void 0:e.type))return[];const o=await e.whenLayerView(s);if(!o.createQuery||!o.queryFeatures)return[];const i=o.createQuery();i.aggregateIds=[t.getObjectId()];const{features:n}=await o.queryFeatures(i);return n}async function bt({expressionInfo:t,arcadeUtils:e,interceptor:r,spatialReference:s,map:o,graphic:i,view:n}){if(!t||!t.expression)return null;const l=e.createSyntaxTree(t.expression),p=dt.filter((t=>e.hasVariable(l,t))),[u]=await a([jt({graphic:i,view:n}),e.loadScriptDependencies(l,!0,p)]),c=e.getViewInfo({spatialReference:s}),m=e.createExecContext(i,c);m.interceptor=r,m.useAsync=!0,function({aggregatedFeatures:t,arcadeUtils:e,featureSetVars:r,context:s,viewInfo:o,map:i,graphic:n,interceptor:a}){r.forEach((r=>{const l=r.toLowerCase(),p={map:i,spatialReference:o.sr,interceptor:a};if("$map"===l&&(s.vars[l]=e.convertMapToFeatureSetCollection(p)),"$layer"===l&&(s.vars[l]=e.convertFeatureLayerToFeatureSet({layer:n.sourceLayer,spatialReference:o.sr,interceptor:a})),"$datastore"===l&&(s.vars[l]=e.convertServiceUrlToWorkspace({url:n.sourceLayer.url,spatialReference:o.sr,interceptor:a})),"$aggregatedfeatures"===l){const r=n.layer,{fields:i,objectIdField:p,geometryType:u,spatialReference:c,displayField:m}=r,d=new X({fields:i,objectIdField:p,geometryType:u,spatialReference:c,displayField:m,..."feature"===r.type?{templates:r.templates,typeIdField:r.typeIdField,types:r.types}:null,source:t});s.vars[l]=e.convertFeatureLayerToFeatureSet({layer:d,spatialReference:o.sr,interceptor:a})}}))}({aggregatedFeatures:u,arcadeUtils:e,featureSetVars:p,context:m,viewInfo:c,map:o,graphic:i,interceptor:r});const d=e.createFunction(l,m);return e.executeAsyncFunction(d,m).catch((e=>ht.error("arcade-execution-error",{error:e,graphic:i,expressionInfo:t})))}async function gt({expressionInfos:t,spatialReference:e,graphic:r,interceptor:s,map:o,view:i}){if(!t||!t.length)return{};const a=await yt(),l={};for(const n of t)l[`expression/${n.name}`]=bt({expressionInfo:n,arcadeUtils:a,interceptor:s,spatialReference:e,map:o,graphic:r,view:i});const p=await n(l),u={};for(const t in p)u[t]=ft(p[t].value);return u}let It=class extends(U(r)){constructor(t){super(t),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.view=null,this._cancelQuery=()=>{const{_abortController:t}=this;t&&t.abort(),this._abortController=null},this._createVM=()=>{var t,e;const r=null==(t=this.contentElement)?void 0:t.type;null==(e=this.contentElementViewModel)||e.destroy();const s="fields"===r?new ot:"media"===r?new mt:"text"===r?new rt:null;this._set("contentElementViewModel",s)},this._compile=async()=>{this._cancelQuery();const t=new AbortController;this._abortController=t,await this._compileExpression(),this._abortController===t&&(this._abortController=null)},this._compileThrottled=p(this._compile,1,this),this._compileExpression=async()=>{const{expressionInfo:t,graphic:e,interceptor:r,spatialReference:s,map:o,view:i,_abortController:n}=this;if(!(t&&e&&s&&o&&i))return void this._set("contentElement",null);const a=await yt();if(n!==this._abortController)return;const l=await bt({arcadeUtils:a,expressionInfo:t,graphic:e,interceptor:r,map:o,spatialReference:s,view:i});if(!l||"esri.arcade.Dictionary"!==l.declaredClass)return void this._set("contentElement",null);const p=await O(l,n.signal),u=null==p?void 0:p.type,c="media"===u?N.fromJSON(p):"text"===u?h.fromJSON(p):"fields"===u?D.fromJSON(p):null;this._set("contentElement",c)},this.handles.add([u(this,["expressionInfo","graphic","map","spatialReference","view"],this._compileThrottled),u(this,"contentElement",this._createVM)])}destroy(){var t;this._cancelQuery(),null==(t=this.contentElementViewModel)||t.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){var t;return(null==(t=this.view)?void 0:t.spatialReference)||null}set spatialReference(t){void 0!==t?this._override("spatialReference",t):this._clearOverride("spatialReference")}get state(){const{_abortController:t,contentElement:e,contentElementViewModel:r}=this;return t?"loading":e||r?"ready":"disabled"}get map(){var t;return(null==(t=this.view)?void 0:t.map)||null}set map(t){void 0!==t?this._override("map",t):this._clearOverride("map")}};t([c()],It.prototype,"_abortController",void 0),t([c({type:$})],It.prototype,"expressionInfo",void 0),t([c({type:e})],It.prototype,"graphic",void 0),t([c({readOnly:!0})],It.prototype,"contentElement",void 0),t([c({readOnly:!0})],It.prototype,"contentElementViewModel",void 0),t([c()],It.prototype,"interceptor",void 0),t([c()],It.prototype,"spatialReference",null),t([c({readOnly:!0})],It.prototype,"state",null),t([c()],It.prototype,"map",null),t([c()],It.prototype,"view",void 0),It=t([d("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],It);const _t=It;var vt;const kt=o.getLogger("esri.widgets.FeatureViewModel"),xt={attachmentsContent:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0};let Mt=vt=class extends r{constructor(t){super(t),this._handles=new s,this._error=null,this._featureAbortController=null,this.graphicChangedThrottled=p(this.graphicChanged,1,this),this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities={...xt},this.content=null,this.contentViewModels=[],this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.relatedInfos=new Map,this.title="",this.view=null,this._isAllowedContentType=t=>{const{abilities:e}=this;return"attachments"===t.type&&e.attachmentsContent||"custom"===t.type&&e.customContent||"fields"===t.type&&e.fieldsContent||"media"===t.type&&e.mediaContent||"text"===t.type&&e.textContent||"expression"===t.type&&e.expressionContent},this._handles.add(u(this,["graphic","_effectivePopupTemplate","abilities"],(()=>this.graphicChangedThrottled())))}destroy(){this._clear(),this._cancelFeatureQuery(),this._error=null,this._handles.destroy(),this._handles=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return i(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return T(S(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return E(this.graphic)}castAbilities(t){return{...xt,...t}}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(t){this._set("graphic",t?t.clone():null)}get spatialReference(){return this.get("view.spatialReference")||null}set spatialReference(t){void 0!==t?this._override("spatialReference",t):this._clearOverride("spatialReference")}get map(){return this.get("view.map")||null}set map(t){void 0!==t?this._override("map",t):this._clearOverride("map")}get waitingForContent(){return!!this._featureAbortController}setActiveMedia(t,e){const r=this.contentViewModels[t];r instanceof mt&&r.setActiveMedia(e)}nextMedia(t){const e=this.contentViewModels[t];e instanceof mt&&e.next()}previousMedia(t){const e=this.contentViewModels[t];e instanceof mt&&e.previous()}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async graphicChanged(){this._cancelFeatureQuery(),this._error=null,this._clear();const{graphic:t}=this;if(!t)return;const e=new AbortController;this._featureAbortController=e;try{await this._queryFeature({signal:e.signal})}catch(e){l(e)||(this._error=e,kt.error("error","The popupTemplate could not be displayed for this feature.",{error:e,graphic:t,popupTemplate:this._effectivePopupTemplate}))}this._featureAbortController===e&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:t}=this;t&&t.abort(),this._featureAbortController=null}_compileContentElement(t,e){return"attachments"===t.type?this._compileAttachments(t,e):"custom"===t.type?this._compileCustom(t,e):"fields"===t.type?this._compileFields(t,e):"media"===t.type?this._compileMedia(t,e):"text"===t.type?this._compileText(t,e):"expression"===t.type?this._compileExpression(t,e):void 0}_compileContent(t){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(t)?t.filter(this._isAllowedContentType).map(((t,e)=>this._compileContentElement(t,e))):"string"==typeof t?this._compileText(new h({text:t}),0).text:t}_destroyContentViewModels(){var t;null==(t=this._handles)||t.remove("content-view-models"),this.contentViewModels.forEach((t=>t&&!t.destroyed&&t.destroy())),this._set("contentViewModels",[])}_setExpressionContentVM(t,e){const{formattedAttributes:r}=this,{contentElement:s,contentElementViewModel:o}=t,i=null==s?void 0:s.type;o&&i&&("fields"===i&&(this._createFieldsFormattedAttributes({contentElement:s,contentElementIndex:e,formattedAttributes:r}),o.set(this._createFieldsVMParams(s,e))),"media"===i&&(this._createMediaFormattedAttributes({contentElement:s,contentElementIndex:e,formattedAttributes:r}),o.set(this._createMediaVMParams(s,e))),"text"===i&&o.set(this._createTextVMParams(s)))}_compileExpression(t,e){const{expressionInfo:r}=t,{graphic:s,map:o,spatialReference:i,view:n}=this,a=new _t({expressionInfo:r,graphic:s,interceptor:vt.interceptor,map:o,spatialReference:i,view:n});return this.contentViewModels[e]=a,this._handles.add(u(a,"contentElementViewModel",(()=>this._setExpressionContentVM(a,e))),"content-view-models"),t}_compileAttachments(t,e){const{graphic:r}=this,{description:s,title:o}=t;return this.contentViewModels[e]=new tt({graphic:r,...this._compileTitleAndDesc({title:o,description:s})}),t}_compileCustom(t,e){const{graphic:r}=this,{creator:s,destroyer:o}=t;return this.contentViewModels[e]=new rt({graphic:r,creator:s,destroyer:o}),t}_compileTitleAndDesc({title:t,description:e}){const{_fieldInfoMap:r,_sourceLayer:s,graphic:o,formattedAttributes:i,_expressionAttributes:n}=this,{attributes:a}=o,l=i.global;return{title:g({attributes:a,fieldInfoMap:r,globalAttributes:l,expressionAttributes:n,layer:s,text:t}),description:g({attributes:a,fieldInfoMap:r,globalAttributes:l,expressionAttributes:n,layer:s,text:e})}}_createFieldsVMParams(t,e){const{_effectivePopupTemplate:r,formattedAttributes:s}=this,o={...s.global,...s.content[e]},i=(null==t?void 0:t.fieldInfos)||(null==r?void 0:r.fieldInfos),n=null==i?void 0:i.filter((({fieldName:t})=>R(t)||b(t)||o.hasOwnProperty(t))),a=null==r?void 0:r.expressionInfos,{description:l,title:p}=t;return{attributes:o,expressionInfos:a,fieldInfos:n,...this._compileTitleAndDesc({title:p,description:l})}}_compileFields(t,e){const r=t.clone(),s=new ot(this._createFieldsVMParams(t,e));return this.contentViewModels[e]=s,r.fieldInfos=s.formattedFieldInfos.slice(0),r}_createMediaVMParams(t,e){const{graphic:r,_fieldInfoMap:s,formattedAttributes:o,_effectivePopupTemplate:i,relatedInfos:n,_sourceLayer:a,_expressionAttributes:l}=this,{attributes:p}=r,{description:u,mediaInfos:c,title:m}=t;return{activeMediaInfoIndex:t.activeMediaInfoIndex||0,attributes:p,layer:a,fieldInfoMap:s,formattedAttributes:{...o.global,...o.content[e]},expressionAttributes:l,mediaInfos:c,popupTemplate:i,relatedInfos:n,...this._compileTitleAndDesc({title:m,description:u})}}_compileMedia(t,e){const r=t.clone(),s=new mt(this._createMediaVMParams(t,e));return r.mediaInfos=s.formattedMediaInfos.slice(0),this.contentViewModels[e]=s,r}_createTextVMParams(t){const{graphic:e,_fieldInfoMap:r,_sourceLayer:s,_expressionAttributes:o}=this;if(t&&t.text){const{attributes:i}=e,n=this.formattedAttributes.global;t.text=g({attributes:i,fieldInfoMap:r,globalAttributes:n,expressionAttributes:o,layer:s,text:t.text})}return{graphic:e,creator:t.text}}_compileText(t,e){const r=t.clone();return this.contentViewModels[e]=new rt(this._createTextVMParams(r)),r}_compileLastEditInfo(){const{_effectivePopupTemplate:t,_sourceLayer:e,graphic:r}=this;if(!t)return;const{lastEditInfoEnabled:s}=t,o=null==e?void 0:e.editFieldsInfo;return s&&o?V(o,r.attributes):void 0}_compileTitle(t){const{_fieldInfoMap:e,_sourceLayer:r,graphic:s,_expressionAttributes:o}=this,{attributes:i}=s,n=this.formattedAttributes.global;return g({attributes:i,fieldInfoMap:e,globalAttributes:n,expressionAttributes:o,layer:r,text:t})}async _getTitle(){const{_effectivePopupTemplate:t,graphic:e}=this,r=null==t?void 0:t.title;return y(r,{graphic:e})}async _getContent(){const{_effectivePopupTemplate:t,graphic:e}=this,r=null==t?void 0:t.content;return y(r,{graphic:e})}async _queryFeature(t){const{_featureAbortController:e,_sourceLayer:r,graphic:s,_effectivePopupTemplate:o,spatialReference:i,map:a,view:l}=this,{content:{value:p},title:{value:u}}=await n({content:this._getContent(),title:this._getTitle()});if(e!==this._featureAbortController||!s)return;await L({graphic:s,popupTemplate:o,layer:r,spatialReference:i},t);const{expressionAttributes:{value:c}}=await n({checkForRelatedFeatures:this._checkForRelatedFeatures(t),expressionAttributes:gt({expressionInfos:null==o?void 0:o.expressionInfos,spatialReference:i,graphic:s,map:a,interceptor:vt.interceptor,view:l})});e===this._featureAbortController&&s&&(this._expressionAttributes=c,this._graphicExpressionAttributes={...s.attributes,...c},this._set("formattedAttributes",this._createFormattedAttributes(p)),this._set("title",this._compileTitle(u)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(p)||null))}_createMediaFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:r}){const{_effectivePopupTemplate:s,graphic:o,relatedInfos:i,_sourceLayer:n,_fieldInfoMap:a,_graphicExpressionAttributes:l}=this;r.content[e]=P({fieldInfos:null==s?void 0:s.fieldInfos,graphic:o,attributes:{...l,...t.attributes},layer:n,fieldInfoMap:a,relatedInfos:i})}_createFieldsFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:r}){if(t.fieldInfos){const{graphic:s,relatedInfos:o,_sourceLayer:i,_fieldInfoMap:n,_graphicExpressionAttributes:a}=this;r.content[e]=P({fieldInfos:t.fieldInfos,graphic:s,attributes:{...a,...t.attributes},layer:i,fieldInfoMap:n,relatedInfos:o})}}_createFormattedAttributes(t){const{_effectivePopupTemplate:e,graphic:r,relatedInfos:s,_sourceLayer:o,_fieldInfoMap:i,_graphicExpressionAttributes:n}=this,a=null==e?void 0:e.fieldInfos,l={global:P({fieldInfos:a,graphic:r,attributes:n,layer:o,fieldInfoMap:i,relatedInfos:s}),content:[]};return Array.isArray(t)&&t.forEach(((t,e)=>{"fields"===t.type&&this._createFieldsFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:l}),"media"===t.type&&this._createMediaFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:l})})),l}_checkForRelatedFeatures(t){const{graphic:e,_effectivePopupTemplate:r}=this;return this._queryRelatedInfos(e,S(r),t)}async _queryRelatedInfos(t,e,r){const{relatedInfos:s,_sourceLayer:o}=this;s.clear();const a=i(o.associatedLayer)?await o.associatedLayer.load(r):o;if(!a)return;const l=e.filter((t=>t&&b(t.fieldName)));if(!l||!l.length)return;e.forEach((t=>this._configureRelatedInfo(t,a)));const p=await ut({relatedInfos:s,layer:a},r);Object.keys(p).forEach((t=>{var e;const r=s.get(t.toString()),o=null==(e=p[t])?void 0:e.value;r&&o&&(r.layerInfo=o.data)}));const u=await function({graphic:t,relatedInfos:e,layer:r},s){const o={};return e.forEach(((e,i)=>{e.layerInfo&&(o[i]=pt(t,e,r,s))})),n(o)}({graphic:t,relatedInfos:s,layer:a},r);Object.keys(u).forEach((t=>{var e;!function(t,e){if(!e)return;if(!t)return;const{features:r,statsFeatures:s}=t,o=r&&r.value;e.relatedFeatures=o?o.features:[];const i=s&&s.value;e.relatedStatsFeatures=i?i.features:[]}(null==(e=u[t])?void 0:e.value,s.get(t.toString()))}))}_configureRelatedInfo(t,e){const{relatedInfos:r}=this,s=at(t.fieldName);if(!s)return;const{layerId:o,fieldName:i}=s;if(!o)return;const n=r.get(o.toString())||lt(o,e);n&&(!function({relatedInfo:t,fieldName:e,fieldInfo:r}){if(t.relatedFields.push(e),r.statisticType){const s=new K({statisticType:r.statisticType,onStatisticField:e,outStatisticFieldName:e});t.outStatistics.push(s)}}({relatedInfo:n,fieldName:i,fieldInfo:t}),this.relatedInfos.set(o,n))}};Mt.interceptor=new class{constructor(t,e){this.preLayerQueryCallback=t,this.preRequestCallback=e,this.preLayerQueryCallback||(this.preLayerQueryCallback=t=>{}),this.preRequestCallback||(this.preLayerQueryCallback=t=>{})}}(C,A),t([c()],Mt.prototype,"_error",void 0),t([c()],Mt.prototype,"_featureAbortController",void 0),t([c({readOnly:!0})],Mt.prototype,"_effectivePopupTemplate",null),t([c({readOnly:!0})],Mt.prototype,"_fieldInfoMap",null),t([c({readOnly:!0})],Mt.prototype,"_sourceLayer",null),t([c()],Mt.prototype,"abilities",void 0),t([m("abilities")],Mt.prototype,"castAbilities",null),t([c({readOnly:!0})],Mt.prototype,"content",void 0),t([c({readOnly:!0})],Mt.prototype,"contentViewModels",void 0),t([c({type:Boolean})],Mt.prototype,"defaultPopupTemplateEnabled",void 0),t([c({readOnly:!0})],Mt.prototype,"state",null),t([c({readOnly:!0})],Mt.prototype,"formattedAttributes",void 0),t([c({type:e,value:null})],Mt.prototype,"graphic",null),t([c({readOnly:!0})],Mt.prototype,"lastEditInfo",void 0),t([c({readOnly:!0})],Mt.prototype,"relatedInfos",void 0),t([c()],Mt.prototype,"spatialReference",null),t([c({readOnly:!0})],Mt.prototype,"title",void 0),t([c()],Mt.prototype,"map",null),t([c({readOnly:!0})],Mt.prototype,"waitingForContent",null),t([c()],Mt.prototype,"view",void 0),Mt=vt=t([d("esri.widgets.FeatureViewModel")],Mt);const wt=Mt;export{tt as F,rt as a,ot as b,mt as c,_t as d,wt as default};
