/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Color.js";import i from"../../core/Accessor.js";import{z as s,i as o,k as r,o as n,b as a,m as l,C as d}from"../../core/lang.js";import c from"../../core/Handles.js";import{createTask as u,after as h,throwIfAborted as p}from"../../core/promiseUtils.js";import{r as m,s as _}from"../../chunks/reactiveUtils.js";import{c as w,b as v,f as y}from"../../chunks/screenUtils.js";import{c as f,d as g}from"../../chunks/timeUtils.js";import{property as T}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import{subclass as P}from"../../core/accessorSupport/decorators/subclass.js";import{b}from"../../chunks/mathUtils.js";import{l as j}from"../../chunks/earthUtils.js";import{b as k}from"../../chunks/sunUtils.js";import O from"../../core/Collection.js";import{r as D}from"../../chunks/collectionUtils.js";import{m as V}from"../../chunks/handleUtils.js";import{t as S}from"../../chunks/throttle.js";import{b as U}from"../../chunks/traversalUtils.js";import"../../chunks/colorUtils.js";import"../../chunks/common.js";import"../../chunks/Logger.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/deprecate.js";import"../../chunks/metadata.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../core/Error.js";import"../../chunks/Evented.js";import"../../chunks/shared.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../geometry/Geometry.js";import"../../chunks/JSONSupport.js";import"../../geometry/SpatialReference.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../chunks/projectionEllipsoid.js";import"../../chunks/mat4.js";import"../../chunks/mat4f64.js";let C=class extends i{constructor(){super({}),this.color=new t([50,50,50,.7]),this.intervalOptions=new O([f(15,"minutes","milliseconds"),f(30,"minutes","milliseconds"),f(1,"hours","milliseconds"),f(2,"hours","milliseconds"),f(3,"hours","milliseconds")]),this.interval=this.intervalOptions.getItemAt(0)}set intervalOptions(e){this._set("intervalOptions",D(e,this._get("intervalOptions")))}};e([T({type:t})],C.prototype,"color",void 0),e([T()],C.prototype,"interval",void 0),e([T({type:O})],C.prototype,"intervalOptions",null),C=e([P("esri.widgets.ShadowCast.DiscreteOptions")],C);const z=C;let A=class extends i{constructor(){super(...arguments),this.color=new t([0,0,255,.7]),this.mode="continuous"}};e([T({type:t})],A.prototype,"color",void 0),e([T()],A.prototype,"mode",void 0),A=e([P("esri.widgets.ShadowCast.DurationOptions")],A);const E=A;var x;!function(e){e.PointerMove="pointer-move",e.Main="main"}(x||(x={}));let M=class extends i{constructor(e){super(e),this._handles=new c,this._screenPoint=null,this._accumulatedShadowTime=null,this._shadowTimeTask=null,this._updateAccumulatedShadowTime=(e,t)=>{this._shadowTimeTask=s(this._shadowTimeTask),this._shadowTimeTask=u((async i=>{const{results:s,ground:o}=await e.hitTest(t);if(0===s.length&&!o.mapPoint)return void(this._accumulatedShadowTime=null);const r=await this.getDuration(t,i);this._accumulatedShadowTime=r}))},this._throttledUpdateAccumulatedShadowTime=S(this._updateAccumulatedShadowTime,300)}initialize(){this._handles.add(m((()=>({enabled:this.enabled,view:this.view})),(({enabled:e,view:t})=>{e&&o(t)?this._startTracking(t):this._stopTracking()}),_))}destroy(){this._handles=r(this._handles)}get screenPoint(){return this.enabled?this._screenPoint:null}get accumulatedShadowTime(){return this.enabled?this._accumulatedShadowTime:null}get testData(){return{setThrottleDelay:e=>{this._throttledUpdateAccumulatedShadowTime.remove(),this._throttledUpdateAccumulatedShadowTime=S(this._updateAccumulatedShadowTime,e)}}}_startTracking(e){const t=this._handles;if(t.has(x.Main))return;const i=()=>{t.has(x.PointerMove)||t.add(e.on("pointer-move",(t=>{const i=w(t.x,t.y);this._screenPoint=i,this._throttledUpdateAccumulatedShadowTime(e,i)})),x.PointerMove)},o=()=>{t.remove(x.PointerMove),this._screenPoint=null,this._accumulatedShadowTime=null};t.add([this._throttledUpdateAccumulatedShadowTime,e.on("pointer-enter",i),e.on("pointer-leave",o),e.on("pointer-down",o),e.on("pointer-drag",o),e.on("pointer-up",i),e.on("click",(t=>{const i=w(t.x,t.y);this._screenPoint=i,this._updateAccumulatedShadowTime(e,i)})),V((()=>{this._shadowTimeTask=s(this._shadowTimeTask)}))],x.Main),i()}_stopTracking(){this._handles.remove(x.Main)}};e([T()],M.prototype,"getDuration",void 0),e([T()],M.prototype,"view",void 0),e([T()],M.prototype,"enabled",void 0),e([T()],M.prototype,"screenPoint",null),e([T()],M.prototype,"accumulatedShadowTime",null),e([T()],M.prototype,"_screenPoint",void 0),e([T()],M.prototype,"_accumulatedShadowTime",void 0),e([T()],M.prototype,"_shadowTimeTask",void 0),M=e([P("esri.widgets.ShadowCast.ShadowTooltipViewModel")],M);let R=class extends i{constructor(){super(...arguments),this.color=new t([255,0,0,.7]),this.value=f(4,"hours","milliseconds"),this.minValue=0,this.maxValue=f(8,"hours","milliseconds")}};e([T({type:t})],R.prototype,"color",void 0),e([T()],R.prototype,"value",void 0),e([T()],R.prototype,"minValue",void 0),e([T()],R.prototype,"maxValue",void 0),R=e([P("esri.widgets.ShadowCast.ThresholdOptions")],R);const N=R,F=[],G=b(),L=[],B=f(1,"hours","milliseconds");let H=class extends i{constructor(e){super(e),this.view=null,this.tooltip=new M({getDuration:(e,t)=>this.getDuration(e,t)}),this.startTimeOfDay=f(10,"hours","milliseconds"),this.endTimeOfDay=f(16,"hours","milliseconds"),this.visualizationType="threshold",this.thresholdOptions=new N,this.durationOptions=new E,this.discreteOptions=new z,this._running=!0,this._handles=new c,this._stopPreviewingTask=null,this._forcePreview=null,this._autoRestoreForcePreviewEnabled=!0,this._utcOffset=null,this.date=new Date}initialize(){this._handles.add([m((()=>({view:this.view,tooltipEnabled:this._tooltipEnabled})),(({view:e,tooltipEnabled:t})=>{this.tooltip.view=e,this.tooltip.enabled=t}),_),m((()=>this._forcePreviewDependencies),(()=>{s(this._stopPreviewingTask),this._forcePreview=!0,this._autoRestoreForcePreviewEnabled&&(this._stopPreviewingTask=u((async e=>{await h(500,e),p(e),this._forcePreview=!1})))}),_),m((()=>({renderView:this.renderView,parameters:this._visualizationParameters})),I,_),m((()=>({renderView:this.renderView,parameters:{lightDirections:this._lightDirections}})),I,_),m((()=>({renderView:this.renderView,parameters:{enabled:this._running}})),I,_),m((()=>({renderView:this.renderView,parameters:{previewing:this._previewing}})),I,_)])}destroy(){this.stop(),this._handles=r(this._handles),r(this.tooltip)}get state(){return o(this.view)&&this.view.ready&&o(this._referencePosition)?"ready":"disabled"}set date(e){const t=new Date(e);t.setHours(0,0,0,0),this._set("date",t)}get utcOffset(){return n(this._utcOffset,this._utcOffsetAuto)}set utcOffset(e){this._utcOffset=e}get testData(){return{setAutoRestoreForcedPreviewEnabled:e=>{this._autoRestoreForcePreviewEnabled=e},setForcedPreview:e=>{this._forcePreview=e},isPreviewing:()=>this._previewing}}get _previewing(){const{view:e}=this;return!(!a(e)&&!a(e.allLayerViews))||(this._forcePreview||!e.stationary||e.allLayerViews.some((e=>J(e)&&e.updating)))}get _utcOffsetAuto(){const e=this._referencePosition;return l(e,0,(e=>j(e[0],!1)))}get _dateUTCOffset(){let e=this.date;return e=g(e,-e.getTimezoneOffset(),"minutes"),e=g(e,-this.utcOffset,"hours"),e}get _startDateTimeUTC(){return g(this._dateUTCOffset,this.startTimeOfDay)}get _endDateTimeUTC(){return g(this._dateUTCOffset,this.endTimeOfDay)}get _referencePosition(){return d(this.view,(e=>d(e.environmentManager,(e=>e.referencePositionWGS84Comparable))))}get _interval(){const e=this._duration>0?Math.floor(this._duration/255):255,t=this.discreteOptions.interval;switch(this.visualizationType){case"threshold":case"duration":return e;case"discrete":return t>0?t:e}}get _sampleCount(){return this._lightDirections.length}get _duration(){return this.endTimeOfDay-this.startTimeOfDay}get _lightDirections(){const{view:e}=this;if(a(e))return F;const t="global"===e.viewingMode?G:this._referencePosition;if(a(t))return F;const i=this._interval,s=k(this._startDateTimeUTC,this._endDateTimeUTC,i,t,e.state.viewingMode),o=s.length;L.length=0;const r=U(0,o,L),n=new Array(o);for(let e=0;e<o;++e)n[e]=s[r[e]];return n}get _tooltipEnabled(){return"ready"===this.state&&"discrete"!==this.visualizationType&&this._running&&!this._previewing}get _visualizationParameters(){if(!this._running)return null;switch(this.visualizationType){case"threshold":return this._thresholdVisualizationParameters;case"duration":return this._durationVisualizationParameters;case"discrete":return this._discreteVisualizationParameters}}get _thresholdVisualizationParameters(){const{value:e,color:i}=this.thresholdOptions,s=this._duration;return{visualization:1,color:t.toUnitRGBA(i),threshold:s>0?e/this._duration:0}}get _durationVisualizationParameters(){const{color:e,mode:i}=this.durationOptions,s=this._duration,o=s>0&&"hourly"===i?B/s:0;return{color:t.toUnitRGBA(e),visualization:0,bandsEnabled:o>0,bandSize:o}}get _discreteVisualizationParameters(){return{color:t.toUnitRGBA(this.discreteOptions.color),visualization:0,bandsEnabled:!1,bandSize:0}}get _forcePreviewDependencies(){const{view:e}=this;if(a(e))return null;const t=e.slicePlane,i=e.allLayerViews.toArray().filter(J),s=i.map((e=>e.layer)).filter(o),r=i.map((e=>e.visible)),n=s.map((e=>e.visible)),l=s.map((e=>e.opacity)),d=s.filter((function(e){return"definitionExpression"in e})).map((e=>e.definitionExpression)),c=i.filter((function(e){return"filter"in e})).map((e=>e.filter));return{slicePlane:t,startDateUTC:this._startDateTimeUTC,endDateUTC:this._endDateTimeUTC,layerViewVisibilities:r,layerVisibilities:n,layerOpacities:l,filters:c,definitionExpressions:d}}get renderView(){const{view:e}=this;if(a(e))return null;const t=e._stage;return a(t)?null:t.renderView}start(){this._running=!0}stop(){this._running=!1}setRunning(e){this._running=e}async getDuration(e,t){const{view:i,renderView:s}=this;if(a(i)||a(s))return 0;const o=i.state.camera.screenToRender(v(e.x,e.y),y()),r=s.readAccumulatedShadow(o),n=this._sampleCount;if(0===n)return 0;return r*n*(this._duration/n)}};function I({renderView:e,parameters:t}){o(e)&&o(t)&&e.setRenderParameters({shadowCastOptions:t})}function J(e){if(e.suspended)return!1;switch(e.type){case"analysis-3d":case"building-scene-3d":case"csv-3d":case"elevation-3d":case"feature-3d":case"geojson-3d":case"graphics-3d":case"integrated-mesh-3d":case"ogc-feature-3d":case"scene-layer-3d":case"scene-layer-graphics-3d":case"stream-3d":case"wms-3d":return!0;case"base-dynamic-3d":case"imagery-3d":case"imagery-tile-3d":case"map-image-3d":case"point-cloud-3d":case"tile-3d":case"vector-tile-3d":case"voxel-3d":case"wfs-3d":case"wmts-3d":case"voxel-3d":default:return!1;case"group":return e.layerViews.toArray().some((e=>J(e)))}}e([T()],H.prototype,"state",null),e([T()],H.prototype,"view",void 0),e([T()],H.prototype,"tooltip",void 0),e([T({nonNullable:!0})],H.prototype,"date",null),e([T({nonNullable:!0})],H.prototype,"utcOffset",null),e([T({nonNullable:!0})],H.prototype,"startTimeOfDay",void 0),e([T({nonNullable:!0})],H.prototype,"endTimeOfDay",void 0),e([T({nonNullable:!0})],H.prototype,"visualizationType",void 0),e([T({type:N,nonNullable:!0})],H.prototype,"thresholdOptions",void 0),e([T({type:E,nonNullable:!0})],H.prototype,"durationOptions",void 0),e([T({type:z,nonNullable:!0})],H.prototype,"discreteOptions",void 0),e([T()],H.prototype,"_running",void 0),e([T()],H.prototype,"_handles",void 0),e([T()],H.prototype,"_stopPreviewingTask",void 0),e([T()],H.prototype,"_forcePreview",void 0),e([T()],H.prototype,"_autoRestoreForcePreviewEnabled",void 0),e([T()],H.prototype,"_previewing",null),e([T()],H.prototype,"_utcOffset",void 0),e([T()],H.prototype,"_utcOffsetAuto",null),e([T()],H.prototype,"_dateUTCOffset",null),e([T()],H.prototype,"_startDateTimeUTC",null),e([T()],H.prototype,"_endDateTimeUTC",null),e([T()],H.prototype,"_referencePosition",null),e([T()],H.prototype,"_interval",null),e([T()],H.prototype,"_sampleCount",null),e([T()],H.prototype,"_duration",null),e([T()],H.prototype,"_lightDirections",null),e([T()],H.prototype,"_tooltipEnabled",null),e([T()],H.prototype,"_visualizationParameters",null),e([T()],H.prototype,"_thresholdVisualizationParameters",null),e([T()],H.prototype,"_durationVisualizationParameters",null),e([T()],H.prototype,"_discreteVisualizationParameters",null),e([T()],H.prototype,"_forcePreviewDependencies",null),e([T()],H.prototype,"renderView",null),H=e([P("esri.widgets.ShadowCast.ShadowCastViewModel")],H);const W=H;export{W as default};
