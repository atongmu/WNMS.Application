/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../intl.js";import{p as t,e as s}from"../../core/promiseUtils.js";import{L as i}from"../../chunks/Logger.js";import{b as a}from"../../core/lang.js";import{r,b as o}from"../../chunks/reactiveUtils.js";import{aliasOf as n}from"../../core/accessorSupport/decorators/aliasOf.js";import"../../chunks/ensureType.js";import{property as l}from"../../core/accessorSupport/decorators/property.js";import{subclass as d}from"../../core/accessorSupport/decorators/subclass.js";import{l as c}from"../../chunks/moment.js";import h from"../Widget.js";import u from"../../core/Error.js";import{g as p,a as _}from"../../chunks/number.js";import m from"./DatePickerViewModel.js";import{P as v}from"../../chunks/Popover.js";import{a as k}from"../../chunks/accessibleHandler.js";import{m as y}from"../../chunks/messageBundle.js";import{t as g}from"../../chunks/jsxFactory.js";import{s as w,h as f,i as D}from"../../chunks/widgetUtils.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/locale.js";import"../../chunks/messages.js";import"../../request.js";import"../../config.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/assets.js";import"../../chunks/jsonMap.js";import"../../core/Accessor.js";import"../../chunks/deprecate.js";import"../../chunks/metadata.js";import"../../chunks/handleUtils.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/domUtils.js";import"../../chunks/Evented.js";import"../../core/Handles.js";import"../../core/Collection.js";import"../../chunks/shared.js";import"../../chunks/Promise.js";import"../../chunks/uuid.js";import"../../core/watchUtils.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/projector.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/MomentElementViewModel.js";function b(e){const t=[/٠/g,/١/g,/٢/g,/٣/g,/٤/g,/٥/g,/٦/g,/٧/g,/٨/g,/٩/g];for(let s=0;s<10;s++)e=e.replace(t[s],s.toString());return Number(e)}function j(e){return new u(`could not parse date input, expecting the following format: ${_(Date.now(),e)}`)}const M="esri-date-picker",P="esri-date-picker__calendar",O="esri-date-picker__month-picker",C="esri-date-picker__day-picker",x="esri-date-picker__week-item",N="esri-date-picker__day-item--nearby-month",I="esri-date-picker__day-item--active",S="esri-date-picker__day-item--today",T="esri-date-picker__day-item--selected",K="esri-date-picker__day-item",Y="esri-date-picker__day-item--header",A="esri-date-picker__year-picker",B="esri-date-picker__year-picker-item--selected",E="esri-date-picker__year-picker-item",U="esri-date-picker__month-dropdown",H="esri-date-picker__date",L="esri-date-picker__calendar-toggle",$="esri-date-picker__input",F="esri-date-picker__text-input",q="esri-date-picker__icon--leading",W="esri-icon-left",V="esri-icon-right",R="esri-icon-calendar",z="esri-widget",G="esri-widget--button",J="esri-input",Q="esri-select",X={year:"numeric",month:"2-digit",day:"2-digit"},Z=[" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"],ee=i.getLogger("esri.widgets.support.DatePicker");let te=class extends h{constructor(e,t){super(e,t),this._activeDate=null,this._calendarNode=null,this._calendarPopover=new v({owner:this,placement:"bottom-start",anchorElement:()=>this._rootNode,renderContentFunction:this._renderCalendar}),this._inputOrButtonNode=null,this._isOpen=!1,this._requestDayPickerFocusOnCreate=!1,this._rootNode=null,this.dateInputEnabled=!1,this.label=void 0,this.messages=null,this.value=null,this.commitOnMonthChange=!1,this.viewModel=new m,this._toggle=this._toggle.bind(this)}initialize(){this.own(r((()=>{var e;return{viewModel:this.viewModel,value:null==(e=this.viewModel)?void 0:e.value}}),(({viewModel:e,value:t})=>{this.destroyed||!e||a(this.onChange)||this.onChange(t)}),o))}async loadLocale(){this._moment=await c(),this._isOpen&&(this._activeDate=this._moment(this._activeDate.toDate()))}destroy(){this._calendarPopover.destroy()}render(){return g("div",{afterCreate:w,bind:this,class:this.classes(M,z),"data-node-ref":"_rootNode"},this.dateInputEnabled?this.renderInputAndButtonMode():this.renderButtonOnlyMode())}renderButtonOnlyMode(){const e=_(this.viewModel.value,X),{_isOpen:t,messages:s}=this;return g("div",{afterCreate:w,"aria-controls":t?this._getCalendarId():null,"aria-expanded":t.toString(),"aria-haspopup":"true","aria-label":s.setDate,"aria-pressed":t.toString(),bind:this,class:this.classes(G,Q,L),"data-node-ref":"_inputOrButtonNode",onclick:this._toggle,onkeydown:this._handleDateButtonKeyDown,role:"button",tabIndex:0},g("span",{class:H},e))}renderInputAndButtonMode(){const e=_(this.viewModel.value,X),{_isOpen:t,messages:s}=this;return g("div",{class:this.classes($)},g("input",{afterCreate:w,"data-node-ref":"_inputOrButtonNode","aria-controls":t?this._getCalendarId():null,"aria-haspopup":"true","aria-label":s.setDate,bind:this,class:this.classes(F,J),key:"date-input",onblur:this._handleDateInputBlur,onclick:this._handleDateInputClick,onkeydown:this._handleDateInputKeyDown,type:"text",value:e}),g("span",{"aria-hidden":"true",class:this.classes(q,R)}))}_handleDateInputClick(){this._open(this.viewModel.value,!1)}_handleDateInputKeyDown(e){const{key:t}=e;this._isOpen?"Enter"===t?this._handleDateText(e):"Escape"===t&&this._close():"ArrowDown"===t&&(this._open(this.viewModel.value),e.preventDefault())}_handleDateButtonKeyDown(e){const{key:t,shiftKey:s}=e;this._isOpen&&"Tab"===t&&s?this._close():f(t)&&this._toggle()}_handleDateInputBlur(e){this._isOpen||this._handleDateText(e)}_handleDateText(e){const t=e.currentTarget;let s;try{s=function(e,t){const s=p(t),i=Date.now(),a=s.formatToParts(i),r=new Set;a.filter((({type:e})=>"literal"===e)).forEach((({value:e})=>r.add(e)));let o=0;const n={};for(;a.length>0;){const{type:t,value:s}=a.shift();for(let i=0;i<s.length;i++,o++){const s=e.charAt(o);if(r.has(s)){o++;break}if("literal"===t)break;n[t]||(n[t]=[]),n[t].push(s)}}const l={};try{l.day=b(n.day.join("")),l.month=b(n.month.join(""))-1,l.year=b((n.year||n.relatedYear).join(""))}catch(e){throw j(t)}if(isNaN(l.day)||isNaN(l.month)||isNaN(l.year))throw j(t);return l}(t.value,X)}catch(e){return ee.warn(e),void(t.value=_(this.viewModel.value,X))}const i=this._moment(s);i.isValid()?(this.viewModel.value=i.toDate(),this._activeDate=i):t.value=_(this.viewModel.value,X)}_handleDatePickerKeydown(e){"Escape"===s(e)&&(this._close(),e.preventDefault(),e.stopPropagation())}_renderCalendar(){const e=this._activeDate,t=this._moment(this.viewModel.value);return g("div",{afterCreate:w,bind:this,class:this.classes(P,z),"data-node-ref":"_calendarNode",id:this._getCalendarId(),key:"esri-date-picker__calendar",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))}_getCalendarId(){return`date-picker__calendar--${this.id}`}_renderMonthPicker(e){const t=D(this.container),s=t?V:W,i=t?W:V,a=this._moment.months().map(((t,s)=>{const i=e.month()===s;return g("option",{selected:i},t)})),{messages:r}=this;return g("div",{class:O},g("div",{"aria-label":r.goToPreviousMonth,bind:this,class:G,onclick:this._setPreviousMonth,onkeydown:this._handlePreviousMonthKeyDown,role:"button",tabIndex:0,title:r.goToPreviousMonth},g("span",{"aria-hidden":"true",class:s})),g("select",{"aria-live":"assertive","aria-label":r.selectMonth,bind:this,class:this.classes(U,Q),id:`${this.id}__month-picker`,onchange:this._setMonth,onkeydown:this._setMonth,title:r.selectMonth},a),g("div",{"aria-label":r.goToNextMonth,bind:this,class:G,onclick:this._setNextMonth,onkeydown:this._setNextMonth,role:"button",tabIndex:0,title:r.goToNextMonth},g("span",{"aria-hidden":"true",class:i})))}_renderDayPicker(e,t){const s=e.clone().day(this._moment.localeData().firstDayOfWeek()),i=this._getWeekLabels(s),a=this._getDayId(e),r=this._renderMonth(e,t);return g("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":a,"aria-labelledby":`${this.id}__month-picker ${this.id}__selected-year`,bind:this,class:C,id:`${this.id}__day-picker`,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:0},g("div",{class:x,role:"row"},i.map((e=>g("div",{"aria-label":e.name,class:this.classes(K,Y),role:"columnheader",title:e.name},e.abbr)))),r)}_getDayId(e){return`${this.id}__${_(e.valueOf(),X)}`}_handleDayPickerCreate(e){this._requestDayPickerFocusOnCreate&&(this._requestDayPickerFocusOnCreate=!1,e.focus())}_getWeekLabels(e){const t=[],s={weekday:"long"},i={weekday:"narrow"};for(let a=0;a<7;a++)t.push({name:_(e.valueOf(),s),abbr:_(e.valueOf(),i)}),e.add(1,"day");return t}_handleDayPickerKeydown(e){const{ctrlKey:t,shiftKey:i}=e,a=s(e),r=this._activeDate;if(-1!==Z.indexOf(a)){if("ArrowLeft"===a)r.subtract(1,"day");else if("ArrowRight"===a)r.add(1,"day");else if("ArrowUp"===a)r.subtract(1,"week");else if("ArrowDown"===a)r.add(1,"week");else if("PageUp"===a){const e=i?"year":"month";r.subtract(1,e)}else if("PageDown"===a){const e=i?"year":"month";r.add(1,e)}else if("Home"===a){const e=t?"year":"month";r.startOf(e)}else if("End"===a){const e=t?"year":"month";r.endOf(e)}else f(a)&&(this.viewModel.value=r.toDate(),this._close());e.preventDefault(),e.stopPropagation()}}_renderMonth(e,t){const s=this._moment(),i=e.clone().startOf("month"),a=e.clone().endOf("month"),r=i.clone().subtract(i.weekday(),"day"),o=[];for(let n=0;n<6;n++){const n=[];for(let o=0;o<7;o++){const o=r.date(),l=r.isSame(e,"day"),d=r.isSame(t,"day"),c=this._getDayId(r),h={[N]:!r.isBetween(i,a,null,"[]"),[S]:r.isSame(s,"day"),[I]:l,[T]:d};n.push(g("div",{"aria-label":o.toString(),"aria-selected":l.toString(),bind:this,class:this.classes(K,h),"data-iso-date":r.toISOString(),id:c,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},o)),r.add(1,"day")}o.push(g("div",{class:x,role:"row"},n))}return o}_renderYearPicker(e){const t={year:"numeric"},s=e.clone(),i=_(s.valueOf(),t),a=_(s.add(1,"year").valueOf(),t),r=_(s.subtract(2,"year").valueOf(),t),{messages:o}=this;return g("div",{class:A},g("div",{"aria-label":o.goToPreviousYear,bind:this,class:E,onclick:this._setPreviousYear,onkeydown:this._setPreviousYear,tabIndex:0,title:o.goToPreviousYear},r),g("div",{class:this.classes(E,B),id:`${this.id}__selected-year`},i),g("div",{"aria-label":o.goToNextYear,bind:this,class:E,onclick:this._setNextYear,onkeydown:this._handleNextYearKeyDown,tabIndex:0,title:o.goToNextYear},a))}_toggle(){this._isOpen?this._close():this._open(this.viewModel.value)}_setMonth(e){const t=e.target.value;this._activeDate.month(t),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())}_close(e=!0){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1,this.pageClickHandler.pause(),e&&this._inputOrButtonNode.focus()}_open(e,s=!0){this._activeDate=this._moment(e),this._isOpen=!0,this._calendarPopover.open=!0,this._requestDayPickerFocusOnCreate=s,this.pageClickHandler||(this.pageClickHandler=t(document,"click",(({target:e})=>{var t,s;(null==(t=this._calendarNode)?void 0:t.contains(e))||(null==(s=this._rootNode)?void 0:s.contains(e))||this._close()})),this.own(this.pageClickHandler)),this.pageClickHandler.resume()}_setPreviousMonth(){this._activeDate.subtract(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())}_handlePreviousMonthKeyDown(e){if("Tab"===e.key&&e.shiftKey)return e.preventDefault(),void this._close();f(e.key)&&this._setPreviousMonth()}_setNextMonth(){this._activeDate.add(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())}_setPreviousYear(){this._activeDate.subtract(1,"year")}_setNextYear(){this._activeDate.add(1,"year")}_handleNextYearKeyDown(e){if("Tab"===e.key&&!e.shiftKey)return e.preventDefault(),void this._close();f(e.key)&&this._setNextYear()}_handleSelectedDate(e){const t=e.target;this.viewModel.value=this._moment(t.getAttribute("data-iso-date")).toDate(),this._close()}};e([l()],te.prototype,"dateInputEnabled",void 0),e([l({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],te.prototype,"label",void 0),e([l(),y("esri/widgets/support/t9n/DatePicker")],te.prototype,"messages",void 0),e([n("viewModel.value")],te.prototype,"value",void 0),e([l()],te.prototype,"commitOnMonthChange",void 0),e([l({type:m})],te.prototype,"viewModel",void 0),e([l()],te.prototype,"onChange",void 0),e([k()],te.prototype,"_setNextMonth",null),e([k()],te.prototype,"_setPreviousYear",null),e([k()],te.prototype,"_handleSelectedDate",null),te=e([d("esri.widgets.support.DatePicker")],te);const se=te;export{se as default};
