/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{b as t}from"../chunks/deprecate.js";import{L as e}from"../chunks/Logger.js";import{v as s,property as r,g as i,s as n}from"./accessorSupport/decorators/property.js";import{g as o,o as a,d as c,c as l}from"../chunks/metadata.js";import{g as u,a as h,clone as d,equals as _,n as f,i as p}from"./lang.js";import{O as g,A as v}from"../chunks/ArrayPool.js";import{t as m,r as y,c as b,d as w,i as O,subclass as k}from"./accessorSupport/decorators/subclass.js";import{schedule as C}from"./scheduling.js";import"../config.js";import"../chunks/object.js";import"../chunks/string.js";import"../chunks/ensureType.js";import"../chunks/handleUtils.js";import"./Error.js";import"../chunks/nextTick.js";import"./promiseUtils.js";class A{constructor(t,e){this._observers=t,this._observer=e}remove(){u(this._observers,this._observer)}}class j{constructor(t,e,s){this.properties=t,this.propertyName=e,this.metadata=s,this._observers=null,this._accessed=null,this._handles=null,this.flags=1|(s.nonNullable?8:0)|(s.hasOwnProperty("value")?16:0)|(void 0===s.get?32:0)|(void 0===s.dependsOn?64:0)}destroy(){this._accessed=null,this._observers=null,this._clearObservationHandles()}getComputed(){m(this);const t=this.properties.store,e=this.propertyName,s=this.flags,r=t.get(e);if(4&s)return r;if(1&~s&&t.has(e))return r;this.flags|=4;const i=this.properties.host;let n;64&s?n=y(this,this.metadata.get,i):(b(i,this),n=this.metadata.get.call(i)),t.set(e,n,1);const o=t.get(e);return o===r?this.flags&=-2:w(this.commit,this),this.flags&=-5,o}onObservableAccessed(t){t!==this&&(null===this._accessed&&(this._accessed=[]),this._accessed.includes(t)||this._accessed.push(t))}onTrackingEnd(){this._clearObservationHandles(),this.flags|=32;const t=this._accessed;if(null===t)return;let e=this._handles;null===e&&(e=this._handles=[]);for(let s=0;s<t.length;++s)e.push(t[s].observe(this));t.length=0}observe(t){return null===this._observers&&(this._observers=[]),this._observers.includes(t)||this._observers.push(t),new A(this._observers,t)}notifyChange(){this.onInvalidated(),this.onCommitted()}invalidate(){this.onInvalidated()}onInvalidated(){2&~this.flags&&(this.flags|=1);const t=this._observers;if(null!==t)for(let e=0;e<t.length;++e)t[e].onInvalidated()}commit(){this.flags&=-2,this.onCommitted()}onCommitted(){if(null===this._observers)return;const t=this._observers.slice();for(let e=0;e<t.length;++e)t[e].onCommitted()}_clearObservationHandles(){const t=this._handles;if(null!==t){for(let e=0;e<t.length;++e)t[e].remove();t.length=0}}}const S=7;function q(t){switch(t){case"defaults":return 0;case"service":return 2;case"portal-item":return 3;case"web-scene":return 4;case"web-map":return 5;case"user":return 6}}function E(t){switch(t){case 0:return"defaults";case 2:return"service";case 3:return"portal-item";case 4:return"web-scene";case 5:return"web-map";case 6:return"user"}return h(void 0)}function z(t){return E(t)}class V{constructor(){this._values=new Map}clone(t){const e=new V;return this._values.forEach(((s,r)=>{t&&t.has(r)||e.set(r,d(s))})),e}get(t){return this._values.get(t)}originOf(){return 6}keys(){return[...this._values.keys()]}set(t,e){this._values.set(t,e)}delete(t){this._values.delete(t)}has(t){return this._values.has(t)}forEach(t){this._values.forEach(t)}}function I(t,e,s){return void 0!==t}function D(t,e,s,r){return void 0!==t&&(!(null==s&&8&t.flags)||(r.lifecycle,!1))}e.getLogger("esri.core.accessorSupport.Properties");class T{constructor(t){this.host=t,this.properties=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=0,this.store=new V,this._origin=6;const e=this.host.constructor.__accessorMetadata__,s=e.properties;for(const t in s){const e=new j(this,t,s[t]);this.properties.set(t,e)}this.metadatas=s,this._autoDestroy=e.autoDestroy}initialize(){this.lifecycle=1}constructed(){this.lifecycle=2}destroy(){if(this.destroyed=!0,this._autoDestroy)for(const[e,s]of this.properties){const r=this.internalGet(e);r&&((t=r)&&"function"==typeof t.destroy)&&(r.destroy(),8&~s.flags&&this._internalSet(s,null)),s.destroy()}else for(const[t,e]of this.properties)e.destroy();var t}get initialized(){return 0!==this.lifecycle}get(t){const e=this.properties.get(t);if(e.metadata.get)return e.getComputed();m(e);const s=this.store;return s.has(t)?s.get(t):e.metadata.value}originOf(t){const e=this.store.originOf(t);if(void 0===e){const e=this.properties.get(t);if(void 0!==e&&16&e.flags)return"defaults"}return E(e)}has(t){return!!this.properties.has(t)&&this.store.has(t)}keys(){return[...this.properties.keys()]}internalGet(t){const e=this.properties.get(t);if(I(e))return this.store.has(t)?this.store.get(t):e.metadata.value}internalSet(t,e){const s=this.properties.get(t);I(s)&&this._internalSet(s,e)}getDependsInfo(t,e,s){const r=this.properties.get(e);if(!I(r))return"";const i=new Set,n=y({onObservableAccessed:t=>i.add(t),onTrackingEnd:()=>{}},(()=>{var e;return null==(e=r.metadata.get)?void 0:e.call(t)}));let a=`${s}${t.declaredClass.split(".").pop()}.${e}: ${n}\n`;if(0===i.size)return a;s+="  ";for(const t of i){if(!(t instanceof j))continue;const e=t.properties.host,r=t.propertyName,i=o(e);a+=i?i.getDependsInfo(e,r,s):`${s}${r}: undefined\n`}return a}setAtOrigin(t,e,s){const r=this.properties.get(t);if(I(r))return this._setAtOrigin(r,e,s)}isOverridden(t){const e=this.properties.get(t);return void 0!==e&&!!(2&e.flags)}clearOverride(t){const e=this.properties.get(t);void 0!==e&&2&e.flags&&(e.flags&=-3,e.notifyChange())}override(t,e){const s=this.properties.get(t);if(!D(s,0,e,this))return;const r=s.metadata.cast;if(r){const t=this._cast(r,e),{valid:s,value:i}=t;if(N.release(t),!s)return;e=i}s.flags|=2,this._internalSet(s,e)}set(t,e){const s=this.properties.get(t);if(!D(s,0,e,this))return;const r=s.metadata.cast;if(r){const t=this._cast(r,e),{valid:s,value:i}=t;if(N.release(t),!s)return;e=i}const i=s.metadata.set;i?i.call(this.host,e):this._internalSet(s,e)}setDefaultOrigin(t){this._origin=q(t)}getDefaultOrigin(){return E(this._origin)}notifyChange(t){const e=this.properties.get(t);void 0!==e&&e.notifyChange()}invalidate(t){const e=this.properties.get(t);void 0!==e&&e.invalidate()}commit(t){const e=this.properties.get(t);void 0!==e&&e.commit()}_internalSet(t,e){const s=0!==this.lifecycle?this._origin:0;this._setAtOrigin(t,e,s)}_setAtOrigin(t,e,s){const r=this.store,i=t.propertyName;r.has(i,s)&&_(e,r.get(i))&&2&~t.flags&&s===r.originOf(i)||(t.invalidate(),r.set(i,e,s),t.commit(),O(this.host,t))}_cast(t,e){const s=N.acquire();return s.valid=!0,s.value=e,t&&(s.value=t.call(this.host,e,s)),s}}const N=new g(class{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}});class P extends g{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=f(this._set)}acquire(...t){const e=super.acquire(...t);return this._set.delete(e),e}release(t){t&&!this._set.has(t)&&(super.release(t),this._set.add(t))}_dispose(t){this._set.delete(t),super._dispose(t)}}function $(t,e){for(const s of t.entries())if(e(s[0]))return!0;return!1}function x(t,e){const s=new Set;return p(t)&&t.forEach((t=>s.add(t))),p(e)&&e.forEach((t=>s.add(t))),s}let M=0;const U=0;function L(){return++M}class G{constructor(t){this._notify=t,this._accessed=[],this._handles=[],this._invalidCount=0}destroy(){this._accessed.length=0,this.clear()}onInvalidated(){this._invalidCount++}onCommitted(){const t=this._invalidCount;if(1===t)return this._invalidCount=0,void this._notify();this._invalidCount=t>0?t-1:0}onObservableAccessed(t){this._accessed.includes(t)||this._accessed.push(t)}onTrackingEnd(){const t=this._handles,e=this._accessed;for(let s=0;s<e.length;++s)t.push(e[s].observe(this));e.length=0}clear(){const t=this._handles;for(let e=0;e<t.length;++e)t[e].remove();t.length=0}}let H=!1;const B=[];function R(t,e){let s=new G((function n(){if(!s||i)return;if(H)return void K(n);const o=r;s.clear(),H=!0,i=!0,r=y(s,t),i=!1,H=!1,e(r,o),Q()})),r=null,i=!1;return i=!0,r=y(s,t),i=!1,{remove:function(){s&&(s.destroy(),s=null,r=null)}}}function F(t,e){let s=new G((function(){e(r,i)})),r=null;function i(){return s?(s.clear(),r=y(s,t),r):null}return i(),{remove:function(){s&&(s.destroy(),s=null),r=null}}}function J(t){let e=new G((function r(){if(!e||s)return;if(H)return void K(r);e.clear(),H=!0,s=!0,y(e,t),s=!1,H=!1,Q()})),s=!1;return s=!0,y(e,t),s=!1,{remove:function(){e&&(e.destroy(),e=null)}}}function K(t){B.includes(t)||B.unshift(t)}function Q(){for(;B.length;)B.pop()()}class W{constructor(){this.uid=L(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(t,e,s,r,i){return this.pool.acquire(0,t,e,s,r,i,_)}static acquireTracked(t,e,s,r){return this.pool.acquire(1,t,e,s,null,null,r)}notify(t,e){0===this.type?this.callback.call(this.target,t,e,this.path,this.target):this.callback.call(null,t,e)}acquire(t,e,s,r,i,n,o){this.uid=L(),this.removed=!1,this.type=t,this.oldValue=e,this.callback=s,this.getValue=r,this.target=i,this.path=n,this.equals=o}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=L(),this.removed=!0}}W.pool=new P(W);const X=new v,Y=new Set;let Z;function tt(t){Y.delete(t),Y.add(t),Z||(Z=C(st))}function et(t){if(t.removed)return;const e=t.oldValue,s=t.getValue();t.equals(e,s)||(t.oldValue=s,t.notify(s,e))}function st(){let t=10;for(;Z&&t--;){Z=null;const t=rt(),e=X.acquire();for(const s of t){const t=s.uid;et(s),t===s.uid&&s.removed&&e.push(s)}for(const t of Y)t.removed&&(e.push(t),Y.delete(t));for(const t of e)W.pool.release(t);X.release(e),X.release(t),it.forEach((t=>t()))}}function rt(){const t=X.acquire();t.length=Y.size;let e=0;for(const s of Y)t[e]=s,++e;return Y.clear(),t}const it=new Set;function nt(t){return it.add(t),{remove(){it.delete(t)}}}function ot(t,e,r,i=!1){return!t.__accessor__||t.__accessor__.destroyed?{remove(){}}:i?function(t,e,r){const i=c(t,e,r,((t,e,r)=>{let n=!1;return R((()=>s(t,e)),((s,o)=>{t.__accessor__.destroyed?i.remove():n||(n=!0,_(o,s)||r.call(t,s,o,e,t),n=!1)}))}));return i}(t,e,r):function(t,e,r){let i=c(t,e,r,((t,e,r)=>{let n,o,c=F((()=>s(t,e)),((s,a)=>{t.__accessor__.destroyed||n&&n.uid!==o?i.remove():(n||(n=W.acquireUntracked(s,r,a,t,e),o=n.uid),tt(n))}));return{remove:a((()=>{c.remove(),n&&(n.uid!==o||n.removed||(n.removed=!0,tt(n)),n=null),i=c=null}))}}));return i}(t,e,r)}function at(t,e,s=!1,r=_){return s?function(t,e,s){let r=!1;return R(t,((t,i)=>{r||(r=!0,s(i,t)||e(t,i),r=!1)}))}(t,e,r):function(t,e,s){let r,i,n=F(t,((t,o)=>{r&&r.uid!==i?n.remove():(r||(r=W.acquireTracked(t,e,o,s),i=r.uid),tt(r))}));return{remove:a((()=>{n.remove(),r&&(r.uid!==i||r.removed||(r.removed=!0,tt(r)),r=null),n=null}))}}(t,e,r)}function ct(t){return $(Y,(e=>e.oldValue===t))}function lt(t){if(null==t)return{value:t};if(Array.isArray(t))return{type:[t[0]],value:null};switch(typeof t){case"object":return t.constructor&&t.constructor.__accessorMetadata__||t instanceof Date?{type:t.constructor,value:t}:t;case"boolean":return{type:Boolean,value:t};case"string":return{type:String,value:t};case"number":return{type:Number,value:t};case"function":return{type:t,value:null};default:return}}class ut{constructor(...t){if(this.constructor===ut)throw new Error("[accessor] cannot instantiate Accessor. This can be fixed by creating a subclass of Accessor");Object.defineProperty(this,"__accessor__",{enumerable:!1,value:new T(this)}),t.length>0&&this.normalizeCtorArgs&&(this.__accessor__.ctorArgs=this.normalizeCtorArgs.apply(this,t))}static createSubclass(t={}){if(Array.isArray(t))throw new Error("Multi-inheritance unsupported since 4.16");const{properties:e,declaredClass:s,constructor:i}=t;delete t.declaredClass,delete t.properties,delete t.constructor;const n=this;class o extends n{constructor(...t){super(...t),this.inherited=null,i&&i.apply(this,t)}}l(o.prototype);for(const e in t){const s=t[e];o.prototype[e]="function"==typeof s?function(...t){const r=this.inherited;let i;this.inherited=function(...t){if(n.prototype[e])return n.prototype[e].apply(this,t)};try{i=s.apply(this,t)}catch(t){throw this.inherited=r,t}return this.inherited=r,i}:t[e]}for(const t in e){const s=lt(e[t]);r(s)(o.prototype,t)}return k(s)(o)}postscript(t){const e=this.__accessor__,s=e.ctorArgs||t;e.initialize(),s&&(this.set(s),e.ctorArgs=null),e.constructed(),this.initialize()}initialize(){}destroy(){this.destroyed||(!function(t){for(const e of Y.values())e.target===t&&(e.removed=!0)}(this),this.__accessor__.destroy())}get initialized(){return this.__accessor__&&this.__accessor__.initialized||!1}get constructed(){return this.__accessor__&&2===this.__accessor__.lifecycle||!1}get destroyed(){return this.__accessor__&&this.__accessor__.destroyed||!1}commitProperty(t){this.get(t)}get(t){return i(this,t)}hasOwnProperty(t){return this.__accessor__?this.__accessor__.has(t):Object.prototype.hasOwnProperty.call(this,t)}isInstanceOf(s){return t(e.getLogger(this.declaredClass),"isInstanceOf",{replacement:"Use instanceof directly",version:"4.16"}),this instanceof s}keys(){return this.__accessor__?this.__accessor__.keys():[]}set(t,e){return n(this,t,e),this}watch(t,e,s){return ot(this,t,e,s)}_clearOverride(t){return this.__accessor__.clearOverride(t)}_override(t,e){return this.__accessor__.override(t,e)}_isOverridden(t){return this.__accessor__.isOverridden(t)}notifyChange(t){this.__accessor__.notifyChange(t)}_get(t){return this.__accessor__.internalGet(t)}_set(t,e){return this.__accessor__.internalSet(t,e),this}}export{U as N,A as O,P as R,G as S,J as a,S as b,E as c,nt as d,ut as default,ct as e,L as g,z as i,q as n,$ as s,x as u,at as w};
