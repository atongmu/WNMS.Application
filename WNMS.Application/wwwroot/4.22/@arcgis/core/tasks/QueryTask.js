/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as t}from"../chunks/tslib.es6.js";import o from"../core/Error.js";import{h as s,i as r,b as e}from"../core/lang.js";import{whenOrAbort as i}from"../core/promiseUtils.js";import{property as p}from"../core/accessorSupport/decorators/property.js";import"../chunks/ensureType.js";import{subclass as n}from"../core/accessorSupport/decorators/subclass.js";import{D as m}from"../chunks/DataLayerSource.js";import{c as a,a as u,d as l,f as c,e as j,g as y,h,i as d,j as b}from"../chunks/executeForTopCount.js";import{c as f,b as S,a as k}from"../chunks/executeQueryJSON.js";import D from"../rest/support/FeatureSet.js";import g from"../rest/support/Query.js";import F from"../rest/support/RelationshipQuery.js";import O from"./Task.js";import"../chunks/Logger.js";import"../config.js";import"../chunks/object.js";import"../chunks/string.js";import"../chunks/metadata.js";import"../chunks/handleUtils.js";import"../chunks/jsonMap.js";import"../chunks/JSONSupport.js";import"../core/Accessor.js";import"../chunks/deprecate.js";import"../chunks/ArrayPool.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../core/accessorSupport/decorators/cast.js";import"../chunks/enumeration.js";import"../chunks/reader.js";import"../layers/support/Field.js";import"../chunks/domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/fieldType.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"../chunks/writer.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/Ellipsoid.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../chunks/utils3.js";import"../core/urlUtils.js";import"../chunks/scaleUtils.js";import"../chunks/unitUtils.js";import"../chunks/projectionEllipsoid.js";import"../chunks/floorFilterUtils.js";import"../kernel.js";import"../request.js";import"../rest/query/support/AttachmentInfo.js";import"../chunks/query.js";import"../geometry/support/normalizeUtils.js";import"../chunks/normalizeUtilsCommon.js";import"../chunks/arcgisLayerUrl.js";import"../chunks/persistableUrlUtils.js";import"../chunks/pbfQueryUtils.js";import"../chunks/pbf.js";import"../chunks/OptimizedFeature.js";import"../chunks/OptimizedFeatureSet.js";import"../chunks/queryZScale.js";import"../chunks/zscale.js";import"../rest/support/AttachmentQuery.js";import"../chunks/compilerUtils.js";import"../chunks/featureConversionUtils.js";import"../rest/support/TopFeaturesQuery.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"../rest/support/TopFilter.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Collection.js";import"../chunks/Evented.js";import"../chunks/shared.js";import"../layers/support/fieldUtils.js";import"../chunks/arcadeOnDemand.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../chunks/date.js";import"../chunks/number.js";import"../chunks/locale.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../chunks/chartMediaInfoUtils.js";import"../chunks/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../support/actions/ActionBase.js";import"../chunks/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../Color.js";import"../chunks/colorUtils.js";import"../chunks/mathUtils.js";import"../chunks/common.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils.js";import"../symbols/edges/Edges3D.js";import"../chunks/screenUtils.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils2.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../chunks/aaBoundingRect.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../chunks/Loadable.js";import"../chunks/Promise.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../chunks/Thumbnail.js";import"../chunks/Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../rest/support/StatisticDefinition.js";let x=class extends O{constructor(t){super(t),this.dynamicDataSource=null,this.fieldsIndex=null,this.format="json",this.gdbVersion=null,this.infoFor3D=null,this.sourceSpatialReference=null}execute(t,o){return this.executeJSON(t,o).then((s=>this.featureSetFromJSON(t,s,o)))}async executeJSON(t,o){var r;const e={...this.requestOptions,...o},i=this._normalizeQuery(t),p=null!=(null==(r=t.outStatistics)?void 0:r[0]),n=s("featurelayer-pbf-statistics"),m=!p||n;let u;if("pbf"===this.format&&m)try{u=await a(this.url,i,e)}catch(t){if("query:parsing-pbf"!==t.name)throw t;this.format="json"}return"json"!==this.format&&m||(u=await f(this.url,i,e)),this._normalizeFields(u.fields),u}async featureSetFromJSON(t,o,s){if(!(this._queryIs3DObjectFormat(t)&&r(this.infoFor3D)&&o.features&&o.features.length))return D.fromJSON(o);const{meshFeatureSetFromJSON:e}=await i(import("../chunks/meshFeatureSet.js"),s);return e(t,this.infoFor3D,o)}executeForCount(t,o){const s={...this.requestOptions,...o},r=this._normalizeQuery(t);return S(this.url,r,s)}executeForExtent(t,o){const s={...this.requestOptions,...o},r=this._normalizeQuery(t);return u(this.url,r,s)}executeForIds(t,o){const s={...this.requestOptions,...o},r=this._normalizeQuery(t);return k(this.url,r,s)}executeRelationshipQuery(t,o){t=F.from(t);const s={...this.requestOptions,...o};return(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),l(this.url,t,s)}executeRelationshipQueryForCount(t,o){t=F.from(t);const s={...this.requestOptions,...o};return(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),c(this.url,t,s)}executeAttachmentQuery(t,o){const s={...this.requestOptions,...o};return j(this.url,t,s)}executeTopFeaturesQuery(t,o){const s={...this.requestOptions,...o};return y(this.parsedUrl,t,this.sourceSpatialReference,s)}executeForTopIds(t,o){const s={...this.requestOptions,...o};return h(this.parsedUrl,t,s)}executeForTopExtents(t,o){const s={...this.requestOptions,...o};return d(this.parsedUrl,t,s)}executeForTopCount(t,o){const s={...this.requestOptions,...o};return b(this.parsedUrl,t,s)}_normalizeQuery(t){let s=g.from(t);if(s.sourceSpatialReference=s.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(s=s===t?s.clone():s,s.gdbVersion=t.gdbVersion||this.gdbVersion,s.dynamicDataSource=t.dynamicDataSource?m.from(t.dynamicDataSource):this.dynamicDataSource),r(this.infoFor3D)&&this._queryIs3DObjectFormat(t)){s=s===t?s.clone():s,s.formatOf3DObjects=null;for(const t of this.infoFor3D.queryFormats){if("3D_glb"===t.id){s.formatOf3DObjects=t.id;break}"3D_gltf"!==t.id||s.formatOf3DObjects||(s.formatOf3DObjects=t.id)}if(!s.formatOf3DObjects)throw new o("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(e(s.outFields)||!s.outFields.includes("*")){s=s===t?s.clone():s,e(s.outFields)&&(s.outFields=[]);const{originX:o,originY:r,originZ:i,translationX:p,translationY:n,translationZ:m,scaleX:a,scaleY:u,scaleZ:l,rotationX:c,rotationY:j,rotationZ:y,rotationDeg:h}=this.infoFor3D.transformFieldRoles;s.outFields.push(o,r,i,p,n,m,a,u,l,c,j,y,h)}}return s}_normalizeFields(t){if(r(this.fieldsIndex)&&r(t))for(const o of t){const t=this.fieldsIndex.get(o.name);t&&Object.assign(o,t.toJSON())}}_queryIs3DObjectFormat(t){return r(this.infoFor3D)&&t.returnGeometry&&"xyFootprint"!==t.multipatchOption&&!t.outStatistics}};t([p({type:m})],x.prototype,"dynamicDataSource",void 0),t([p()],x.prototype,"fieldsIndex",void 0),t([p()],x.prototype,"format",void 0),t([p()],x.prototype,"gdbVersion",void 0),t([p()],x.prototype,"infoFor3D",void 0),t([p()],x.prototype,"sourceSpatialReference",void 0),x=t([n("esri.tasks.QueryTask")],x);const U=x;export{U as default};
