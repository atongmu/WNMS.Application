/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import"../../geometry.js";import e from"../../Viewpoint.js";import{a as r}from"../../chunks/JSONSupport.js";import{property as n}from"../../core/accessorSupport/decorators/property.js";import{i as s,j as o,b as i}from"../../core/lang.js";import"../../chunks/ensureType.js";import{subclass as a}from"../../core/accessorSupport/decorators/subclass.js";import{t as c,a as u}from"../../chunks/common.js";import{f as l,s as m,i as f,t as p,r as h,a as y,b as g}from"../../chunks/mat2d.js";import{c as j}from"../../chunks/mat2df32.js";import{c as d}from"../../chunks/mat2df64.js";import{c as w,a as x,b as k,r as b,m as v}from"../../chunks/mat3.js";import{c as R}from"../../chunks/mat3f32.js";import{s as M,c as G,b as S,e as z,t as A,n as _,f as N,g as P,h as U,i as T,j as V,l as E}from"../../chunks/vec2.js";import{f as F}from"../../chunks/vec2f32.js";import{c as q,f as I}from"../../chunks/vec2f64.js";import O from"../../core/Collection.js";import{d as W}from"../../chunks/unitUtils.js";import D from"../../geometry/Extent.js";import L from"../../geometry/Geometry.js";import C from"../../geometry/Point.js";import Q,{j as B,g as J}from"../../geometry/SpatialReference.js";import{e as H}from"../../chunks/Ellipsoid.js";import{canProject as K,project as X}from"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/writer.js";import"../../chunks/zmUtils.js";import"../../chunks/Logger.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import"../../chunks/handleUtils.js";import"../../core/Error.js";import"../../core/Accessor.js";import"../../chunks/deprecate.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../core/promiseUtils.js";import"../../chunks/reader.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../chunks/jsonMap.js";import"../../geometry/support/jsonUtils.js";import"../../Camera.js";import"../../chunks/mathUtils.js";import"../../chunks/mathUtils2.js";import"../../chunks/Evented.js";import"../../chunks/shared.js";import"../../chunks/projectionEllipsoid.js";function Y(t){return function(t){return t instanceof Float32Array&&t.length>=2}(t)||function(t){return Array.isArray(t)&&t.length>=2}(t)}const Z=180/Math.PI;function $(t,e,r,n){return n&&r&&!n.equals(r)&&K(n,r)&&n.isWebMercator?n.isWebMercator?function(t,e){let r=e[1];return r>89.99999?r=89.99999:r<-89.99999&&(r=-89.99999),r=Math.sin(c(r)),M(t,c(e[0])*H.radius,.5*H.radius*Math.log((1+r)/(1-r)))}(t,e):function(t,e,r){const n=u(e[0]/H.radius);return M(t,r?n:n-360*Math.floor((n+180)/360),u(.5*Math.PI-2*Math.atan(Math.exp(-e[1]/H.radius))))}(t,e):G(t,e)}function tt(t){return t.wkid?t:t.spatialReference||Q.WGS84}function et(t,e){return e.type?M(t,e.x,e.y):G(t,e)}function rt(t){return W(t)}function nt(t,e){return Math.max(t.width/e[0],t.height/e[1])*(r=t.spatialReference,B(r)?39.37*rt(r)*96:1);var r}async function st(t,e,r,n){let a,c;if(!t)return null;if(Array.isArray(t)&&!t.length)return null;if(O.isCollection(t)&&(t=t.toArray()),Array.isArray(t)&&t.length&&"object"==typeof t[0]){const o=t.every((t=>"attributes"in t)),i=t.some((t=>!t.geometry));let a=t;if(o&&i&&e&&e.allLayerViews){const r=new Map;for(const e of t){const t=e.layer,n=r.get(t)||[],s=e.attributes[t.objectIdField];null!=s&&n.push(s),r.set(t,n)}const n=[];r.forEach(((t,r)=>{const s=e.allLayerViews.find((t=>t.layer.id===r.id));if("queryFeatures"in s){const e=r.createQuery();e.objectIds=t,e.returnGeometry=!0,n.push(s.queryFeatures(e))}}));const o=await Promise.all(n),i=[];for(const t of o)if(t&&t.features&&t.features.length)for(const e of t.features)s(e.geometry)&&i.push(e.geometry);a=i}for(const t of a)n=await st(t,e,r,n);return n}if(Array.isArray(t)&&2===t.length&&"number"==typeof t[0]&&"number"==typeof t[1])a=new C(t);else if(t instanceof L)a=t;else if("geometry"in t)if(t.geometry)a=t.geometry;else if(t.layer){const r=t.layer,n=e.allLayerViews.find((t=>t.layer.id===r.id));if("queryFeatures"in n){const e=r.createQuery();e.objectIds=[t.attributes[r.objectIdField]],e.returnGeometry=!0;const s=await n.queryFeatures(e);a=o(s,"features",0,"geometry")}}if(i(a))return null;if(c="point"===a.type?new D({xmin:a.x,ymin:a.y,xmax:a.x,ymax:a.y,spatialReference:a.spatialReference}):a.extent,!c)return null;const u=X(c,r);return i(u)?null:n=n?n.union(u):u}async function ot(t,r){if(!t||!r)return new e({targetGeometry:new C,scale:0,rotation:0});let n=r.spatialReference;const{constraints:o,padding:i,viewpoint:a,size:c}=r,u=[i?c[0]-i.left-i.right:c[0],i?c[1]-i.top-i.bottom:c[1]];let l=null;t instanceof e?l=t:t.viewpoint?l=t.viewpoint:t.target&&"esri.Viewpoint"===t.target.declaredClass&&(l=t.target);let m=null;l&&l.targetGeometry?m=l.targetGeometry:t instanceof D?m=t:(t||t&&("center"in t||"extent"in t||"target"in t))&&(m=await st(t.center,r,n)||await st(t.extent,r,n)||await st(t.target,r,n)||await st(t,r,n)),!m&&a&&a.targetGeometry?m=a.targetGeometry:!m&&r.extent&&(m=r.extent);const f=tt(m);if(n||(n=tt(r.spatialReference||r.extent||m)),!K(m,n)&&f&&!f.equals(n))return null;const p=et(q(),m.center?m.center:m),h=new C($(p,p,f,n),n);let y=null;if(l&&s(l.targetGeometry)&&"point"===l.targetGeometry.type)y=l.scale;else if(t.hasOwnProperty("scale")&&t.scale)y=t.scale;else if(t.hasOwnProperty("zoom")&&-1!==t.zoom&&o&&o.effectiveLODs)y=o.zoomToScale(t.zoom);else if(Array.isArray(m)||"point"===m.type||"extent"===m.type&&0===m.width&&0===m.height){const t=X(r.extent,n);y=s(t)?nt(t,u):r.extent?nt(r.extent,u):a.scale}else y=K(m.extent,n)?nt(X(m.extent,n),u):nt(m.extent,u);const g=function(t){if(t&&(!Array.isArray(t)||"number"!=typeof t[0])&&("object"==typeof t||Array.isArray(t)&&"object"==typeof t[0])){if("layer"in t&&t.layer&&t.layer.minScale&&t.layer.maxScale){const e=t.layer;return{min:e.minScale,max:e.maxScale}}if(Array.isArray(t)&&t.length&&t.every((t=>"layer"in t))){let e=0,r=0;for(const n of t){const t=n.layer;t&&t.minScale&&t.maxScale&&(e=t.minScale<e?t.minScale:e,r=t.maxScale>r?t.maxScale:r)}return e&&r?{min:e,max:r}:null}}}(t);g&&(g.min&&g.min>y?y=g.min:g.max&&g.max<y&&(y=g.max));let j=0;l?j=l.rotation:t.hasOwnProperty("rotation")?j=t.rotation:a&&(j=a.rotation);let d=new e({targetGeometry:h,scale:y,rotation:j});return o&&(d=o.fit(d),o.constrainByGeometry(d),o.rotationEnabled||(d.rotation=j)),d}function it(t,e){const r=t.targetGeometry,n=e.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,t.scale=e.scale,t.rotation=e.rotation,t}function at(t,e,r){return r?M(t,.5*(e[0]-r.right+r.left),.5*(e[1]-r.bottom+r.top)):z(t,e,.5)}const ct=function(){const t=q();return function(e,r,n){const s=r.targetGeometry;et(t,s);const o=.5*ft(r);return e.xmin=t[0]-o*n[0],e.ymin=t[1]-o*n[1],e.xmax=t[0]+o*n[0],e.ymax=t[1]+o*n[1],e.spatialReference=s.spatialReference,e}}();function ut(t,e,r,n,s){return kt(t,e,r.center),t.scale=nt(r,n),s&&s.constraints&&s.constraints.constrain(t),t}const lt=function(){const t=q();return function(e,r,n){return S(e,function(t,e){return z(t,e,.5)}(e,r),at(t,r,n))}}(),mt=function(){const t=d(),e=q();return function(r,n,s,o){const i=ft(n),a=pt(n);return M(e,i,i),y(t,e),h(t,t,a),p(t,t,lt(e,s,o)),p(t,t,[0,o.top-o.bottom]),M(r,t[4],t[5])}}();function ft(t){return t.scale*(e=t.targetGeometry,s(e)&&B(e.spatialReference)?1/(39.37*rt(e.spatialReference)*96):1);var e}function pt(t){return c(t.rotation)||0}const ht=function(){const t=q(),e=q(),r=q();return function(n,s,o,i,a,c){return _(t,s),z(e,o,.5*c),M(r,1/i*c,-1/i*c),f(n),p(n,n,e),a&&h(n,n,a),m(n,n,r),p(n,n,t),n}}(),yt=function(){const t=q();return function(e,r,n,s){const o=ft(r),i=pt(r);return et(t,r.targetGeometry),ht(e,t,n,o,i,s)}}(),gt=function(){const t=q();return function(e,r,n,s){const o=ft(r);return et(t,r.targetGeometry),ht(e,t,n,o,0,s)}}();function jt(t){if(t.isWrappable){const e=J(t);return e.valid[1]-e.valid[0]}return 0}function dt(t,e){return ot(t,e)}const wt=function(){const t=q(),e=q(),r=[0,0,0];return function(n,s,o){P(t,n,s),U(t,t),P(e,n,o),U(e,e),T(r,t,e);let i=Math.acos(V(t,e)/(E(t)*E(e)))*Z;return r[2]<0&&(i=-i),isNaN(i)&&(i=0),i}}(),xt=function(){const t=q();return function(e,r,n,s){const o=e.targetGeometry;return it(e,r),mt(t,r,n,s),o.x+=t[0],o.y+=t[1],e}}(),kt=function(){const t=q();return function(e,r,n){it(e,r);const s=e.targetGeometry,o=tt(n),i=tt(s);return et(t,n),$(t,t,o,i),s.x=t[0],s.y=t[1],e}}(),bt=function(){const t=q();return function(e,r,n,s,o){o||(o="center"),S(t,n,s),z(t,t,.5);const i=t[0],a=t[1];switch(o){case"center":M(t,0,0);break;case"left":M(t,-i,0);break;case"top":M(t,0,a);break;case"right":M(t,i,0);break;case"bottom":M(t,0,-a);break;case"top-left":M(t,-i,a);break;case"bottom-left":M(t,-i,-a);break;case"top-right":M(t,i,a);break;case"bottom-right":M(t,i,-a)}return Nt(e,r,t),e}}();function vt(t,e,r){return it(t,e),t.rotation+=r,t}function Rt(t,e,r){return it(t,e),t.rotation=r,t}const Mt=function(){const t=q();return function(e,r,n,s,o){return it(e,r),isNaN(n)||0===n||(At(t,s,r,o),e.scale=r.scale*n,_t(t,t,e,o),Nt(e,e,M(t,t[0]-s[0],s[1]-t[1]))),e}}();function Gt(t,e,r){return it(t,e),t.scale=r,t}const St=function(){const t=q();return function(e,r,n,s,o,i){return it(e,r),isNaN(n)||0===n||(At(t,o,r,i),e.scale=r.scale*n,e.rotation+=s,_t(t,t,e,i),Nt(e,e,M(t,t[0]-o[0],o[1]-t[1]))),e}}(),zt=function(){const t=q(),e=q();return function(r,n,s,o,i,a,c){return lt(e,a,c),N(t,i,e),o?St(r,n,s,o,t,a):Mt(r,n,s,t,a)}}(),At=function(){const t=d();return function(e,r,n,s){return A(e,r,function(t,e,r,n){return yt(t,e,r,n),g(t,t)}(t,n,s,1))}}(),_t=function(){const t=d();return function(e,r,n,s){return A(e,r,yt(t,n,s,1))}}(),Nt=function(){const t=q(),e=d();return function(r,n,s){it(r,n);const o=ft(n),i=r.targetGeometry;return l(e,pt(n)),m(e,e,I(o,o)),A(t,s,e),i.x+=t[0],i.y+=t[1],r}}();var Pt;const Ut=[0,0];let Tt=Pt=class extends r{constructor(t){super(t),this._viewpoint2D={center:q(),rotation:0,scale:0,spatialReference:null},this.center=[0,0],this.extent=new D,this.id=0,this.inverseTransform=d(),this.resolution=0,this.rotation=0,this.scale=0,this.transform=d(),this.transformNoRotation=d(),this.displayMat3=R(),this.displayViewMat3=R(),this.viewMat3=R(),this.viewMat2d=j(),this.worldScreenWidth=0,this.size=[0,0]}set pixelRatio(t){this._set("pixelRatio",t),this._update()}set size(t){this._set("size",t),this._update()}set viewpoint(t){if(t){const e=this._viewpoint2D,r=t.targetGeometry;e.center[0]=r.x,e.center[1]=r.y,e.rotation=t.rotation,e.scale=t.scale,e.spatialReference=r.spatialReference}this._update()}copy(t){const e=this.size,r=this.viewpoint;return r&&e?(this.viewpoint=it(r,t.viewpoint),this._set("size",G(e,t.size))):(this.viewpoint=t.viewpoint.clone(),this._set("size",[t.size[0],t.size[1]])),this._set("pixelRatio",t.pixelRatio),this}clone(){return new Pt({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})}toMap(t,e,r){return Y(e)?A(t,e,this.inverseTransform):(Ut[0]=e,Ut[1]=r,A(t,Ut,this.inverseTransform))}toScreen(t,e,r){return Y(e)?A(t,e,this.transform):(Ut[0]=e,Ut[1]=r,A(t,Ut,this.transform))}toScreenNoRotation(t,e,r){return Y(e)?A(t,e,this.transformNoRotation):(Ut[0]=e,Ut[1]=r,A(t,Ut,this.transformNoRotation))}getScreenTransform(t,e){const{center:r}=this._viewpoint2D,n=this._get("pixelRatio")||1,s=this._get("size");return ht(t,r,s,e,0,n),t}_update(){const{center:t,spatialReference:r,scale:n,rotation:s}=this._viewpoint2D,o=this._get("pixelRatio")||1,i=this._get("size"),a=new e({targetGeometry:new C(t[0],t[1],r),scale:n,rotation:s});if(this._set("viewpoint",a),!i||!r||!n)return;this.resolution=ft(a),this.rotation=s,this.scale=n,this.spatialReference=r,G(this.center,t);const u=0!==i[0]?2/i[0]:0,l=0!==i[1]?-2/i[1]:0;w(this.displayMat3,u,0,0,0,l,0,-1,1,1);const m=x(this.viewMat3),y=F(i[0]/2,i[1]/2),j=F(-i[0]/2,-i[1]/2),d=c(s);k(m,m,y),b(m,m,d),k(m,m,j),v(this.displayViewMat3,this.displayMat3,m);const R=f(this.viewMat2d);return p(R,R,y),h(R,R,d),p(R,R,j),ct(this.extent,a,i),yt(this.transform,a,i,o),g(this.inverseTransform,this.transform),gt(this.transformNoRotation,a,i,o),this.worldScreenWidth=function(t,e){return Math.round(jt(t)/e)}(this.spatialReference,this.resolution),this._set("id",this.id+1),this}};t([n({readOnly:!0})],Tt.prototype,"id",void 0),t([n({value:1,json:{write:!0}})],Tt.prototype,"pixelRatio",null),t([n({json:{write:!0}})],Tt.prototype,"size",null),t([n({type:e,json:{write:!0}})],Tt.prototype,"viewpoint",null),Tt=Pt=t([a("esri.views.2d.ViewState")],Tt);const Vt=Tt;export{xt as a,kt as b,it as c,Gt as d,Vt as default,dt as e,bt as f,nt as g,St as h,lt as i,at as j,vt as k,wt as l,jt as m,zt as p,Rt as r,ut as s,Nt as t};
