/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../Map.js";import i from"../TimeExtent.js";import r from"../core/Accessor.js";import a from"../core/Collection.js";import{C as o}from"../chunks/CollectionFlattener.js";import s from"../core/Error.js";import{E as n}from"../chunks/Evented.js";import{HandleOwner as l,W as p,HandleOwnerMixin as c}from"../core/HandleOwner.js";import{m as u}from"../chunks/handleUtils.js";import{L as h}from"../chunks/Loadable.js";import{L as d}from"../chunks/Logger.js";import{b as y,i as m,r as g,C as f,u as v,k as w,z as _}from"../core/lang.js";import{a as b}from"../chunks/Promise.js";import{createDeferred as k,isAbortError as M,onAbort as j,throwIfAborted as T,createTask as I,whenOrAbort as R,isAborted as S,after as V}from"../core/promiseUtils.js";import{r as x}from"../chunks/reactiveUtils.js";import{on as E,init as C,watch as P,whenOnce as L,whenFalseOnce as D}from"../core/watchUtils.js";import{aliasOf as O}from"../core/accessorSupport/decorators/aliasOf.js";import{s as F}from"../chunks/ensureType.js";import{property as U}from"../core/accessorSupport/decorators/property.js";import{subclass as A}from"../core/accessorSupport/decorators/subclass.js";import{O as q,G as K,o as B}from"../chunks/GraphicsCollection.js";import G from"../geometry/Extent.js";import W from"../geometry/HeightModelInfo.js";import H from"../geometry/SpatialReference.js";import{BasemapView as z}from"./BasemapView.js";import{schedule as N}from"../core/scheduling.js";import $ from"./Magnifier.js";import{T as Q,I as Y}from"../chunks/Scheduler.js";import{I as J,V as X}from"../chunks/InputManager.js";import{r as Z,c as ee}from"../chunks/mathUtils.js";import{c as te}from"../chunks/screenUtils.js";import{a as ie,g as re}from"../chunks/interactiveToolUtils.js";import{c as ae}from"../chunks/screenUtils2.js";import oe from"./input/Input.js";import se from"./navigation/Navigation.js";import ne from"../core/Handles.js";import{project as le,canProjectWithoutEngine as pe,isLoaded as ce}from"../geometry/projection.js";import{m as ue,d as he}from"../chunks/heightModelInfoUtils.js";import{s as de}from"../chunks/ViewingMode.js";import"../Basemap.js";import"../chunks/collectionUtils.js";import"../chunks/deprecate.js";import"../chunks/JSONSupport.js";import"../chunks/metadata.js";import"../chunks/loadAll.js";import"../chunks/asyncUtils.js";import"../core/urlUtils.js";import"../config.js";import"../chunks/object.js";import"../chunks/string.js";import"../chunks/writer.js";import"../portal/Portal.js";import"../kernel.js";import"../request.js";import"../chunks/reader.js";import"../chunks/locale.js";import"../portal/PortalQueryParams.js";import"../chunks/jsonMap.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/Ellipsoid.js";import"../chunks/ArrayPool.js";import"../chunks/nextTick.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalItem.js";import"../chunks/assets.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/messages.js";import"../chunks/writeUtils.js";import"../chunks/shared.js";import"../Ground.js";import"../Color.js";import"../chunks/colorUtils.js";import"../chunks/common.js";import"../chunks/compilerUtils.js";import"../chunks/enumeration.js";import"../chunks/opacityUtils.js";import"../chunks/basemapUtils.js";import"../chunks/TablesMixin.js";import"../layers/Layer.js";import"../geometry.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../chunks/Identifiable.js";import"../chunks/timeUtils.js";import"../Graphic.js";import"../PopupTemplate.js";import"../layers/support/fieldUtils.js";import"../chunks/arcadeOnDemand.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../chunks/date.js";import"../chunks/number.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../chunks/chartMediaInfoUtils.js";import"../chunks/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils2.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../chunks/aaBoundingRect.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../chunks/persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../chunks/Thumbnail.js";import"../chunks/Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../chunks/unitUtils.js";import"../chunks/projectionEllipsoid.js";import"../chunks/debugFlags.js";import"../chunks/Queue.js";import"./input/gamepad/GamepadSettings.js";import"./input/gamepad/GamepadInputDevice.js";import"./navigation/gamepad/GamepadSettings.js";import"../chunks/mat4.js";import"../chunks/pe.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/arcgisLayerUrl.js";let ye=class extends q{_own(e){e.parent=this.owner}_release(e){e.parent=null}};ye=e([A("esri.support.AnalysesCollection")],ye);const me=d.getLogger("esri.views.LayerViewManager");class ge{constructor(e,t,i){this.layer=e,this.view=t,this.layerViewImporter=i,this._controller=new AbortController,this._deferred=k(),this._started=!1,this.done=!1,j(this._controller.signal,(()=>{const t=new s("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred.reject(t)}))}get promise(){return this._deferred.promise}destroy(){this._controller.abort();const{layerView:e}=this;if(!e)return;const{layer:t,view:i}=this;t.emit("layerview-destroy",{view:i,layerView:e}),i.emit("layerview-destroy",{layer:t,layerView:e}),this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null}async start(){if(this._started)return;this._started=!0;const{_controller:{signal:e},layer:t,view:i}=this;this._map=i.map;try{var r,a;let o,n;if(await t.load({signal:e}),"prefetchResources"in t&&await t.prefetchResources({signal:e}),t.createLayerView)o=await t.createLayerView(i,{signal:e});else{if(!this.layerViewImporter.hasLayerViewModule(t))throw new s("layer:view-not-supported","No layerview implementation was found");const r=await this.layerViewImporter.importLayerView(t);T(e),o="default"in r?new r.default({layer:t,view:i}):new r({layer:t,view:i})}const l=()=>{n=g(n),o.destroyed||o.destroy(),o.layer=null,o.parent=null,o.view=null,this.done=!0};n=j(e,l),T(e);try{await o.when()}catch(e){throw l(),e}if(!(null==(r=this._map)||null==(a=r.allLayers)?void 0:a.includes(t)))return l(),void this._deferred.reject(new s("view:no-layerview-for-layer","The layer has been removed from the map",{layer:t}));this.layerView=o,t.emit("layerview-create",{view:i,layerView:o}),i.emit("layerview-create",{layer:t,layerView:o}),this.done=!0,this._deferred.resolve(o)}catch(e){t.emit("layerview-create-error",{view:i,error:e}),i.emit("layerview-create-error",{layer:t,error:e}),this.done=!0,this._deferred.reject(new s("layerview:create-error","layerview creation failed",{layer:t,error:e}))}}}let fe=class extends l{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._watchUpdatingTracking=new p,this.supportsGround=!0,this._preloadLayerViewModules=()=>{var e;const t=null==(e=this.view.map)?void 0:e.allLayers;if(t)for(const e of t)this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e)},this._reschedule=()=>(y(this._workPromise)&&(this._workPromise=k()),this.handles.remove("reschedule"),this.handles.add(N(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{var e,t,i;const r=this.view.map;if(this._map!==r&&(this.clear(),this._map=r),y(this._workPromise))return void this.notifyChange("updating");this.handles.remove("reschedule"),this.handles.remove("collection-change");const a=new o({getCollections:()=>this._rootCollectionNames.map((e=>this.get(e))),getChildrenFunction:e=>e&&"layers"in e?e.layers:null});if(!a)return this._workPromise.resolve(),void(this._workPromise=null);for(const e of a)this._createLayerView(e);this._refreshCollections();for(const[e,t]of this._layerLayerViewInfoMap)a.includes(e)||(this._layerLayerViewInfoMap.delete(t.layer),t.destroy());const s=a.filter((e=>"group"===e.type)).map((e=>e.layers)),n=[null==r||null==(e=r.ground)?void 0:e.layers,null==r||null==(t=r.basemap)?void 0:t.baseLayers,null==r||null==(i=r.basemap)?void 0:i.referenceLayers,null==r?void 0:r.layers,...s].filter((e=>!!e));this.handles.add(n.map((e=>this._watchUpdatingTracking.addOnCollectionChange(e,this._reschedule))),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.handles.add([E(this,"view.map.allLayers","change",this._preloadLayerViewModules,this._preloadLayerViewModules),C(this.view,["map.basemap","map.ground","map.layers","ready"],this._reschedule,!0)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),this._watchUpdatingTracking.destroy(),this._map=null}get _layersToLayerViews(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return m(this._workPromise)||this._watchUpdatingTracking.updating||F(this._layerLayerViewInfoMap,(e=>!e.done))}get updatingRemaining(){let e=0;for(const t of this._layerLayerViewInfoMap.values())t.done||++e;return e}clear(){if(!this.destroyed){for(const e of this._layerLayerViewInfoMap.values())e.destroy();this._layerLayerViewInfoMap.clear(),this._refreshCollections()}}async whenLayerView(e){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(e))throw new s("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e});return this._layerLayerViewInfoMap.get(e).promise}_refreshCollections(){for(const[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(e),this.get(t),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void(t&&t.removeAll());let r=0;for(const a of e){const e=this._layerLayerViewInfoMap.get(a);if(!e||!e.layerView)continue;const o=e.layerView;o.layer=a,o.parent=i,t.getItemAt(r)!==o&&t.splice(r,0,o),a.layers&&this._populateLayerViewsOwners(a.layers,o.layerViews,o),r+=1}r<t.length&&t.splice(r,t.length)}_createLayerView(e){if(this._layerLayerViewInfoMap.has(e))return this.view.ready&&this._layerLayerViewInfoMap.get(e).start(),this.notifyChange("updating"),void this.notifyChange("updatingRemaining");e.load().catch((()=>{})),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const t=new ge(e,this.view,this.layerViewImporter);t.promise.then((()=>this._refreshCollections()),(t=>{var i,r;t&&(M(t)||"cancelled:layerview-create"===t.name)||me.error(`Failed to create layerview for layer title:'${null!=(i=e.title)?i:"no title"}', id:'${null!=(r=e.id)?r:"no id"}' of type '${e.type}'.`,{layer:e,error:t});this._refreshCollections()})),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};e([U()],fe.prototype,"_workPromise",void 0),e([U({readOnly:!0})],fe.prototype,"_watchUpdatingTracking",void 0),e([U({readOnly:!0})],fe.prototype,"_layersToLayerViews",null),e([U({readOnly:!0})],fe.prototype,"_rootCollectionNames",null),e([U()],fe.prototype,"layerViewImporter",void 0),e([U()],fe.prototype,"supportsGround",void 0),e([U({readOnly:!0})],fe.prototype,"updating",null),e([U({readOnly:!0})],fe.prototype,"updatingRemaining",null),e([U({constructOnly:!0})],fe.prototype,"view",void 0),fe=e([A("esri.views.LayerViewManager")],fe);const ve=fe;class we{constructor(e,t){this._stage=e,this._textureRequests=new Map,this._frameTask=m(t)?t.registerTask(Q.TEXTURE_UNLOAD):Y}destroy(){this._frameTask.remove(),this._textureRequests.forEach((e=>this._releaseTextureRequest(e))),this._textureRequests.clear()}fromData(e,t){const i=this.makeUid(e);let r=this._textureRequests.get(i);return r||(r={referenceCount:0,texture:t(),textureAsync:null,abortController:null},this._stage&&(this._stage.add(r.texture),this._stage.loadSynchronous(r.texture)),this._textureRequests.set(i,r)),r.referenceCount++,{uid:i,texture:r.texture,release:()=>this._release(i)}}_release(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this._releaseNow(e)))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}_releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){var t;e.texture?null==(t=this._stage)||t.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return m(t)?`${e}.${t}px`:e}}const _e=["click","double-click","immediate-click","immediate-double-click","hold","drag","key-down","key-up","pointer-down","pointer-move","pointer-up","pointer-drag","mouse-wheel","pointer-enter","pointer-leave","gamepad","focus","blur"],be={};function ke(e){return!!be[e]}_e.forEach((e=>{be[e]=!0}));class Me{constructor(e){this.handlers=new Map,this.counter=0,this.handlerCounts=new Map,this.view=e,this.inputManager=null}connect(e){e&&this.disconnect(),this.inputManager=e,this.handlers.forEach((({handler:e,priority:t},i)=>this.inputManager.installHandlers(i,[e],t)))}disconnect(){this.inputManager&&this.handlers.forEach(((e,t)=>this.inputManager.uninstallHandlers(t))),this.inputManager=null}destroy(){this.disconnect(),this.handlers.clear(),this.view=null}on(e,t,i,r){const a=Array.isArray(e)?e:e.split(",");if(!function(e){for(const t of e)if(!ke(t))return!1;return!0}(a))return a.some(ke)&&console.error("Error: registering input events and other events on the view at the same time is not supported."),null;let o,s;Array.isArray(t)?s=t:(o=t,s=[]),"function"==typeof i?o=i:r=i,r=null!=r?r:X.DEFAULT;const n=this.createUniqueGroupName(),l=new je(this.view,a,s,o);this.handlers.set(n,{handler:l,priority:r});for(const e of a){const t=this.handlerCounts.get(e)||0;this.handlerCounts.set(e,t+1)}return this.inputManager&&this.inputManager.installHandlers(n,[l],r),{remove:()=>this.removeHandler(n,a)}}hasHandler(e){return!!this.handlerCounts.get(e)}removeHandler(e,t){if(this.handlers.has(e)){this.handlers.delete(e);for(const e of t){const t=this.handlerCounts.get(e);void 0===t?console.error("Trying to remove handler for event that has no handlers registered: ",e):1===t?this.handlerCounts.delete(e):this.handlerCounts.set(e,t-1)}}this.inputManager&&this.inputManager.uninstallHandlers(e)}createUniqueGroupName(){return this.counter+=1,`viewEvents_${this.counter}`}}class je extends J{constructor(e,t,i,r){super(!0),this.view=e;for(const e of t)switch(e){case"click":this.registerIncoming("click",i,(e=>r(this.wrapClick(e))));break;case"double-click":this.registerIncoming("double-click",i,(e=>r(this.wrapDoubleClick(e))));break;case"immediate-click":this.registerIncoming("immediate-click",i,(e=>r(this.wrapImmediateClick(e))));break;case"immediate-double-click":this.registerIncoming("immediate-double-click",i,(e=>r(this.wrapImmediateDoubleClick(e))));break;case"hold":this.registerIncoming("hold",i,(e=>r(this.wrapHold(e))));break;case"drag":this.registerIncoming("drag",i,(e=>{const t=this.wrapDrag(e);t&&r(t)}));break;case"key-down":this.registerIncoming("key-down",i,(e=>r(this.wrapKeyDown(e))));break;case"key-up":this.registerIncoming("key-up",i,(e=>r(this.wrapKeyUp(e))));break;case"pointer-down":this.registerIncoming("pointer-down",i,(e=>r(this.wrapPointer(e,"pointer-down"))));break;case"pointer-move":this.registerIncoming("pointer-move",i,(e=>r(this.wrapPointer(e,"pointer-move"))));break;case"pointer-up":this.registerIncoming("pointer-up",i,(e=>r(this.wrapPointer(e,"pointer-up"))));break;case"pointer-drag":this.registerIncoming("pointer-drag",i,(e=>r(this.wrapPointerDrag(e))));break;case"mouse-wheel":this.registerIncoming("mouse-wheel",i,(e=>r(this.wrapMouseWheel(e))));break;case"pointer-enter":this.registerIncoming("pointer-enter",i,(e=>r(this.wrapPointer(e,"pointer-enter"))));break;case"pointer-leave":this.registerIncoming("pointer-leave",i,(e=>r(this.wrapPointer(e,"pointer-leave"))));break;case"gamepad":this.registerIncoming("gamepad",i,(e=>{r(this.wrapGamepad(e))}));break;case"focus":this.registerIncoming("focus",i,(e=>{r(this.wrapFocus(e))}));break;case"blur":this.registerIncoming("blur",i,(e=>{r(this.wrapBlur(e))}))}}wrapFocus(e){return{type:"focus",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapBlur(e){return{type:"blur",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapClick(e){const{pointerType:t,button:i,buttons:r,x:a,y:o,native:s,eventId:n}=e.data,{cancelable:l,timestamp:p}=e;return{type:"click",pointerType:t,button:i,buttons:r,x:a,y:o,native:s,timestamp:p,screenPoint:te(a,o),mapPoint:this.getMapPoint(a,o),eventId:n,cancelable:l,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapDoubleClick(e){const{pointerType:t,button:i,buttons:r,x:a,y:o,native:s,eventId:n}=e.data,{cancelable:l,timestamp:p}=e;return{type:"double-click",pointerType:t,button:i,buttons:r,x:a,y:o,native:s,timestamp:p,mapPoint:this.getMapPoint(a,o),eventId:n,cancelable:l,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapImmediateClick(e){const{pointerType:t,button:i,buttons:r,x:a,y:o,native:s,eventId:n}=e.data,l=s.pointerId,{cancelable:p,timestamp:c}=e;return{type:"immediate-click",pointerId:l,pointerType:t,button:i,buttons:r,x:a,y:o,native:s,timestamp:c,mapPoint:this.getMapPoint(a,o),eventId:n,cancelable:p,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapImmediateDoubleClick(e){const{pointerType:t,button:i,buttons:r,x:a,y:o,native:s,eventId:n}=e.data,l=s.pointerId,{cancelable:p,timestamp:c}=e;return{type:"immediate-double-click",pointerId:l,pointerType:t,button:i,buttons:r,x:a,y:o,native:s,timestamp:c,mapPoint:this.getMapPoint(a,o),eventId:n,cancelable:p,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapHold(e){const{pointerType:t,button:i,buttons:r,x:a,y:o,native:s}=e.data,{cancelable:n,timestamp:l}=e;return{type:"hold",pointerType:t,button:i,buttons:r,x:a,y:o,native:s,timestamp:l,mapPoint:this.getMapPoint(a,o),cancelable:n,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}getMapPoint(e,t){return this.view.toMap(te(e,t),{exclude:[]})}wrapDrag(e){const t=e.data,{x:i,y:r}=t.center,{action:a,pointerType:o,button:s}=t;if("start"===a&&(this.latestDragStart=t),!this.latestDragStart)return;const n=t.pointer.native,l=t.buttons,{cancelable:p,timestamp:c}=e,u={x:this.latestDragStart.center.x,y:this.latestDragStart.center.y};return"end"===a&&(this.latestDragStart=void 0),{type:"drag",action:a,x:i,y:r,origin:u,pointerType:o,button:s,buttons:l,radius:t.radius,angle:Z(t.angle),native:n,timestamp:c,cancelable:p,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapKeyDown(e){const{key:t,repeat:i,native:r}=e.data,{cancelable:a,timestamp:o}=e;return{type:"key-down",key:t,repeat:i,native:r,timestamp:o,cancelable:a,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapKeyUp(e){const{key:t,native:i}=e.data,{cancelable:r,timestamp:a}=e;return{type:"key-up",key:t,native:i,timestamp:a,cancelable:r,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapPointer(e,t){const{x:i,y:r,button:a,buttons:o,native:s,eventId:n}=e.data,l=s.pointerId,p=s.pointerType,{cancelable:c,timestamp:u}=e;return{type:t,x:i,y:r,pointerId:l,pointerType:p,button:a,buttons:o,native:s,timestamp:u,eventId:n,cancelable:c,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapPointerDrag(e){const{x:t,y:i,buttons:r,native:a,eventId:o}=e.data.currentEvent,{button:s}=e.data.startEvent,n=e.data.startEvent.native.pointerId,l=e.data.startEvent.native.pointerType,p=e.data.action,c={x:e.data.startEvent.x,y:e.data.startEvent.y},{cancelable:u,timestamp:h}=e;return{type:"pointer-drag",x:t,y:i,pointerId:n,pointerType:l,button:s,buttons:r,action:p,origin:c,native:a,timestamp:h,eventId:o,cancelable:u,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapMouseWheel(e){const{cancelable:t,data:i,timestamp:r}=e,{x:a,y:o,deltaY:s,native:n}=i;return{type:"mouse-wheel",x:a,y:o,deltaY:s,native:n,timestamp:r,cancelable:t,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapGamepad(e){const{action:t,state:i,device:r}=e.data,{cancelable:a,timestamp:o}=e,{buttons:s,axes:n}=i;return{type:"gamepad",device:r,timestamp:o,action:t,buttons:s,axes:n,cancelable:a,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}}class Te{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._currentlyActiveTool=null,this._revertToActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}handleInputEvent(e,t){const i=()=>e.stopPropagation();switch(e.type){case"pointer-move":Ie(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(i(),"end"===e.action&&(this._stopDrag=!1));break;case"pointer-down":{if(!Re(e))break;const r=ae(e),a=this._intersect(r,e.pointerType,t.forEachTool);if(y(a))break;const o=this._findToolAndManipulatorByKey(a,t.forEachTool,Se),s=f(o,(e=>e.manipulator)),n=f(o,(e=>e.tool));!(m(s)&&m(n)&&s.interactive)||s.grabbable&&s.grabbableForEvent(e)||!s.grabbing||s.dragging||this._ungrabManipulatorBeforeDragging(s,n,e),m(s)&&s.interactive&&s.grabbable&&s.grabbableForEvent(e)&&!s.grabbing&&(this._grabbedManipulators.set(e.pointerId,{key:a,start:r,pointerType:e.pointerType}),1===this._grabbedManipulators.size&&t.activeTool!==a.tool&&(this._currentlyActiveTool=t.activeTool,this._revertToActiveTool=!0,t.setActiveTool(a.tool)),s.grabbing=!0,s.events.emit("grab-changed",{action:"start",pointerType:e.pointerType,screenPoint:r}),i());break}case"pointer-up":this._handlePointerEnd(e,t);break;case"pointer-drag":{if(!Re(e))break;const r=this._grabbedManipulators.get(e.pointerId),a=this._draggedManipulators.get(e.pointerId),o=f(r||a,(({key:e})=>e)),s=this._findManipulatorByKey(o,t.forEachTool);if(y(s))break;const n=ae(e);n.x=ee(n.x,0,t.view.width),n.y=ee(n.y,0,t.view.height);const l=v(r||a).start;switch(e.action){case"start":case"update":"update"!==e.action&&1!==this._grabbedManipulators.size||(s.dragging=!0,a?s.events.emit("drag",{action:"update",start:l,screenPoint:n}):s.events.emit("drag",{action:"start",start:l,screenPoint:n,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{key:v(o),start:l}));break;case"end":s.dragging=!1,a&&s.events.emit("drag",{action:"end",start:l,screenPoint:n}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,t)}i();break}case"immediate-click":{const r=ae(e),a=this._intersect(r,e.pointerType,t.forEachTool),o=this._findToolAndManipulatorByKey(a,t.forEachTool,Se);if(e.native.shiftKey||t.forEachTool((e=>{if((!m(o)||o.tool!==e||e.automaticManipulatorSelection)&&e.manipulators){let t=!1;e.manipulators.forEach((({manipulator:e})=>{e.selected&&(e.selected=!1,t=!0)})),t&&e.manipulatorSelectionChanged&&e.manipulatorSelectionChanged()}})),y(o))break;const{manipulator:s,tool:n}=o;if(!s.interactive)break;s.selectable&&n.automaticManipulatorSelection&&(s.selected=!s.selected,n.manipulatorSelectionChanged&&n.manipulatorSelectionChanged());const l=e.native.shiftKey;s.events.emit("immediate-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:l,stopPropagation:i});break}case"click":{const r=ae(e),a=this._intersect(r,e.pointerType,t.forEachTool),o=this._findManipulatorByKey(a,t.forEachTool);if(y(o)||!o.interactive)break;const s=e.native.shiftKey;o.events.emit(e.type,{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:s}),i();break}case"double-click":{const r=ae(e),a=this._intersect(r,e.pointerType,t.forEachTool),o=this._findManipulatorByKey(a,t.forEachTool);if(y(o)||!o.interactive)break;const s=e.native.shiftKey;o.events.emit("double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:s,stopPropagation:i});break}case"immediate-double-click":{const r=ae(e),a=this._intersect(r,e.pointerType,t.forEachTool),o=this._findManipulatorByKey(a,t.forEachTool);if(y(o)||!o.interactive)break;const s=e.native.shiftKey;o.events.emit("immediate-double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:s,stopPropagation:i});break}}this._updateCursor(t.forEachTool)}_ungrabManipulatorBeforeDragging(e,t,i){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",pointerType:i.pointerType,screenPoint:ae(i)}),this._grabbedManipulators.forEach((({key:i},r)=>{i.tool===t&&t.manipulators.findById(i.manipulatorId)===e&&this._grabbedManipulators.delete(r)}))}_handlePointerEnd(e,t){const i=f(this._grabbedManipulators.get(e.pointerId),(({key:e})=>e)),r=this._findManipulatorByKey(i,t.forEachTool);m(r)&&!r.dragging&&(1===this._grabbedManipulators.size&&0===this._draggedManipulators.size&&this._revertToActiveTool&&(t.setActiveTool(this._currentlyActiveTool),this._revertToActiveTool=!1,this._currentlyActiveTool=null),r.grabbing&&(r.grabbing=!1,r.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:ae(e)})),this._grabbedManipulators.delete(e.pointerId))}_cursorFromMap(e,t){let i=null;return F(e,(({key:e})=>{const r=this._findManipulatorByKey(e,t);return!!(m(r)&&r.interactive&&"cursor"in r&&r.cursor)&&(i=r.cursor,!0)})),i}_updateCursor(e){this._grabbedManipulators.size>0?this._cursor=this._cursorFromMap(this._grabbedManipulators,e)||"grabbing":this._hoveredManipulators.size>0?this._cursor=this._cursorFromMap(this._hoveredManipulators,e)||"pointer":this._cursor=null}clearPointers(e,t,i=!0,r){const a=t=>t.tool===e&&(y(r)||t.manipulatorId===r);this._grabbedManipulators.forEach((({key:e,pointerType:i},r)=>{if(a(e)){this._grabbedManipulators.delete(r);const a=this._findManipulatorByKey(e,t);m(a)&&(a.grabbing=!1,a.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:i}))}})),this._draggedManipulators.forEach((({key:e},i)=>{if(a(e)){this._draggedManipulators.delete(i);const r=this._findManipulatorByKey(e,t);m(r)&&(r.dragging=!1,r.events.emit("drag",{action:"cancel"}))}})),i&&this._hoveredManipulators.forEach((({key:e},i)=>{if(a(e)){this._hoveredManipulators.delete(i);const r=this._findManipulatorByKey(e,t);m(r)&&(r.hovering=!1)}})),this._updateCursor(t)}_intersect(e,t,i){let r=null;return i((i=>{if(null==i.manipulators||!ie(i))return!1;const a=i.manipulators.intersect(e,t);return!y(a)&&(r={manipulatorId:a.id,tool:i},!0)})),r}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach(((t,i)=>{this._updateHoveredStateForPointerAtScreenPosition(te(t.x,t.y),i,t.pointerType,e)}))}handleHoverEvent(e,t){"pointer-up"!==e.type&&"immediate-click"!==e.type&&"pointer-move"!==e.type||!Ie(e.pointerType)||this._updateHoveredStateForPointerAtScreenPosition(ae(e),e.pointerId,e.pointerType,t)}_updateHoveredStateForPointerAtScreenPosition(e,t,i,r){const a=this._intersect(e,i,r);let o=this._findManipulatorByKey(a,r);const s=f(this._hoveredManipulators.get(t),(({key:e})=>e)),n=this._findManipulatorByKey(s,r);m(o)&&!o.interactive&&(o=null),n!==o&&(m(n)&&(n.hovering=!1),m(o)?(o.hovering=!0,this._hoveredManipulators.set(t,{key:v(a)})):this._hoveredManipulators.delete(t),this._updateCursor(r))}_findManipulatorByKey(e,t){return this._findToolAndManipulatorByKey(e,t,Se)?Se.manipulator:null}_findToolAndManipulatorByKey(e,t,i){return y(e)?null:(i.tool=null,i.manipulator=null,t((t=>{if(t!==e.tool||null==t.manipulators||!ie(t))return!1;const r=t.manipulators.findById(e.manipulatorId);return!!m(r)&&(i.manipulator=r,i.tool=t,!0)})),i.manipulator?i:null)}}function Ie(e){return"mouse"===e}function Re(e){return"mouse"!==e.pointerType||0===e.button}const Se={manipulator:null,tool:null},Ve=d.getLogger("esri.views.ToolViewManager");let xe=class extends l{constructor(e){super(e),this._manipulatorState=new Te,this.tools=new a,this.cursor=null,this._forEachTool=e=>{for(const t of this.tools.items)if(e(t))return}}initialize(){this.handles.add([this.view.on(_e,(e=>{this._handleInputEvent(e)}),X.TOOL),...re(this.tools),this.tools.on("before-add",(e=>{const t=e.item;if(null==t||this.tools.includes(t))return Ve.warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void e.preventDefault()})),this.tools.on("before-remove",(({item:e})=>{this._manipulatorState.clearPointers(e,this._forEachTool)})),this.tools.on("change",(()=>{this._refreshToolWatchers()}))])}destroy(){this._forEachTool((e=>e.destroy()))}set activeTool(e){if(m(e)&&!this.view.ready)return void Ve.error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return void(m(e)&&Ve.warn("Tool is already active - ignoring activation request."));m(this.activeTool)&&this.activeTool.deactivate(),m(e)&&e.activate(),this._set("activeTool",e),this._removeIncompleteTools(e);const t=y(this.activeTool);for(const e of this.tools){e.setEditableFlag(1,t||e===this.activeTool);const i=ie(e);!t&&i||this._manipulatorState.clearPointers(e,this._forEachTool,!i)}this._updateCursor()}get updating(){return this.updatingHandles.updating||this.tools.some((e=>e.updating))}attach(){this._forEachTool((e=>e.attach())),"3d"===this.view.type?(this._set("textures",new we(this.view._stage,this.view.resourceController.scheduler)),this.handles.add([this.view.state.watch("camera",(()=>{this._forEachManipulator((e=>{null!=e.onViewChange&&e.onViewChange()}))})),this.view.elevationProvider.on("elevation-change",(e=>{this._forEachManipulator((t=>{null!=t.onElevationChange&&t.onElevationChange(e)}))})),u((()=>this._set("textures",w(this.textures))))],"attached")):this.handles.add(this.view.watch("extent",(()=>{this._forEachManipulator((e=>{null!=e.onViewChange&&e.onViewChange()}))})))}detach(){m(this.activeTool)&&(this.activeTool=null),this._forEachTool((e=>{e.detach(),e.destroy()})),this.tools.removeAll(),this.handles.remove("attached")}_forEachManipulator(e){this._forEachTool((t=>{t.manipulators&&t.manipulators.forEach((({manipulator:i})=>e(i,t)))}))}_handleInputEvent(e){let t=!1;const i={...e,stopPropagation:()=>{t=!0,e.stopPropagation()}};m(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool((e=>{!t&&e.attached&&e.visible&&e.handleInputEvent(i)})),!t&&"key-down"===e.type&&"Escape"===e.key&&this.activeTool&&(e.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},view:this.view}),!t&&m(this.activeTool)&&this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor()}_refreshToolWatchers(){this.handles.remove("tools"),this._forEachTool((e=>{if(e instanceof r){const t=P(e,["cursor","visible","editable"],(()=>{ie(e)||this._manipulatorState.clearPointers(e,this._forEachTool),this._updateCursor()}));this.handles.add(t,"tools")}e.manipulators&&this.handles.add(e.manipulators.on("change",(t=>{t.removed.forEach((({id:t})=>{this._manipulatorState.clearPointers(e,this._forEachTool,!0,t)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()})),"tools")})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateCursor(){let e=this._manipulatorState.cursor;this._forEachTool((t=>!(!m(t.cursor)||!t.visible)&&(e=t.cursor,!0))),this._get("cursor")!==e&&this._set("cursor",e)}_removeIncompleteTools(e){this.tools.filter((t=>(y(e)||t!==e)&&!t.completed)).forEach((e=>{this.tools.remove(e),e.destroy()}))}};e([U({constructOnly:!0,nonNullable:!0})],xe.prototype,"view",void 0),e([U({readOnly:!0,nonNullable:!0})],xe.prototype,"textures",void 0),e([U({value:null})],xe.prototype,"activeTool",null),e([U({readOnly:!0,type:a})],xe.prototype,"tools",void 0),e([U({readOnly:!0})],xe.prototype,"cursor",void 0),e([U({readOnly:!0})],xe.prototype,"updating",null),xe=e([A("esri.views.ToolViewManager")],xe);const Ee=xe,Ce=d.getLogger("esri.views.support.DefaultsFromMap");Ce.level="info";let Pe=class extends r{constructor(e){super(e),this._handles=new ne,this.required={tileInfo:!1,heightModelInfo:!1,extent:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.priorityCollection=null,this.logDebugInformation=!1,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._handles=w(this._handles),this._projectExtentTask.task&&(this._debug("Aborting project extent task"),this._projectExtentTask.task=_(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return m(this.userSpatialReference)?this.userSpatialReference:v(this._spatialReferenceTask.spatialReference)}get extent(){return v(this._extentTask.extent)}get heightModelInfo(){return v(this._heightModelInfoTask.heightModelInfo)}get vcsWkid(){return v(this._heightModelInfoTask.vcsWkid)}get latestVcsWkid(){return v(this._heightModelInfoTask.latestVcsWkid)}get viewingMode(){return y(this.userSpatialReference)||this.userSpatialReference.equals(v(this._spatialReferenceTask.spatialReference))?v(this._spatialReferenceTask.viewingMode):null}get tileInfo(){return v(this._tileInfoTask.tileInfo)}get mapCollections(){var e,t,i,r;const a=null==(e=this.map)?void 0:e.call(this),o=[];return m(this.priorityCollection)&&o.push(this.priorityCollection),o.push({parent:null==a?void 0:a.basemap,layers:null==a||null==(t=a.basemap)?void 0:t.baseLayers},{layers:null==a?void 0:a.layers},{parent:null==a?void 0:a.ground,layers:null==a||null==(i=a.ground)?void 0:i.layers},{parent:null==a?void 0:a.basemap,layers:null==a||null==(r=a.basemap)?void 0:r.referenceLayers}),o}get _allLayers(){var e,t;const i=this._collectLayers(this.mapCollections);return this._debug("Collected",null!=(e=null==(t=i.layers)?void 0:t.length)?e:0,"layers, updating",i.updating),i}get _spatialReferenceTask(){var e,t;if(this.suspended)return null!=(t=this._get("_spatialReferenceTask"))?t:{updating:!1};const{layers:i,updating:r}=this._allLayers,a={candidates:null};for(const e of i)if(this._processSpatialReferenceCandidates(e,a),a.candidates&&1===a.candidates.length)break;if(1!==(null==(e=a.candidates)?void 0:e.length)&&r)return{updating:!0};const o=this._pickSpatialReferenceCandidate(a.candidates);return this._debug("Finished spatial reference",m(o)?`${o.spatialReference.wkid}:${m(o.viewingMode)?de(o.viewingMode):"global/local"}`:"none available"),{spatialReference:m(o)?o.spatialReference:null,viewingMode:m(o)?o.viewingMode:null,updating:!1}}get _tileInfoTask(){var e,t,i,r,a,o,s,n;if(!this.required.tileInfo)return null!=(n=this._get("_tileInfoTask"))?n:{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{layers:l,updating:p}=this._collectLayers([{parent:null==(e=this.map)||null==(t=e.call(this))?void 0:t.basemap,layers:null==(i=this.map)||null==(r=i.call(this))||null==(a=r.basemap)?void 0:a.baseLayers},{layers:null==(o=this.map)||null==(s=o.call(this))?void 0:s.layers}]);if(l&&l.length>0&&"tileInfo"in l[0]){const e=l[0].tileInfo;return{tileInfo:e&&e.spatialReference.equals(this.spatialReference)?e:null,updating:!1}}return{updating:p}}get _heightModelInfoTask(){var e,t;if(!this.required.heightModelInfo||this.suspended&&null!=(e=this._get("_heightModelInfoTask"))&&e.heightModelInfo)return null!=(t=this._get("_heightModelInfoTask"))?t:{updating:!1};const{layers:i,updating:r}=this._allLayers;for(const e of i){var a,o;if(this._debug("Considering",null!=(a=null!=(o=e.title)?o:e.id)?a:e.declaredClass,"for height model info"),ue(e)){const t=he(e);var s,n;if(t)return this._debug("Derived height model info",t),{heightModelInfo:t,vcsWkid:null==(s=e.spatialReference)?void 0:s.vcsWkid,latestVcsWkid:null==(n=e.spatialReference)?void 0:n.latestVcsWkid,updating:!1}}this._debug("Layer does not support height models")}return this._debug("No height model info found,","updating",r),{updating:r}}get _extentCandidatesTask(){var e;if(this.suspended||!this.required.extent)return null!=(e=this._get("_extentCandidatesTask"))?e:{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const t=this._allLayers,i=t.updating,r=[];for(const e of t.layers){const t="fullExtents"in e&&e.fullExtents||(m(e.fullExtent)?[e.fullExtent]:[]),i=t.find((e=>e.spatialReference.equals(this.spatialReference)));if(i)return{candidates:[{extent:i,layer:e}],updating:!1};if(this._getSupportedSpatialReferences(e).length>0)for(const i of t)r.push({extent:i,layer:e})}return{candidates:r,updating:i}}get _extentTask(){const{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(y(e)||0===e.length)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{candidate:i,requiresGeometryService:r}=this._pickExtentCandidate(e),a=this.spatialReference;if(i.extent.equals(this._projectExtentTask.input)&&a.equals(this._projectExtentTask.spatialReference))return{extent:this._projectExtentTask.output,updating:m(this._projectExtentTask.task)&&!this._projectExtentTask.task.finished};if(m(this._projectExtentTask.task)&&(this._debug("Aborting project extent task"),this._projectExtentTask.task=_(this._projectExtentTask.task)),!r){this._projectExtentTask={input:null,output:null,task:null,spatialReference:null};try{return{extent:le(i.extent,a),updating:!1}}catch{return{updating:!1}}}return this._debug("Starting project extent task for",i.extent),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:a.clone(),task:I((async e=>{try{const t=await R(import("../chunks/geometryServiceUtils.js"),e),r=await t.projectGeometry(i.extent,a,i.layer.portalItem,e);this._debug("Project extent task finished",r),this._projectExtentTask={...this._projectExtentTask,task:null,output:r}}catch(t){if(S(e))return;this._projectExtentTask={...this._projectExtentTask,task:null}}}))},{updating:!0}}_processSpatialReferenceCandidates(e,t){var i;const r=this._getSupportedSpatialReferences(e);if(0!==r.length)if(this._debug("Spatial reference candidates from",null!=(i=e.title)?i:e.id,":",r.map((e=>`${e.spatialReference.wkid}:${m(e.viewingMode)?de(e.viewingMode):"global/local"}`)).join(", ")),t.candidates){const e=[],i=(e,t)=>y(e.viewingMode)?t.viewingMode:(y(t.viewingMode)||e.viewingMode===t.viewingMode)&&e.viewingMode;for(const a of t.candidates)for(const t of r){if(!a.spatialReference.equals(t.spatialReference))continue;const r=i(a,t);if(!1!==r){e.push({spatialReference:a.spatialReference,viewingMode:r});break}}e.length>0&&(t.candidates=e)}else t.candidates=r}_pickSpatialReferenceCandidate(e){const t=this.defaultSpatialReference;return!e||e.length<1?m(t)?{spatialReference:t,viewingMode:null}:null:m(t)&&e.length>1&&e.some((({spatialReference:e})=>e.equals(t)))?{spatialReference:t,viewingMode:null}:e[0]}_getSupportedSpatialReferences(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===t.length)return[];const i=[];for(const r of t){const t=this.getSpatialReferenceSupport({spatialReference:r,layer:e});if(m(t)){const e=m(t.constraints)?t.constraints:[{spatialReference:r}];for(const{spatialReference:t,viewingMode:r}of e)(y(this.userSpatialReference)||t.equals(this.userSpatialReference))&&i.push({spatialReference:t,viewingMode:r})}}return i}_pickExtentCandidate(e){const t=this.spatialReference,i=e.find((({extent:e})=>pe(e.spatialReference,t)||ce()));return m(i)?{candidate:i,requiresGeometryService:!1}:{candidate:e[0],requiresGeometryService:!0}}_collectLayers(e){var t;if("loaded"!==this._loadMaybe(null==(t=this.map)?void 0:t.call(this)))return{layers:[],updating:!0};const i={layers:[],preloading:-1,updating:!1};for(const t of e)if(this._collectCollection(t,i),10===i.preloading)break;return{layers:i.layers,updating:i.updating}}_collectCollection(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const a of e.layers){switch(this._loadMaybe(a)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":var i,r;if(!t.updating)this._debug("Considering layer",null!=(i=null!=(r=a.title)?r:a.id)?i:a.declaredClass),t.layers.push(a);"layers"in a&&this._collectCollection({layers:a.layers},t)}if(10===t.preloading)break}}}_loadMaybe(e){return e&&"loadStatus"in e?"not-loaded"===e.loadStatus?(this._debug("Triggering load",null!=(t=null!=(i=e.title)?i:e.id)?t:e.declaredClass),e.load(),"loading"):e.loadStatus:"loaded";var t,i}_debug(...e){this.logDebugInformation&&Ce.info(...e)}};e([U()],Pe.prototype,"required",void 0),e([U({constructOnly:!0})],Pe.prototype,"map",void 0),e([U({constructOnly:!0})],Pe.prototype,"getSpatialReferenceSupport",void 0),e([U()],Pe.prototype,"defaultSpatialReference",void 0),e([U()],Pe.prototype,"userSpatialReference",void 0),e([U()],Pe.prototype,"priorityCollection",void 0),e([U()],Pe.prototype,"logDebugInformation",void 0),e([U()],Pe.prototype,"suspended",void 0),e([U({readOnly:!0})],Pe.prototype,"ready",null),e([U({readOnly:!0})],Pe.prototype,"heightModelInfoReady",null),e([U({readOnly:!0})],Pe.prototype,"spatialReference",null),e([U({readOnly:!0})],Pe.prototype,"extent",null),e([U({readOnly:!0})],Pe.prototype,"heightModelInfo",null),e([U({readOnly:!0})],Pe.prototype,"vcsWkid",null),e([U({readOnly:!0})],Pe.prototype,"latestVcsWkid",null),e([U({readOnly:!0})],Pe.prototype,"viewingMode",null),e([U({readOnly:!0})],Pe.prototype,"tileInfo",null),e([U({readOnly:!0})],Pe.prototype,"mapCollections",null),e([U({readOnly:!0})],Pe.prototype,"_allLayers",null),e([U({readOnly:!0})],Pe.prototype,"_spatialReferenceTask",null),e([U({readOnly:!0})],Pe.prototype,"_tileInfoTask",null),e([U({readOnly:!0})],Pe.prototype,"_heightModelInfoTask",null),e([U({readOnly:!0})],Pe.prototype,"_extentCandidatesTask",null),e([U()],Pe.prototype,"_extentTask",null),e([U()],Pe.prototype,"_projectExtentTask",void 0),Pe=e([A("esri.views.support.DefaultsFromMap")],Pe);const Le=Pe;var De;const Oe=d.getLogger("esri.views.View");let Fe=De=class extends(c(n.EventedMixin(b(r)))){constructor(e){super(e),this._userSpatialReference=null,this._cursor=null,this.allLayerViews=new o({getCollections:()=>{var e,t,i;return[null==(e=this.basemapView)?void 0:e.baseLayerViews,null==(t=this.groundView)?void 0:t.layerViews,this.layerViews,null==(i=this.basemapView)?void 0:i.referenceLayerViews]},getChildrenFunction:e=>e.layerViews}),this.groundView=null,this.animation=null,this.basemapView=null,this.fatalError=null,this.extent=null,this.graphics=new K,this.analyses=new ye,this.navigating=!1,this.typeSpecificPreconditionsReady=!0,this.layerViews=new a,this.magnifier=new $,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this.spatialReferenceWarningDelay=1e3,this.supportsGround=!0,this.timeExtent=null,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.input=new oe,this.navigation=new se,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new Me(this),this.persistableViewModels=new a,this._isValid=!1,this._readyCycleForced=!1,this.handles.add(this.watch("preconditionsReady",(e=>{var t,i;(e?(this._currentSpatialReference=this.spatialReference,De.views.add(this)):(this._currentSpatialReference=null,De.views.remove(this)),this.notifyChange("spatialReference"),!e&&this.ready)?(null==(t=this.layerViewManager)||t.clear(),null==(i=this.toolViewManager)||i.detach(),m(this.analysisViewManager)&&this.analysisViewManager.detach(),this._teardown()):e&&!this.ready&&(m(this.analysisViewManager)&&this.analysisViewManager.attach(),this._startup(),this.toolViewManager.attach())}),!0))}initialize(){this.addResolvingPromise(this.validate().then((()=>(this._isValid=!0,L(this,"ready"))))),this.basemapView=new z({view:this}),this.layerViewManager=new ve({view:this,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.toolViewManager=new Ee({view:this}),this._setupSpatialReferenceLogger(),this.handles.add([x((()=>this.initialExtentRequired),(e=>this.defaultsFromMap.required={...this.defaultsFromMap.required,extent:e}),{sync:!0,initial:!0}),x((()=>this.ready),(e=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=e,this.defaultsFromMap.userSpatialReference=e?this.spatialReference:this._userSpatialReference)}),{sync:!0}),x((()=>this._userSpatialReference),(e=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=e)}),{sync:!0,initial:!0})])}_setupSpatialReferenceLogger(){let e=null;this.handles.add([x((()=>{var e;return null==(e=this.defaultsFromMap)?void 0:e.ready}),(t=>{var i;const r=(null==(i=this.map)?void 0:i.allLayers.length)>0;if(t&&!this.spatialReference&&r){if(m(e))return;const t=u((()=>e=_(e)));e=I((async t=>{try{await V(this.spatialReferenceWarningDelay,null,t)}catch{return}finally{e=null}Oe.warn("#spatialReference","no spatial reference could be derived from the currently added map layers")})),this.handles.add(t,"spatial-reference-logger-task")}else this.handles.remove("spatial-reference-logger-task")}),{sync:!0})])}destroy(){if(this.destroyed)return;this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=w(this.graphics),this.analyses=w(this.analyses),this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),this.toolViewManager=w(this.toolViewManager),this.layerViewManager=w(this.layerViewManager),this.basemapView=w(this.basemapView),this.invalidate(),this._emitter.clear(),this.handles.removeAll();const e=this.map;this.map=null,null==e||e.destroy()}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return Oe.error("#toMap()","Not implemented on this instance of View"),null}get _defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new Le({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:e=>this.getSpatialReferenceSupport(e),...this._defaultsFromMapSettings})}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get interacting(){return this.navigating}get preconditionsReady(){var e;return!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||h.isLoadable(this.map)&&!this.map.loaded||0===this.width||0===this.height||!this.spatialReference||!this.typeSpecificPreconditionsReady||!this._validateSpatialReference(this.spatialReference)||!(this._currentSpatialReference||null!=(e=this.defaultsFromMap)&&e.ready))}set map(e){var t;e!==this._get("map")&&(null!=(t=e)&&t.destroyed&&(Oe.warn("#map","The provided map is already destroyed",{map:e}),e=null),h.isLoadable(e)&&e.load().catch((()=>{})),this.initialized&&(this.forceReadyCycle(),this._currentSpatialReference=null),this._set("map",e))}get spatialReference(){var e,t;let i=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return i&&null!=(e=this.defaultsFromMap)&&null!=(t=e.required)&&t.heightModelInfo&&(i=i.clone(),i.vcsWkid=this.defaultsFromMap.vcsWkid,i.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),i}set spatialReference(e){this._userSpatialReference=e,this._set("spatialReference",e)}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get initialExtent(){var e;return null==(e=this.defaultsFromMap)?void 0:e.extent}get cursor(){const e=this.toolViewManager?this.toolViewManager.cursor:null;return m(e)?e:this._cursor||"default"}set cursor(e){this._cursor=e,this.notifyChange("cursor")}get size(){return[this.width,this.height]}whenLayerView(e){return this.layerViewManager.whenLayerView(e)}getDefaultSpatialReference(){var e;return null==(e=this.defaultsFromMap)?void 0:e.spatialReference}getDefaultHeightModelInfo(){var e,t,i;return null!=(e=null!=(t=this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)?t:null==(i=this.defaultsFromMap)?void 0:i.heightModelInfo)?e:null}importLayerView(e){throw new s("importLayerView() not implemented")}hasLayerViewModule(e){return!1}async validate(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{}}_validateSpatialReference(e){return m(this.getSpatialReferenceSupport({spatialReference:e}))}when(e,t){return this.isResolved()&&!this.ready&&Oe.warn("#when()",'Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use watchUtils.whenOnce(view, "ready").then(...) instead.'),super.when(e,t)}forceReadyCycle(){this.ready&&(D(this,"preconditionsReady",(()=>this._readyCycleForced=!1)),this._readyCycleForced=!0)}addAndActivateTool(e){this.toolViewManager.tools.add(e),this.activeTool=e}tryFatalErrorRecovery(){this.fatalError=null}};Fe.views=new a,e([U()],Fe.prototype,"_userSpatialReference",void 0),e([O("toolViewManager.activeTool")],Fe.prototype,"activeTool",void 0),e([U({readOnly:!0})],Fe.prototype,"allLayerViews",void 0),e([U()],Fe.prototype,"groundView",void 0),e([U()],Fe.prototype,"animation",void 0),e([U()],Fe.prototype,"basemapView",void 0),e([U({readOnly:!0})],Fe.prototype,"_defaultsFromMapSettings",null),e([U()],Fe.prototype,"defaultsFromMap",null),e([U()],Fe.prototype,"fatalError",void 0),e([U({type:G})],Fe.prototype,"extent",void 0),e([U(B(K,"graphics"))],Fe.prototype,"graphics",void 0),e([U(B(ye,"analyses"))],Fe.prototype,"analyses",void 0),e([U({readOnly:!0,type:W})],Fe.prototype,"heightModelInfo",null),e([U({readOnly:!0})],Fe.prototype,"interacting",null),e([U({readOnly:!0})],Fe.prototype,"navigating",void 0),e([U({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],Fe.prototype,"preconditionsReady",null),e([U({readOnly:!0})],Fe.prototype,"typeSpecificPreconditionsReady",void 0),e([U({type:a,readOnly:!0})],Fe.prototype,"layerViews",void 0),e([U({type:$})],Fe.prototype,"magnifier",void 0),e([U({value:null,type:t})],Fe.prototype,"map",null),e([U()],Fe.prototype,"padding",void 0),e([U({readOnly:!0})],Fe.prototype,"ready",void 0),e([U({type:H})],Fe.prototype,"spatialReference",null),e([U()],Fe.prototype,"spatialReferenceWarningDelay",void 0),e([U()],Fe.prototype,"stationary",null),e([U({readOnly:!0})],Fe.prototype,"supportsGround",void 0),e([U({type:i})],Fe.prototype,"timeExtent",void 0),e([O("toolViewManager.tools")],Fe.prototype,"tools",void 0),e([U()],Fe.prototype,"toolViewManager",void 0),e([U({readOnly:!0})],Fe.prototype,"type",void 0),e([U({type:Number})],Fe.prototype,"scale",void 0),e([U({readOnly:!0})],Fe.prototype,"updating",void 0),e([U({readOnly:!0})],Fe.prototype,"initialExtentRequired",void 0),e([U({readOnly:!0,type:G})],Fe.prototype,"initialExtent",null),e([U()],Fe.prototype,"cursor",null),e([U({readOnly:!0})],Fe.prototype,"input",void 0),e([U({type:se,nonNullable:!0})],Fe.prototype,"navigation",void 0),e([U()],Fe.prototype,"layerViewManager",void 0),e([U()],Fe.prototype,"analysisViewManager",void 0),e([U()],Fe.prototype,"width",void 0),e([U()],Fe.prototype,"height",void 0),e([U({readOnly:!0})],Fe.prototype,"resizing",void 0),e([U({value:null,readOnly:!0})],Fe.prototype,"size",null),e([U({readOnly:!0})],Fe.prototype,"suspended",void 0),e([U({readOnly:!0})],Fe.prototype,"viewEvents",void 0),e([U({readOnly:!0})],Fe.prototype,"persistableViewModels",void 0),e([U()],Fe.prototype,"_isValid",void 0),e([U()],Fe.prototype,"_readyCycleForced",void 0),e([U()],Fe.prototype,"_currentSpatialReference",void 0),Fe=De=e([A("esri.views.View")],Fe);const Ue=Fe;export{we as T,Ue as default};
