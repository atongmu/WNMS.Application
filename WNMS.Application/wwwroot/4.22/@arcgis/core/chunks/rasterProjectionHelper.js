/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import"../geometry.js";import e from"../core/Error.js";import{b as n,i as t}from"../core/lang.js";import{d as a}from"./unitUtils.js";import{isLoaded as i,load as o,project as s,canProjectWithoutEngine as r,getTransformation as l}from"../geometry/projection.js";import c from"../geometry/Extent.js";import f from"../geometry/Point.js";function u(e,n,t){return!r(e,n,t)}function x(n,t,a){const o=u(n,t,a);if(o&&!i())throw new e("rasterprojectionhelper-project","projection engine is not loaded");return o}const m=function(e,n,t){const a=(e[0]+e[4]+e[4*n.cols]+e[4*n.cols+4])/4,i=(e[1]+e[5]+e[4*n.rows+1]+e[4*n.rows+5])/4,o=(e[4*n.cols]-e[0]+e[4*n.cols+4]-e[4])/t[0]*.5,s=(e[4*n.cols+1]-e[1]+e[4*n.cols+5]-e[5])/t[1]*.5;return[0===o||isNaN(o)?0:Math.abs(a-e[2*n.rows+2])/Math.abs(o),0===s||isNaN(s)?0:Math.abs(i-e[2*n.rows+3])/Math.abs(s)]},p={3395:20037508.342789244,3410:17334193.943686873,3857:20037508.342788905,3975:17367530.445161372,4087:20037508.342789244,4088:20015108.787169147,6933:17367530.445161372,32662:20037508.342789244,53001:20015086.79602057,53002:10007543.39801029,53003:20015086.79602057,53004:20015086.79602057,53016:14152803.599503474,53017:17333573.624304302,53034:20015086.79602057,53079:20015114.352186374,53080:20015114.352186374,54001:20037508.342789244,54002:10018754.171394624,54003:20037508.342789244,54004:20037508.342789244,54016:14168658.027268292,54017:17367530.44516137,54034:20037508.342789244,54079:20037508.342789244,54080:20037508.342789244,54100:20037508.342789244,54101:20037508.342789244};async function h(){if(i())return null;await o()}function y(e,n,t){if(!x(e.spatialReference,n))return null;return t?l(n,e.spatialReference,e):l(e.spatialReference,n,e)}function g(e,t,a,i=null){if(e.spatialReference.equals(t))return e;x(e.spatialReference,t,i);const o=a.center,r=new c({xmin:o.x-e.x/2,xmax:o.x+e.x/2,ymin:o.y-e.y/2,ymax:o.y+e.y/2,spatialReference:e.spatialReference}),l=s(r,t,i);if(n(l))return null;return{x:l.xmax-l.xmin,y:l.ymax-l.ymin}}function d(e,n=.01){return a(e)?n/a(e):0}function M(e,n,t=null,a=!0){const i=e.spatialReference;if(i.equals(n))return e;x(i,n,t);const o=s(e,n,t);if(a&&n.isGeographic){const[n,t]=N(i,!0),a=d(i);a&&null!=n&&null!=t&&(Math.abs(e.x-n)<a&&Math.abs(180-o.x)<5e-4?o.x-=360:Math.abs(e.x-t)<a&&Math.abs(180+o.x)<5e-4&&(o.x+=360))}return o}function R(e){const n=v(e[0].spatialReference);if(e.length<2||!t(n))return e[0];let{xmin:a,xmax:i,ymin:o,ymax:s}=e[0];for(let t=1;t<e.length;t++){const a=e[t];i=a.xmax+n*t,o=Math.min(o,a.ymin),s=Math.max(s,a.ymax)}return new c({xmin:a,xmax:i,ymin:o,ymax:s,spatialReference:e[0].spatialReference})}function w(e,n,a=null,i=!0){if(e.spatialReference.equals(n))return e;const o=j(e),s=v(e.spatialReference,!0);if(!t(s)||0===o)return b(e,n,a,i);return R(e.clone().normalize().map((e=>b(e,n,a,i))))}function b(e,n,t=null,a=!0){const i=e.spatialReference;if(i.equals(n))return e;x(i,n,t);const o=s(e,n,t);let[r,l]=N(i,!0);if(o&&a&&i.isWebMercator&&n.isGeographic&&null!=r&&null!=l){const a=.001,s=1e3;if(Math.abs(e.xmin-r)<a&&Math.abs(l-e.xmax)>s&&Math.abs(180-o.xmax)<5e-4){o.xmin=-180;const a=[];a.push(new f(e.xmax,e.ymin,i)),a.push(new f(e.xmax,(e.ymin+e.ymax)/2,i)),a.push(new f(e.xmax,e.ymax,i));const s=a.map((e=>M(e,n,t))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));o.xmax=Math.max.apply(null,s)}if(Math.abs(e.xmax-l)<a&&Math.abs(r-e.xmin)>s&&Math.abs(180+o.xmin)<5e-4){o.xmax=180;const a=[];a.push(new f(e.xmin,e.ymin,i)),a.push(new f(e.xmin,(e.ymin+e.ymax)/2,i)),a.push(new f(e.xmin,e.ymax,i));const s=a.map((e=>M(e,n,t))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));o.xmin=Math.min.apply(null,s)}}[r,l]=N(n,!0);const c=d(n);return c&&null!=r&&null!=l&&o&&(Math.abs(o.xmin-r)<c&&(o.xmin=r),Math.abs(o.xmax-l)<c&&(o.xmax=l)),o}function v(e,n=!1){const t=n?20037508.342787:20037508.342788905;return e.isWebMercator?2*t:e.wkid&&e.isGeographic?360:2*p[e.wkid]||null}function N(e,n=!1){const a=[],i=v(e,n);return t(i)&&(a.push(-i/2),a.push(i/2)),a}function z(e,n,t,a){let i=(e-n)/t;return i-Math.floor(i)!=0?i=Math.floor(i):a&&(i-=1),i}function j(e,n=!1){const a=v(e.spatialReference);if(!t(a))return 0;const i=n?0:-(a/2);return z(e.xmax,i,a,!0)-z(e.xmin,i,a,!1)}function S(e){const n=e.storageInfo.origin.x,a=v(e.spatialReference,!0);if(!t(a))return{originX:n,halfWorldWidth:null,pyramidsInfo:null};const i=a/2,{nativePixelSize:o,storageInfo:s,extent:r}=e,{maximumPyramidLevel:l,blockWidth:c,pyramidScalingFactor:f}=s;let u=o.x;const x=[],m=t(e.transform)&&"gcs-shift"===e.transform.type,p=n+(m?0:i),h=m?a-n:i-n;for(let e=0;e<=l;e++){const e=(r.xmax-n)/u/c,t=e-Math.floor(e)==0?e:Math.ceil(e),a=h/u/c,i=a-Math.floor(a)==0?a:Math.ceil(a),o=Math.floor(p/u/c),s=Math.round(p/u)%c,l=(c-Math.round(h/u)%c)%c;x.push({resolutionX:u,blockWidth:c,datsetColumnCount:t,worldColumnCountFromOrigin:i,leftMargin:s,rightPadding:l,originColumnOffset:o}),u*=f}return{originX:n,halfWorldWidth:i,pyramidsInfo:x,hasGCSSShiftTransform:m}}function P(e){const n=e.isAdaptive&&null==e.spacing,t=e.spacing||[32,32];let a=C(e),i={cols:a.size[0]+1,rows:a.size[1]+1},o=m(a.offsets,i,t);const s=(o[0]+o[1])/2,r=a.outofBoundPointCount>0&&a.outofBoundPointCount<a.offsets.length/2;return n&&(r||s>4)&&(a=C({...e,spacing:[4,4]}),i={cols:a.size[0]+1,rows:a.size[1]+1},o=m(a.offsets,i,t)),a.error=o,a.coefficients=function(e,n,t){const{cols:a,rows:i}=n,o=new Float32Array((a-1)*(i-1)*2*6),s=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),r=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let n=0;n<a-1;n++){for(let t=0;t<i-1;t++){let l=n*i*2+2*t;const c=e[l],f=e[l+1],u=e[l+2],x=e[l+3];l+=2*i;const m=e[l],p=e[l+1],h=e[l+2],y=e[l+3];let g=0,d=12*(t*(a-1)+n);for(let e=0;e<3;e++)o[d++]=s[g++]*c+s[g++]*u+s[g++]*h;g=0;for(let e=0;e<3;e++)o[d++]=s[g++]*f+s[g++]*x+s[g++]*y;g=0;for(let e=0;e<3;e++)o[d++]=r[g++]*c+r[g++]*m+r[g++]*h;g=0;for(let e=0;e<3;e++)o[d++]=r[g++]*f+r[g++]*p+r[g++]*y}if(t)for(let e=0;e<o.length;e++)isNaN(o[e])&&(o[e]=-1)}return o}(a.offsets,i,r),a}function C(e){const{projectedExtent:n,srcBufferExtent:a,pixelSize:i,datumTransformation:o,rasterTransform:r}=e,l=n.spatialReference,c=a.spatialReference;x(l,c);const{xmin:u,ymin:m,xmax:p,ymax:h}=n,y=v(c),g=e.hasWrapAround||"gcs-shift"===(null==r?void 0:r.type),d=e.spacing||[32,32],M={x:d[0]*i.x,y:d[1]*i.y},R=Math.ceil((p-u)/M.x-.1/d[0])+1,w=Math.ceil((h-m)/M.y-.1/d[1])+1,b=M.x,N=M.y,z=[];let j,S=0;const P=[];for(let e=0;e<R;e++)for(let n=0;n<w;n++)P.push(new f({x:u+b*e,y:h-N*n,spatialReference:l}));const C=function(e,n,t=null){const a=e[0].spatialReference;return a.equals(n)?e:(x(a,n,t),s(e,n,t))}(P,c,o);for(let e=0;e<R;e++){const n=[];for(let i=0;i<w;i++){let o=C[e*w+i];r&&(o=r.inverseTransform(o)),n.push(o),e>0&&g&&o&&j[i]&&t(y)&&o.x<j[i].x&&(o.x+=y),o?(z.push((o.x-a.xmin)/(a.xmax-a.xmin)),z.push((a.ymax-o.y)/(a.ymax-a.ymin))):(z.push(NaN),z.push(NaN),S++)}j=n}return{offsets:z,error:null,coefficients:null,outofBoundPointCount:S,spacing:d,size:[R-1,w-1]}}function W(e){const n=e.clone().normalize();return 1===n.length?n[0]:R(n)}function G(e,n,a){const{storageInfo:i,pixelSize:o}=n;let s,r=!1;const{pyramidResolutions:l}=i;if(t(l)&&l.length){const t=(e.x+e.y)/2,i=l[l.length-1],c=(i.x+i.y)/2,u=(o.x+o.y)/2;if(t<=u)s=0;else if(t>=c)s=l.length,r=t/c>8;else{let e,n=u;for(let i=1;i<=l.length;i++){if(e=(l[i-1].x+l[i-1].y)/2,t<=e){t===e?s=i:"down"===a?(s=i-1,r=t/n>8):s="up"===a||t-n>e-t||t/n>2?i:i-1;break}n=e}}const x=0===s?o:l[s-1];return{pyramidLevel:s,pyramidResolution:new f({x:x.x,y:x.y,spatialReference:n.spatialReference}),excessiveReading:r}}const c=Math.log(e.x/o.x)/Math.LN2,u=Math.log(e.y/o.y)/Math.LN2,x=n.storageInfo.maximumPyramidLevel||0;s="down"===a?Math.floor(Math.min(c,u)):"up"===a?Math.ceil(Math.max(c,u)):Math.round((c+u)/2),s<0?s=0:s>x&&(r=s>x+3,s=x);const m=2**s;return{pyramidLevel:s,pyramidResolution:new f({x:m*n.nativePixelSize.x,y:m*n.nativePixelSize.y,spatialReference:n.spatialReference}),excessiveReading:r}}function T(e,n,t=512,i=!0){const{extent:o,spatialReference:s,pixelSize:r}=e,l=g(new f({x:r.x,y:r.y,spatialReference:s}),n,o);if(null==l)return{projectedPixelSize:null,scales:null,srcResolutions:null,isCustomTilingScheme:!1};const c=(l.x+l.y)/2,u=a(n),x=c*u*96*39.37,m=n.isGeographic?256/t*295828763.7958547:256/t*591657527.591555;let p="vector-magdir"===e.dataType||"vector-uv"===e.dataType;const h=w(o,n);p||i&&(n.isGeographic||n.isWebMercator)&&(p=h.xmin*h.xmax<0);let y,d=x;const M=1.001;if(p){d=m;const e=n.isGeographic?1341104507446289e-21:.29858214164761665,t=e*(96*u*39.37),a=n.isGeographic?4326:3857;y=g(new f({x:e,y:e,spatialReference:{wkid:a}}),s,h),y.x*=d/t,y.y*=d/t}else{y={x:r.x,y:r.y};const n=Math.ceil(Math.log(Math.min(e.width,e.height)/32)/Math.LN2);let t=0;for(;d<.5005*m&&t<n;)t++,d*=2,y.x*=2,y.y*=2;Math.max(d,m)/Math.min(d,m)<=M&&(d=m)}const R=[d],b=[{x:y.x,y:y.y}],v=Math.min(70.5310735,x)/M;for(;d>=v;)d/=2,y.x/=2,y.y/=2,R.push(d),b.push({x:y.x,y:y.y});return{projectedPixelSize:l,scales:R,srcResolutions:b,isCustomTilingScheme:!p}}export{W as a,j as b,w as c,P as d,S as e,g as f,v as g,T as h,y as i,h as l,M as p,u as r,G as s};
