/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{r as e,i as t,d as s,clone as n,b as r,o as i}from"../core/lang.js";import{_ as o}from"./tslib.es6.js";import a from"../request.js";import l from"../core/Accessor.js";import u from"../core/Error.js";import{createResolver as c,onAbort as h,createAbortError as f,throwIfAborted as d,isAbortError as p}from"../core/promiseUtils.js";import{property as m}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as g}from"../core/accessorSupport/decorators/subclass.js";import{d as k}from"./Util2.js";import{T as y}from"./Scheduler.js";import{b,m as w,s as T,d as _,g as v,f as x}from"./mathUtils.js";import{canProjectToWGS84ComparableLonLat as S}from"../geometry/projection.js";import{d as L,e as I,f as Q,a as W}from"./aaBoundingRect.js";import{T as E,M as j}from"./TerrainConst.js";import{f as M,h as q}from"../geometry/SpatialReference.js";class R{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new C}}class C{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class z{constructor(e,t,s,n){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=s,this._totalNumWorkers=0,this._clients=n.map((e=>new R(e)))}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,((e,t)=>this._taskCallback(e,t)))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}destroy(){this._clients.length=0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,k(t.numWorkers>=0),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),((e,t)=>this._taskCallback(e,t))))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){const e=this;return{set workerFunc(t){e._workerFunc=t}}}}class F extends class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}{constructor(e,t,s,n,r){super(n),this.url=e,this.options=t,this.docType=s,this.key=r,this.result=null,this.status=1,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0}}let A=class extends l{constructor(){super(...arguments),this.tasks=new Map,this.onLoadQueue=new Array,this.doneQueue=new Array,this.updating=!1}setup(e,t,s){this.loadQueue=new z(((e,t)=>this.startLoading(e,t)),((e,t)=>this.doneLoadingCallback(e,t)),e,t),s&&(this.taskHandle=s.registerTask(y.STREAM_DATA_LOADER,this))}destroy(){this.taskHandle=e(this.taskHandle),this.tasks.forEach((e=>{e.abortController&&e.abortController.abort()})),this.loadQueue.destroy(),this.loadQueue=null,this.onLoadQueue=null,this.doneQueue=null,this.tasks=null}hasDownloadSlots(e){return this.loadQueue.hasQuota(e)}request(e,s,n,r={}){const i=c();i.__signal=t(r)?r.signal:null;const o=this.createOrUpdateTask(e,s,n,r,i);return h(r,(()=>this.cancelRequest(o,i))),i.promise}createTask(e,t,s,n,r,i){const o=new F(e,t,s,n,r);return this.updateTask(o,i),this.tasks.set(r,o),1===this.tasks.size&&this._set("updating",!0),this.loadQueue.push(o),o}cancelRequest(e,t){s(e.resolvers,t),t.reject(f()),0===e.resolvers.length&&(2===e.status&&(e.status=4,this.loadQueue.cancel(e),e.abortController.abort(),e.request=null,e.abortController=null),e.status=4,this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1))}taskKey(e,t,s){return`${e}:${t}:${s}`}updateTask(e,t){e.resolvers.push(t)}createOrUpdateTask(e,s,n,r,i){const o=t(r)&&r.uid||e,a=this.taskKey(o,s,n),l=this.tasks.get(a);return l?(this.updateTask(l,i),l):this.createTask(e,r,s,n,a,i)}doneLoadingCallback(e,t){this.loadQueue&&(k(2===e.status),e.status=3,this.taskHandle?this.doneQueue.push({task:e,err:t}):this.doneLoading(e,t))}get running(){return this.doneQueue.length>0||this.onLoadQueue.length>0}runTask(e){for(;!e.done&&this.onLoadQueue.length>0;){const t=this.onLoadQueue.shift();d(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this.doneQueue.length>0;){const t=this.doneQueue.shift();3!==t.task.status&&(t.err=t.err||f()),this.doneLoading(t.task,t.err),e.madeProgress()}}doneLoading(e,t){let s=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)p(t)?r.reject(t):r.reject(new u("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--s;const t=s<=0?e.result:n(e.result);r.resolve(t)}this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1)}startLoading(e,t){if(4===e.status)return!1;let s,n;switch(e.startTime=performance.now(),e.status=2,e.docType){case"binary":n="array-buffer",s=0;break;case"image":n="image";break;case"image+type":n="array-buffer";break;default:n="json"}e.abortController=new AbortController;const r=e.abortController.signal;e.request=a(e.url,{...e.options,responseType:n,timeout:s,signal:r});let i=()=>{};const o=s=>{e.duration=performance.now()-e.startTime,e.size=s instanceof ArrayBuffer?s.byteLength:e.size||0,e.result=s,this.taskHandle?this.onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},l=s=>{2===e.status&&t(e,s),i()};return"image+type"!==e.docType?(e.request.then((e=>o(e.data)),l),!0):(e.request.then((t=>{const u=t.data,c=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);if(137===t[0]&&80===t[1])return"image/png";if(71===t[0]&&73===t[1])return"image/gif";if(66===t[0]&&77===t[1])return"image/bmp";if(255===t[0]&&216===t[1])return"image/jpeg";return"unknown"}(u);if(n="image",e.size=u.byteLength,"unknown"===c)return e.request=a(e.url,{responseType:n,timeout:s,signal:r}),void e.request.then((e=>o(e.data)),l);const h=new Blob([u],{type:c}),f=window.URL.createObjectURL(h);i=()=>window.URL.revokeObjectURL(f),e.request=a(f,{responseType:n,timeout:s,signal:r}),e.request.then((e=>o(new O(e.data,c,i))),l)}),l),!0)}get test(){return{loadQueue:this.loadQueue}}};o([m({readOnly:!0})],A.prototype,"updating",void 0),A=o([g("esri.views.3d.support.StreamDataLoader")],A);class O{constructor(e,t,s){this.image=e,this.type=t,this.release=s}get isOpaque(){return"image/jpeg"===this.type}}const N=A,U=b(),H=b(),B=b(),G=b();function D(e,t,s,n){w(U,s),U[n]=t[n];const r=T(U,U,t),i=T(H,e,t),o=_(i,r),a=_(r,r);let l;l=o<=0?t:a<=o?s:v(U,t,x(r,r,o/a));const u=T(U,e,l);return Math.PI/2-Math.atan(u[2]/Math.sqrt(u[0]*u[0]+u[1]*u[1]))}const P=Object.freeze({__proto__:null,isInsideExtent:function(e,t,s=0){const n=e.extent;if(r(n))return!1;if(0===s)return L(n,t);const i=Math.min(n[2]-n[0],n[3]-n[1]);return I(n,t,s*i)},tiltToExtentEdge:function(e,t,s){const n=e.extent;if(r(n))return 0;B[0]=n[0],B[1]=n[1],B[2]=s,G[0]=n[2],G[1]=n[3],G[2]=s;let i=1/0,o=1/0;return t[0]<B[0]?i=D(t,B,G,0):t[0]>G[0]&&(i=D(t,G,B,0)),t[1]<B[1]?o=D(t,B,G,1):t[1]>G[1]&&(o=D(t,G,B,1)),Math.min(i,o)},checkIfTileInfoSupportedForViewSR:function(e,s,n){if(e.spatialReference.isGeographic&&!S(e.spatialReference))return new u("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const r=E.checkUnsupported(e);if(t(r))return r;const i=function(e,t){const s=e.lods,n=s[0].resolution*2**s[0].level,r=[n*e.size[0],n*e.size[1]],i=[e.origin.x,e.origin.y],o=Q(t),a=W();E.computeRowColExtent(o,r,i,a);const l=(a[2]-a[0])*(a[3]-a[1]);if(l>j){const t=s[0].scale*2**s[0].level;let r=Math.max((o[3]-o[1])/e.size[1],(o[2]-o[0])/e.size[0])*t/n;const i=Math.floor(Math.log(r)/Math.log(10));return r=Math.ceil(r/10**i)*10**i,new u("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+r.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:r,requiredNumRootTiles:l,allowedNumRootTiles:j})}return null}(e,n);return i||(s&&!e.spatialReference.equals(s)?new u("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null)}});const V={1:Object.freeze({__proto__:null,isInsideExtent:function(){return!0},tiltToExtentEdge:function(){return 0},checkIfTileInfoSupportedForViewSR:function(e,t){const s=e.lods.length-1,n=e.spatialReference,r=S(n)||M(n)||q(n);if(n.isWebMercator){if(!E.makeWebMercatorAuxiliarySphere(s).compatibleWith(e))return new u("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!r)return new u("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!E.makeGCSWithTileSize(e.spatialReference,e.size[0],s).compatibleWith(e))return e.spatialReference.isWGS84?new u("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new u("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}if(t&&!e.spatialReference.equals(t))return new u("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}}),2:P};function $(e,t){e||console.warn("Terrain: "+t)}const K=80/180*Math.PI,J=110/180*Math.PI;function X(e,s,n){const r=V[e.viewingMode];let o;if(r.isInsideExtent(e,s))o=i(e.getElevation(s[0],s[1],s[1],e.spatialReference),0);else{if(!r.isInsideExtent(e,s,1.2))return 0;const n=e.getTileWithElevation(s[0],s[1],s[1],e.spatialReference);o=.5*((t(n)?n.elevationBounds[0]:e.elevationBounds.min)+(t(n)?n.elevationBounds[1]:e.elevationBounds.max));const i=r.tiltToExtentEdge(e,s,o);if(i>K&&i<J)return 0}const a=s[2]-o;return Math.abs(a)<n?0:a<0?-1:1}function Y(e){return te(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function Z(e){return"vector-tile"===(null==e?void 0:e.type)}function ee(e){return"imagery-tile"===(null==e?void 0:e.type)||"wcs"===(null==e?void 0:e.type)}function te(e){return"imagery-tile-3d"===(null==e?void 0:e.type)}function se(e){return"tile-3d"===(null==e?void 0:e.type)}function ne(e){return"vector-tile-3d"===(null==e?void 0:e.type)}function re(e){return"elevation-3d"===(null==e?void 0:e.type)}function ie(e){return e&&(se(e)||te(e)||re(e)||ne(e)||function(e){return"wmts-3d"===(null==e?void 0:e.type)}(e))}function oe(e){var s;const n=null==e||null==(s=e.sourceLayerInfo)?void 0:s.data;return t(n)&&"type"in n&&"raster-tile"===n.type}function ae(e){var s;const n=null==e||null==(s=e.sourceLayerInfo)?void 0:s.data;return t(n)&&"type"in n&&"vector-tile"===n.type}function le(e){var s;const n=null==e||null==(s=e.sourceLayerInfo)?void 0:s.data;return t(n)&&"type"in n&&"tile-texture"===n.type}function ue(e){var t;const s=null==e||null==(t=e.sourceLayerInfo)?void 0:t.data;return s instanceof HTMLImageElement||s instanceof O||s instanceof HTMLCanvasElement||s instanceof ImageData}function ce(e){return t(e)&&"release"in e&&e.release(),null}function he(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function fe(e,t,s,n){return V[n].checkIfTileInfoSupportedForViewSR(e,s,t)}function de(e,s,n){let r=null,i=null;if("wmts"===e.type){const t=e.activeLayer;if(t){const e=t.tileMatrixSet;if(e)r=e.tileInfo,i=e.fullExtent;else{const e=t.tileMatrixSets;if(e){const t=e.find((e=>null==fe(e.tileInfo,e.fullExtent,s,n)));if(t)return{tileInfo:t.tileInfo,fullExtent:t.fullExtent}}}}}else i=ee(e)?e.getCompatibleFullExtent(s):e.fullExtent,r=Z(e)&&!pe.force512VTL?e.compatibleTileInfo256:ee(e)?e.getCompatibleTileInfo(s,i,2===n):e.tileInfo;return t(r)&&t(i)&&null==fe(r,i,s,n)?{tileInfo:r,fullExtent:i}:null}const pe={force512VTL:!1};export{O as I,N as S,ee as a,Y as b,fe as c,ne as d,ae as e,oe as f,de as g,ue as h,ie as i,le as j,Z as k,X as l,re as m,te as n,se as o,ce as r,he as u,$ as w};
