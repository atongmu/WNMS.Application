/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import e from"../request.js";import{i as t}from"../core/lang.js";import{join as r,urlToObject as n}from"../core/urlUtils.js";import{getJsonType as i}from"../geometry/support/jsonUtils.js";import{normalizeCentralMeridian as o}from"../geometry/support/normalizeUtils.js";import{i as s}from"./arcgisLayerUrl.js";import{p as a}from"./pbfQueryUtils.js";import{a as u}from"./queryZScale.js";function l(e){const t={};for(const r in e){if("declaredClass"===r)continue;const n=e[r];if(null!=n&&"function"!=typeof n)if(Array.isArray(n)){t[r]=[];for(let e=0;e<n.length;e++)t[r][e]=l(n[e])}else"object"==typeof n?n.toJSON&&(t[r]=JSON.stringify(n)):t[r]=n}return t}function y(e,r,n=!1){const o=e.geometry,s=e.toJSON(),a=s,u=e.outSpatialReference;let l,y;if(t(o)){if(l=o.spatialReference,y=o.spatialReference.wkid||JSON.stringify(o.spatialReference),a.geometryType=i(o),"extent"===o.type)a.geometry=`${o.xmin},${o.ymin},${o.xmax},${o.ymax}`;else if("point"===o.type)a.geometry=`${o.x},${o.y}`;else{const e=o.toJSON();delete e.spatialReference,a.geometry=JSON.stringify(e)}a.inSR=y}if(l||(l=u),s.groupByFieldsForStatistics&&(a.groupByFieldsForStatistics=s.groupByFieldsForStatistics.join(",")),s.objectIds&&(a.objectIds=s.objectIds.join(",")),s.orderByFields&&(a.orderByFields=s.orderByFields.join(",")),!s.outFields||!s.returnDistinctValues&&(null!=r&&r.returnCountOnly||null!=r&&r.returnExtentOnly||null!=r&&r.returnIdsOnly)?delete a.outFields:-1!==s.outFields.indexOf("*")?a.outFields="*":a.outFields=s.outFields.join(","),s.outSR?a.outSR=s.outSR.wkid||JSON.stringify(s.outSR):o&&(s.returnGeometry||s.returnCentroid)&&(a.outSR=a.inSR),s.returnGeometry&&delete s.returnGeometry,s.outStatistics&&(a.outStatistics=JSON.stringify(s.outStatistics)),s.pixelSize&&(a.pixelSize=JSON.stringify(s.pixelSize)),s.quantizationParameters&&(n&&t(l)&&t(e.quantizationParameters)&&t(e.quantizationParameters.extent)&&l.equals(e.quantizationParameters.extent.spatialReference)&&delete s.quantizationParameters.extent.spatialReference,a.quantizationParameters=JSON.stringify(s.quantizationParameters)),s.parameterValues&&(a.parameterValues=JSON.stringify(s.parameterValues)),s.rangeValues&&(a.rangeValues=JSON.stringify(s.rangeValues)),s.dynamicDataSource&&(a.layer=JSON.stringify({source:s.dynamicDataSource}),delete s.dynamicDataSource),s.timeExtent){const e=s.timeExtent,{start:t,end:r}=e;null==t&&null==r||(a.time=t===r?t:`${null==t?"null":t},${null==r?"null":r}`),delete s.timeExtent}return a}async function c(e,r,n,i){const o=t(r.timeExtent)&&r.timeExtent.isEmpty?{data:{features:[]}}:await S(e,r,"json",i);return u(r,n,o.data),o}async function m(e,r,n,i){if(t(r.timeExtent)&&r.timeExtent.isEmpty)return Promise.resolve({data:n.createFeatureResult()});const o=await f(e,r,i),s=o;return s.data=a(o.data,n),s}function f(e,t,r){return S(e,t,"pbf",r)}function p(e,r,n){return t(r.timeExtent)&&r.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):S(e,r,"json",n,{returnIdsOnly:!0})}function d(e,r,n){return t(r.timeExtent)&&r.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):S(e,r,"json",n,{returnIdsOnly:!0,returnCountOnly:!0})}function x(e,r,n){return t(r.timeExtent)&&r.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):S(e,r,"json",n,{returnExtentOnly:!0,returnCountOnly:!0}).then((e=>{const t=e.data;if(t.hasOwnProperty("extent"))return e;if(t.features)throw new Error("Layer does not support extent calculation.");if(t.hasOwnProperty("count"))throw new Error("Layer does not support extent calculation.");return e}))}function S(i,a,u,c={},m={}){const f="string"==typeof i?n(i):i,p=a.geometry?[a.geometry]:[];return c.responseType="pbf"===u?"array-buffer":"json",o(p,null,c).then((n=>{const i=n&&n[0];t(i)&&((a=a.clone()).geometry=i);const o=s(f.path),p=l({...f.query,f:u,...m,...y(a,m,o)});return e(r(f.path,"query"),{...c,query:{...p,...c.query}})}))}const g=Object.freeze({__proto__:null,queryToQueryStringParameters:y,executeQuery:c,executeQueryPBF:m,executeQueryPBFBuffer:f,executeQueryForIds:p,executeQueryForCount:d,executeQueryForExtent:x,runQuery:S});export{p as a,c as b,x as c,m as d,d as e,f,l as m,g as q,S as r};
