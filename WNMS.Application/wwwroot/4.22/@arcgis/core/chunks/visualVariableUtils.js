/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import e from"../Color.js";import t from"../Graphic.js";import{n as o}from"./compilerUtils.js";import{L as r}from"./Logger.js";import{b as s,i}from"../core/lang.js";import{m as a}from"./lengthUtils.js";import{i as n,b as l}from"./sizeVariableUtils.js";import"./colorUtils.js";import"./mathUtils.js";import"./common.js";import"./ensureType.js";import"../config.js";import"./object.js";import"./string.js";import"./tslib.es6.js";import"../geometry.js";import"../geometry/Extent.js";import"../core/accessorSupport/decorators/property.js";import"./metadata.js";import"./handleUtils.js";import"../core/accessorSupport/decorators/subclass.js";import"../core/Error.js";import"../geometry/Geometry.js";import"./JSONSupport.js";import"../core/Accessor.js";import"./deprecate.js";import"./ArrayPool.js";import"../core/scheduling.js";import"./nextTick.js";import"../core/promiseUtils.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"./jsonMap.js";import"../geometry/support/jsonUtils.js";import"../PopupTemplate.js";import"../core/Collection.js";import"./Evented.js";import"./shared.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"./date.js";import"./number.js";import"./locale.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"./chartMediaInfoUtils.js";import"./MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../support/actions/ActionBase.js";import"./Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils.js";import"../symbols/edges/Edges3D.js";import"./screenUtils.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils2.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"./aaBoundingRect.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../kernel.js";import"../request.js";import"./Loadable.js";import"./Promise.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"./Thumbnail.js";import"./Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./unitUtils.js";import"./projectionEllipsoid.js";const p=r.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),c=new t,m=Math.PI,u=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function j(t,o,r){const s="visualVariables"in t&&t.visualVariables?t.visualVariables.filter((e=>"color"===e.type))[0]:t;if(!s)return;if("esri.renderers.visualVariables.ColorVariable"!==s.declaredClass)return void p.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const a="number"==typeof o,n=a?null:o,l=n&&n.attributes;let c=a?o:null;const m=s.field,{ipData:u,hasExpression:j}=s.cache;let d=s.cache.compiledFunc;if(!m&&!j){const e=s.stops;return e&&e[0]&&e[0].color}if("number"!=typeof c)if(j){if(!i(r)||!i(r.arcade))return void p.error("Use of arcade expressions requires an arcade context");const e={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},t=r.arcade.arcadeUtils,o=t.getViewInfo(e),a=t.createExecContext(n,o);if(!d){const e=t.createSyntaxTree(s.valueExpression);d=t.createFunction(e),s.cache.compiledFunc=d}c=t.executeFunction(d,a)}else l&&(c=l[m]);const b=s.normalizationField,f=l?parseFloat(l[b]):void 0;if(null!=c&&(!b||a||!isNaN(f)&&0!==f)){isNaN(f)||a||(c/=f);const t=x(c,u);if(t){const o=t[0],a=t[1],n=o===a?s.stops[o].color:e.blendColors(s.stops[o].color,s.stops[a].color,t[2],i(r)?r.color:void 0);return new e(n)}}}function d(e,t,o){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.filter((e=>"opacity"===e.type))[0]:e;if(!r)return;if("esri.renderers.visualVariables.OpacityVariable"!==r.declaredClass)return void p.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const i="number"==typeof t,a=i?null:t,n=a&&a.attributes;let l=i?t:null;const c=r.field,{ipData:m,hasExpression:u}=r.cache;let j=r.cache.compiledFunc;if(!c&&!u){const e=r.stops;return e&&e[0]&&e[0].opacity}if("number"!=typeof l)if(u){if(s(o)||s(o.arcade))return void p.error("Use of arcade expressions requires an arcade context");const e={viewingMode:o.viewingMode,scale:o.scale,spatialReference:o.spatialReference},t=o.arcade.arcadeUtils,i=t.getViewInfo(e),n=t.createExecContext(a,i);if(!j){const e=t.createSyntaxTree(r.valueExpression);j=t.createFunction(e),r.cache.compiledFunc=j}l=t.executeFunction(j,n)}else n&&(l=n[c]);const d=r.normalizationField,b=n?parseFloat(n[d]):void 0;if(null!=l&&(!d||i||!isNaN(b)&&0!==b)){isNaN(b)||i||(l/=b);const e=x(l,m);if(e){const t=e[0],o=e[1];if(t===o)return r.stops[t].opacity;{const s=r.stops[t].opacity;return s+(r.stops[o].opacity-s)*e[2]}}}}function b(e,t,o){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.filter((e=>"rotation"===e.type))[0]:e;if(!r)return;if("esri.renderers.visualVariables.RotationVariable"!==r.declaredClass)return void p.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const i=r.axis||"heading",a="heading"===i&&"arithmetic"===r.rotationType?90:0,n="heading"===i&&"arithmetic"===r.rotationType?-1:1,l="number"==typeof t?null:t,c=l&&l.attributes,m=r.field,{hasExpression:u}=r.cache;let j=r.cache.compiledFunc,d=0;if(!m&&!u)return d;if(u){if(s(o)||s(o.arcade))return void p.error("Use of arcade expressions requires an arcade context");const e={viewingMode:o.viewingMode,scale:o.scale,spatialReference:o.spatialReference},t=o.arcade.arcadeUtils,i=t.getViewInfo(e),a=t.createExecContext(l,i);if(!j){const e=t.createSyntaxTree(r.valueExpression);j=t.createFunction(e),r.cache.compiledFunc=j}d=t.executeFunction(j,a)}else c&&(d=c[m]||0);return d="number"!=typeof d||isNaN(d)?null:a+n*d,d}function f(e,t,o){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.filter((e=>"size"===e.type))[0]:e;if(!r)return;if("esri.renderers.visualVariables.SizeVariable"!==r.declaredClass)return void p.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const a=function(e,t,o){const r="number"==typeof t,a=r?null:t,n=a&&a.attributes;let c=r?t:null;const{isScaleDriven:m}=e.cache;let u=e.cache.compiledFunc;if(m){const t=i(o)?o.scale:void 0,r=i(o)?o.view:void 0;c=null==t||"3d"===r?function(e){let t=null,o=null;const r=e.stops;return r?(t=r[0].value,o=r[r.length-1].value):(t=e.minDataValue||0,o=e.maxDataValue||0),(t+o)/2}(e):t}else if(!r)switch(e.inputValueType){case"expression":{if(s(o)||s(o.arcade))return void p.error("Use of arcade expressions requires an arcade context");const t={viewingMode:o.viewingMode,scale:o.scale,spatialReference:o.spatialReference},r=o.arcade.arcadeUtils,i=r.getViewInfo(t),n=r.createExecContext(a,i);if(!u){const t=r.createSyntaxTree(e.valueExpression);u=r.createFunction(t),e.cache.compiledFunc=u}c=r.executeFunction(u,n);break}case"field":n&&(c=n[e.field]);break;case"unknown":c=null}if(!l(c))return null;if(r||!e.normalizationField)return c;const j=n?parseFloat(n[e.normalizationField]):null;return l(j)&&0!==j?c/j:null}(r,t,o),n=v(a,r,t,o,r.cache.ipData);return null==n||isNaN(n)?0:n}function y(e,t,o){return null==e?null:n(e)?f(e,t,o):l(e)?e:null}function h(e,t,o){return l(o)&&e>o?o:l(t)&&e<t?t:e}function v(e,t,o,r,s){switch(t.transformationType){case"additive":return function(e,t,o,r){return e+(y(t.minSize,o,r)||t.minDataValue)}(e,t,o,r);case"constant":return function(e,t,o){const r=e.stops;let s=r&&r.length&&r[0].size;return null==s&&(s=e.minSize),y(s,t,o)}(t,o,r);case"clamped-linear":return function(e,t,o,r){const s=(e-t.minDataValue)/(t.maxDataValue-t.minDataValue),a=y(t.minSize,o,r),n=y(t.maxSize,o,r),l=i(r)?r.shape:void 0;if(e<=t.minDataValue)return a;if(e>=t.maxDataValue)return n;if("area"===t.scaleBy&&l){const e="circle"===l,t=e?m*(a/2)**2:a*a,o=t+s*((e?m*(n/2)**2:n*n)-t);return e?2*Math.sqrt(o/m):Math.sqrt(o)}return a+s*(n-a)}(e,t,o,r);case"proportional":return function(e,t,o,r){const s=i(r)?r.shape:void 0,a=e/t.minDataValue,n=y(t.minSize,o,r),l=y(t.maxSize,o,r);let p=null;return p="circle"===s?2*Math.sqrt(a*(n/2)**2):"square"===s||"diamond"===s||"image"===s?Math.sqrt(a*n**2):a*n,h(p,n,l)}(e,t,o,r);case"stops":return function(e,t,o,r,s){const[i,a,n]=x(e,s);if(i===a)return y(t.stops[i].size,o,r);{const e=y(t.stops[i].size,o,r);return e+(y(t.stops[a].size,o,r)-e)*n}}(e,t,o,r,s);case"real-world-size":return function(e,t,o,r){const s=(i(r)&&r.resolution?r.resolution:1)*a[t.valueUnit],n=y(t.minSize,o,r),l=y(t.maxSize,o,r),{valueRepresentation:p}=t;let c=null;return c="area"===p?2*Math.sqrt(e/m)/s:"radius"===p||"distance"===p?2*e/s:e/s,h(c,n,l)}(e,t,o,r);case"identity":return e;case"unknown":return null}}function S(e,t,o){const{isScaleDriven:r}=e.cache;if(!(r&&"3d"===o||t))return null;const s={scale:t,view:o};let i=y(e.minSize,c,s),a=y(e.maxSize,c,s);if(null!=i||null!=a){if(i>a){const e=a;a=i,i=e}return{minSize:i,maxSize:a}}}function V(e,t,o){if(!e.visualVariables)return;const r=[],s=[],i=[],a=[],n=[];for(const t of e.visualVariables)switch(t.type){case"color":s.push(t);break;case"opacity":i.push(t);break;case"rotation":n.push(t);break;case"size":a.push(t)}return s.forEach((e=>{const s=j(e,t,o);r.push({variable:e,value:s})})),i.forEach((e=>{const s=d(e,t,o);r.push({variable:e,value:s})})),n.forEach((e=>{const s=b(e,t,o);r.push({variable:e,value:s})})),a.forEach((e=>{const s=f(e,t,o);r.push({variable:e,value:s})})),r.filter((e=>null!=e.value))}function x(e,t){if(!t)return;let o=0,r=t.length-1;return t.some(((t,s)=>e<t?(r=s,!0):(o=s,!1))),[o,r,(e-t[o])/(t[r]-t[o])]}function g(e,t,r){const s=["proportional","proportional","proportional"];for(const i of e){const e=i.useSymbolValue?"symbol-value":f(i,t,r);switch(i.axis){case"width":s[0]=e;break;case"depth":s[1]=e;break;case"height":s[2]=e;break;case"width-and-depth":s[0]=e,s[1]=e;break;case"all":case void 0:case null:s[0]=e,s[1]=e,s[2]=e;break;default:o(i.axis)}}return s}export{g as getAllSizes,j as getColor,d as getOpacity,b as getRotationAngle,f as getSize,v as getSizeForValue,y as getSizeFromNumberOrVariable,S as getSizeRangeAtScale,V as getVisualVariableValues,u as viewScaleRE};
