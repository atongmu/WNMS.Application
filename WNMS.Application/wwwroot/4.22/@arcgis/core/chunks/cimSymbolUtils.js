/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{a as e}from"./cimAnalyzer.js";import{a as t}from"./enums.js";import{c as a}from"./MaterialKey.js";import{i as r,a as s}from"./devEnvironmentUtils.js";import n from"../core/Error.js";import{throwIfAborted as l}from"../core/promiseUtils.js";import{urlToObject as i}from"../core/urlUtils.js";import m from"../portal/Portal.js";import{f as o}from"./persistableUrlUtils.js";import{f as c,S as u,r as f,m as y,s as p}from"./styleUtils.js";const d={marker:t.MARKER,fill:t.FILL,line:t.LINE,text:t.TEXT};class h{constructor(e,t,r,s){const n={minScale:null==t?void 0:t.minScale,maxScale:null==t?void 0:t.maxScale},l=function(e){if(!e.minScale&&!e.maxScale)return"";return e.minScale+"-"+e.maxScale}(n);this.layers=e,this.data=t,this.hash=this._createHash()+l,this.rendererKey=r;const i={isOutline:!1,isOutlinedFill:!1,placement:null,stride:{fill:"default"},vvFlags:r};for(const t of e){const e=d[t.type];t.materialKey=a(e,i),t.maxVVSize=s,t.scaleInfo=n,t.templateHash+=l}}get type(){return"expanded-cim"}_createHash(){let e="";for(const t of this.layers)e+=t.templateHash;return e}}async function S(e,t,a){if(!e.name)return Promise.reject(new n("style-symbol-reference-name-missing","Missing name in style symbol reference"));if(e.styleName&&"Esri2DPointSymbolsStyle"===e.styleName)return async function(e,t){const a=u.replace(/\{SymbolName\}/gi,e.name);try{const e=await f(a,t);return y(e.data)}catch(e){return l(e),null}}(e,a);try{return async function(e,t,a,c){const u=e.data,d={portal:a&&a.portal||m.getDefault(),url:i(e.baseUrl),origin:"portal-item"},h=u.items.find((e=>e.name===t));if(!h){throw new n("symbolstyleutils:symbol-name-not-found",`The symbol name '${t}' could not be found`,{symbolName:t})}let S=o(p(h,"cimRef"),d);r()&&(S=s(S));try{const e=await f(S,c);return y(e.data)}catch(e){return l(e),null}}(await c(e,t,a),e.name,t,a)}catch(e){return l(e),null}}const x=async(t,a,r)=>new h(await e(t.data,a,r),t.data,t.rendererKey,t.maxVVSize),b=async(e,t,a,r)=>{if(!e)return null;if("cim"===e.type)return x(e,t,a);if("web-style"===e.type){const s={type:"cim",data:await S(e,null,r),rendererKey:e.rendererKey,maxVVSize:e.maxVVSize};return x(s,t,a)}return e};function j(e){if(!e)return null;const{type:t,cim:a,url:r,materialHash:s}=e,n={cim:a,type:t,mosaicHash:s,url:r,size:null,dashTemplate:null,path:null,text:null,fontName:null};switch(t){case"marker":n.size=e.size,n.path=e.path;break;case"line":n.dashTemplate=e.dashTemplate;break;case"text":n.text=e.text,n.fontName=e.fontName}return n}export{j as c,b as e};
