/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import{d as t,h as i,m as a,r as s}from"./handleUtils.js";import{i as r,u as n,b as o,o as l,k as p,h,r as c,G as d}from"../core/lang.js";import{init as u}from"../core/watchUtils.js";import{property as m}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as g}from"../core/accessorSupport/decorators/subclass.js";import{e as y,d as v,a as f,g as _}from"./elevationInfoUtils.js";import{E as M}from"./ElevationInfo.js";import b from"../Color.js";import{b as S,k as x,m as w,s as j,p as E,u as O,w as G,W as D,n as R,g as A,c as I,A as P,e as V,h as C,o as T,f as z,ab as k,d as H,a as L,L as U,M as F,l as B,q as Z,r as N,_ as Y,af as W,Z as X,a8 as q}from"./mathUtils.js";import Q from"../core/Handles.js";import{f as J,a as K}from"./vec4f32.js";import{k as $,l as ee,m as te,n as ie,o as ae}from"./frustum.js";import{c as se,f as re,g as ne}from"./lineSegment.js";import{c as oe,e as le,w as pe,d as he}from"./ray.js";import{L as ce}from"./LaserlineVisualElement.js";import{O as de}from"./LineVisualElement.js";import{G as ue,C as me}from"./ColorMaterial.js";import{y as ge,H as ye}from"./lineUtils.js";import{b as ve,d as fe,s as _e}from"./screenUtils.js";import{h as Me,g as be,e as Se,s as xe,f as we,p as je,j as Ee,w as Oe,x as Ge}from"./vec2.js";import{f as De}from"./vec4f64.js";import{projectVectorToVector as Re,projectPointToVector as Ae}from"../geometry/projection.js";import{n as Ie,c as Pe,b as Ve,F as Ce}from"./aaBoundingBox.js";import{b as Te,s as ze,c as ke}from"./vectorStacks.js";import{V as He,s as Le,O as Ue,c as Fe}from"./OutlineVisualElement.js";import{E as Be}from"./lineStippleUtils.js";import{H as Ze,l as Ne,n as Ye}from"./sdfPrimitives.js";import{T as We}from"./Texture2.js";import{R as Xe}from"./RightAngleQuadVisualElement.js";import{d as qe}from"./Settings2.js";import{a as Qe,d as Je}from"./RightAngleSnappingHint.js";import{a as Ke,S as $e}from"./SnappingContext.js";import{S as et,M as tt,a as it,g as at,e as st,p as rt,b as nt}from"./manipulatorUtils.js";import{G as ot}from"./GraphicState.js";import{D as lt,g as pt}from"./DrawGraphicTool.js";import{D as ht,S as ct,E as dt,b as ut}from"./drawSurfaces.js";import mt from"../core/Collection.js";import{E as gt}from"./Evented.js";import{HandleOwnerMixin as yt,HandleOwner as vt}from"../core/HandleOwner.js";import{m as ft}from"./dehydratedFeatures.js";import{c as _t}from"./manipulatorUtils2.js";import{A as Mt}from"./aaBoundingRect.js";import{p as bt,i as St,y as xt,m as wt,r as jt,v as Et,t as Ot,k as Gt,s as Dt,j as Rt}from"./mat4.js";import{c as At,f as It,I as Pt}from"./mat4f64.js";import{b as Vt,c as Ct,d as Tt,e as zt,f as kt,g as Ht,a as Lt}from"./dragEventPipeline3D.js";import{d as Ut,a as Ft,c as Bt,b as Zt,e as Nt,f as Yt,E as Wt,g as Xt,I as qt,h as Qt,i as Jt}from"./InteractiveToolBase.js";import{d as Kt}from"./colorUtils2.js";import{G as $t}from"./GraphicManipulator.js";import{i as ei,g as ti,a as ii}from"../widgets/Sketch/SketchViewModel.js";import{E as ai,O as si,U as ri,M as ni,R as oi,S as li}from"./EditGeometryOperations.js";import pi from"../geometry/Polyline.js";import{j as hi}from"./utils4.js";import{n as ci,e as di,c as ui,h as mi}from"./plane.js";import gi from"../geometry/Point.js";import{addFrameTask as yi}from"../core/scheduling.js";import{b as vi}from"./mathUtils2.js";import{r as fi,b as _i}from"./reactiveUtils.js";import{b as Mi,e as bi}from"./axisAngleDegrees.js";import{d as Si}from"./unitUtils.js";import{c as xi}from"./vec2f64.js";import{c as wi,u as ji,a as Ei}from"./boundedPlane.js";import{E as Oi,c as Gi,F as Di,b as Ri,a as Ai,H as Ii,J as Pi,K as Vi,h as Ci,m as Ti,n as zi,q as ki}from"./sliceToolUtils.js";import{g as Hi}from"./Factory.js";import{a as Li}from"./ray2.js";import"../core/promiseUtils.js";import"../core/Error.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"./metadata.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"./Ellipsoid.js";import"./jsonMap.js";import"./JSONSupport.js";import"../core/Accessor.js";import"./deprecate.js";import"./ArrayPool.js";import"./nextTick.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"../geometry/support/webMercatorUtils.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./colorUtils.js";import"./common.js";import"./shared.js";import"./VisualElement.js";import"./sphere.js";import"./glUtil.js";import"./InterleavedLayout.js";import"./BufferView.js";import"./types.js";import"./StencilUtils.js";import"./Texture.js";import"./Program.js";import"./parser.js";import"./_commonjsHelpers.js";import"./Util2.js";import"./geometryDataUtils.js";import"./triangle.js";import"./utils14.js";import"./mat3.js";import"./quatf64.js";import"./quat.js";import"./vec3f32.js";import"./doublePrecisionUtils.js";import"./CameraSpace.glsl.js";import"./OrderIndependentTransparency.js";import"./ScreenSpacePass.js";import"../Graphic.js";import"../PopupTemplate.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"./date.js";import"./number.js";import"./locale.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"./chartMediaInfoUtils.js";import"./MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../support/actions/ActionBase.js";import"./Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils2.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../kernel.js";import"../request.js";import"./Loadable.js";import"./Promise.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"./Thumbnail.js";import"./Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./VertexColor.glsl.js";import"./projectionEllipsoid.js";import"./triangulationUtils.js";import"./earcut.js";import"./deduplicate.js";import"./compilerUtils.js";import"./ElevationProvider.js";import"./vec2f32.js";import"./FramebufferObject.js";import"./Camera.js";import"./PhysicallyBasedRendering.glsl.js";import"./Intersector.js";import"./MemCache.js";import"./floatRGBA.js";import"./Scheduler.js";import"./debugFlags.js";import"./pe.js";import"./assets.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./VerticalOffset.glsl.js";import"./requestImageUtils.js";import"./PointSnappingHint.js";import"../layers/GraphicsLayer.js";import"./GraphicsCollection.js";import"../layers/Layer.js";import"./BlendLayer.js";import"./jsonUtils.js";import"./ScaleRangeLayer.js";import"../geometry/Circle.js";import"../geometry/support/geodesicUtils.js";import"../geometry/geometryEngine.js";import"./geometryEngineBase.js";import"./hydrated.js";import"./surfaceCoordinateSystems.js";import"./mat2d.js";import"./mat2df64.js";import"./dehydratedFeatureComparison.js";import"./byteSizeEstimations.js";import"./quantizationUtils.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./drawUtils.js";import"./DOMContainer.js";import"./domUtils.js";import"./projector.js";import"./widgetUtils.js";import"../widgets/Popup.js";import"../intl.js";import"./messages.js";import"./throttle.js";import"../core/accessorSupport/decorators/aliasOf.js";import"../widgets/Feature.js";import"../widgets/Widget.js";import"./uuid.js";import"./jsxWidgetSupport.js";import"../widgets/Attachments.js";import"../widgets/Attachments/AttachmentsViewModel.js";import"../rest/query/support/AttachmentInfo.js";import"../rest/support/AttachmentQuery.js";import"./messageBundle.js";import"./jsxFactory.js";import"../widgets/Feature/FeatureViewModel.js";import"./languageUtils.js";import"./datetime.js";import"./number3.js";import"../rest/support/Query.js";import"../TimeExtent.js";import"./timeUtils.js";import"./DataLayerSource.js";import"../rest/support/StatisticDefinition.js";import"../rest/support/RelationshipQuery.js";import"../tasks/QueryTask.js";import"./executeForTopCount.js";import"./utils3.js";import"./scaleUtils.js";import"./floorFilterUtils.js";import"./query.js";import"../geometry/support/normalizeUtils.js";import"./normalizeUtilsCommon.js";import"./arcgisLayerUrl.js";import"./pbfQueryUtils.js";import"./pbf.js";import"./OptimizedFeature.js";import"./OptimizedFeatureSet.js";import"./queryZScale.js";import"./featureConversionUtils.js";import"../rest/support/FeatureSet.js";import"../rest/support/TopFeaturesQuery.js";import"../rest/support/TopFilter.js";import"./executeQueryJSON.js";import"../tasks/Task.js";import"../layers/FeatureLayer.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"./colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"./VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"./LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"./sizeVariableUtils.js";import"./visualVariableUtils.js";import"../renderers/support/ClassBreakInfo.js";import"./commonProperties2.js";import"../symbols/support/jsonUtils.js";import"./symbolConversion.js";import"../renderers/DictionaryRenderer.js";import"./LRUCache.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"./diffUtils.js";import"../renderers/support/UniqueValueInfo.js";import"./styleUtils.js";import"../renderers/support/jsonUtils.js";import"./MultiOriginJSONSupport.js";import"../core/sql.js";import"../form/FormTemplate.js";import"../form/ExpressionInfo.js";import"../form/elements/GroupElement.js";import"../form/elements/FieldElement.js";import"../form/elements/support/inputs.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/SwitchInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../form/support/elements.js";import"../geometry/HeightModelInfo.js";import"./FeatureIndex.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"../core/workers/RemoteClient.js";import"./APIKeyMixin.js";import"./ArcGISService.js";import"./CustomParametersMixin.js";import"./FeatureEffectLayer.js";import"../layers/support/FeatureEffect.js";import"../layers/support/FeatureFilter.js";import"./OperationalLayer.js";import"./commonProperties.js";import"../support/timeUtils.js";import"./OrderedLayer.js";import"./PortalLayer.js";import"./asyncUtils.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"./RefreshableLayer.js";import"./TemporalLayer.js";import"../TimeInterval.js";import"../layers/support/TimeInfo.js";import"./featureReductionUtils.js";import"../layers/support/FeatureReductionSelection.js";import"../layers/support/FeatureReductionCluster.js";import"../layers/support/LabelClass.js";import"./labelUtils.js";import"./defaultsJSON.js";import"../layers/support/FeatureTemplate.js";import"../layers/support/FeatureType.js";import"./fieldProperties.js";import"../layers/support/FieldsIndex.js";import"../layers/support/GeometryFieldsInfo.js";import"./labelingInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"./styleUtils2.js";import"../support/popupUtils.js";import"./Heading.js";import"../widgets/support/widget.js";import"./accessibleHandler.js";import"./vmEvent.js";import"../widgets/Spinner/SpinnerViewModel.js";import"./AnchorElementViewModel.js";import"../widgets/Popup/PopupViewModel.js";import"../symbols/support/symbolUtils.js";import"./ItemCache.js";import"../symbols/support/cimSymbolUtils.js";import"./utils5.js";import"./InputManager.js";import"./Queue.js";import"./layerViewUtils.js";import"./actions.js";import"./GoTo.js";import"./drapedUtils.js";import"./keybindings.js";import"./geometry2dUtils.js";import"../views/interactive/snapping/SnappingOptions.js";import"../views/interactive/snapping/FeatureSnappingLayerSource.js";import"./screenUtils2.js";import"./RenderCoordsHelper.js";import"./spatialReferenceSupport.js";import"./ImageMaterial.js";import"./NativeLineMaterial.js";import"../widgets/Slice/SlicePlane.js";import"./persistable.js";import"./multiOriginJSONSupportUtils.js";class Ui extends de{constructor(e){super(e),this._ray=oe(),this._externalResources=null,this._handles=new Q,this._isWorldDown=!1,this._start=S(),this._end=x(1,0,0),this._width=1,this._color=J(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=J(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=0,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=4,this._fadedExtensions=Yi,this.applyProps(e)}createExternalResources(){const e=new ge(this.materialParameters);this._handles.add(this.view.state.watch("camera",(()=>{this.updateGeometry()})));const t=new ce({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:e,laserline:t}}destroyExternalResources(){r(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalMaterial(e){r(this._externalResources)&&e(this._externalResources.material)}createGeometries(e){const t=[S(),S()],i=3===this.extensionType;i&&t.push(S(),S());const a=i?new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]):null,s=ue.createPolylineGeometry(t,null,a);e.addGeometry(s,n(this._externalResources).material),this.updateVertices(e)}updateVisibility(e){super.updateVisibility(e),r(this._externalResources)&&(this._externalResources.laserline.visible=e)}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,w(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),j(this._end,e,this._end),le(this._start,this._end,this._ray),this.updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,E(this._start,e)||(w(this._start,e),le(this._start,this._end,this._ray),this.updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,E(this._end,e)||(w(this._end,e),le(this._start,this._end,this._ray),this.updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this.updateMaterial())}get color(){return this._color}set color(e){O(e,this._color)||(G(this._color,e),this.updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this.updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this.updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this.updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){O(e,this._innerColor)||(G(this._innerColor,e),this.updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=r(e)!==r(this._stipplePattern);this._stipplePattern=e,t?this.recreate():this.updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(o(e)||o(this._stippleOffColor)||!O(e,this._stippleOffColor))&&(this._stippleOffColor=r(e)?K(e):null,this.updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this.updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this.updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&r(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,r(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,r(e)&&(this._externalResources.laserline.style=e))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,r(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=l(e,Yi),this.recreateGeometry()}updateMaterial(){if(o(this._externalResources))return;this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,polygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}updateGeometry(){r(this.object)&&this.updateVertices(this.object)}updateVertices(e){const t=3===this._extensionType?this.updateLineSegmentFinite(Ni):this.updateLineSegmentInfinite(this._extensionType,Ni);this.updateVertexAttributes(e,t),r(this._externalResources)&&(this._externalResources.laserline.intersectsLine=t)}updateLineSegmentFinite(e){return re(this._start,this._end,e)}updateLineSegmentInfinite(e,t){const i=this.view.state.camera;switch(ee(this._ray,Fi),e){case 0:Fi.c0=-Number.MAX_VALUE;break;case 1:case 2:{const e=this._ray.origin,t=l(this.view.elevationProvider.getElevation(e[0],e[1],e[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),i=this.view.renderCoordsHelper.getAltitude(e);this._isWorldDown&&i<t&&D(Fi.ray.direction,Fi.ray.direction),2===this._extensionType&&null!=t&&(Fi.c1=Math.abs(i-t));break}}if(!te(i.frustum,Fi))return re(this._start,this._end,t);const a=ie(Fi,Bi),s=ae(Fi,Zi);return re(a,s,t)}updateVertexAttributes(e,t){const i=e.geometries[0].getMutableAttribute("position").data;if(3===this.extensionType){const e=ne(t,-this.fadedExtensions.start,Bi);i[0]=e[0],i[1]=e[1],i[2]=e[2];const a=ne(t,0,Bi);i[3]=a[0],i[4]=a[1],i[5]=a[2];const s=ne(t,1,Bi);i[6]=s[0],i[7]=s[1],i[8]=s[2];const r=ne(t,1+this.fadedExtensions.end,Bi);i[9]=r[0],i[10]=r[1],i[11]=r[2]}else{const e=ne(t,0,Bi);i[0]=e[0],i[1]=e[1],i[2]=e[2];const a=ne(t,1,Bi);i[3]=a[0],i[4]=a[1],i[5]=a[2]}e.geometryVertexAttrsUpdated(e.geometryRecords[0])}}const Fi=$(),Bi=S(),Zi=S(),Ni=se(),Yi={start:.3333333333333333,end:.3333333333333333};class Wi extends de{constructor(e){super(e),this._handles=new Q,this._location=S(),this._direction=x(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=J(1,0,1,1),this._renderOccluded=4,this.applyProps(e)}get location(){return this._location}set location(e){E(this._location,e)||(w(this._location,e),this.updateGeometry())}get direction(){return this._direction}set direction(e){E(this._direction,e)||(w(this._direction,e),this.updateGeometry())}setDirectionFromPoints(e,t){R(this._direction,j(this._direction,t,e)),this.updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this.updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this.updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this.updateGeometry())}get color(){return this._color}set color(e){O(e,this._color)||(G(this._color,e),this.updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial())}createExternalResources(){const e=new ge(this.materialParameters);this._handles.add(this.view.state.watch("camera",(()=>{this.updateGeometry()}))),this._externalResources={material:e}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(e){const t=ue.createPolylineGeometry([S(),S()]),i=ue.createPolylineGeometry([S(),S()]),a=n(this._externalResources).material;e.addGeometry(t,a),e.addGeometry(i,a),this.updateVertices(e)}forEachExternalMaterial(e){r(this._externalResources)&&e(this._externalResources.material)}updateMaterial(){if(o(this._externalResources))return;this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}updateGeometry(){const e=this.object;o(e)||this.updateVertices(e)}updateVertices(e){const t=this.view.state.camera;t.projectToScreen(this.location,qi),A(Xi,this.location,this.direction),t.projectToScreen(Xi,Qi),Me(Qi,be(Qi,Qi,qi)),this.updateVertexAttributes(t,e,0,qi,Qi,1),this.updateVertexAttributes(t,e,1,qi,Qi,-1)}updateVertexAttributes(e,t,i,a,s,r){const n=t.geometryRecords[i],o=n.geometry.getMutableAttribute("position").data,l=Se(Ji,xe(Ji,s[1]*r,s[0]*-r),this.offset+this.width/2),p=we(Ki,we(Ki,we(Ki,a,Se(Ki,s,this.length/2)),l),l),h=we($i,p,Se($i,s,-this.length));e.unprojectFromScreen(p,Xi),o[0]=Xi[0],o[1]=Xi[1],o[2]=Xi[2],e.unprojectFromScreen(h,Xi),o[3]=Xi[0],o[4]=Xi[1],o[5]=Xi[2],t.geometryVertexAttrsUpdated(n)}}const Xi=S(),qi=ve(),Qi=ve(),Ji=ve(),Ki=ve(),$i=ve();class ea{constructor(e){this.view=null,this._geometry=null,this._size=3,this._color=De(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=De(1,1,1,1),this._elevationInfo=null,this.resources=new He({view:e.view,createResources:e=>this.createResources(e),recreateGeometry:(e,t)=>(e.geometry=this.recreateGeometry(t,e.material),r(e.geometry)?[e.geometry]:[])});let t=!0;for(const i in e)i in this?"attached"===i?t=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}destroy(){this.resources.destroy()}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e}get attached(){return this.resources.attached}set attached(e){this.resources.attached=e}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const t=this.preferredTextureSize;this._size=e,t<this.preferredTextureSize?r(this.resources)&&this.resources.recreate():this.updateSizeAttribute()}}get color(){return this._color}set color(e){O(e,this._color)||(G(this._color,e),this.updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this.updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,r(this.resources)&&this.resources.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this.updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){O(e,this._outlineColor)||(G(this._outlineColor,e),this.updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources&&this.resources.recreateGeometry()}updateMaterial(){const e=this.resources.resources;o(e)||e.material.setParameters(this.materialParameters(e.texture.id))}updateSizeAttribute(){const e=this.resources.resources,t=this.resources.object;if(o(e)||o(t))return;const i=e.geometry;if(o(i))return;const a=i.getMutableAttribute("size").data,s=this.geometrySize;a[0]=s,a[1]=s,t.geometryVertexAttrsUpdated(t.geometryRecords[0])}materialParameters(e){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:ia,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:e,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled}}get geometrySize(){return this._size/ta}recreateGeometry(e,t){const i=this.createRenderGeometry();return r(i)&&e.addGeometry(i,t),i}createResources(e){const t=this.createTexture(),i=new Ze(this.materialParameters(t.id)),a=this.recreateGeometry(e,i);return{material:i,texture:t,geometry:a,forEach(e){e(t),e(i),r(this.geometry)&&e(this.geometry)}}}get preferredTextureSize(){return I(P(2*this.geometrySize),16,128)}createTexture(){const e=this.preferredTextureSize;return new We(Ne(this._primitive,e,e*ta),{mipmap:!1,wrap:{s:33071,t:33071},width:e,height:e,components:4,noUnpackFlip:!0})}calculateMapBounds(e){if(o(this.resources.resources)||o(this.resources.resources.geometry))return!1;const t=this.resources.resources.geometry.vertexAttributes.get("position");return Re(t.data,this.view.renderCoordsHelper.spatialReference,aa,this.view.spatialReference),Ie(e,aa),!0}createRenderGeometry(){const e=this.geometry;if(o(e))return null;const{renderCoordsHelper:t,elevationProvider:i}=this.view,a=ye(e,i,Be.fromElevationInfo(this.elevationInfo),t),s=V(Te.get(),e.x,e.y,a),r=Te.get();Re(s,e.spatialReference,r,t.spatialReference);const n=this.geometrySize;return ue.createPointGeometry(null,r,null,[n,n],[0,0,0,1])}}const ta=.5,ia=[ta/2,ta/2,1-ta/2,1-ta/2],aa=S();class sa extends Ke{visualizeIntersectionPoint(e,i){const{coordinateHelper:a,elevationInfo:s,view:r}=i;return t(new ea({view:r,primitive:"circle",geometry:a.vectorToPoint(e.intersectionPoint),elevationInfo:s,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:b.toUnitRGBA(qe.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,i){const{coordinateHelper:a,elevationInfo:s,view:r}=i;return t(new ea({view:r,primitive:"circle",geometry:a.vectorToPoint(e.point),elevationInfo:s,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:b.toUnitRGBA(qe.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,i){const{coordinateHelper:a,elevationInfo:s,view:r}=i;return t(this.createLineSegmentHintFromMap(e.type,e.lineStart,e.lineEnd,a,s,r,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,i){const{coordinateHelper:a,elevationInfo:s,view:r}=i,n=Qe(e.lineStart,a,s,i.view),o=Qe(e.lineEnd,a,s,i.view),l=C(o,n,o,.5),p=new Wi({view:r,attached:!1,offset:qe.parallelLineHintOffset,length:qe.parallelLineHintLength,width:qe.parallelLineHintWidth,color:b.toUnitRGBA(qe.orange),location:l,renderOccluded:16});return p.setDirectionFromPoints(n,l),p.attached=!0,t(p)}visualizeRightAngleQuad(e,i){const{coordinateHelper:a,elevationInfo:s,view:r}=i;return t(new Xe({view:r,attached:!0,color:b.toUnitRGBA(qe.orange),renderOccluded:2,outlineRenderOccluded:16,outlineColor:b.toUnitRGBA(qe.orange),outlineSize:qe.rightAngleHintOutlineSize,size:qe.rightAngleHintSize,geometry:{previous:Qe(e.previousVertex,a,s,r),center:Qe(e.centerVertex,a,s,r),next:Qe(e.nextVertex,a,s,r)}}))}createLineSegmentHintFromMap(e,t,i,a,s,r,n=!0,o=!0){const l=S(),p=S();return Je(t,i,a,s,r,l,p),this.createLineSegmentHint(e,r,l,p,n,o)}createLineSegmentHint(e,t,i,a,s=!0,r=!0){const n=new Ui({view:t,extensionType:3,start:i,end:a,color:b.toUnitRGBA(qe.orange),renderOccluded:16});switch(e){case 0:n.width=qe.lineHintWidthTarget,n.fadedExtensions={start:0,end:qe.lineHintFadedExtensions};break;case 2:n.width=qe.lineHintWidthReference,n.fadedExtensions={start:0,end:0};break;case 1:n.width=qe.lineHintWidthReference,n.fadedExtensions={start:s?qe.lineHintFadedExtensions:0,end:r?qe.lineHintFadedExtensions:0}}return n.attached=!0,n}}class ra extends de{constructor(e){super(e),this.view=null,this._renderOccluded=4,this._vertices=null,this._spatialReference=null,this._color=Le.colorToVec4(Le.reshapeManipulators.vertex.color),this._size=Le.reshapeManipulators.vertex.size,this._outlineColor=Le.colorToVec4(Le.reshapeManipulators.vertex.outlineColor),this._outlineSize=Le.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial(),this.updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){O(e,this._color)||(G(this._color,e),this.updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this.updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){O(e,this._outlineColor)||(G(this._outlineColor,e),this.updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this.updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSize:this.size,renderOccluded:this._renderOccluded}}get vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSize:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}updateMaterial(){this.attached&&this.vertexMaterial.setParameters(this.vertexMaterialParameters)}updateOutlineMaterial(){this.attached&&this.vertexOutlineMaterial.setParameters(this.vertexOutlineMaterialParameters)}createRenderGeometries(){const e=this.vertices;if(o(e)||0===e.length)return[];const t=Ye(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Be.fromElevationInfo(this.elevationInfo)),i=[],a=t.numVertices,s=t.position;for(let e=0;e<a;++e){const t=V(na,s[3*e+0],s[3*e+1],s[3*e+2]),a=oa(.5,t),r=oa(.5,t);i.push({vertexGeometry:a,vertexOutlineGeometry:r})}return i}createGeometries(e){const t=this.createRenderGeometries();for(const{vertexGeometry:i,vertexOutlineGeometry:a}of t)e.addGeometry(i,this.vertexMaterial),e.addGeometry(a,this.vertexOutlineMaterial)}createExternalResources(){this.vertexMaterial=new et({...this.vertexMaterialParameters,writeDepth:!0,cullFace:2,screenSizeEnabled:!0}),this.vertexOutlineMaterial=new et({...this.vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:1,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this.vertexMaterial),e(this.vertexOutlineMaterial)}}const na=S();function oa(e,t){return ue.createSphereGeometry(e,16,16,{offset:t})}let la=class extends lt{constructor(e){super(e),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:e,offset:t}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new M({mode:e,offset:t})}normalizeCtorArgs(e){if(!e.elevationInfo){var t;const i=null==(t=e.hasZ)||t;return{...e,elevationInfo:{mode:i?"absolute-height":"on-the-ground",offset:0}}}return e}initializeGraphic(e){return this._createGraphicState=new ot({graphic:e}),i([this.view.maskOccludee(e),this.view.trackGraphicState(this._createGraphicState),u(this._createGraphicState,"isDraped",(e=>{r(this._outlineVisualElement)&&(this._outlineVisualElement.isDraped=e)}))])}makeDrawOperation(){return new ht({view:this.view,manipulators:this.manipulators,geometryType:pt(this.geometryType),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new ct(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new dt(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new sa})}onActiveVertexChanged(e){return r(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[e],null):(this._activeVertexVisualElement=new ra({view:this.view,spatialReference:this.view.spatialReference,vertices:[e],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:Le.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=Le.colorToVec4(Le.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,a((()=>{this._activeVertexVisualElement=p(this._activeVertexVisualElement)})))}onOutlineChanged(e){if(r(this._outlineVisualElement))return this._outlineVisualElement.geometry=e,null;const t=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new Ue({view:this.view,geometry:e,elevationInfo:t,isDraped:r(this._createGraphicState)?this._createGraphicState.isDraped:"on-the-ground"===y(this.hasZ,t),attached:!1}),Le.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),Le.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,a((()=>{this._outlineVisualElement=p(this._outlineVisualElement)}))}onRegularVerticesChanged(e){return r(this._verticesVisualElement)?(this._verticesVisualElement.vertices=e,null):(this._verticesVisualElement=new ra({view:this.view,spatialReference:this.view.spatialReference,vertices:e,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:Le.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,a((()=>{this._verticesVisualElement=p(this._verticesVisualElement)})))}};e([m({constructOnly:!0})],la.prototype,"elevationInfo",void 0),e([m({constructOnly:!0})],la.prototype,"geometryType",void 0),e([m({readOnly:!0})],la.prototype,"type",void 0),e([m({constructOnly:!0,nonNullable:!0})],la.prototype,"view",void 0),la=e([g("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],la);class pa{constructor(){this.grabbingState=0,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=0,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator(((e,t)=>{if(0===t&&(this.zManipulator=e),e instanceof tt&&(e.selected&&(0===this.numSelected&&(this.firstSelected=e),this.numSelected++),o(this.firstGrabbedXY)&&e.grabbing&&1===t&&(this.firstGrabbedXY=e)),e.grabbing)switch(this.grabbingState|=1,t){case 0:this.grabbingState|=2;break;case 1:this.grabbingState|=4}}))}}function ha(e){const{view:a,graphic:n}=e,o=new ot({graphic:n}),l=function(e,a){const{view:s,graphic:r}=e,n=new Ue({view:s,geometry:ca(r)?r.geometry:null,elevationInfo:v(r),attached:!1});Le.visualElements.lineGraphics.shadowStyle.apply(n);const o=()=>{n.attached=a.displaying};Le.visualElements.lineGraphics.outline.apply(n);const l=[a.watch("displaying",o),a.watch("isDraped",(e=>n.isDraped=e)),a.on("changed",(()=>n.geometry=ca(r)?r.geometry:null)),t(n)];return o(),{visualElement:n,remove:()=>i(l).remove()}}(e,o),p=function(e,a,n){const{graphic:o,view:l}=e,p=[],h=v(o),c="on-the-ground"===h.mode||!h.offset&&"absolute-height"!==h.mode,d=new pa,u=new Ui({view:l,extensionType:Le.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});Le.visualElements.pointGraphics.shadowStyle.apply(u);const m=T(Le.visualElements.heightPlaneAngleCutoff),g=new ce({view:l,attached:!1,angleCutoff:m});Le.visualElements.heightPlane.apply(g);let y=1,f=1;const _=()=>{if(d.update(e),!n.displaying||c&&(n.isDraped||!ca(o)||!o.geometry.hasZ))return a.laserlineEnabled=!1,u.attached=!1,void(g.attached=!1);a.laserlineEnabled=!0;{const e=4&d.grabbingState?Le.visualElements.laserlineAlphaMultiplier:1;e!==y&&(y=e,Le.visualElements.lineGraphics.shadowStyle.apply(a,e),Le.visualElements.pointGraphics.shadowStyle.apply(u,e))}{const e=2&d.grabbingState?Le.visualElements.laserlineAlphaMultiplier:1;e!==f&&(f=e,Le.visualElements.heightPlane.apply(g,e))}!function(e,t){const i=1===t.numSelected?t.firstSelected:t.numSelected>1&&r(t.firstGrabbedXY)?t.firstGrabbedXY:null;r(i)?(e.setStartEndFromWorldDownAtLocation(i.renderLocation),e.attached=!0):e.attached=!1}(u,d),function(e,t,i,a){if(a.numSelected>0){V(da,0,0,0);let t=0;e.forEachManipulator(((e,i)=>{1===i&&e.selected&&e instanceof tt&&(A(da,da,e.renderLocation),t++)})),t>0?(i.heightManifoldTarget=z(da,da,1/t),i.attached=!0):i.attached=!1}else{const a=t.attachmentOrigin;r(a)&&e.view.renderCoordsHelper.toRenderCoords(a,da)?(i.heightManifoldTarget=da,i.attached=!0):i.attached=!1}}(e,a,g,d)};Le.visualElements.zVerticalLine.apply(u),p.push(n.on("changed",_),n.watch("displaying",_),a.events.on("attachment-origin-changed",_),t(u),t(g));const M=[],b=()=>{i(M).remove(),M.length=0,e.forEachManipulator((e=>M.push(e.events.on("grab-changed",_)))),e.forEachManipulator((e=>M.push(e.events.on("select-changed",_)))),_()};return b(),p.push(e.onManipulatorsChanged(b),s((()=>i(M)))),i(p)}(e,l.visualElement,o),h=[l,p,a.maskOccludee(n),a.trackGraphicState(o)];return{visualElement:l.visualElement,remove:()=>i(h).remove()}}function ca(e){return r(e.geometry)&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const da=S();function ua(e){const{view:a,graphic:n}=e,l=new ot({graphic:n}),p=[],h=function(e,i,a){const{view:n,graphic:o}=e,l=new ea({view:n,geometry:ma(o),elevationInfo:v(o),attached:!1});return function(e,t,i,a){const n=()=>t.attached=i.displaying;(function(e,t,i,a){const{view:n,graphic:o}=e;let l=null;const p=e=>{r(l)&&(l.remove(),l=null),i.isDraped&&r(e)&&(l=function(e,t,i){const a=e.elevationProvider.spatialReference;Ae(t,ga,a);const s=ga[0],r=ga[1];return e.elevationProvider.on("elevation-change",(e=>{Mt(e.extent,s,r)&&i()}))}(n,e,(()=>{t.geometry=e})))},h=()=>{const e=ma(o);p(e),t.geometry=e};a.push(i.on("changed",h),s((()=>l))),h()})(e,t,i,a),Le.visualElements.pointGraphics.outline.apply(t),a.push(u(i,"displaying",n))}(e,l,i,a),a.push(t(l)),l}(e,l,p);return function(e,i,a,s){const{view:n,graphic:l}=e,p=new Ui({view:n,extensionType:Le.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});Le.visualElements.zVerticalLine.apply(p);const h=new ce({view:n,intersectsLineInfinite:!0,attached:!1});Le.visualElements.pointGraphics.shadowStyle.apply(h);const c=T(Le.visualElements.heightPlaneAngleCutoff),d=new ce({view:n,attached:!1,angleCutoff:c});Le.visualElements.heightPlane.apply(d);const u=v(e.graphic),m=Be.fromElevationInfo(u),g="on-the-ground"===u.mode||!u.offset&&"absolute-height"!==u.mode,y=new pa;let f=1,_=1;const M=()=>{y.update(e);const t=ma(l),a=g&&(i.isDraped||o(t)||!t.hasZ);let c=!0;if(!a&&r(t)){const e=ye(t,n.elevationProvider,m,n.renderCoordsHelper);V(ga,t.x,t.y,e),Re(ga,t.spatialReference,ga,n.renderCoordsHelper.spatialReference),p.setStartEndFromWorldDownAtLocation(ga),h.intersectsWorldUpAtLocation=ga}else c=!1;const u=2&y.grabbingState?Le.visualElements.laserlineAlphaMultiplier:1;u!==f&&(f=u,Le.visualElements.heightPlane.apply(d,u));const v=Ve(ya);!a&&i.displaying&&s.calculateMapBounds(v)&&Re(Ce(v,ga),n.spatialReference,ga,n.renderCoordsHelper.spatialReference)?(d.heightManifoldTarget=ga,d.attached=!0):d.attached=!1;const M=4&y.grabbingState?Le.visualElements.laserlineAlphaMultiplier:1;M!==_&&(_=M,Le.visualElements.pointGraphics.shadowStyle.apply(h,M));const b=c&&i.displaying&&!a;h.attached=b,p.attached=b};a.push(i.watch(["displaying","isDraped"],M),i.on("changed",M)),e.forEachManipulator((e=>{a.push(e.events.on("grab-changed",M))})),a.push(t(h)),a.push(t(p)),a.push(t(d)),M()}(e,l,p,h),p.push(a.trackGraphicState(l)),{visualElement:h,remove(){i(p).remove()}}}function ma(e){const t=e.geometry;return o(t)?null:"point"===t.type?t:"mesh"===t.type?t.anchor.clone():null}const ga=S(),ya=Pe();function va(e){switch(n(e.graphic.geometry).type){case"point":case"mesh":return ua(e);case"polygon":case"polyline":return ha(e);default:return null}}const fa=[1,.5,0],_a=Math.ceil(70/3*2),Ma=5*Math.PI/12,ba=1*Math.PI/3;class Sa{constructor(){this._available=!0}set location(e){this.forEachManipulator3D((t=>t.location=e))}set elevationAlignedLocation(e){this.forEachManipulator3D((t=>t.elevationAlignedLocation=e))}set elevationInfo(e){this.forEachManipulator3D((t=>t.elevationInfo=e))}get renderLocation(){let e;return this.forEachManipulator3D((t=>{e||(e=t.renderLocation)})),e}get available(){return this._available}set available(e){this._available=e,this.forEachManipulator3D((t=>t.available=e))}get grabbing(){return this.someManipulator((e=>e.grabbing))}get dragging(){return this.someManipulator((e=>e.dragging))}hasManipulator(e){return this.someManipulator((t=>t===e))}someManipulator(e){let t=!1;return this.forEachManipulator((i=>{!t&&e(i)&&(t=!0)})),t}forEachManipulator3D(e){this.forEachManipulator(((t,i)=>{t instanceof tt&&e(t,i)}))}}function xa(e,t,i,a){const s=e.graphic,r=(e,i)=>t({action:e,graphic:s,dxScreen:i.screenDeltaX,dyScreen:i.screenDeltaY});return i(((e,t,i)=>{const n=t.next((e=>("start"===e.action&&r("start",e),e))).next(Ut(s,a)).next((e=>{switch(e.action){case"start":case"update":(e.translationX||e.translationY||e.translationZ)&&r("update",e);break;case"end":r("end",e)}return e}));return i.next(Ft(s)).next((()=>{r("end",{screenDeltaX:0,screenDeltaY:0})})),n}))}function wa(e){if(o(e)||"polyline"!==e.type&&"polygon"!==e.type)return 0;const t=("polyline"===e.type?e.paths:e.rings)[0];if(!t||t.length<2)return 0;const i=t[0],a=t[1];return Math.atan2(a[1]-i[1],a[0]-i[0])}class ja extends Sa{constructor(e){super(),this._handles=new Q,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this.createMaterial(),this._transparentMaterial=this.createMaterial(.5),this._angle=0,this._scale=1,this._radius=70,this._updateAfterDrag=!1,this.events=new gt,this._tool=e.tool,this._view=e.view,null!=e.radius&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}set orthogonalAvailable(e){this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e}destroy(){this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._handles=p(this._handles),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){for(const{manipulator:t}of this._arrowManipulatorInfos)e(t,1)}createGraphicDragPipeline(e,t,i){const a=t.graphic,s=v(a),r=n(a.geometry).spatialReference;return xa(t,i,(t=>this.createDragPipeline(((i,a,s,r,n)=>t(i,e(i,a,s,r,n),s)),s,r,a)),this._view.state.viewingMode)}createDragPipeline(e,t,a,s){return i(this._arrowManipulatorInfos.map((({manipulator:i},r)=>Bt(i,((i,n,o,l,p)=>{const h=n.next((e=>({...e,manipulatorType:1}))).next(Zt(this._view,i.elevationAlignedLocation)).next(Vt(this._view,i.elevationAlignedLocation,t,a,s)).next(Nt(i.location,this.angle+(r+1)*Math.PI*.5)).next(Yt());e(i,h,o,l,p)})))))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:e,transform:t},i){const a=this._radius/70,s=54*a,r=s*Math.sqrt(3)/2,n=ue.createExtrudedTriangle(r,s/2,s/2,.02);ue.transformInPlace(n,bt(ze.get(),V(Te.get(),0,-r/3,0))),e.renderObjects=[{geometry:n,material:this._opaqueMaterial,stateMask:2},{geometry:n,material:this._transparentMaterial,stateMask:1}],e.radius=r/3*2*1.2;const o=St(ze.get());xt(o,i*Math.PI/2);const l=St(ze.get());bt(l,V(Te.get(),0,100*a,0)),wt(t,o,l)}_createManipulators(){for(let e=0;e<4;e++){const t=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(t)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const e=this.angle,t=St(ze.get());jt(t,t,e,x(0,0,1));const i=Et(ze.get(),V(Te.get(),this.displayScale,this.displayScale,this.displayScale)),a=St(ze.get());wt(a,i,t);for(const e of this._arrowManipulatorInfos){const t=wt(ze.get(),a,e.transform);e.manipulator.modelTransform=t}}_createArrowManipulator(e){const t=new tt({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:x(0,0,1)}}),i={manipulator:t,transform:At()};return this._updateArrowManipulator(i,e),this._handles.add(t.events.on("drag",(e=>{this._updateAfterDrag&&"end"===e.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)}))),i}createMaterial(e=1){const t=b.toUnitRGBA(Fe.main);return t[3]*=e,new me({color:t,transparent:1!==e,cullFace:2,renderOccluded:2})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map((({manipulator:e})=>e))}}}class Ea{constructor(){this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new Wt,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&r(this.lastDragEvent)){const t=this.lastDragEvent.mapEnd,i=this.snap(this.lastDragEvent.screenEnd);if(r(i)){const a={action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:!0===e?i:t,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd};this.next.execute(a)}}this._enabled=e}snap(e){const t=r(this.view)?this.view.toMap(e,{exclude:[]}):null;return r(t)&&r(this.view)&&(t.z=f(t,this.view,this.elevationInfo)),t}createDragEventPipelineStep(e,t){return this.view=e,this.elevationInfo=t,this.lastDragEvent=null,e=>{if(this.lastDragEvent="end"!==e.action?{...e}:null,this._enabled){const t=this.snap(e.screenEnd);return r(t)?{action:e.action,mapStart:e.mapStart,mapEnd:t,screenStart:e.screenStart,screenEnd:e.screenEnd}:null}return{action:e.action,mapStart:e.mapStart,mapEnd:e.mapEnd,screenStart:e.screenStart,screenEnd:e.screenEnd}}}}class Oa extends Sa{constructor(e){super(),this._handles=new Q,this._snapToScene=new Ea,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=70,this._view=e.view,this._tool=e.tool,null!=e.snapToScene&&(this.snapToScene=e.snapToScene),null!=e.radius&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,1)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}createGraphicDragPipeline(e,t,i){const a=t.graphic,s=v(a),r=n(a.geometry).spatialReference;return xa(t,i,(t=>this.createDragPipeline(((i,a,s,r,n)=>t(i,e(i,a,s,r,n),s)),s,r,a)),this._view.state.viewingMode)}createDragPipeline(e,t,i,a){const s=this._view;return Bt(this._manipulator,((r,n,o,l,p)=>{const h=n.next(Zt(s,r.elevationAlignedLocation)).next(Vt(s,r.elevationAlignedLocation,t,i,a)).next(this._snapToScene.createDragEventPipelineStep(s,t),this._snapToScene.next).next((e=>({...e,manipulatorType:1}))).next(Yt());e(r,h,o,l,p)}))}_updateManipulatorTransform(){const e=Et(ze.get(),V(Te.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new tt({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:x(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=ue.createCylinderGeometry(.02,1,128,x(0,0,1),x(0,0,0)),t=Et(At(),x(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:e,material:this._discMaterial,transform:t,stateMask:2},{geometry:e,material:this._discMaterialTransparent,transform:t,stateMask:1}],this._manipulator.radius=this._radius/70*80}_createMaterial(e=1){const t=b.toUnitRGBA(Fe.main);return t[3]*=e,new me({color:t,transparent:1!==e,cullFace:2,renderOccluded:2})}get test(){return{discManipulator:this._manipulator}}}class Ga extends Sa{constructor(e){super(),this._handles=new Q,this._radius=70,this.events=new gt,this._tool=e.tool,this._view=e.view,null!=e.radius&&(this._radius=e.radius),this.createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()}))}forEachManipulator(e){e(this._manipulator,0)}createGraphicDragPipeline(e,t,i){const a=n(t.graphic.geometry).spatialReference;return xa(t,i,(t=>this.createDragPipeline(((i,a,s,r,n)=>t(i,e(i,a,s,r,n),s)),a)),this._view.state.viewingMode)}createDragPipeline(e,t){const i=this._view;return Bt(this._manipulator,((a,s,r,n,o)=>{const l=s.next((e=>({...e,manipulatorType:0}))).next(Ct(i,a.renderLocation,t)).next(Yt());e(a,l,r,n,o)}))}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this.updateManipulator())}updateManipulator(){const e=this._radius/70,t=Le.zManipulator.height*e,i=Le.zManipulator.coneHeight*e,a=Le.zManipulator.coneWidth*e,s=Le.zManipulator.width*e,r=[x(0,0,0),x(0,0,t)],n=ue.createTubeGeometry(r,s/2,16,!1),o=ue.createConeGeometry(i,a/2,16,!1),l=[x(0,0,0),x(0,0,t+i)],p=(e=>{const i=At();if(Ot(i,i,[0,0,t]),Gt(i,i,Math.PI/2),e){const t=1+2*e/a;Dt(i,i,[t,t,t])}return i})(0),h=(e,t)=>{const i=Kt(Le.zManipulator.color,t);return[i.r/255,i.g/255,i.b/255,Le.zManipulator.color.a*e]},c=it(h(1,.25),1),d=it(h(1,0),1),u=it(h(.7,0),Le.zManipulator.renderOccluded),m=it(h(.85,0),Le.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:o,transform:p,material:c,stateMask:1},{geometry:n,material:c,stateMask:1},{geometry:o,transform:p,material:d,stateMask:2},{geometry:n,material:d,stateMask:2},{geometry:o,transform:p,material:u,stateMask:1},{geometry:n,material:u,stateMask:1},{geometry:o,transform:p,material:m,stateMask:2},{geometry:n,material:m,stateMask:2}],this._manipulator.radius=s/2+2,this._manipulator.collisionType={type:"line",paths:[l]}}createManipulator(){const e=new tt({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=e=>{const t=this._view.state.camera,i=Da;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,i);const a=k(t.eye,i),s=t.computeRenderPixelSizeAtDist(a),r=j(Ra,i,t.eye);R(r,r);const n=Aa;this._view.renderCoordsHelper.worldUpAtPosition(Da,n);const o=Math.abs(H(r,n)),l=L(Ra,r,n),p=L(Ra,l,n),h=I(o,.01,1),c=1-Math.sqrt(1-h*h)/h/t.fullWidth,d=this._radius/70,u=Le.zManipulator.width*d;z(p,R(p,p),(1/c-1)*a+s*u),e[12]-=Ra[0],e[13]-=Ra[1],e[14]-=Ra[2]},this._manipulator=e,this.updateManipulator()}get test(){return{manipulator:this._manipulator}}}const Da=S(),Ra=S(),Aa=S();class Ia extends Sa{constructor(e){super(),this._handles=new Q,this._angleDeferred=null,this._interactive=!0;const{tool:t,view:i,snapToScene:a,radius:s}=e;this._view=i,this.xyManipulation=new Oa({tool:t,view:i,snapToScene:a,radius:s}),this.xyAxisManipulation=new ja({tool:t,view:i,radius:s}),this.zManipulation=new Ga({tool:t,view:i,radius:s}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this.autoHideXYAxis(),this.forEachManipulator((e=>{this._handles.add(e.events.on("grab-changed",(()=>this.updateManipulatorInteractivity())))}))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(e,t,a){return i([this.xyManipulation.createGraphicDragPipeline(((t,i,a,s,r)=>e(0,t,i,a,s,r)),t,a),this.xyAxisManipulation.createGraphicDragPipeline(((t,i,a,s,r)=>e(1,t,i,a,s,r)),t,a),this.zManipulation.createGraphicDragPipeline(((t,i,a,s,r)=>e(2,t,i,a,s,r)),t,a)])}createDragPipeline(e,t,a,s){return i([this.xyManipulation.createDragPipeline(((t,i,a,s,r)=>e(0,t,i,a,s,r)),t,a,s),this.xyAxisManipulation.createDragPipeline(((t,i,a,s,r)=>e(1,t,i,a,s,r)),t,a,s),this.zManipulation.createDragPipeline(((t,i,a,s,r)=>e(2,t,i,a,s,r)),a)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this._angleDeferred=null,this.xyAxisManipulation.angle=e}set angleDeferred(e){this.xyAxisVisible?this.angle=e():this._angleDeferred=e}set interactive(e){this._interactive!==e&&(this._interactive=e,this.updateManipulatorInteractivity())}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator((t=>e(t,1))),this.xyAxisManipulation.forEachManipulator((t=>e(t,1))),this.zManipulation.forEachManipulator((t=>e(t,0)))}get xyAxisVisible(){const e=this.xyManipulation.someManipulator((e=>e.focused))||this.xyAxisManipulation.someManipulator((e=>e.focused));return this._view.inputManager&&"touch"===this._view.inputManager.latestPointerType||e}autoHideXYAxis(){const e=this.xyAxisManipulation,t=this.xyManipulation;if(h("esri-mobile"))return;const i=[];t.forEachManipulator((e=>i.push(e))),e.forEachManipulator((e=>i.push(e)));const a=()=>{const t=[];this.xyAxisVisible?r(this._angleDeferred)&&(this.angle=this._angleDeferred()):e.forEachManipulator((e=>t.push(e.disableDisplay()))),this._handles.remove(Pa),this._handles.add(t,Pa)};for(const e of i)this._handles.add(e.events.on("focus-changed",a));this._view.inputManager&&this._handles.add(this._view.inputManager.watch("latestPointerType",a)),a()}updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator((t=>{t.interactive=!e&&this._interactive||t.grabbing}))}static radiusForSymbol(e){const t=r(e)&&"point-3d"===e.type&&e.symbolLayers;return!!t&&t.length>0&&t.some((e=>"icon"===e.type))?_a:70}}const Pa="disable-xy-axis-display";class Va extends Sa{constructor(e){super(),this._handles=new Q,this._view=e.view,this._tool=e.tool,this._graphicState=e.graphicState,this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(e){e(this._manipulator,1)}createGraphicDragPipeline(e){return xa(this._graphicState,e,(e=>this.createDragPipeline(e)),this._view.state.viewingMode)}createDragPipeline(e){const t=this._view,i=this._graphicState.graphic,a=r(i.geometry)?i.geometry.spatialReference:null;return Bt(this._manipulator,((s,r,n,o,l)=>{const p=r.next(Tt(l,t,i,a)).next(Xt()).next(Yt());e(s,p,n,o,l)}))}_createManipulator(){const e=this._view,t=this._graphicState.graphic;this._manipulator=new $t({graphic:t,view:e,selectable:!0,cursor:"move"})}}class Ca{constructor(e){this.allGraphics=e,this.type="graphic-move-start"}}class Ta{constructor(e,t,i){this.dx=e,this.dy=t,this.allGraphics=i,this.type="graphic-move"}}class za{constructor(e){this.allGraphics=e,this.type="graphic-move-stop"}}let ka=class extends(yt(gt.EventedMixin(qt))){constructor(e){super(e),this.graphics=new mt,this.enableZ=!0,this.type="move-3d",this._toolHandles=new Q,this.snappingPipeline=new ut}initialize(){this._toolHandles.add([this.graphics.on("change",(()=>this._refreshManipulators()))]),this._refreshManipulators(),this.complete()}destroy(){this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const e=this.graphics.toArray().filter((e=>0===ei(e))).map((e=>new Ha(e)));e.length&&(this.createManipulators(e),this.createVisualElements(e),this.handles.add(e.map((e=>this.view.trackGraphicState(e.state)))),this.updateMoveManipulation(e))}createManipulators(e){for(const t of e){const i=t.state;t.manipulationXY=new Va({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:i.graphic}),e.stopPropagation()}))))),this.handles.add(t.manipulationXY.createDragPipeline(((t,i,a,s)=>this.buildDragEventPipeline(e,0,t,i,a,s))))}this.createMoveManipulation(e)}createMoveManipulation(e){const t=new Ia({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===e.length?Ia.radiusForSymbol(e[0].graphic.symbol):70});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator((e=>{this.handles.add(e.events.on("immediate-click",(i=>{t.zManipulation.hasManipulator(e)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.getItemAt(0)}),i.stopPropagation()})))}));const i=()=>this.updateMoveManipulation(e);for(const t of e)this.handles.add([t.state.on("changed",i),t.state.watch("displaying",i)]);const a=e[e.length-1];this.handles.add(a.state.on("changed",(()=>this.updateMoveManipulationAngle(a)))),this.handles.add(t.createDragPipeline(((t,i,a,s,r)=>this.buildDragEventPipeline(e,t,i,a,s,r)),v(a.graphic),n(a.graphic.geometry).spatialReference,a.graphic)),this.updateMoveManipulationAngle(a)}createVisualElements(e){for(const t of e){const i=t.graphic,s=va({view:this.view,graphic:i,forEachManipulator:e=>{t.manipulationXY.forEachManipulator(e),this._moveManipulation.forEachManipulator(e)},onManipulatorsChanged:()=>a()});o(s)||(t.geometryRepresentation=s.visualElement,t.geometryRepresentation instanceof Ue&&this.handles.add([t.geometryRepresentation.events.on("attachment-origin-changed",(()=>{t.state.isDraped||this.updateMoveManipulation(e)})),t.state.watch("isDraped",(()=>this.updateMoveManipulation(e)))]),this.handles.add(s))}}updateMoveManipulationAngle(e){this._moveManipulation.angleDeferred=()=>wa(e.graphic.geometry)}updateMoveManipulation(e){const t=ft(0,0,0,this.view.spatialReference);let i=0,a=!1;const s=this._moveManipulation;for(const s of e){if(!s.state.displaying)continue;const e=s.state.graphic;this.enableZ&&_t(e)&&(a=!0);const n=s.geometryRepresentation instanceof Ue&&!s.state.isDraped?s.geometryRepresentation.attachmentOrigin:at(this.view,e);r(n)&&(t.x+=n.x,t.y+=n.y,t.z+=n.z,i++)}i>0?(t.x/=i,t.y/=i,t.z/=i,s.location=t,s.xyManipulation.available=!0,s.xyAxisManipulation.available=!0,s.zManipulation.available=a):s.available=!1}buildDragEventPipeline(e,t,i,a,s,r){const n=[],o=[];let l=null,p=null;const h=()=>{for(const e of n)e.dragging=!1;n.length=0,o.length=0,l=null,p=null,this._moveManipulation.interactive=!0};if(1===e.length&&0===t){const t=e[0].graphic;a=this.buildSnappingPipelineSteps(t,v(t),a,s,r)}const c=a.next((t=>{if("start"===t.action){n.length=0,o.length=0;for(const t of e)t.dragging||!t.manipulationXY.hasManipulator(i)&&t.manipulationXY.grabbing||(n.push(t),o.push(t.graphic),t.dragging=!0);if(0!==o.length&&(this._moveManipulation.interactive=!1,l=Qt(o,this.view.state.viewingMode),p=Jt(o),this.emit("graphic-move-start",new Ca(o)),this.destroyed))return null}return 0!==o.length?t:null})).next((e=>l(e))).next((e=>{switch(e.action){case"start":case"update":if(e.translationX||e.translationY||e.translationZ){const t=this.view.toScreen(e.mapStart),i=this.view.toScreen(e.mapEnd),a=i.x-t.x,s=i.y-t.y;if(this.emit("graphic-move",new Ta(a,s,o)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new za(o)),this.destroyed)return null;h()}}));return s.next((e=>p(e))).next((()=>{if(this.emit("graphic-move-stop",new za(o)),this.destroyed)return null;h()})),c}buildSnappingPipelineSteps(e,t,i,a,s){const r=e.geometry;if(o(r)||"point"!==r.type&&"mesh"!==r.type)return i;const n=("point"===r.type?r:r.anchor).clone(),l=new $e({elevationInfo:t,pointer:s,editGeometryOperations:ai.fromGeometry(n,this.view.state.viewingMode),visualizer:new sa,excludeFeature:e}),p=this.snappingManager;return i.next((t=>{n.z=_(this.view,n,v(e),{mode:"absolute-height",offset:0});return{...t,snapOrigin:l.coordinateHelper.pointToVector(n)}})).next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:l,snappingManager:p,cancel:a,updatingHandles:this.updatingHandles}),this.snappingPipeline.next)}};e([m({constructOnly:!0,nonNullable:!0})],ka.prototype,"view",void 0),e([m({readOnly:!0})],ka.prototype,"graphics",void 0),e([m({constructOnly:!0,nonNullable:!0})],ka.prototype,"enableZ",void 0),e([m({constructOnly:!0})],ka.prototype,"snappingManager",void 0),e([m({readOnly:!0})],ka.prototype,"type",void 0),e([m({readOnly:!0})],ka.prototype,"updating",null),ka=e([g("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],ka);class Ha{constructor(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new ot({graphic:e})}get graphic(){return this.state.graphic}}function La(e,t,i){const a="on-the-ground"===i.mode?1:0;return new si(e,a,t,0)}function Ua(e,t,i){const a=S();if(!e.renderCoordsHelper.toRenderCoords(t,a))return null;const s=Fa(e,t,ci(i.plane)),r=Fa(e,t,i.edgeDirection);if(o(s)||o(r))return null;const n=L(S(),s,r);return di(a,n,ui())}function Fa(e,t,i){const a=ft(t.x+i[0],t.y+i[1],t.z+i[2],t.spatialReference),s=S(),r=S();return e.renderCoordsHelper.toRenderCoords(t,s)&&e.renderCoordsHelper.toRenderCoords(a,r)?U(r,s,r):null}let Ba=class extends(gt.EventedMixin(vt)){constructor(e){super(e),this._vertexManipulatorMaterial=it(Le.colorToVec4(Le.reshapeManipulators.vertex.color),Le.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=st(Le.colorToVec4(Le.reshapeManipulators.vertex.outlineColor),Le.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=st(Le.colorToVec4(Le.reshapeManipulators.vertex.hoverOutlineColor),Le.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=it(Le.colorToVec4(Le.reshapeManipulators.edge.color),Le.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=st(Le.colorToVec4(Le.reshapeManipulators.edge.outlineColor),Le.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=it(Le.colorToVec4(Le.reshapeManipulators.edgeOffset.color),Le.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=it(Le.colorToVec4(Le.reshapeManipulators.edgeOffset.hoverColor),Le.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=it(Le.colorToVec4(Le.reshapeManipulators.selected.color),Le.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=st(Le.colorToVec4(Le.reshapeManipulators.selected.outlineColor),Le.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=st(Le.colorToVec4(Le.reshapeManipulators.selected.hoverOutlineColor),Le.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._edgeOffsetManipulatorGeometryInside=null,this._edgeOffsetManipulatorGeometryOutside=null,this._manipulatorHandles=new Q,this._manipulatorInfos=[],this._editGeometryOperations=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=0,this._outlineVisualElement=null,this.tool=null,this.outputGeometry=null,this._snappingPipeline=new ut,this._snappingPipelineHandle=new ut,this._vertexLaserLineVisualElement=null}initialize(){const e=new ot({graphic:this.graphic});this._graphicState=e,this.handles.add([e.watch("displaying",(e=>{for(const t of this._manipulatorInfos)t.manipulator.available=e})),this.view.trackGraphicState(e)])}destroy(){this._editGeometryOperations=p(this._editGeometryOperations),this._moveManipulation=p(this._moveManipulation),this._graphicMoveManipulation=p(this._graphicMoveManipulation),this._manipulatorHandles=p(this._manipulatorHandles),this.manipulators.removeAll(),this._manipulatorInfos=[],this._resetGrabbingDragging()}get inputGeometry(){return r(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null}set inputGeometry(e){this._recreateEditGeometryAndManipulators(e)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}removeSelectedVertices(){const e=this._manipulatorInfos.filter((e=>e.manipulator.selected&&"vertex"===e.handle.type));this._removeVertices(e)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._moveManipulation=p(this._moveManipulation),this._graphicMoveManipulation=p(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[]}_resetGrabbingDragging(){this._numGrabbing=0,this._numDragging=0}_createManipulators(){if(o(this._editGeometryOperations))return;const e=v(this.graphic);for(const t of this._editGeometryOperations.data.components){for(const i of t.vertices)this._createVertexOrEdgeManipulator(i,e);for(const i of t.edges)this._createVertexOrEdgeManipulator(i,e)}this._createGraphicMoveManipulators(e)}get canRedo(){return r(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}get canUndo(){return r(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}redo(){if(o(this._editGeometryOperations))return null;const e=this._editGeometryOperations.redo();return r(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}undo(){if(o(this._editGeometryOperations))return null;this.emit("undo");const e=this._editGeometryOperations.undo();return r(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}_recreateManipulators(){this._removeManipulators(),this._resetGrabbingDragging(),this._createManipulators()}_recreateEditGeometryAndManipulators(e=this.inputGeometry){this._removeManipulators(),this._resetGrabbingDragging(),o(e)||(p(this._editGeometryOperations),this._editGeometryOperations=ai.fromGeometry(e,this.view.state.viewingMode),this._createManipulators())}_perGraphicManipulatorDragAction(e,t){if("end"===t.action)return;let i=0;const a=[],s=this._manipulatorInfos.some((e=>"vertex"===e.handle.type&&e.manipulator.selected)),r=1===e&&s;for(const e of this._manipulatorInfos)Na(e)&&(e.manipulator.grabbing||r&&!e.manipulator.selected||a.push(e),i++);if(0===a.length)return;this._moveVertices(a,t);if(a.length===i){if(this._updateEventState(1),this.destroyed)return;this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(2),this.destroyed)return;this.emit("reshape",{type:"reshape",mover:this.graphic})}}_isMultiVertexSelection(){let e=0;for(const t of this._manipulatorInfos)Na(t)&&t.manipulator.selected&&e++;return e>1}_perVertexManipulatorDragAction(e){if(this._updateEventState(2),this.destroyed)return;const{mapDeltaX:t,mapDeltaY:i,mapDeltaZ:a}=e;if(!t&&!i&&!a)return;const s=[];for(const t of this._manipulatorInfos)Na(t)&&(t.manipulator.selected&&!t.manipulator.grabbing||t===e.info)&&s.push(t);this._moveVertices(s,e,1),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(e){if(e===this._reshapeEventState)return!1;switch(e){case 0:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case 1:switch(this._reshapeEventState){case 0:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case 2:switch(this._reshapeEventState){case 0:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t}_createGraphicMoveManipulators(e){if(this._graphicMoveManipulation=new Va({tool:this.tool,view:this.view,graphicState:this._graphicState}),this.enableMoveGraphic){let e=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((t,i,a)=>{i.next((e=>this._trackNumDragging(e))).next((t=>("start"===t.action&&(e=n(this._editGeometryOperations).createUndoGroup()),t))).next((t=>{this._perGraphicManipulatorDragAction(0,t),"end"===t.action&&(e=c(e))})),a.next(this._cancelDragOperation((()=>e=c(e))))})))}else this._graphicMoveManipulation.forEachManipulator((e=>{e.grabbable=!1,e.cursor=null}));this._graphicMoveManipulation.forEachManipulator((e=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()}))]))),this._moveManipulation=new Ia({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&_t(this.graphic),snapToScene:!1,radius:Ia.radiusForSymbol(this.graphic.symbol)}),this._moveManipulation.forEachManipulator((e=>{this.handles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(t=>{this._moveManipulation.zManipulation.hasManipulator(e)||this._manipulatorInfos.some((e=>e.manipulator.selected))||this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()}))])})),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const t=n(this.graphic.geometry).spatialReference;this.handles.add([this._moveManipulation.createDragPipeline(((t,i,a,s,r)=>{const o=a.next((e=>this._trackNumDragging(e))).next((e=>{const t=this._manipulatorInfos.filter((e=>Na(e)&&e.manipulator.selected));return 1===e.manipulatorType&&1===t.length?{...e,info:t[0],snapOrigin:t[0].handle.pos}:{...e,info:null}})).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:e=>!!e.info,cancel:s,snappingManager:this.tool.snappingManager,snappingContext:new $e({editGeometryOperations:n(this._editGeometryOperations),elevationInfo:e,pointer:r,excludeFeature:this.graphic,visualizer:new sa}),updatingHandles:this.updatingHandles}),this._snappingPipelineHandle.next).next(Xt()).next((e=>(this._perGraphicManipulatorDragAction(1,e),e)));return s.next(this._cancelDragOperation()),o}),e,t,this.graphic),u(this._graphicState,"displaying",(()=>{this._updateMoveManipulationPosition()})),this._graphicState.on("changed",(()=>this._updateMoveManipulationPosition())),u(this._graphicState,"isDraped",(()=>{const e="align-move-manipulation";this._graphicState.isDraped?this.handles.add(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),e):this.handles.remove(e)}))]),this._updateMoveManipulationPosition();const i=va({view:this.view,graphic:this.graphic,forEachManipulator:e=>{if(!this.destroyed){r(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(e);for(const t of this._manipulatorInfos)e(t.manipulator,1);this._moveManipulation.forEachManipulator(e)}},onManipulatorsChanged:e=>this.on("manipulators-changed",e)});r(i)&&(this._outlineVisualElement=i.visualElement instanceof Ue?i.visualElement:null),r(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._graphicState.watch("isDraped",(()=>this._updateMoveManipulationPosition()))]),this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(e,t=v(this.graphic)){const a=Le.reshapeManipulators.edgeOffset,s=a.size/2,n=s+a.collisionPadding;if(o(this._edgeOffsetManipulatorGeometryInside)||o(this._edgeOffsetManipulatorGeometryOutside)){const e=s/n,t=e*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=ue.createExtrudedTriangle(t,e/2,e/2,a.height,a.offset),this._edgeOffsetManipulatorGeometryOutside=ue.createExtrudedTriangle(-t,e/2,e/2,a.height,-a.offset)}const l=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:1},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:2},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:1},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:2}],p=new tt({view:this.view,renderObjects:l,elevationInfo:"on-the-ground"!==t.mode||hi(this.graphic.symbol)?{mode:"absolute-height",offset:0}:t,worldOriented:!1,focusMultiplier:1,radius:n,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:x(0,0,1)},collisionPriority:1}),h=new tt({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default"}),c={manipulator:p,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:h,elevationInfo:t,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(c,a.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(c);const d=this._getManipulatorInfoFromHandle(c.handle.leftVertex).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(c))),u=this._getManipulatorInfoFromHandle(c.handle.rightVertex).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(c)));c.locationUpdateHandle=i([d,u]),this._manipulatorHandles.add(c.locationUpdateHandle,p),this._manipulatorHandles.add([this._watchAndUpdateGrabState(p,!0),this._watchAndUpdateGrabState(h,!0)],p),this._manipulatorHandles.add(Bt(p,this._createEdgeOffsetPipeline(c,t)),p),this._manipulatorHandles.add(Bt(h,((e,i,a,s)=>{if("touch"===s){this._createEdgeOffsetPipeline(c,t)(e,i,a)}else if(this.enableMoveGraphic){const s=this.graphic,n=r(s.geometry)?s.geometry.spatialReference:null;i.next((e=>this._trackNumDragging(e))).next(Zt(this.view,e.elevationAlignedLocation)).next(Vt(this.view,e.elevationAlignedLocation,t,n,s)).next(Yt()).next(Xt()).next((e=>this._perGraphicManipulatorDragAction(0,e))),a.next(this._cancelDragOperation())}})),p);const m=e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()};return this._manipulatorHandles.add([p.events.on("immediate-click",m),h.events.on("immediate-click",m)],p),this._manipulatorInfos.push(c),this.manipulators.add(p),this.manipulators.add(h),this.emit("manipulators-changed"),c}_autoHideEdgeOffsetManipulator(e,t){const a=e.manipulator,s=e.edgeManipulator,n=()=>{c(e.visibilityHandle);const n=function(e,t,i){const a=i.projectToRenderScreen(e,fe()),s=i.projectToRenderScreen(t,fe());return r(a)&&r(s)?F(j(a,a,s)):0}(this._getManipulatorInfoFromHandle(e.handle.leftVertex).manipulator.renderLocation,this._getManipulatorInfoFromHandle(e.handle.rightVertex).manipulator.renderLocation,this.view.state.camera)<t;(!a.focused&&!s.focused||n)&&(a.grabbable=!n,s.grabbable=!n,e.visibilityHandle=i([a.disableDisplay(),{remove:()=>{a.grabbable=!0,s.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([a.events.on("focus-changed",n),s.events.on("focus-changed",n),{remove:()=>{c(e.visibilityHandle),this.manipulators.remove(s)}}],a),n()}_updateEdgeOffsetManipulator(e){this._updateManipulatorPosition(e);const t=n(this._editGeometryOperations).data.coordinateHelper,i=Ua(this.view,e.manipulator.elevationAlignedLocation,La(t,e.handle,n(e.manipulator.elevationInfo))),a=this._getManipulatorInfoFromHandle(e.handle.leftVertex).manipulator.renderLocation,s=this._getManipulatorInfoFromHandle(e.handle.rightVertex).manipulator.renderLocation,o=r(i)?function(e,t,i){const a=ci(e),s=U(S(),t,i),r=L(S(),s,a),n=L(S(),s,r);return It(s[0],s[1],s[2],0,r[0],r[1],r[2],0,n[0],n[1],n[2],0,0,0,0,1)}(i,a,s):Pt;e.manipulator.modelTransform=o,e.edgeManipulator.elevationAlignedLocation=e.manipulator.elevationAlignedLocation,e.edgeManipulator.modelTransform=o;const l=B(j(Xa,a,s))/2;e.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}}_createEdgeOffsetPipeline(e,t){return(i,a,s)=>{this._clearSelection();const{step:r,cleanup:o}=this._initializeEdgeOffset(e,t);a.next((e=>this._trackNumDragging(e))).next(Zt(this.view,i.elevationAlignedLocation)).next(r).next(zt(this.view)).next(kt(this.view,n(this._editGeometryOperations).data.spatialReference)).next(Xt()).next(this._applyEdgeOffsetStep(e)).next((e=>{"end"===e.action&&o()})),s.next((e=>(o(),e))).next(this._cancelDragOperation())}}_initializeEdgeOffset(e,a){const s=n(this._editGeometryOperations),r=La(s.data.coordinateHelper,e.handle,a),l=s.createUndoGroup(),p=Ua(this.view,e.manipulator.elevationAlignedLocation,r);r.requiresSplitEdgeLeft&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(e.handle.leftVertex.leftEdge),1),r.requiresSplitEdgeRight&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(e.handle.rightVertex.rightEdge),0);const h=()=>new pi({paths:[[e.handle.leftVertex.pos,e.handle.rightVertex.pos]],spatialReference:n(this._editGeometryOperations).data.spatialReference}),d=new Ue({view:this.view,isDraped:this._graphicState.isDraped,geometry:h(),elevationInfo:e.elevationInfo,width:Le.visualElements.lineGraphics.outline.width,color:Le.colorToVec4(Fe.main),attached:!0});let u;const m=()=>{this._cleanEdgeOffsetCollapsedEdges(e),u=c(u)},g=this.on("undo",m);return u=i([t(d),this._graphicState.watch("isDraped",(e=>d.isDraped=e)),this._graphicState.on("changed",(()=>d.geometry=h())),l,g]),{step:e=>o(r)||o(p)?(m(),null):{...e,operation:r,plane:p},cleanup:m}}_applyEdgeOffsetStep(e){return t=>{if(this.destroyed||o(t.operation))return t;this._updateEventState(2);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:s}=t;return(i||a||s)&&(this._offsetEdge(e,t),this.emit("reshape",{type:"reshape",mover:this.graphic})),t}}_cleanEdgeOffsetCollapsedEdges(e){var t,i;const a=null==(t=e.handle.leftVertex.leftEdge)?void 0:t.leftVertex,s=e.handle.leftVertex,r=null==(i=e.handle.rightVertex.rightEdge)?void 0:i.rightVertex,o=e.handle.rightVertex,l=n(this._editGeometryOperations).data.coordinateHelper,p=1e-6,h=[];a&&l.distance(a.pos,s.pos)<p&&h.push(this._getManipulatorInfoFromHandle(s)),(l.distance(s.pos,o.pos)<p||r&&l.distance(r.pos,o.pos)<p)&&h.push(this._getManipulatorInfoFromHandle(o)),h.length&&this._removeVertices(h)}_computeVertexManipulatorSizeAndOutline(e){const t=e.size/2,i=t+e.collisionPadding;return{size:t/i,outlineSize:(t+e.outlineSize)/i}}_createVertexOrEdgeManipulator(e,t=v(this.graphic)){if("edge"===e.type){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(e,t);if(!this.enableMidpoints)return null}if(o(this._vertexManipulatorGeometry)||o(this._vertexManipulatorOutlineGeometry)){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(Le.reshapeManipulators.vertex);this._vertexManipulatorGeometry=ue.createSphereGeometry(e,16,16),this._vertexManipulatorOutlineGeometry=ue.createSphereGeometry(t,16,16)}if(o(this._edgeManipulatorGeometry)||o(this._edgeManipulatorOutlineGeometry)){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(Le.reshapeManipulators.edge);this._edgeManipulatorGeometry=ue.createSphereGeometry(e,16,16),this._edgeManipulatorOutlineGeometry=ue.createSphereGeometry(t,16,16)}const a=r(this.graphic.geometry)&&"point"===this.graphic.geometry.type?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:4|qa.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:5|qa.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|qa.Vertex},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:8},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:9},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:10}];this.enableMidpoints&&a.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:6|qa.Edge},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|qa.Edge},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:5|qa.Edge},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:5|qa.Edge});const s=new tt({view:this.view,renderObjects:a,elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(s,e,t);const l="edge"===e.type?{manipulator:s,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:s,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(l),this.manipulators.add(s),this._updateManipulatorPosition(l),"edge"===l.type){const e=this._getManipulatorInfoFromHandle(l.handle.leftVertex).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(l))),t=this._getManipulatorInfoFromHandle(l.handle.rightVertex).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(l)));l.locationUpdateHandle=i([e,t]),this._manipulatorHandles.add(l.locationUpdateHandle,s)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(s,!0),s);const p=Bt(s,((e,i,a,s)=>{let r=null;i.next((e=>this._trackNumDragging(e))).next((e=>{if("start"===e.action&&(r=n(this._editGeometryOperations).createUndoGroup()),Ya(l)){const t=this._splitEdgeManipulator(l);return{...e,info:t,snapOrigin:t.handle.pos}}return{...e,info:l,snapOrigin:l.handle.pos}})).next(Zt(this.view,e.elevationAlignedLocation)).next(Ht(this.view,this.graphic,e.elevationAlignedLocation,e.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),cancel:a,snappingManager:this.tool.snappingManager,snappingContext:new $e({editGeometryOperations:n(this._editGeometryOperations),elevationInfo:t,pointer:s,excludeFeature:this.graphic,visualizer:new sa}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(Xt()).next((e=>{this._perVertexManipulatorDragAction(e),"end"===e.action&&(r=c(r))})),a.next(this._cancelDragOperation((()=>r=c(r))))}));return this._manipulatorHandles.add(p,s),this._manipulatorHandles.add([s.events.on("immediate-click",(e=>this._manipulatorClickCallback(e,l))),s.events.on("select-changed",(()=>{l.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}))],s),this.emit("manipulators-changed"),l}_trackNumDragging(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e}_cancelDragOperation(e){return()=>{switch(this._numDragging--,this.undo(),this.outputGeometry=r(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null,r(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._reshapeEventState){case 0:break;case 1:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape",mover:this.graphic})}e&&e(),this.destroyed||this._updateEventState(0)}}_setTypeSpecificManipulatorSettings(e,t,i){switch(t.type){case"vertex":e.state=qa.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=Le.reshapeManipulators.vertex.size/2+Le.reshapeManipulators.vertex.collisionPadding,e.elevationInfo=i,e.interactive=r(this.graphic.geometry)&&"point"!==this.graphic.geometry.type;break;case"edge":e.state=qa.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=Le.reshapeManipulators.edge.size/2+Le.reshapeManipulators.edge.collisionPadding,e.elevationInfo="on-the-ground"!==i.mode||hi(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}}_watchAndUpdateGrabState(e,t){return e.events.on("grab-changed",(i=>{if("start"===i.action)t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(0),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,("touch"!==i.pointerType||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach((e=>{e.manipulator.interactive=!this._numGrabbing&&r(this.graphic.geometry)&&"point"!==this.graphic.geometry.type,"edgeManipulator"in e&&(e.edgeManipulator.interactive=!this._numGrabbing)})),n(this._graphicMoveManipulation).forEachManipulator((e=>e.interactive=!this._numGrabbing)))}))}_clearSelection(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)}_updateSelection(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(e){e&&(this._manipulatorHandles.remove(e.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(e),1),this.manipulators.remove(e.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(e){if(e)for(const t of this._manipulatorInfos)if(e===t.handle)return t;return null}_updateManipulatorPosition(e){if(!e)return;const t=n(this._editGeometryOperations);if("vertex"===e.handle.type)e.manipulator.location=t.data.coordinateHelper.vectorToDehydratedPoint(e.handle.pos,Wa),e.manipulator.grabbing&&r(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if("edge"===e.handle.type){const i=this._getManipulatorInfoFromHandle(e.handle.leftVertex).manipulator,a=this._getManipulatorInfoFromHandle(e.handle.rightVertex).manipulator;if(r(e.manipulator.elevationInfo)&&"on-the-ground"===e.manipulator.elevationInfo.mode){const s=i.location,r=a.location,n=.5,o=s.x+n*(r.x-s.x),l=s.y+n*(r.y-s.y),p=s.hasZ&&r.hasZ?0:void 0;e.manipulator.location=ft(o,l,p,t.data.spatialReference)}else C(Xa,i.renderLocation,a.renderLocation,.5),e.manipulator.renderLocation=Xa}}_splitEdgeManipulator(e,t=.5){const i=n(this._editGeometryOperations),a=n(i.splitEdge(e.handle,t).createdVertex);e.locationUpdateHandle.remove(),e.locationUpdateHandle=void 0;const s=v(this.graphic);let r;this.enableEdgeOffset?(this._removeManipulator(e),r=this._createVertexOrEdgeManipulator(a)):(r=e,r.handle=a,r.type="vertex",this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,s)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(r),this._updateSelection(e.manipulator);const o=this._updateEventState(2),l=i.data.coordinateHelper.vectorToArray(r.handle.pos),p=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:l,componentIndex:p,vertexIndex:n(a.index)}],added:l}),o&&this._updateEventState(0),r}_updateMoveManipulationPosition(){const e=V(Xa,0,0,0);let t=0,i=!1,a=null,s=null;for(const r of this._manipulatorInfos)Na(r)&&(r.manipulator.selected?(t++,A(e,e,r.manipulator.renderLocation),o(a)||r.selectedIndex>a.selectedIndex?(s=a,a=r):(o(s)||r.selectedIndex>s.selectedIndex)&&(s=r)):i=!0);if(0!==t){const e=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.zManipulation.available=e&&this.enableZVertex&&_t(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e&&1!==t}else{const e=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e,this._moveManipulation.zManipulation.available=e&&this.enableZShape&&_t(this.graphic)}if(0!==t){let e=0;if(r(a)){const t=a.handle.pos,i=r(s)?s.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,n=!r(s)&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;i&&n?this._moveManipulation.xyAxisManipulation.available=!1:i?e=Za(i,t):n&&(e=Za(t,n))}this._moveManipulation.angle=e,this._moveManipulation.radius=_a}else this._moveManipulation.angleDeferred=()=>wa(n(this.graphic.geometry)),this._moveManipulation.radius=Ia.radiusForSymbol(this.graphic.symbol);0!==t&&i?(z(e,e,1/t),Wa.spatialReference=n(this._editGeometryOperations).data.spatialReference,Wa.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,Wa),this._moveManipulation.elevationAlignedLocation=Wa):r(this._outlineVisualElement)&&!this._graphicState.isDraped&&r(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:rt(this.view,this._moveManipulation,this.graphic)}_removeVertices(e){const t=[],i=n(this._editGeometryOperations);for(const a of e)if("vertex"===a.handle.type&&i.canRemoveVertex()){t.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const e=n(i.removeVertices([a.handle]).removedVertices[0].createdEdge);e&&this._createVertexOrEdgeManipulator(e)}if(t.length>0){const e=t.map((e=>{const t=i.data.components.indexOf(e.component);return{coordinates:i.data.coordinateHelper.vectorToArray(e.pos),componentIndex:t,vertexIndex:n(e.index)}}));this.outputGeometry=i.data.geometry;const a=this._updateEventState(2);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:e.map((e=>e.coordinates)),vertices:e}),this.destroyed)return;if(a&&(this._updateEventState(0),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(e,t,i=("start"===t.action?0:1)){const a=n(this._editGeometryOperations);a.moveVertices(e.map((e=>e.handle)),t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const t of e)this._updateManipulatorPosition(t)}_offsetEdge(e,t){if(o(t.operation))return;const i=n(this._editGeometryOperations),a=t.operation.clone();a.distance=t.operation.signedDistanceToPoint(t.mapEnd),i.updateVertices([e.handle.leftVertex,e.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.rightVertex))}_manipulatorClickCallback(e,t){e.shiftKey||this._clearSelection(),"vertex"===t.handle.type&&(t.manipulator.selected=!t.manipulator.selected),"vertex"===t.handle.type&&2===e.button&&this._removeVertices([t]),Ya(t)&&0===e.button&&this._splitEdgeManipulator(t),e.stopPropagation()}};function Za(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function Na(e){return"vertex"===e.handle.type}function Ya(e){return"edge"===e.handle.type}e([m({constructOnly:!0})],Ba.prototype,"tool",void 0),e([m()],Ba.prototype,"inputGeometry",null),e([m()],Ba.prototype,"outputGeometry",void 0),e([m({readOnly:!0})],Ba.prototype,"updating",null),Ba=e([g("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],Ba);const Wa=ft(0,0,null,null),Xa=S();var qa;!function(e){e.Vertex=16,e.Edge=32}(qa||(qa={}));let Qa=class extends(gt.EventedMixin(qt)){constructor(e){super(e),this._handles=new Q,this._reshapeOperation=null,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.snappingManager=null,this.automaticManipulatorSelection=!1}destroy(){this._handles=p(this._handles),this._reshapeOperation=p(this._reshapeOperation),this._set("view",null),this._set("graphic",null)}get updating(){var e,t;return null!=(e=null==(t=this._reshapeOperation)?void 0:t.updating)&&e}_updateGeometry(){const e=ti(this.graphic);this._reshapeOperation.inputGeometry=r(e)?e.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),0!==ii(this.graphic))return;const e=this.watch("graphic.geometry",(()=>{!1===this._internalGeometryUpdate&&this._updateGeometry()}),!0);this._handles.add(e,"onGraphicGeometryChange")}manipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}_updateGeometryInternally(e){this._internalGeometryUpdate=!0,this.graphic.geometry=e,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){o(this.graphic)||this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}initialize(){this._reshapeOperation=new Ba({tool:this}),this._handles.add([this._reshapeOperation.on("reshape",(e=>{"reshape"===e.type&&this._onReshapeGeometryChanged(),this.emit("reshape",e)})),this._reshapeOperation.on("move",(e=>{"move"===e.type&&this._onReshapeGeometryChanged(),this.emit("move",e)})),this._reshapeOperation.on("vertex-add",(e=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",e)})),this._reshapeOperation.on("vertex-remove",(e=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",e)})),this._reshapeOperation.on("immediate-click",(e=>this.emit("immediate-click",e))),this.view.on("pointer-down",["Shift"],(e=>{e.stopPropagation()})),u(this,"graphic",(()=>{this._updateGraphic()}),!0)]),this.complete()}get canUndo(){var e,t;return null!=(e=null==(t=this._reshapeOperation)?void 0:t.canUndo)&&e}undo(){r(this.snappingManager)&&this.snappingManager.doneSnapping(),r(this._reshapeOperation.undo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canRedo(){var e,t;return null!=(e=null==(t=this._reshapeOperation)?void 0:t.canRedo)&&e}redo(){r(this.snappingManager)&&this.snappingManager.doneSnapping(),r(this._reshapeOperation.redo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}onInputEvent(e){"key-down"!==e.type||"Delete"!==e.key&&"Backspace"!==e.key||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager}}};var Ja;e([m()],Qa.prototype,"_reshapeOperation",void 0),e([m({constructOnly:!0,nonNullable:!0})],Qa.prototype,"view",void 0),e([m({constructOnly:!0})],Qa.prototype,"graphic",void 0),e([m({constructOnly:!0,nonNullable:!0})],Qa.prototype,"enableZShape",void 0),e([m({constructOnly:!0,nonNullable:!0})],Qa.prototype,"enableZVertex",void 0),e([m({constructOnly:!0,nonNullable:!0})],Qa.prototype,"enableMoveGraphic",void 0),e([m({constructOnly:!0,nonNullable:!0})],Qa.prototype,"enableMidpoints",void 0),e([m({constructOnly:!0,nonNullable:!0})],Qa.prototype,"enableEdgeOffset",void 0),e([m({readOnly:!0})],Qa.prototype,"type",void 0),e([m({constructOnly:!0})],Qa.prototype,"snappingManager",void 0),e([m({readOnly:!0})],Qa.prototype,"updating",null),e([m()],Qa.prototype,"automaticManipulatorSelection",void 0),Qa=e([g("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],Qa),function(e){e.ScaleIn=32,e.ScaleOut=64,e.RotateLeft=128,e.RotateRight=256,e.Unlocked=1024,e.DelayedFocused=2048,e.TouchInput=32768}(Ja||(Ja={}));class Ka{constructor(e){this.mode=null,this._handles=new Q,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new gt,this.getFocused=()=>this.ringManipulator.focused,this.getScale=()=>r(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this.adapter.scale:1,this.tool=e.tool,this.mode=e.mode,this.adapter=e.adapter,this.createManipulator(),this.updateDragState(),this.updateManipulatorTransform()}get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(e){this.ringManipulator.location=e}set elevationAlignedLocation(e){this.ringManipulator.elevationAlignedLocation=e}get grabbing(){return this.ringManipulator.grabbing}set interactive(e){this.ringManipulator.interactive=e}destroy(){r(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=p(this._handles),this.tool.manipulators.remove(this.ringManipulator),this.ringManipulator=null}startAnimation(e){this.cancelActiveAnimation(),e.start();const t=yi({update:({deltaTime:t})=>{e.update(t)&&this.cancelActiveAnimation()}});this._activeAnimation={...e,frameTask:t}}cancelActiveAnimation(){r(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=p(this._activeAnimation))}forEachManipulator(e){e(this.ringManipulator,4)}createManipulator(){this.ringManipulator=this.createRingManipulator(),this.tool.manipulators.add(this.ringManipulator);const e=this.ringManipulator,t=this.tool.graphicState.graphic,i=Bt(e,((e,i,a)=>{this._scaleRotateDragData=null,this.adapter.restart();const s={mode:"none",origin:Z(e.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=s,this.updateDragState();const n=Te.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(e.renderLocation,n),i.next(Lt(this.tool.view,di(e.renderLocation,n,ui()))).next((e=>{const i=ci(e.plane),a=nt(e.renderStart,e.renderEnd,s.origin,i),n=vi.shortestSignedDiff(s.angle,a);s.angleDir=I(s.angleDir+n,-.3,.3),s.angle=a;const o=function(e,t){const i=j(Te.get(),t.renderStart,e.origin),a=j(Te.get(),t.renderEnd,e.origin),s=B(i),r=B(a);if(0===s)return 0;return r/s}(s,e),l=o-this.adapter.scale;if(s.scaleDir=I(s.scaleDir+l,-.2,.2),this.onScaleChanged(),"none"===s.mode){const i=this.mode||function(e,t,i,a){const{renderStart:s,renderEnd:r}=e,n=$a(s,a,Te.get()),o=$a(r,a,Te.get());if(Y(n,o)<100)return null;const l=j(Te.get(),s,i),p=L(Te.get(),l,ci(t)),h=s,c=A(Te.get(),h,p),d=$a(i,a,Te.get()),u=n,m=$a(c,a,Te.get()),g=j(Te.get(),m,u),y=j(Te.get(),n,d),v=pe(u,g),f=pe(d,y);if(he(v,o)<he(f,o))return"rotate";return"scale"}(e,e.plane,s.origin,this.tool.view.state.camera);if(r(i)){switch(i){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:t,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:t,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}s.mode=i}}switch(s.mode){case"rotate":this.adapter.angle=s.initialAngle+a;break;case"scale":this.adapter.scale=o,this.onScaleChanged()}switch(this.updateDragState(),this.updateManipulatorTransform(),e.action){case"start":case"update":switch(s.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:t,angle:N(s.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:t,xScale:o,yScale:o})}break;case"end":switch(s.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:N(s.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:o,yScale:o})}}"end"===e.action&&(this.startAnimation(es(this,(()=>this.onScaleChanged()))),this._scaleRotateDragData=null,this.updateDragState())})),a.next((()=>{if(this.adapter.cancel(),r(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:1,yScale:1})}this.startAnimation(es(this,(()=>this.onScaleChanged()))),this._scaleRotateDragData=null,this.updateDragState()}}))}));this._handles.add(i),this._handles.add([this.ringManipulator.events.on("focus-changed",(e=>{"focus"===e.action?this.startAnimation(function(e,t){let i=0,a=null;const s=()=>!1;return{start:()=>{a=e.getFocused,e.getFocused=s,i=0,t()},update:e=>(i+=e,!a()||i>200?1:0),destroy:()=>{e.getFocused=a,t()}}}(this,(()=>this.updateDelayedFocusedState()))):this.updateDelayedFocusedState()})),this.ringManipulator.events.on("immediate-click",(e=>{e.stopPropagation()})),u(this.tool.graphicState,"displaying",(e=>this.ringManipulator.available=e))])}onScaleChanged(){this.events.emit("scale-changed"),this.updateManipulatorTransform()}updateDelayedFocusedState(){this.ringManipulator.updateStateEnabled(Ja.DelayedFocused,this.getFocused())}updateDragState(){if(this.ringManipulator.updateStateEnabled(Ja.Unlocked,!(r(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode)),r(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this.ringManipulator.updateStateEnabled(Ja.ScaleIn|Ja.ScaleOut,!1),this.ringManipulator.updateStateEnabled(Ja.RotateLeft,this._scaleRotateDragData.angleDir<0),this.ringManipulator.updateStateEnabled(Ja.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this.ringManipulator.updateStateEnabled(Ja.RotateLeft|Ja.RotateRight,!1),this.ringManipulator.updateStateEnabled(Ja.ScaleIn,this._scaleRotateDragData.scaleDir<0),this.ringManipulator.updateStateEnabled(Ja.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this.ringManipulator.updateStateEnabled(Ja.ScaleIn|Ja.ScaleOut|Ja.RotateLeft|Ja.RotateRight,!1)}updateManipulatorTransform(){const e=St(ze.get()),t=this.adapter.angle;jt(e,e,t,x(0,0,1));const i=this.getScale(),a=Et(ze.get(),V(Te.get(),i,i,i)),s=St(ze.get());wt(s,a,e),this.ringManipulator.modelTransform=s}createRingManipulator(){const e=(e,t,i)=>{const a=[],s=Math.ceil(128*(t-e)/(2*Math.PI));for(let r=0;r<s+1;r++){const n=e+r*(t-e)/s;a.push(x(i*Math.cos(n),i*Math.sin(n),0))}return a},t=t=>e(0,2*Math.PI,t),i=(e,t)=>ue.createPathExtrusionGeometry((e=>[[-e/2,0],[e/2,0],[e/2,.25],[-e/2,.25]])(t),e,[],[],!1),a=t(160),s=i(a,24),r={left:[],right:[]},n=[];for(let t=0;t<2;t++){const a=t*Math.PI-Math.PI/4,s=Math.PI/2-Ma,o=a+s,l=a+Math.PI/2-s,p=e(o,l,190),h=i(p,9);n.push(p),n.push(e(o,l,201)),r.left.push(h),r.right.push(h);for(let e=0;e<2;e++){const t=0===e,i=At();if(t){Dt(i,i,[1,-1,1]),jt(i,i,-o,[0,0,1]);const e=Math.round(.2*(p.length-1));i[12]=p[e][0],i[13]=p[e][1],i[14]=p[e][2]}else{jt(i,i,l,[0,0,1]);const e=Math.round(.8*(p.length-1));i[12]=p[e][0],i[13]=p[e][1],i[14]=p[e][2]}const a=ue.createExtrudedTriangle(60,0,23,.5);ue.transformInPlace(a,i),(t?r.left:r.right).push(a)}}const o=[];for(let t=0;t<2;t++){const a=t*Math.PI-Math.PI/4,s=Math.PI/2-ba,r=a+s,n=a+Math.PI/2-s,l=e(r,n,213);o.push(i(l,9))}const l=t(190),p=t(213),h=i(l,9),c=i(p,9),d=t(130),u=t(107),m=i(d,9),g=i(u,9),y=this.createMaterial(),f=this.createMaterial(.66),_=this.createMaterial(.5),M=this.createMaterial(.33);let b=[{geometry:s,material:y,stateMask:Ja.DelayedFocused},{geometry:s,material:_,stateMask:0}];this.mode&&"scale"!==this.mode||(b=b.concat([{geometry:o,material:y,stateMask:Ja.DelayedFocused|Ja.Unlocked},{geometry:h,material:f,stateMask:Ja.DelayedFocused|Ja.ScaleIn},{geometry:c,material:M,stateMask:Ja.DelayedFocused|Ja.ScaleIn},{geometry:m,material:f,stateMask:Ja.DelayedFocused|Ja.ScaleOut},{geometry:g,material:M,stateMask:Ja.DelayedFocused|Ja.ScaleOut}])),this.mode&&"rotate"!==this.mode||(b=b.concat([{geometry:r.right,material:y,stateMask:Ja.DelayedFocused|Ja.Unlocked},{geometry:r.left,material:y,stateMask:Ja.DelayedFocused|Ja.RotateLeft},{geometry:r.right,material:y,stateMask:Ja.DelayedFocused|Ja.RotateRight}]));const S=[a,...n];return new tt({view:this.tool.view,renderObjects:b,autoScaleRenderObjects:!1,worldOriented:!0,radius:24,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:v(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:S,direction:x(0,0,1)}})}createMaterial(e=1){const t=[...fa,e];return new me({color:t,transparent:1!==e,cullFace:2,renderOccluded:2})}get test(){return{ringManipulator:this.ringManipulator}}}function $a(e,t,i){return t.projectToScreen(e,ts),V(i,ts[0],ts[1],0)}function es(e,t){let i=null,a=1;const s=()=>a;return{start:()=>{a=e.getScale(),i=e.getScale,e.getScale=s,t()},update:e=>(a+=((a+1)/2-a)*Math.min(3*e,1),t(),Math.abs(a-1)<.01?1:0),destroy:()=>{e.getScale=i,t()}}}const ts=ve();function is(e){return r(e.geometry)&&"mesh"===e.geometry.type?(t=e.geometry,r(t.transform)?function(e,t){let i=t.clone(),a=null;return{undo:t=>{a=r(e.transform)?e.transform.clone():null,e.transform=i,t.notifyGeometryChanged()},redo:t=>{i=r(e.transform)?e.transform.clone():null,e.transform=a,t.notifyGeometryChanged()}}}(t,t.transform):function(e){let t,i=e.vertexAttributes.clonePositional();return{undo:a=>{t=e.vertexAttributes.clonePositional(),e.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=e.vertexAttributes.clonePositional(),e.vertexAttributes=t,a.notifyGeometryChanged()}}}(t)):function(e){let t=e.geometry,i=d;return{undo(e){i=e.geometry,e.geometry=t},redo(e){t=e.geometry,e.geometry=i}}}(e);var t}let as=class extends vt{constructor(e){super(e),this.angle=0,this.scale=1,this.initialAngle=0,this.previousAngle=0,this.previousScale=1}initialize(){this.restart()}restart(){this.handles.remove(ss);const e=this.geometry.transform;if(this.scale=1,r(e)){const t=Mi(e.rotation)[2];Math.abs(t)>.999999&&(this.angle=T(bi(e.rotation))*Math.sign(t))}this.initialAngle=this.angle,this.previousAngle=this.angle,this.previousScale=this.scale,this.handles.add(fi((()=>({angle:this.angle,scale:this.scale})),(e=>this.update(e)),_i),ss)}cancel(){this.scale=1,this.angle=this.initialAngle}createUndoRecord(){return is(this.graphic)}update({scale:e,angle:t}){const i=this.geometry.anchor,a=1===this.viewingMode;e!==this.previousScale&&(this.geometry.scale(e/this.previousScale,{origin:i,geographic:a}),this.previousScale=e,this.graphic.notifyGeometryChanged()),t!==this.previousAngle&&(this.geometry.rotate(0,0,N(t-this.previousAngle),{origin:i,geographic:a}),this.previousAngle=t,this.graphic.notifyGeometryChanged())}};e([m({constructOnly:!0})],as.prototype,"graphic",void 0),e([m({constructOnly:!0})],as.prototype,"geometry",void 0),e([m({constructOnly:!0})],as.prototype,"viewingMode",void 0),e([m()],as.prototype,"angle",void 0),e([m()],as.prototype,"scale",void 0),as=e([g("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],as);const ss="scale-heading-update-key";let rs=class extends vt{constructor(e){super(e),this.angle=0,this.scale=1,this.symbol=null,this.initialAngle=0}initialize(){this.restart()}restart(){this.handles.remove(ns);const e=r(this.graphic.symbol)&&"point-3d"===this.graphic.symbol.type?this.graphic.symbol:d;if(this.symbol=r(e)?e.clone():null,this.initialSizes=[],r(e)){const t=this.findLayerView();r(t)&&(this.initialSizes=e.symbolLayers.map((i=>"object"===i.type?t.getSymbolLayerSize(e,i):null)).toArray())}this.angle=0,r(e)&&e.symbolLayers.some((e=>!("object"!==e.type||!r(e.heading))&&(this.angle=-T(e.heading),!0))),this.initialAngle=this.angle,this.scale=1,this.handles.add(fi((()=>({angle:this.angle,scale:this.scale})),(e=>this.updateSymbol(e)),_i),ns)}cancel(){this.graphic.symbol=this.symbol}createUndoRecord(){let e=this.graphic.symbol,t=null;return{undo:i=>{t=i.symbol,i.symbol=e,this.restart()},redo:i=>{e=i.symbol,i.symbol=t,this.restart()}}}updateSymbol({scale:e,angle:t}){const i=this.graphic.symbol;if(o(this.symbol)||o(i)||"point-3d"!==i.type)return;const a=i.clone(),s=-N(t-this.initialAngle);let n=!1;this.forEachObjectSymbolLayerPair(this.symbol,a,((t,i,a)=>{const o=l(t.heading,0)+s;i.heading!==o&&(i.heading=o,n=!0);const p=this.initialSizes[a];if(r(p)&&"width"in p){p.width=this.sizeFilter(p.width),p.height=this.sizeFilter(p.height),p.depth=this.sizeFilter(p.depth);const t=p.width*e;i.width!==t&&(i.width=t,n=!0);const a=p.depth*e;i.depth!==a&&(i.depth=a,n=!0);const s=p.height*e;i.height!==s&&(i.height=s,n=!0)}})),n&&(this.graphic.symbol=a)}forEachObjectSymbolLayerPair(e,t,i){e.symbolLayers.forEach(((e,a)=>{const s=t.symbolLayers.getItemAt(a);"object"===e.type&&"object"===s.type&&i(e,s,a)}))}};e([m()],rs.prototype,"angle",void 0),e([m()],rs.prototype,"scale",void 0),e([m({constructOnly:!0})],rs.prototype,"graphic",void 0),e([m()],rs.prototype,"symbol",void 0),e([m({constructOnly:!0})],rs.prototype,"findLayerView",void 0),e([m({constructOnly:!0})],rs.prototype,"sizeFilter",void 0),rs=e([g("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],rs);const ns="scale-heading-update-key";let os=class extends(yt(gt.EventedMixin(qt))){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.type="transform-3d",this.scaleRotate=null,this.snappingPipeline=new ut}initialize(){this.graphicState=new ot({graphic:this.graphic}),this.moveManipulation=new Ia({tool:this,view:this.view,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&_t(this.graphic),radius:Ia.radiusForSymbol(this.graphic.symbol)}),this.moveManipulation.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:this.graphicState.graphic}),e.stopPropagation()}))))),this.moveManipulation.elevationInfo=v(this.graphic);const e=this.graphic.geometry;if(this.moveManipulation.createGraphicDragPipeline(((t,i,a,s,n)=>(r(e)&&0===t&&(a=a.next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new $e({elevationInfo:v(this.graphic),pointer:n,editGeometryOperations:ai.fromGeometry(new gi({spatialReference:e.spatialReference}),this.view.state.viewingMode),visualizer:new sa,excludeFeature:this.graphic}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:s}),this.snappingPipeline.next)),a)),this.graphicState,(e=>{const{action:t,graphic:i,dxScreen:a,dyScreen:s}=e,r={graphic:i,dxScreen:a,dyScreen:s};switch(t){case"start":this.emit("graphic-translate-start",r),this.emit("record-undo",{record:this.createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",r);break;case"end":this.emit("graphic-translate-stop",r)}})),this.moveManipulation.angle=r(this.scaleRotate)?this.scaleRotate.angle:0,this.scaleRotateAdapter=this.createScaleRotateAdapter(),this.handles.add(this.scaleRotateAdapter.watch("angle",(()=>this.updateMoveAngle()))),this.enableScaling||this.enableRotation){const e=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this.scaleRotate=new Ka({tool:this,mode:e,adapter:this.scaleRotateAdapter}),this.handles.add(this.scaleRotate.events.on("scale-changed",(()=>this.onScaleChanged())))}this.handles.add([va({view:this.view,graphic:this.graphic,forEachManipulator:e=>this.forEachManipulator(e),onManipulatorsChanged:()=>a()}),this.graphicState.on("changed",(()=>this.onGeometryChanged())),this.hideManipulatorsForGraphicState(),this.view.watch("scale",(()=>this.updateMoveAngle()))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this.onGeometryChanged(),this.updateMoveAngle(),this.forEachManipulator((e=>{e instanceof tt&&this.handles.add(e.events.on("grab-changed",(()=>this.updateManipulatorsInteractive())))})),this.complete()}updateManipulatorsInteractive(){o(this.scaleRotate)||(this.scaleRotate.interactive=!this.moveManipulation.grabbing,this.moveManipulation.interactive=!this.scaleRotate.grabbing)}createScaleRotateAdapter(){return r(this.graphic.geometry)&&"mesh"===this.graphic.geometry.type?new as({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new rs({graphic:this.graphic,sizeFilter:e=>this.enforceNonZeroSize(e),findLayerView:()=>this.view.allLayerViews.find((e=>e.layer===this.graphic.layer))})}forEachManipulator(e){this.moveManipulation.forEachManipulator(e),r(this.scaleRotate)&&this.scaleRotate.forEachManipulator(e)}hideManipulatorsForGraphicState(){return this.graphicState.watch("displaying",(e=>{this.forEachManipulator((t=>t.available=e)),this.moveManipulation.zManipulation.available=e&&this.enableZ&&_t(this.graphic)}))}createGeometryUndoRecord(){return is(this.graphic)}destroy(){this.moveManipulation.destroy(),this.scaleRotate=p(this.scaleRotate),this.scaleRotateAdapter=p(this.scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}set snapToScene(e){this.moveManipulation&&(this.moveManipulation.snapToScene=e),this._set("snapToScene",e)}get updating(){return this.updatingHandles.updating}set location(e){this.moveManipulation.location=e,r(this.scaleRotate)&&(this.scaleRotate.location=e)}set elevationAlignedLocation(e){this.moveManipulation.elevationAlignedLocation=e,r(this.scaleRotate)&&(this.scaleRotate.elevationAlignedLocation=e)}reset(){}onDetach(){r(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}onHide(){r(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}onScaleChanged(){if(o(this.scaleRotate))return;const e=this.scaleRotate.getScale();this.moveManipulation.displayScale=e}updateMoveAngle(){2===this.view.state.viewingMode||this.view.scale<1e6?this.moveManipulation.angle=this.scaleRotateAdapter.angle:this.moveManipulation.angle=0}onGeometryChanged(){rt(this.view,this,this.graphic)}enforceNonZeroSize(e){return e||this.view.state.camera.computeRenderPixelSizeAt(this.moveManipulation.renderLocation)}get test(){return{discManipulator:this.moveManipulation.xyManipulation.test.discManipulator,zManipulator:this.moveManipulation.zManipulation.test.manipulator,ringManipulator:r(this.scaleRotate)?this.scaleRotate.test.ringManipulator:null,arrowManipulators:this.moveManipulation.xyAxisManipulation.test.arrowManipulators}}};e([m({constructOnly:!0,nonNullable:!0})],os.prototype,"view",void 0),e([m({constructOnly:!0,nonNullable:!0})],os.prototype,"graphic",void 0),e([m({constructOnly:!0,nonNullable:!0})],os.prototype,"enableZ",void 0),e([m()],os.prototype,"enableRotation",void 0),e([m()],os.prototype,"enableScaling",void 0),e([m({value:!1})],os.prototype,"snapToScene",null),e([m({constructOnly:!0})],os.prototype,"snappingManager",void 0),e([m({readOnly:!0})],os.prototype,"type",void 0),e([m({readOnly:!0})],os.prototype,"updating",null),os=e([g("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],os);class ls{constructor(){this.lastDragEvent=null,this.next=new Wt,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&r(this.lastDragEvent)){const t={...this.lastDragEvent,action:"update"};e&&this.adjustScaleFactors(t),this.next.execute(t)}this._enabled=e}createDragEventPipelineStep(){return this.lastDragEvent=null,e=>(this.lastDragEvent="end"!==e.action?{...e}:null,this._enabled&&this.adjustScaleFactors(e),e)}adjustScaleFactors(e){const t=Oi(e.handle)?Math.max(Math.abs(e.factor1),Math.abs(e.factor2)):0===e.handle.direction[0]?Math.abs(e.factor2):Math.abs(e.factor1);e.factor1=e.factor1<0?-t:t,e.factor2=e.factor2<0?-t:t}get test(){return{adjustScaleFactors:e=>this.adjustScaleFactors(e)}}}function ps(e,t){return cs(e,t,!1)}function hs(e,t){return cs(e,t,!0)}function cs(e,t,i){if(e instanceof ri){if(e.operation instanceof ni)return function(e,t,i=!1){const a=i?-1:1,s=x(a*e.dx,a*e.dy,a*e.dz);A(t.origin,t.origin,s)}(e.operation,t,i),!0;if(e.operation instanceof oi)return function(e,t,i=!1){const a=i?-e.angle:e.angle;W(t.basis1,t.basis1,X,a),W(t.basis2,t.basis2,X,a)}(e.operation,t,i),!0;if(e.operation instanceof li)return function(e,t,i=!1){const a=i?1/e.factor1:e.factor1,s=i?1/e.factor2:e.factor2;z(t.basis1,t.basis1,a),z(t.basis2,t.basis2,s),je(t.origin,t.origin,e.origin,e.axis1,a),je(t.origin,t.origin,e.origin,e.axis2,s)}(e.operation,t,i),!0}return!1}let ds=class extends(gt.EventedMixin(qt)){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this._preserveAspectRatio=new ls,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this.handles=new Q,this.moveZManipulator=null,this.resizeManipulators=null,this.rotateManipulator=null,this.attachmentOrigin=null,this.outlineVisualElement=null,this.mapBounds=wi(),this.mapBoundsStart=wi(),this.displayBounds=wi(),this.displayBoundsStart=wi(),this.displayBoundsMarginStart=0,this.resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}]}initialize(){this.graphicState=new ot({graphic:this.graphic});const e=this.graphic.geometry;this.editGeometryOperations=ai.fromGeometry(e,this.view.state.viewingMode),this.graphicMoveManipulation=new Va({tool:this,view:this.view,graphicState:this.graphicState}),this.handles.add(this.createMoveXYGraphicDragPipeline()),this.moveZManipulator=Gi(this.view,0),this.moveZManipulator.state|=Di,this.handles.add(this.watch("enableZ",(()=>this.updateManipulatorAvailability(this.moveZManipulator,0)))),this.handles.add(this.createMoveZDragPipeline()),this.manipulators.add(this.moveZManipulator),this.resizeManipulators=this.resizeHandles.map((e=>{const t=Ri(this.view,e);return this.handles.add(this.watch("enableScaling",(()=>this.updateManipulatorAvailability(t,2)))),t.events.on("grab-changed",(e=>this.onResizeGrab(e))),this.handles.add(this.createResizeDragPipeline(t,e)),t})),this.manipulators.addMany(this.resizeManipulators),this.rotateManipulatorTexture=Hi(this.view.toolViewManager.textures),this.rotateManipulator=Ai(this.view,this.rotateManipulatorTexture.texture),this.handles.add(this.watch("enableRotation",(()=>this.updateManipulatorAvailability(this.rotateManipulator,3)))),this.rotateManipulator.events.on("grab-changed",(e=>{this.onRotateGrab(e)})),this.handles.add(this.createRotateDragPipeline(this.rotateManipulator)),this.manipulators.add(this.rotateManipulator),this.calculateMapBounds(),this.updateDisplayBounds();const t=va({view:this.view,graphic:this.graphic,forEachManipulator:e=>this.forEachManipulator(e),onManipulatorsChanged:()=>a()});r(t)&&(this.outlineVisualElement=t.visualElement instanceof Ue?t.visualElement:null),r(this.outlineVisualElement)&&this.handles.add(this.outlineVisualElement.events.on("attachment-origin-changed",(()=>this.updateDisplayBounds()))),this.handles.add(t),this.handles.add([this.graphicState.on("changed",(()=>this.onGeometryChanged())),this.graphicState.watch("displaying",(()=>this.updateAllManipulatorAvailability())),u(this.graphicState,"isDraped",(()=>this.graphicDrapedChanged())),this.view.trackGraphicState(this.graphicState)]);const i=this.view.pointsOfInterest;i&&this.handles.add(i.centerOnSurfaceFrequent.watch("location",(()=>this.updateDisplayBounds())));this.forEachManipulator((e=>{this.handles.add(e.events.on("grab-changed",(()=>{this.grabbing=e.grabbing,this.updateAllManipulatorAvailability()})))}));this.forEachManipulator(((e,t)=>{this.handles.add(e.events.on("immediate-click",(e=>{1===t&&this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()})))})),this.onGeometryChanged(),this.updateAllManipulatorAvailability(),this.complete()}graphicDrapedChanged(){this.handles.remove(us),this.updateDisplayBounds(),this.graphicState.isDraped&&this.handles.add(this.view.elevationProvider.on("elevation-change",(e=>{r(this.attachmentOrigin)&&Mt(e.extent,this.attachmentOrigin.x,this.attachmentOrigin.y)&&this.updateDisplayBounds()})),us)}updateAllManipulatorAvailability(){this.forEachManipulator(((e,t)=>this.updateManipulatorAvailability(e,t)))}updateManipulatorAvailability(e,t){const i=this.grabbing&&!e.grabbing;if(e.interactive=!i,e instanceof tt){const a=this.graphicState.displaying,s=this.enableZ&&_t(this.graphic);switch(t){case 3:e.available=a&&this.enableRotation;break;case 2:e.available=a&&(this.enableScaling||this.enableRotation||s),e.interactive=!i&&this.enableScaling,e.state=this.enableScaling?Ii:Pi;break;case 0:e.available=a&&s;break;default:e.available=a}}}forEachManipulator(e){this.graphicMoveManipulation.forEachManipulator(e),this.resizeManipulators.forEach((t=>e(t,2))),e(this.rotateManipulator,3),e(this.moveZManipulator,0)}destroy(){this.rotateManipulatorTexture.release(),this.handles.destroy(),this.graphicMoveManipulation.destroy(),this.editGeometryOperations.destroy(),this._set("view",null),this._set("graphic",null)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(e){this._preserveAspectRatio.enabled=e,this._set("preserveAspectRatio",e)}reset(){}onDetach(){this.mapBounds=null,this.displayBounds=null}onGeometryChanged(){this.updateDisplayBounds()}calculateMapBounds(){const e=this.graphic.geometry,t=this.editGeometryOperations.data,i=t.components[0].edges[0],a=be(ke.get(),i.leftVertex.pos,i.rightVertex.pos);Me(a,a);const s=l(at(this.view,this.graphic),e.extent.center);let r=gs*this.view.pixelSizeAt(s);const n=this.view.spatialReference;n!==e.spatialReference&&(r*=Si(n)/Si(e.spatialReference)),function(e,t,i,a){a||(a=wi());const s=xe(ke.get(),e[1],-e[0]),r=xe(ke.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),n=xe(ke.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),o=ke.get();t.components.forEach((t=>t.vertices.forEach((t=>{const i=t.pos;xe(o,Ee(e,i),Ee(s,i)),Oe(r,r,o),Ge(n,n,o)}))));const l=1e-6,p=xe(ke.get(),n[0]-r[0]<l?i/2:0,n[1]-r[1]<l?i/2:0);be(r,r,p),we(n,n,p),Se(a.basis1,e,(n[0]-r[0])/2),Se(a.basis2,s,(n[1]-r[1])/2),xe(a.origin,r[0]*e[0]+r[1]*s[0],r[0]*e[1]+r[1]*s[1]),we(a.origin,a.origin,a.basis1),we(a.origin,a.origin,a.basis2)}(a,t,r,this.mapBounds)}updateDisplayBounds(){const e=this.graphic.geometry;if(o(e))return;const t=r(this.outlineVisualElement)&&!this.graphicState.isDraped&&r(this.outlineVisualElement.attachmentOrigin)?this.outlineVisualElement.attachmentOrigin:at(this.view,this.graphic);this.attachmentOrigin=l(t,e.extent.center);const i=r(t)?t.z:ye(this.mapBounds.origin,this.view.elevationProvider,Be.fromElevationInfo(v(this.graphic)),this.view.renderCoordsHelper),a=Ei(this.mapBounds);a.origin[2]=i,function(e,t,i,a=0,s){s||(s=wi()),t.toRenderCoords(e.origin,i,s.origin);const r=Te.get();A(r,e.origin,e.basis1),A(r,r,e.basis2),t.toRenderCoords(r,i,r);const n=Te.get();A(n,e.origin,e.basis1),j(n,n,e.basis2),t.toRenderCoords(n,i,n);const o=Te.get();j(o,e.origin,e.basis1),j(o,o,e.basis2),t.toRenderCoords(o,i,o);const l=Te.get();j(l,e.origin,e.basis1),A(l,l,e.basis2),t.toRenderCoords(l,i,l);const p=C(Te.get(),r,n,.5);j(p,p,s.origin);const h=C(Te.get(),o,l,.5);j(h,s.origin,h),C(s.basis1,p,h,.5);const c=C(Te.get(),l,r,.5);j(c,c,s.origin);const d=C(Te.get(),n,o,.5);j(d,s.origin,d),C(s.basis2,c,d,.5);const u=L(Te.get(),s.basis1,s.basis2),m=L(u,u,s.basis1);R(m,m),z(s.basis2,m,H(s.basis2,m)),z(s.basis1,s.basis1,1+a/B(s.basis1)),z(s.basis2,s.basis2,1+a/B(s.basis2)),ji(s)}(a,this.view.renderCoordsHelper,e.spatialReference,this.displayBoundsMargin,this.displayBounds),this.updateManipulators()}get displayBoundsMargin(){const e=this.view.pointsOfInterest,t=e?e.centerOnSurfaceFrequent.location:this.editGeometryOperations.data.geometry.extent.center;return ms*this.view.pixelSizeAt(t)}createMoveXYGraphicDragPipeline(){return this.graphicMoveManipulation.createDragPipeline(((e,t,i)=>this.applyGraphicMoveSteps(t,i)))}createMoveZDragPipeline(){const e=this.view,t=this.editGeometryOperations.data.spatialReference;return Bt(this.moveZManipulator,((i,a,s)=>{const r=Z(i.renderLocation),n=a.next(Ct(e,r,t)).next(Yt());this.applyGraphicMoveSteps(n,s)}))}applyGraphicMoveSteps(e,t){const i=e.next((e=>("start"===e.action&&(this.inputState={type:"move"},Ei(this.mapBounds,this.mapBoundsStart),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:e.screenDeltaX,dyScreen:e.screenDeltaY})),e))).next(Xt()).next(this.moveDragUpdateGeometry()).next((e=>{const t={graphic:this.graphic,dxScreen:e.screenDeltaX,dyScreen:e.screenDeltaY};switch(e.action){case"start":case"update":(e.mapEnd.x-e.mapStart.x||e.mapEnd.y-e.mapStart.y||e.mapEnd.z-e.mapStart.z)&&this.emit("graphic-translate",t);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",t)}return e}));return t.next((()=>{r(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this.cancel()})),i}moveDragUpdateGeometry(){return e=>{if(o(this.inputState)||"move"!==this.inputState.type)return e;const t=[];for(const e of this.editGeometryOperations.data.components)t.push(...e.vertices);const i="start"===e.action?0:1;return ps(this.editGeometryOperations.moveVertices(t,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i),this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,e}}onResizeGrab(e){if("start"!==e.action)return;const t=this.calculatePickRay(e.screenPoint);mi(this.displayBounds.plane,t,Te.get())&&(Ei(this.displayBounds,this.displayBoundsStart),Ei(this.mapBounds,this.mapBoundsStart),this.displayBoundsMarginStart=this.displayBoundsMargin,this.inputState={type:"resize"})}createResizeDragPipeline(e,t){return Bt(e,((e,i,a)=>{o(this.inputState)||(i.next((e=>("start"===e.action&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),e))).next(Lt(this.view,this.displayBoundsStart.plane)).next((e=>({...e,handle:t}))).next(this.resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this.resizeDragUpdateGeometry()).next((e=>{const t={graphic:this.graphic,xScale:e.factor1,yScale:e.factor2};switch(e.action){case"start":case"update":this.emit("graphic-scale",t);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",t)}return e})),a.next((()=>{r(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this.cancel()})))}))}resizeDragRenderPlaneToFactors(){return e=>{const t=this.displayBoundsStart,i=e.handle.direction,a=this.displayBoundsMargin,s=this.displayBoundsMarginStart,r=w(Te.get(),t.origin);q(r,r,t.basis1,-i[0]),q(r,r,t.basis2,-i[1]);const n=j(Te.get(),e.renderEnd,r),o=j(Te.get(),e.renderStart,r),l=Oi(e.handle),p=Vi(t),h=Vi(this.displayBounds)/p,c=(e,t)=>{if(0===e)return 1;let i=B(t),r=.5*e*H(t,n)/i;const p=r<0?-1:1;if(l){r+=(i-.5*e*H(t,o)/i)*p*h}const c=i<1.5*s?1:ys;return i=Math.max(i-s,ys),p>0&&(r-=a),p*Math.max(p*(r/i),c)};return{...e,factor1:c(i[0],t.basis1),factor2:c(i[1],t.basis2)}}}resizeDragUpdateGeometry(){return e=>{const t=w(S(),this.mapBoundsStart.origin);q(t,t,this.mapBoundsStart.basis1,-e.handle.direction[0]),q(t,t,this.mapBoundsStart.basis2,-e.handle.direction[1]);const i=xe(xi(),this.mapBoundsStart.basis1[0],this.mapBoundsStart.basis1[1]);Me(i,i);const a=[];for(const e of this.editGeometryOperations.data.components)a.push(...e.vertices);const s="start"===e.action?0:1,r=this.editGeometryOperations.scaleVertices(a,t,i,e.factor1,e.factor2,s,1);return Ei(this.mapBoundsStart,this.mapBounds),ps(r,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,e}}onRotateGrab(e){if("start"!==e.action)return;const t=Ci(this.displayBounds,this.view.renderCoordsHelper,1,ui()),i=this.calculatePickRay(e.screenPoint);mi(t,i,Te.get())&&(Ei(this.displayBounds,this.displayBoundsStart),Ei(this.mapBounds,this.mapBoundsStart),this.inputState={type:"rotate",rotatePlane:t})}createRotateDragPipeline(e){return Bt(e,((e,t,i)=>{const a=this.inputState;o(a)||(t.next((e=>("start"===e.action&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),e))).next(Lt(this.view,a.rotatePlane)).next(this.rotateDragRenderPlaneToRotate(a)).next(this.rotateDragUpdateGeometry()).next((e=>{const t={graphic:this.graphic,angle:N(e.rotateAngle)};switch(e.action){case"start":case"update":this.emit("graphic-rotate",t);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",t)}return e})),i.next((()=>{r(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this.cancel()})))}))}rotateDragRenderPlaneToRotate(e){return t=>{const i=ci(e.rotatePlane),a=nt(t.renderStart,t.renderEnd,this.displayBounds.origin,i);return{...t,rotateAxis:i,rotateAngle:a}}}rotateDragUpdateGeometry(){return e=>{const t=w(S(),this.mapBoundsStart.origin),i=[];for(const e of this.editGeometryOperations.data.components)i.push(...e.vertices);const a="start"===e.action?0:1,s=this.editGeometryOperations.rotateVertices(i,t,e.rotateAngle,a,1);return Ei(this.mapBoundsStart,this.mapBounds),ps(s,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,e}}calculatePickRay(e){const t=oe(),i=_e(e);return Li(this.view.state.camera,i,t),R(t.direction,t.direction),t}updateManipulators(){if(!this.visible)return;const e=Ti(this.displayBounds,ze.get());zi(this.rotateManipulator,e,this.displayBounds,this.view.renderCoordsHelper),this.updateZMoveHandle(this.moveZManipulator,e),this.resizeManipulators.forEach(((t,i)=>{ki(t,this.resizeHandles[i],e,this.displayBounds)}))}updateZMoveHandle(e,t){const i=this.displayBounds,a={basis:i.basis1,direction:-1,position:j(Te.get(),i.origin,i.basis1),edge:2},s=ze.get();Rt(s,t,a.edge*Math.PI/2),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=a.position}cancel(){const e=this.editGeometryOperations.lastOperation;o(e)||(this.editGeometryOperations.undo(),this.graphic.geometry=this.editGeometryOperations.data.geometry,hs(e,this.mapBounds),this.updateDisplayBounds(),this.inputState=null)}get canUndo(){return this.editGeometryOperations.canUndo}undo(){if(r(this.inputState))this.view.activeTool=null;else if(this.canUndo){const e=this.editGeometryOperations.undo();this.graphic.geometry=this.editGeometryOperations.data.geometry,hs(n(e),this.mapBounds),this.updateDisplayBounds()}}get canRedo(){return this.editGeometryOperations.canRedo}redo(){if(this.canRedo){const e=this.editGeometryOperations.redo();this.graphic.geometry=this.editGeometryOperations.data.geometry,ps(n(e),this.mapBounds),this.updateDisplayBounds()}}get test(){return{resizeManipulators:this.resizeManipulators,rotateManipulator:this.rotateManipulator,moveZManipulator:this.moveZManipulator}}};e([m({constructOnly:!0,nonNullable:!0})],ds.prototype,"view",void 0),e([m({constructOnly:!0,nonNullable:!0})],ds.prototype,"graphic",void 0),e([m({constructOnly:!0,nonNullable:!0})],ds.prototype,"enableZ",void 0),e([m()],ds.prototype,"enableRotation",void 0),e([m()],ds.prototype,"enableScaling",void 0),e([m()],ds.prototype,"preserveAspectRatio",null),e([m()],ds.prototype,"grabbing",void 0),e([m()],ds.prototype,"inputState",void 0),e([m({readOnly:!0})],ds.prototype,"type",void 0),ds=e([g("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],ds);const us="draped-elevation-changes",ms=10,gs=80,ys=1e-6;export{la as DrawGraphicTool3D,ds as ExtentTransformTool,ka as GraphicMoveTool,Qa as GraphicReshapeTool,os as GraphicTransformTool};
