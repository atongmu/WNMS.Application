/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{i as t,o as r}from"../core/lang.js";import{f as s}from"./mat4.js";import{I as i,c as e}from"./mat4f64.js";import{h as a,b as n,g as o,j as h,f as d,l as c,m as l,J as u,n as f,a9 as m}from"./mathUtils.js";import{c as y}from"./vec4f64.js";import{c as _,e as g,a as p}from"./ray.js";import{e as O}from"./boundedPlane.js";import{I as L,a as b,i as j}from"./utils14.js";class v{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=2}}function E(r){return t(r)&&t(r.dist)}function T(t){return(r,s,i)=>(a(x,r,s,i),!O(t,x))}function A(t){return E(t)&&0===t.intersector&&!!t.target}function w(r){return E(r)&&1===r.intersector&&!!r.target&&t(r.target.center)}const x=n(),I=1e-5;class N{constructor(t){this.options=new v,this._results=new R,this.transform=new L,this.tolerance=1e-5,this.verticalOffset=null,this._ray=_(),this._rayEnd=n(),this._rayBeginTransformed=n(),this._rayEndTransformed=n(),this.viewingMode=null==t?1:t}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,r,s){this.resetWithRay(g(t,r,this._ray),s)}resetWithRay(t,r){this.camera=r,t!==this._ray&&p(t,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,o(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(r=null,s,i,e,a){this.point=s,this.filterPredicate=e,this.tolerance=null==i?1e-5:i;const n=b(this.verticalOffset);if(t(r)&&r.length>0){const s=a?t=>{a(t)&&this.intersectObject(t)}:t=>{this.intersectObject(t)};for(const i of r){const r=i.getSpatialQueryAccelerator&&i.getSpatialQueryAccelerator();t(r)?(t(n)?r.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,s,n):r.forEachAlongRay(this._ray.origin,this._ray.direction,s),this.options.selectionMode&&this.options.hud&&r.forEachDegenerateObject(s)):i.objects.forAll((t=>s(t)))}}this.sortResults()}intersectObject(r){const s=r.geometryRecords;if(!s)return;const e=r.transformation,a=b(this.verticalOffset);for(const n of s){const{geometry:s,material:o,instanceParameters:d}=n;if(j(d))continue;const c=s.id;this.transform.setAndInvalidateLazyTransforms(e,n.getShaderTransformation()),h(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),h(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const l=this.transform.transform;t(a)&&(a.objectTransform=this.transform),o.intersect(s,d,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((s,e,a,n,o,h)=>{if(s>=0){if(t(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,s))return;if(n){if(null==this._results.hud.dist||s<this._results.hud.dist){const t={object:r,geometryId:c,triangleNr:a,center:h};this._results.hud.set(1,t,s,e,i,o)}return}const d=t=>t.set(0,{object:r,geometryId:c,triangleNr:a},s,e,l,o);if((null==this._results.min.drapedLayerOrder||o>=this._results.min.drapedLayerOrder)&&(null==this._results.min.dist||s<this._results.min.dist)&&d(this._results.min),0!==this.options.store&&(null==this._results.max.drapedLayerOrder||o<this._results.max.drapedLayerOrder)&&(null==this._results.max.dist||s>this._results.max.dist)&&d(this._results.max),2===this.options.store){const t=P(this._ray);t.set(0,{object:r,geometryId:c,triangleNr:a},s,e,l),this._results.all.push(t)}}}),n.shaderTransformation)}}sortResults(){this._results.all.sort(((t,s)=>t.dist!==s.dist?r(t.dist,0)-r(s.dist,0):t.drapedLayerOrder!==s.drapedLayerOrder?r(t.drapedLayerOrder,Number.MAX_VALUE)-r(s.drapedLayerOrder,Number.MAX_VALUE):r(s.drapedLayerGraphicOrder,Number.MIN_VALUE)-r(t.drapedLayerGraphicOrder,Number.MIN_VALUE)))}}function M(t){return new N(t)}class R{constructor(){this._min=new G(_()),this._max=new G(_()),this._hud=new G(_()),this._ground=new G(_())}get min(){return this._min}get max(){return this._max}get hud(){return this._hud}get ground(){return this._ground}init(t){this._min.init(t),this._max.init(t),this._hud.init(t),this._ground.init(t),this.all=[]}}class G{constructor(t){this.intersector=0,this.normal=n(),this.transformation=e(),this._ray=_(),this.init(t)}get ray(){return this._ray}get distanceInRenderSpace(){return t(this.dist)?(d(B,this.ray.direction,this.dist),c(B)):null}getIntersectionPoint(t){return!!E(this)&&(d(B,this.ray.direction,this.dist),o(t,this.ray.origin,B),!0)}getTransformedNormal(t){return l(U,this.normal),U[3]=0,u(U,U,this.transformation),l(t,U),f(t,t)}init(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=0,p(t,this._ray)}set(t,e,a,n,o,h,d){this.intersector=t,this.dist=a,l(this.normal,r(n,m)),s(this.transformation,r(o,i)),this.target=e,this.drapedLayerOrder=h,this.drapedLayerGraphicOrder=d}copy(t){p(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,l(this.normal,t.normal),s(this.transformation,t.transformation)}}function P(t){return new G(t)}const B=n(),U=y();export{I as D,w as a,P as b,A as c,E as i,M as n,T as s};
