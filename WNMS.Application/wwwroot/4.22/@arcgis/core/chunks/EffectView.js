/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import e from"../core/Accessor.js";import{h as s,clone as r}from"../core/lang.js";import{L as i}from"./Logger.js";import{property as n}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import{p as l,c as o,n as f}from"./parser.js";let a=class extends e{constructor(t){super(t),this._from=null,this._to=null,this._final=null,this._current=[],this._time=0,this.duration=s("mapview-transitions-duration"),this.effects=[]}set effect(t){if(this._get("effect")!==(t=t||"")){this._set("effect",t);try{this._transitionTo(u(t))}catch(e){this._transitionTo([]),i.getLogger(this.declaredClass).warn("Invalid Effect",{effect:t,error:e})}}}get hasEffects(){return this.transitioning||!!this.effects.length}set scale(t){this._updateForScale(t)}get transitioning(){return null!==this._to}canTransitionTo(t){try{return this.scale>0&&_(this._current,u(t),this.scale)}catch{return!1}}transitionStep(t,e){this._applyTimeTransition(t),this._updateForScale(e)}end(){this._applyTimeTransition(this.duration)}_transitionTo(t){this.scale>0&&_(this._current,t,this.scale)?(this._final=t,this._to=r(t),function(t,e,s){var r,i;const n=t.length>e.length?t:e,c=t.length>e.length?e:t,l=c[c.length-1],o=null!=(r=null==l?void 0:l.scale)?r:s,a=null!=(i=null==l?void 0:l.effects)?i:[];for(let t=c.length;t<n.length;t++)c.push({scale:o,effects:[...a]});for(let t=0;t<n.length;t++)c[t].scale=-1===c[t].scale?s:c[t].scale,n[t].scale=-1===n[t].scale?s:n[t].scale,f(c[t].effects,n[t].effects)}(this._current,this._to,this.scale),this._from=r(this._current),this._time=0):(this._from=this._to=this._final=null,this._current=t),this._set("effects",this._current[0]?r(this._current[0].effects):[])}_applyTimeTransition(t){if(!(this._to&&this._from&&this._current&&this._final))return;this._time+=t;const e=Math.min(1,this._time/this.duration);for(let t=0;t<this._current.length;t++){const s=this._current[t],r=this._from[t],i=this._to[t];s.scale=p(r.scale,i.scale,e);for(let t=0;t<s.effects.length;t++){const n=s.effects[t],c=r.effects[t],l=i.effects[t];n.interpolate(c,l,e)}}1===e&&(this._current=this._final,this._set("effects",this._current[0]?r(this._current[0].effects):[]),this._from=this._to=this._final=null)}_updateForScale(t){if(this._set("scale",t),0===this._current.length)return;const e=this._current,s=this._current.length-1;let r,i,n=1;if(1===e.length||t>=e[0].scale)i=r=e[0].effects;else if(t<=e[s].scale)i=r=e[s].effects;else for(let c=0;c<s;c++){const s=e[c],l=e[c+1];if(s.scale>=t&&l.scale<=t){n=(t-s.scale)/(l.scale-s.scale),r=s.effects,i=l.effects;break}}for(let t=0;t<this.effects.length;t++){this.effects[t].interpolate(r[t],i[t],n)}}};t([n()],a.prototype,"_to",void 0),t([n()],a.prototype,"duration",void 0),t([n({value:""})],a.prototype,"effect",null),t([n({readOnly:!0})],a.prototype,"effects",void 0),t([n({readOnly:!0})],a.prototype,"hasEffects",null),t([n({value:0})],a.prototype,"scale",null),t([n({readOnly:!0})],a.prototype,"transitioning",null),a=t([c("esri.layers.effects.EffectView")],a);const h=a;function u(t){const e=l(t)||[];return function(t){const e=t[0];if(!e)return!1;return"type"in e}(e)?[{scale:-1,effects:e}]:e}function _(t,e,s){var r,i,n,c;if(null==(r=t[0])||!r.effects||null==(i=e[0])||!i.effects)return!0;return!((-1===(null==(n=t[0])?void 0:n.scale)||-1===(null==(c=e[0])?void 0:c.scale))&&(t.length>1||e.length>1)&&s<=0)&&o(t[0].effects,e[0].effects)}function p(t,e,s){return t+(e-t)*s}export{h as E};
