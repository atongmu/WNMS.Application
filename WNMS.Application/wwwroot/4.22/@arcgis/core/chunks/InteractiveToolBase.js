/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{i as t,b as e,u as a,clone as n}from"../core/lang.js";import{c as r,k as i}from"./mathUtils.js";import{c as o}from"./screenUtils.js";import{project as s}from"../geometry/projection.js";import{m as l}from"./drawUtils.js";import{_ as c}from"./tslib.es6.js";import h from"../core/Accessor.js";import{L as u}from"./Logger.js";import{createResolver as p}from"../core/promiseUtils.js";import{property as d}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import{i as f}from"./DOMContainer.js";import v from"../core/Collection.js";function g(a,n){return a.events.on("drag",function(a,n){let r=null,i=null;return o=>{if("cancel"===o.action)return void(t(i)&&(i.execute({action:"cancel"}),r=null,i=null));const s={action:o.action,screenStart:o.start,screenEnd:o.screenPoint};"start"===o.action&&e(r)&&(r=new R,i=new R,n(a,r,i,o.pointerType,s)),t(r)&&r.execute(s),"end"===o.action&&t(r)&&(r=null,i=null)}}(a,n))}function y(t,e){const a=[t.x,t.y,t.z],n=e,r=[Math.cos(n),Math.sin(n)],i=Math.sqrt(r[0]*r[0]+r[1]*r[1]);if(0===i)return null;r[0]/=i,r[1]/=i;const o=t=>{const e=(t.x-a[0])*r[0]+(t.y-a[1])*r[1];t.x=a[0]+e*r[0],t.y=a[1]+e*r[1]};return t=>(o(t.mapStart),o(t.mapEnd),t)}function _(a,n){let r=null;return o=>{if("start"===o.action&&(r=function(a,n,r){const o=a.geometry;if(e(o))return null;if("mesh"===o.type)return function(a,n,r,o){if(t(n.transform))return function(a,n,r,o){const c=E(r.getOriginPoint(n.spatialReference),o),h=n.spatialReference;if(e(c))return null;return{move:(e,n,o)=>{const u=l(c.clone(),e,n,o);if(u.spatialReference.equals(h))r.origin=i(u.x,u.y,u.z);else{const e=s(u,h);t(e)&&(r.origin=i(e.x,e.y,e.z))}a.notifyGeometryChanged()}}}(a,n,n.transform,r);if(!n.spatialReference.equals(r))return null;let c=0,h=0,u=0;return{move:(t,e,r)=>{const i=t-c,s=e-h,l=r-u;if(i||s||l){const p=n.origin.clone().offset(i,s,l);n.centerAt(p,{geographic:1===o}),a.notifyGeometryChanged(),c=t,h=e,u=r}}}}(a,o,n,r);const c=E(o,n),h=o.spatialReference;if(e(c))return null;return{move:(t,e,n)=>{const r=l(c.clone(),t,e,n);r.spatialReference.equals(h)?a.geometry=r:a.geometry=s(r,h)}}}(a,o.mapStart.spatialReference,n)),e(r))return null;const c=o.mapEnd.x-o.mapStart.x,h=o.mapEnd.y-o.mapStart.y,u=o.mapEnd.z-o.mapStart.z;return r.move(c,h,u),{...o,translationX:c,translationY:h,translationZ:u}}}function E(t,a){return e(t)?null:t.spatialReference.equals(a)?t.clone():s(t,a)}function b(a,n=null,r){let i=null;const o=t(n)&&!a.spatialReference.equals(n)?e=>t(e)?s(e,n):e:t=>t,l={exclude:[],...r};return n=>{if("start"===n.action&&(i=o(a.toMap(n.screenStart,l))),e(i))return null;const r=o(a.toMap(n.screenEnd,l));return t(r)?{...n,mapStart:i,mapEnd:r}:null}}function S(e,n){const r=e.map((t=>a(_(t,n)))).filter((e=>t(e)));return t=>{const e=t.mapEnd.x-t.mapStart.x,a=t.mapEnd.y-t.mapStart.y,n=t.mapEnd.z-t.mapStart.z;return r.forEach((e=>e(t))),{...t,translationX:e,translationY:a,translationZ:n}}}function x(t,e){const a=new Map;for(const r of e)a.set(r,n(t[r]));return e=>(a.forEach(((e,a)=>{t[a]=e})),e)}function w(e){return t(e.geometry)&&"mesh"===e.geometry.type?function(e,a){const n=t(a.transform)?a.transform.clone():null,r=a.vertexAttributes.clonePositional();return t=>(a.transform=n,a.vertexAttributes=r,e.notifyGeometryChanged(),t)}(e,e.geometry):x(e,["geometry"])}function M(e){const n=e.map((t=>a(w(t)))).filter((e=>t(e)));return t=>(n.forEach((e=>e(t))),t)}function A(){let t=0,e=0,a=0;return n=>{"start"===n.action&&(t=n.mapStart.x,e=n.mapStart.y,a=n.mapStart.z);const r=n.mapEnd.x-t,i=n.mapEnd.y-e,o=n.mapEnd.z-a;return t=n.mapEnd.x,e=n.mapEnd.y,a=n.mapEnd.z,{...n,mapDeltaX:r,mapDeltaY:i,mapDeltaZ:o,mapDeltaSpatialReference:n.mapStart.spatialReference}}}function C(){let t=0,e=0;return a=>{"start"===a.action&&(t=a.screenStart.x,e=a.screenStart.y);const n=a.screenEnd.x-t,r=a.screenEnd.y-e;return t=a.screenEnd.x,e=a.screenEnd.y,{...a,screenDeltaX:n,screenDeltaY:r}}}function I(t,e){let a=null,n=0,i=0;return s=>{if("start"===s.action&&(a=t.toScreen(e),a.x<0||a.x>t.width||a.y<0||a.y>t.height?a=null:(n=s.screenStart.x-a.x,i=s.screenStart.y-a.y)),null==a)return null;const l=r(s.screenEnd.x-n,0,t.width),c=r(s.screenEnd.y-i,0,t.height),h=o(l,c);return s.screenStart=a,s.screenEnd=h,s}}class R{constructor(){this.execute=()=>{}}next(e,a=new R){return t(e)&&(this.execute=n=>{const r=e(n);t(r)&&a.execute(r)}),a}}class T{constructor(){this._isToolEditable=!0,this._manipulators=new v,this._nextManipulatorId=0,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(t){this._isToolEditable=t}get length(){return this._manipulators.length}add(t,e=0){return this.addMany([t],e)[0]}addMany(t,e=0){return t.map((t=>{const a=this._nextManipulatorId++,n={id:a,manipulator:t,visibilityPredicate:e,attached:!1};return this._manipulators.add(n),this._attached&&this._updateManipulatorAttachment(n),a}))}remove(t){if("number"==typeof t){const e=t;for(let t=0;t<this._manipulators.length;t++)if(this._manipulators.getItemAt(t).id===e){const e=this._manipulators.splice(t,1)[0];return this._detachManipulator(e),e.id}return null}const e=t;for(let t=0;t<this._manipulators.length;t++)if(this._manipulators.getItemAt(t).manipulator===e){const e=this._manipulators.splice(t,1)[0];return this._detachManipulator(e),e.id}return null}removeAll(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._manipulators.removeAll()}attach(){this._manipulators.forEach((t=>{this._updateManipulatorAttachment(t)})),this._attached=!0}detach(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._attached=!1}destroy(){this._manipulators.forEach((({manipulator:t})=>{t.destroy&&t.destroy()})),this._manipulators.destroy(),this._resourceContexts=null}on(t,e){return this._manipulators.on(t,(t=>{e(t)}))}forEach(t){for(const e of this._manipulators.items)t(e)}some(t){return this._manipulators.items.some(t)}toArray(){const t=[];return this.forEach((e=>t.push(e.manipulator))),t}intersect(e,a){let n=null,r=Number.MAX_VALUE;return this._manipulators.forEach((({id:i,manipulator:o,attached:s})=>{if(!s||!o.interactive)return;const l=o.intersectionDistance(e,a);t(l)&&l<r&&(r=l,n={id:i,manipulator:o})})),n}findById(t){if(e(t))return null;for(const e of this._manipulators.items)if(t===e.id)return e.manipulator;return null}_updateManipulatorAttachment(t){this._isManipulatorItemVisible(t)?this._attachManipulator(t):this._detachManipulator(t)}_attachManipulator(t){t.attached||(t.manipulator.attach&&t.manipulator.attach(this._resourceContexts),t.attached=!0)}_detachManipulator(t){if(!t.attached)return;const e=t.manipulator;e.grabbing=!1,e.dragging=!1,e.hovering=!1,e.selected=!1,e.detach&&e.detach(this._resourceContexts),t.attached=!1}_isManipulatorItemVisible(t){return 2===t.visibilityPredicate||(this._isToolEditable?0===t.visibilityPredicate:1===t.visibilityPredicate)}}const j=u.getLogger("esri.views.interactive.InteractiveToolBase");let D=class extends h{constructor(t){super(t),this.toolState="pending",this.completed=!1,this.manipulators=new T,this.updating=!1,this.automaticManipulatorSelection=!0,this._editableFlags=new Map([[1,!0],[0,!0]]),this._creationStartedResolver=p(),this._creationFinishedResolver=p()}get active(){return null!=this.view&&this.view.activeTool===this}set visible(t){this._set("visible",t),t||this.active&&(this.view.activeTool=null),this.attached&&(t?this._show():this._hide())}get editable(){return this.getEditableFlag(0)}set editable(t){this.setEditableFlag(0,t)}get attached(){return this._get("attached")}get created(){return"created"===this.toolState}get cursor(){return null}attach(){this.attached?j.warn("Tool is already attached. Ignoring attach request."):(this.manipulators.attach(),this.onAttach(),this.visible&&this.onShow(),this._set("attached",!0))}detach(){this.attached?(this.visible&&this.onHide(),this.onDetach(),this.manipulators.detach(),this._set("attached",!1)):j.error("Tool isn't currently attached. Ignoring detach request.")}activate(){e(this.view)?j.error("Can't activate tool if view is not defined."):this.active?j.warn("Tool is already active, ignoring activation request."):(f(this.view)&&this.view.focus(),this.onActivate())}deactivate(){this.active?this.onDeactivate():j.warn("Tool is not active, ignoring deactivation request.")}handleInputEvent(t){this.attached?this.onInputEvent(t):j.warn("handleInputEvent() called on detached tool")}handleInputEventAfter(t){this.attached?this.onInputEventAfter(t):j.warn("handleInputEventAfter() called on detached tool")}destroy(){this.manipulators.destroy(),this._set("view",null),this._set("completed",!1)}setEditableFlag(t,e){this._editableFlags.set(t,e),this.manipulators.isToolEditable=this.internallyEditable,this._updateManipulatorAttachment(),0===t&&this.notifyChange("editable"),this.onEditableChange()}getEditableFlag(t){return this._editableFlags.get(t)}whenCreationStarted(){return this._creationStartedResolver.promise}whenCreated(){return this._creationFinishedResolver.promise}rejectCreation(t){"pending"!==this.toolState&&"creating"!==this.toolState||this._creationStartedResolver.resolve(this),this._creationFinishedResolver.reject(t)}onActivate(){}onDeactivate(){}onAttach(){}onDetach(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(t){}onInputEventAfter(t){}get internallyEditable(){return this.getEditableFlag(0)&&this.getEditableFlag(1)}startToolCreation(){if("pending"===this.toolState)return this._creationStartedResolver.resolve(this),void(this.toolState="creating");throw new Error(`Unexpected tool state ${this.toolState}`)}finishToolCreation(){switch(this.toolState){case"pending":this.startToolCreation();case"creating":this.created||this._creationFinishedResolver.resolve(this),this.toolState="created";break;case"created":break;default:throw new Error(`Unexpected tool state ${this.toolState}`)}}complete(){this.finishToolCreation(),this._set("completed",!0)}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.attached&&this.visible?this.manipulators.attach():this.manipulators.detach()}};c([d()],D.prototype,"toolState",void 0),c([d({constructOnly:!0})],D.prototype,"view",void 0),c([d({readOnly:!0})],D.prototype,"active",null),c([d({value:!0})],D.prototype,"visible",null),c([d({value:!0})],D.prototype,"editable",null),c([d({value:!1,readOnly:!0})],D.prototype,"attached",null),c([d({readOnly:!0})],D.prototype,"created",null),c([d({readOnly:!0})],D.prototype,"completed",void 0),c([d({readOnly:!0})],D.prototype,"manipulators",void 0),c([d({readOnly:!0})],D.prototype,"updating",void 0),c([d()],D.prototype,"cursor",null),c([d()],D.prototype,"automaticManipulatorSelection",void 0),D=c([m("esri.views.interactive.InteractiveToolBase")],D);export{R as E,D as I,T as M,w as a,I as b,g as c,_ as d,y as e,C as f,A as g,S as h,M as i,x as r,b as s};
