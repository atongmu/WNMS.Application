/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import e from"../Color.js";import t from"../request.js";import{throwIfAborted as r}from"../core/promiseUtils.js";import{a as i}from"./screenUtils.js";import{n as a}from"./string.js";import{getJsonType as o,isPolygon as s,isPolyline as n}from"../geometry/support/jsonUtils.js";import{a as m,b as c}from"./cimAnalyzer.js";import{T as l,C as h}from"./CIMSymbolHelper.js";import{R as p}from"./Rasterizer.js";import{d as y,e as g,g as f}from"./utils5.js";import{scaleCIMMarker as u}from"../symbols/support/cimSymbolUtils.js";import{S as d}from"../symbols/IconSymbol3DLayer.js";import"./colorUtils.js";import"./mathUtils.js";import"./common.js";import"../core/lang.js";import"./ensureType.js";import"./Logger.js";import"../config.js";import"./object.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"../geometry/Extent.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./metadata.js";import"./handleUtils.js";import"../core/accessorSupport/decorators/subclass.js";import"../geometry/Geometry.js";import"./JSONSupport.js";import"../core/Accessor.js";import"./deprecate.js";import"./ArrayPool.js";import"../core/scheduling.js";import"./nextTick.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./arcadeOnDemand.js";import"../geometry.js";import"./typeUtils.js";import"./jsonMap.js";import"./floatRGBA.js";import"./callExpressionWithFeature.js";import"./quantizationUtils.js";import"./shapingUtils.js";import"./Rect.js";import"./mat2d.js";import"./mat2df32.js";import"./vec2.js";import"./vec2f32.js";import"./number2.js";import"./aaBoundingRect.js";import"./definitions.js";import"./GeometryUtils.js";import"./enumeration.js";import"../symbols/Symbol3DLayer.js";import"./colors.js";import"./persistableUrlUtils.js";import"./materialUtils.js";import"./opacityUtils.js";import"./Symbol3DMaterial.js";var M;!function(e){e.Legend="legend",e.Preview="preview"}(M||(M={}));const j=(e,t,r)=>{if(e&&e.targetSize){let a;if(r){const t=Math.max(r.frame.xmax-r.frame.xmin,r.frame.ymax-r.frame.ymin);a=e.targetSize/i(t)}else a=e.targetSize/t.referenceSize;return a}return e&&e.scaleFactor?e.scaleFactor:1},C={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};class I{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._pictureMarkerCache=new Map,this._textRasterizer=new l,this._cimResourceManager=new h,this._rasterizer=new p(this._cimResourceManager)}async rasterizeCIMSymbolAsync(e,t,r,i,a,s,n,m){i=i||(t?null!=t.centroid?"esriGeometryPolygon":o(t.geometry):null)||function(e){if(!(e&&e.data&&e.data.symbol))return null;switch(e.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}(e);const c=await this.analyzeCIMSymbol(e,t?function(e){const t=e?Object.keys(e):[];return t.map((t=>({name:t,alias:t,type:"string"==typeof e[t]?"esriFieldTypeString":"esriFieldTypeDouble"})))}(t.attributes):null,r,i,m);return this.rasterizeCIMSymbol(c,t,i,a,s,n)}async analyzeCIMSymbol(e,t,i,a,o){const s=[],n=t?{geometryType:a,spatialReference:this._spatialReference,fields:t}:null;let c;await m(e.data,n,this._cimResourceManager,s,this._avoidSDF),r(o);for(const e of s)"CIMPictureMarker"!==e.cim.type&&"CIMPictureFill"!==e.cim.type&&"CIMPictureStroke"!==e.cim.type||(c||(c=[]),c.push(this.fetchPictureMarkerResource(e,o))),i&&"text"===e.type&&"string"==typeof e.text&&e.text.indexOf("[")>-1&&(e.text=y(i,e.text,e.cim.textCase));return c&&await Promise.all(c),s}async fetchPictureMarkerResource(e,r){const i=e.materialHash;if(!this._pictureMarkerCache.get(i)){const a=(await t(e.cim.url,{responseType:"image",signal:r&&r.signal})).data;this._pictureMarkerCache.set(i,a)}}rasterizeCIMSymbol(e,t,r,i,a,o){const s=[];for(const n of e){i&&"function"==typeof i.scaleFactor&&(i.scaleFactor=i.scaleFactor(t,a,o));const e=this._getRasterizedResource(n,t,r,i,a,o);if(!e)continue;let m=0,c=e.anchorX||0,l=e.anchorY||0,h=!1,p=0,y=0;if("esriGeometryPoint"===r){const e=j(i,n,null);if(p=g(n.offsetX,t,a,o)*e||0,y=g(n.offsetY,t,a,o)*e||0,"marker"===n.type)m=g(n.rotation,t,a,o)||0,h=!!n.rotateClockwise&&n.rotateClockwise;else if("text"===n.type){if(m=g(n.angle,t,a,o)||0,void 0!==n.horizontalAlignment)switch(n.horizontalAlignment){case"left":c=-.5;break;case"right":c=.5;break;default:c=0}if(void 0!==n.verticalAlignment)switch(n.verticalAlignment){case"top":l=.5;break;case"bottom":l=-.5;break;case"baseline":l=-.25;break;default:l=0}}}null!=e&&s.push({angle:m,rotateClockWise:h,anchorX:c,anchorY:l,offsetX:p,offsetY:y,rasterizedResource:e})}return this.getSymbolImage(s)}getSymbolImage(e){const t=document.createElement("canvas"),r=t.getContext("2d");let a=0,o=0,s=0,n=0;const m=[];for(let t=0;t<e.length;t++){const c=e[t],l=c.rasterizedResource;if(!l)continue;const h=l.size,p=c.offsetX,y=c.offsetY,g=c.anchorX,f=c.anchorY,u=c.rotateClockWise||!1;let d=c.angle,M=i(p)-h[0]*(.5+g),j=i(y)-h[1]*(.5+f),C=M+h[0],I=j+h[1];if(d){u&&(d=-d);const e=Math.sin(d*Math.PI/180),t=Math.cos(d*Math.PI/180),r=M*t-j*e,i=M*e+j*t,a=M*t-I*e,o=M*e+I*t,s=C*t-I*e,n=C*e+I*t,m=C*t-j*e,c=C*e+j*t;M=Math.min(r,a,s,m),j=Math.min(i,o,n,c),C=Math.max(r,a,s,m),I=Math.max(i,o,n,c)}a=M<a?M:a,o=j<o?j:o,s=C>s?C:s,n=I>n?I:n;const z=r.createImageData(l.size[0],l.size[1]);z.data.set(new Uint8ClampedArray(l.image.buffer));const x={offsetX:p,offsetY:y,rotateClockwise:u,angle:d,rasterizedImage:z,anchorX:g,anchorY:f};m.push(x)}t.width=s-a,t.height=n-o;const c=-a,l=n;for(let e=0;e<m.length;e++){const t=m[e],a=this._imageDataToCanvas(t.rasterizedImage),o=t.rasterizedImage.width,s=t.rasterizedImage.height,n=c-o*(.5+t.anchorX),h=l-s*(.5-t.anchorY);if(t.angle){const e=(360-t.angle)*Math.PI/180;r.save(),r.translate(i(t.offsetX),-i(t.offsetY)),r.translate(c,l),r.rotate(e),r.translate(-c,-l),r.drawImage(a,n,h),r.restore()}else r.drawImage(a,n+i(t.offsetX),h-i(t.offsetY))}const h=new d({x:c/t.width-.5,y:l/t.height-.5});return{imageData:0!==t.width&&0!==t.height?r.getImageData(0,0,t.width,t.height):r.createImageData(1,1),anchorPosition:h}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,r=t.getContext("2d");return t.width=e.width,t.height=e.height,r.putImageData(e,0,0),t}_imageTo32Array(t,r,i,a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const o=this._imageDataCanvas,s=o.getContext("2d");if(o.width=r,o.height=i,s.drawImage(t,0,0,r,i),a){s.save();const o=new e(a);s.fillStyle=o.toHex(),s.globalCompositeOperation="multiply",s.fillRect(0,0,r,i),s.globalCompositeOperation="destination-atop",s.drawImage(t,0,0,r,i),s.restore()}return new Uint32Array(s.getImageData(0,0,r,i).data.buffer)}_getRasterizedResource(e,t,r,i,o,s){let n,m,c,l,h=null,p=null;if("esriGeometryPolyline"===r||"esriGeometryPolygon"===r){const l=i&&i.style?i.style:M.Legend,y="esriGeometryPolyline"===r?C.stroke[l]:C.fill[l];if("line"===e.type){if("CIMSolidStroke"!==e.cim.type){if("CIMPictureStroke"===e.cim.type){const r=g(e.width,t,o,s),i=g(e.color,t,o,s),{image:a,width:n,height:m}=this._getPictureResource(e,r,i);return this._rasterizePictureResource(e,a,n,m,y,r)}return null}({analyzedCIM:n,hash:c}=z(e,t,o,s)),m=this._embedCIMLayerInVectorMarker(n,y)}else if("marker"===e.type){if("CIMPictureMarker"===e.cim.type)return null;if("CIMVectorMarker"!==e.cim.type)return null;e.cim.offsetX=g(e.offsetX,t,o,s),e.cim.offsetY=g(e.offsetY,t,o,s),e.cim.rotation=g(e.rotation,t,o,s),e.cim.markerPlacement=e.markerPlacement,({analyzedCIM:n}=z(e,t,o,s)),c=a(JSON.stringify(n)).toString(),m=this._embedCIMLayerInVectorMarker(n,y),h=g(e.size,t,o,s),p=e.path}else{if("text"===e.type)return null;if("fill"===e.type){if("CIMHatchFill"===e.cim.type||"CIMVectorMarker"===e.cim.type||"CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type){const r=e.cim.size||e.cim.height;let i,a,m;if("CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type)({image:i,width:a,height:m}=this._getPictureResource(e,r,g(e.color,t,o,s)));else{({analyzedCIM:n,hash:c}=z(e,t,o,s));const l=this._rasterizer.rasterizeJSONResource({cim:n,type:e.type,url:e.url,mosaicHash:c,size:r,path:p},1,this._avoidSDF);i=l.image,a=l.size[0],m=l.size[1]}return this._rasterizePictureResource(e,i,a,m,y,null)}if("CIMSolidFill"!==e.cim.type)return null;({analyzedCIM:n,hash:c}=z(e,t,o,s)),m=this._embedCIMLayerInVectorMarker(n,y)}}}else{if("text"===e.type)return l=this._rasterizeTextResource(e,t,i,o,s),l;({analyzedCIM:n,hash:c}=z(e,t,o,s));const r=j(i,e,null);if("CIMPictureMarker"===e.cim.type){const i=g(e.size,t,o,s)*r,{image:a,width:n,height:m}=this._getPictureResource(e,i,g(e.color,t,o,s));return l={image:a,size:[n,m],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},l}u(n,r,{preserveOutlineWidth:!1}),m=n}c+=r,i&&(c+=JSON.stringify(i));const y=this._resourceCache;return y.has(c)?y.get(c):(l=this._rasterizer.rasterizeJSONResource({cim:m,type:e.type,url:e.url,mosaicHash:c,size:h,path:p},window.devicePixelRatio||1,this._avoidSDF),y.set(c,l),l)}_rasterizeTextResource(e,t,r,i,a){const o=j(r,e,null),s=g(e.text,t,i,a);if(!s||0===s.length)return null;const n=g(e.fontName,t,i,a),m=g(e.style,t,i,a),c=g(e.weight,t,i,a),l=g(e.decoration,t,i,a),h=g(e.size,t,i,a)*o,p=g(e.horizontalAlignment,t,i,a),y=g(e.verticalAlignment,t,i,a),u=f(g(e.color,t,i,a)),d=f(g(e.outlineColor,t,i,a)),M={color:u,size:h,horizontalAlignment:p,verticalAlignment:y,font:{family:n,style:m,weight:c,decoration:l},halo:{size:g(e.outlineSize,t,i,a)||0,color:d,style:m},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(s,M)}_rasterizePictureResource(e,t,r,a,o,m){const c=document.createElement("canvas"),l=c.getContext("2d");c.height=i(Math.max(o.frame.ymax-o.frame.ymin,m)),c.width=i(o.frame.xmax-o.frame.xmin);const h=l.createImageData(r,a);h.data.set(new Uint8ClampedArray(t.buffer));const p=this._imageDataToCanvas(h),y=l.createPattern(p,"repeat"),g=Math.cos((-e.cim.rotation||0)*Math.PI/180),f=Math.sin((-e.cim.rotation||0)*Math.PI/180);y.setTransform({m11:g,m12:f,m21:-f,m22:g,m41:i(e.cim.offsetX)||0,m42:i(e.cim.offsetY)||0});const u=o.canvasPaths;let d,M,j;s(u)?(d=u.rings,l.fillStyle=y,M=l.fill,j=["evenodd"]):n(u)&&(d=u.paths,l.strokeStyle=y,l.lineWidth=m,M=l.stroke,d[0][0][1]=c.height/2,d[0][1][1]=c.height/2),l.beginPath();for(const e of d){const t=e?e.length:0;if(t>1){let r=e[0];l.moveTo(i(r[0]),i(r[1]));for(let a=1;a<t;++a)r=e[a],l.lineTo(i(r[0]),i(r[1]));l.closePath()}}M.apply(l,j);const C=l.getImageData(0,0,c.width,c.height),I=new Uint8Array(C.data);return{size:[c.width,c.height],image:new Uint32Array(I.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(e,t,r){const a=this._pictureMarkerCache.get(e.materialHash);if(!a)return null;const o=a.height/a.width,s=t?o>1?i(t):i(t)/o:a.width,n=t?o>1?i(t)*o:i(t):a.height;return{image:this._imageTo32Array(a,s,n,r),width:s,height:n}}_embedCIMLayerInVectorMarker(e,t){const r=s(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol",i=t.frame;return{type:"CIMVectorMarker",frame:i,size:i.ymax-i.ymin,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:r,symbolLayers:[e]}}]}}}function z(e,t,r,i){let a,o;if("function"==typeof e.materialHash){a=(0,e.materialHash)(t,r,i),o=c(e.cim,e.materialOverrides)}else a=e.materialHash,o=e.cim;return{analyzedCIM:o,hash:a}}export{I as CIMSymbolRasterizer,M as GeometryStyle};
