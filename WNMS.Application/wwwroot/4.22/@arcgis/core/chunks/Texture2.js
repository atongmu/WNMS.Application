/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{p as e,b as t,i as r,L as s,K as i,r as a}from"../core/lang.js";import{a2 as o,ad as n,d as h}from"./StencilUtils.js";import{n as l}from"./compilerUtils.js";import u from"../core/Error.js";import{E as m}from"./Evented.js";import{C as d,A as c}from"./mathUtils.js";import{onAbort as p,createAbortError as g}from"../core/promiseUtils.js";import{isBlobProtocol as x,isDataProtocol as f}from"../core/urlUtils.js";import{r as T}from"./requestImageUtils.js";import{l as w}from"../request.js";import{g as _}from"./assets.js";import{T as F,i as I}from"./Texture.js";import{a as M,v as y}from"./Program.js";import{L as D}from"./Logger.js";import{d as b}from"./Util2.js";import{F as A}from"./FramebufferObject.js";class E extends o{constructor(e){super(e),this._numLoading=0,this._disposed=!1,this._textureRepository=e.textureRep,this._textureId=e.textureId,this._acquire(e.textureId).then((e=>this._texture=e)),this._acquire(e.normalTextureId).then((e=>this._textureNormal=e)),this._acquire(e.emissiveTextureId).then((e=>this._textureEmissive=e)),this._acquire(e.occlusionTextureId).then((e=>this._textureOcclusion=e)),this._acquire(e.metallicRoughnessTextureId).then((e=>this._textureMetallicRoughness=e))}dispose(){this._texture=e(this._texture),this._textureNormal=e(this._textureNormal),this._textureEmissive=e(this._textureEmissive),this._textureOcclusion=e(this._textureOcclusion),this._textureMetallicRoughness=e(this._textureMetallicRoughness),this._disposed=!0}ensureResources(e){return 0===this._numLoading?2:1}updateTexture(r){(t(this._texture)||r!==this._texture.id)&&(this._texture=e(this._texture),this._textureId=r,this._acquire(this._textureId).then((e=>this._texture=e)))}bindTextures(e){r(this._texture)&&e.bindTexture(this._texture.glTexture,"tex"),r(this._textureNormal)&&e.bindTexture(this._textureNormal.glTexture,"normalTexture"),r(this._textureEmissive)&&e.bindTexture(this._textureEmissive.glTexture,"texEmission"),r(this._textureOcclusion)&&e.bindTexture(this._textureOcclusion.glTexture,"texOcclusion"),r(this._textureMetallicRoughness)&&e.bindTexture(this._textureMetallicRoughness.glTexture,"texMetallicRoughness")}bindTextureScale(e){const t=r(this._texture)?this._texture.glTexture:null;r(t)&&t.descriptor.textureCoordinateScaleFactor?e.setUniform2fv("textureCoordinateScaleFactor",t.descriptor.textureCoordinateScaleFactor):e.setUniform2f("textureCoordinateScaleFactor",1,1)}_acquire(r){return t(r)?Promise.resolve(null):(++this._numLoading,this._textureRepository.acquire(r).then((t=>this._disposed?(e(t),null):t)).finally((()=>--this._numLoading)))}}let v,S=null,C=null;async function O(){return t(C)&&(C=function(){if(t(v)){const e=e=>_(`esri/libs/basisu/${e}`);v=import("./basis_transcoder.js").then((e=>e.b)).then((({default:t})=>t({locateFile:e}).then((e=>(e.initializeBasis(),delete e.then,e)))))}return v}(),S=await C),C}function L(e,t,r,s,i){const a=M(t?37496:37492),o=i&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(r*s*a*o)}function U(e){return e.getNumImages()>=1&&!e.isUASTC()}function P(e){return e.getFaces()>=1&&e.isETC1S()}function N(e,t,r,s,i,a,o,n){const{compressedTextureETC:h,compressedTextureS3TC:l}=e.capabilities,[u,m]=h?s?[1,37496]:[0,37492]:l?s?[3,33779]:[2,33776]:[13,6408],d=t.hasMipmap?r:Math.min(1,r),c=[];for(let e=0;e<d;e++)c.push(new Uint8Array(o(e,u))),n(e,u,c[e]);const p=c.length>1,g=p?9987:9729,x={...t,samplingMode:g,hasMipmap:p,internalFormat:m,width:i,height:a};return new F(e,x,{type:"compressed",levels:c})}const R=D.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil");function j(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const H=j("DXT1"),q=j("DXT3"),V=j("DXT5");function k(e,t,r){const{textureData:s,internalFormat:i,width:a,height:o}=function(e,t){const r=new Int32Array(e,0,31);if(542327876!==r[0])return R.error("Invalid magic number in DDS header"),null;if(!(4&r[20]))return R.error("Unsupported format, must contain a FourCC code"),null;const s=r[21];let i,a;switch(s){case H:i=8,a=33776;break;case q:i=16,a=33778;break;case V:i=16,a=33779;break;default:return R.error("Unsupported FourCC code:",(o=s,String.fromCharCode(255&o,o>>8&255,o>>16&255,o>>24&255))),null}var o;let n=1,h=r[4],l=r[3];0==(3&h)&&0==(3&l)||(R.warn("Rounding up compressed texture size to nearest multiple of 4."),h=h+3&-4,l=l+3&-4);const u=h,m=l;131072&r[2]&&!1!==t&&(n=Math.max(1,r[7]));1===n||d(h)&&d(l)||(R.warn("Ignoring mipmaps of non power of two sized compressed texture."),n=1);let c,p,g=r[1]+4;const x=[];for(let t=0;t<n;++t)p=(h+3>>2)*(l+3>>2)*i,c=new Uint8Array(e,g,p),x.push(c),g+=p,h=Math.max(1,h>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:x},internalFormat:a,width:u,height:m}}(r,t.hasMipmap);return t.samplingMode=s.levels.length>1?9987:9729,t.hasMipmap=s.levels.length>1,t.internalFormat=i,t.width=a,t.height=o,new F(e,t,s)}class B extends n{constructor(e,t){super(),this.data=e,this.type=4,this._glTexture=null,this._powerOfTwoStretchInfo=null,this._loadingPromise=null,this._loadingController=null,this.events=new m,this.params=t||{},this.params.mipmap=!1!==this.params.mipmap,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:10497,t:10497},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||1,this.estimatedTexMemRequired=B.estimateTexMemRequired(this.data,this.params),this.startPreload()}startPreload(){const e=this.data;t(e)||(e instanceof HTMLVideoElement?this.startPreloadVideoElement(e):e instanceof HTMLImageElement&&this.startPreloadImageElement(e))}startPreloadVideoElement(e){x(e.src)||"auto"===e.preload&&e.crossOrigin||(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src)}startPreloadImageElement(e){f(e.src)||x(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}static getDataDimensions(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}static estimateTexMemRequired(e,r){if(t(e))return 0;if(s(e)||i(e))return r.encoding===B.KTX2_ENCODING?function(e,r){if(t(S))return e.byteLength;const s=new S.KTX2File(new Uint8Array(e)),i=P(s)?L(s.getLevels(),s.getHasAlpha(),s.getWidth(),s.getHeight(),r):0;return s.close(),s.delete(),i}(e,r.mipmap):r.encoding===B.BASIS_ENCODING?function(e,r){if(t(S))return e.byteLength;const s=new S.BasisFile(new Uint8Array(e)),i=U(s)?L(s.getNumLevels(0),s.getHasAlpha(),s.getImageWidth(0,0),s.getImageHeight(0,0),r):0;return s.close(),s.delete(),i}(e,r.mipmap):e.byteLength;const{width:a,height:o}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?B.getDataDimensions(e):r;return(r.mipmap?4/3:1)*a*o*(r.components||4)||0}dispose(){this.data=void 0}get width(){return this.params.width}get height(){return this.params.height}createDescriptor(e){var t;return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?9987:9729,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:null!=(t=this.params.maxAnisotropy)?t:this.params.mipmap?e.parameters.maxMaxAnisotropy:1}}get glTexture(){return this._glTexture}load(e,a){if(r(this._glTexture))return this._glTexture;if(r(this._loadingPromise))return this._loadingPromise;const o=this.data;return t(o)?(this._glTexture=new F(e,this.createDescriptor(e),null),this._glTexture):"string"==typeof o?this.loadFromURL(e,a,o):o instanceof Image?this.loadFromImageElement(e,a,o):o instanceof HTMLVideoElement?this.loadFromVideoElement(e,a,o):o instanceof ImageData||o instanceof HTMLCanvasElement?this.loadFromImage(e,o,a):(s(o)||i(o))&&this.params.encoding===B.DDS_ENCODING?this.loadFromDDSData(e,o):(s(o)||i(o))&&this.params.encoding===B.KTX2_ENCODING?this.loadFromKTX2(e,o):(s(o)||i(o))&&this.params.encoding===B.BASIS_ENCODING?this.loadFromBasis(e,o):i(o)?this.loadFromPixelData(e,o):s(o)?this.loadFromPixelData(e,new Uint8Array(o)):null}get requiresFrameUpdates(){return this.data instanceof HTMLVideoElement}frameUpdate(e,s,i){if(!(this.data instanceof HTMLVideoElement)||t(this._glTexture))return i;if(this.data.readyState<2||i===this.data.currentTime)return i;if(r(this._powerOfTwoStretchInfo)){const{framebuffer:t,vao:r,sourceTexture:i}=this._powerOfTwoStretchInfo;i.setData(this.data),this.drawStretchedTexture(e,s,t,r,i,this._glTexture)}else{const{width:e,height:t}=this.data,{width:r,height:s}=this._glTexture.descriptor;e!==r||t!==s?this._glTexture.updateData(0,0,0,Math.min(e,r),Math.min(t,s),this.data):this._glTexture.setData(this.data)}return this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.data.currentTime}loadFromDDSData(e,t){return this._glTexture=k(e,this.createDescriptor(e),t),this._glTexture}loadFromKTX2(e,r){return this.loadAsync((()=>async function(e,r,s){t(S)&&(S=await O());const i=new S.KTX2File(new Uint8Array(s));if(!P(i))return null;i.startTranscoding();const a=N(e,r,i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),((e,t)=>i.getImageTranscodedSizeInBytes(e,0,0,t)),((e,t,r)=>i.transcodeImage(r,e,0,0,t,0,-1,-1)));return i.close(),i.delete(),a}(e,this.createDescriptor(e),r).then((e=>(this._glTexture=e,e)))))}loadFromBasis(e,r){return this.loadAsync((()=>async function(e,r,s){t(S)&&(S=await O());const i=new S.BasisFile(new Uint8Array(s));if(!U(i))return null;i.startTranscoding();const a=N(e,r,i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),((e,t)=>i.getImageTranscodedSizeInBytes(0,e,t)),((e,t,r)=>i.transcodeImage(r,0,e,t,0,0)));return i.close(),i.delete(),a}(e,this.createDescriptor(e),r).then((e=>(this._glTexture=e,e)))))}loadFromPixelData(e,t){b(this.params.width>0&&this.params.height>0);const r=this.createDescriptor(e);return r.pixelFormat=1===this.params.components?6409:3===this.params.components?6407:6408,r.width=this.params.width,r.height=this.params.height,this._glTexture=new F(e,r,t),this._glTexture}loadFromURL(e,t,r){return this.loadAsync((async s=>{const i=await T(r,{signal:s});return this.loadFromImage(e,i,t)}))}loadFromImageElement(e,t,r){return r.complete?this.loadFromImage(e,r,t):this.loadAsync((async s=>{const i=await w(r,r.src,!1,s);return this.loadFromImage(e,i,t)}))}loadFromVideoElement(e,t,r){return r.readyState>=2?this.loadFromImage(e,r,t):this.loadFromVideoElementAsync(e,t,r)}loadFromVideoElementAsync(e,t,r){return this.loadAsync((s=>new Promise(((i,o)=>{const n=()=>{r.removeEventListener("loadeddata",h),r.removeEventListener("error",l),a(m)},h=()=>{r.readyState>=2&&(n(),i(this.loadFromImage(e,r,t)))},l=e=>{n(),o(e||new u("Failed to load video"))};r.addEventListener("loadeddata",h),r.addEventListener("error",l);const m=p(s,(()=>l(g())))}))))}loadFromImage(e,t,r){const s=B.getDataDimensions(t);this.params.width=s.width,this.params.height=s.height;const i=this.createDescriptor(e);return i.pixelFormat=3===this.params.components?6407:6408,!this.requiresPowerOfTwo(e,i)||d(s.width)&&d(s.height)?(i.width=s.width,i.height=s.height,this._glTexture=new F(e,i,t),this._glTexture):(this._glTexture=this.makePowerOfTwoTexture(e,t,s,i,r),this._glTexture)}loadAsync(e){const t=new AbortController;this._loadingController=t;const r=e(t.signal);this._loadingPromise=r;const s=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null)};return r.then(s,s),r}requiresPowerOfTwo(e,t){const r=33071,s="number"==typeof t.wrapMode?t.wrapMode===r:t.wrapMode.s===r&&t.wrapMode.t===r;return!I(e.gl)&&(t.hasMipmap||!s)}makePowerOfTwoTexture(e,t,r,s,i){const{width:a,height:o}=r,n=c(a),h=c(o);let u;switch(s.width=n,s.height=h,this.params.powerOfTwoResizeMode){case 2:s.textureCoordinateScaleFactor=[a/n,o/h],u=new F(e,s),u.updateData(0,0,0,a,o,t);break;case 1:case null:case void 0:u=this.stretchToPowerOfTwo(e,t,s,i());break;default:l(this.params.powerOfTwoResizeMode)}return s.hasMipmap&&u.generateMipmap(),u}stretchToPowerOfTwo(e,t,r,s){const i=new F(e,r),a=new A(e,{colorTarget:0,depthStencilTarget:0},i),o=new F(e,{target:3553,pixelFormat:r.pixelFormat,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!!r.flipped,maxAnisotropy:8,preMultiplyAlpha:r.preMultiplyAlpha},t),n=h(e),l=e.getBoundFramebufferObject();return this.drawStretchedTexture(e,s,a,n,o,i),this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:n,sourceTexture:o,framebuffer:a}:(n.dispose(!0),o.dispose(),a.detachColorTexture(),a.dispose()),e.bindFramebuffer(l),i}drawStretchedTexture(e,t,r,s,i,a){e.bindFramebuffer(r);const o=e.getViewport();e.setViewport(0,0,a.descriptor.width,a.descriptor.height);const n=t.program;e.useProgram(n),n.setUniform4f("color",1,1,1,1),n.bindTexture(i,"tex"),e.bindVAO(s),t.bindPipelineState(e),e.drawArrays(5,0,y(s,"geometry")),e.bindFramebuffer(null),e.setViewport(o.x,o.y,o.width,o.height)}unload(){if(r(this._powerOfTwoStretchInfo)){const{framebuffer:e,vao:t,sourceTexture:r}=this._powerOfTwoStretchInfo;t.dispose(!0),r.dispose(),e.dispose(),this._glTexture=null,this._powerOfTwoStretchInfo=null}if(r(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),r(this._loadingController)){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}}B.DDS_ENCODING="image/vnd-ms.dds",B.KTX2_ENCODING="image/ktx2",B.BASIS_ENCODING="image/x.basis";export{E as G,B as T,O as l};
