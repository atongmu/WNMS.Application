/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import e from"../Color.js";import"../symbols.js";import{i as t}from"../core/lang.js";import s from"../core/Error.js";import{a as n,c as o}from"./number.js";import{r as i}from"./numberUtils.js";import{a}from"./PointSizeSplatAlgorithm.js";import{a as r}from"./scaleUtils.js";import l from"../renderers/visualVariables/SizeVariable.js";import{s as m}from"./spatialStatistics.js";import{c as u,f as c,g as f}from"./layerUtils2.js";import d from"../smartMapping/statistics/classBreaks.js";import p from"../smartMapping/statistics/summaryStatistics.js";import{d as y,e as w,f as h}from"./utils7.js";import b from"../symbols/edges/SketchEdges3D.js";import g from"../symbols/edges/SolidEdges3D.js";import{getBackgroundColorTheme as v}from"../views/support/colorUtils.js";import j from"../symbols/MeshSymbol3D.js";import D from"../symbols/FillSymbol3DLayer.js";import S from"../symbols/SimpleFillSymbol.js";import z from"../symbols/PolygonSymbol3D.js";import x from"../symbols/ExtrudeSymbol3DLayer.js";import V from"../symbols/SimpleLineSymbol.js";import U from"../symbols/LineSymbol3D.js";import k from"../symbols/LineSymbol3DLayer.js";import L from"../symbols/PathSymbol3DLayer.js";import T from"../symbols/SimpleMarkerSymbol.js";import I from"../symbols/PointSymbol3D.js";import F from"../symbols/IconSymbol3DLayer.js";import M from"../symbols/ObjectSymbol3DLayer.js";const B=[{size:10,width:0},{size:20,width:.5},{size:80,width:1},{size:250,width:2}];async function A(e){const{layerAdapter:n,...o}=await async function(e){const{view:n}=e;if(!(e&&n&&e.layer))throw new s("outline:missing-parameters","'view' and 'layer' parameters are required");const{layer:o,...i}=e,a=u(o,c),r={layerAdapter:a,...i};if(!a)throw new s("outline:invalid-parameters","'layer' must be one of these types: "+f(c).join(", "));await n.when();const l=t(r.signal)?{signal:r.signal}:null;if(await a.load(l),"polygon"!==a.geometryType)throw new s("outline:not-supported",`outline is not supported for geometryType: ${a.geometryType}`);return r}(e),i=await n.getSampleFeatures({sampleSize:-1,returnGeometry:!0,...o}),a=await m({features:i,geometryType:n.geometryType});if(!("avgSize"in a)||!a.avgSize)throw new s("outline:insufficient-info","average polygon size is invalid");return function(e,t){const s=e.avgSize,n=r(1,t.spatialReference),o=B.map((e=>({size:e.width,value:Math.round(s/e.size*n)})));return o.sort(((e,t)=>e.value-t.value)),{visualVariables:[new l({target:"outline",valueExpression:"$view.scale",stops:o})],opacity:.25}}(a,o.view)}const C=/^(\d+(\.\d+)?)\s*(%)$/i,E=[0,0,0,.4],P=["hours","minutes","seconds"],R=[].concat(y.light).concat(y.dark);function q(e,t,s){if("string"==typeof e){const t=s.getField(e);if(t&&"date"===t.type)return t.alias||t.name}else if("number"==typeof e||e instanceof Date){const s=P.indexOf(t)>-1?"short-date-short-time":"short-date";return n(e,o(s))}return e}function O(e,t){return new s(e,t)}function Y(e,t,s){return e+t>0&&0>e-t&&s<0?0:e}function $(e,t,s,n,o=!0){const i="90-10"===s&&t?{min:t.classBreakInfos[0].maxValue,max:t.classBreakInfos[t.classBreakInfos.length-1].minValue,avg:null,stddev:null}:e,{avg:a,stddev:r,min:l,max:m}=i,u=W(i,n,o);let c=u?u[0]:l,f=u?u[1]:m;return u?{minDataValue:c,maxDataValue:f,defaultValuesUsed:!0}:("above"===s?c=Y(a,r,l):"below"===s&&(f=Y(a,r,l)),{minDataValue:c,maxDataValue:f,defaultValuesUsed:!1})}function W(e,t,s){let n,o;const i=function(e){let t,s,n=e&&e.statistics;n||(n={});if(null==n.min)if(e.isDate){const e=G();t=e[0],s=e[1]}else t=0,s=100;else if(n.min===n.max)if(e.isDate){const e=G(n.min);t=e[0],s=e[1]}else n.min<0?(t=2*n.min,s=0):n.min>0?(t=0,s=2*n.min):(t=0,s=100);return{min:null!=t?t:n.min,max:null!=s?s:n.max,defaultValuesUsed:null!=t||null!=s}}({statistics:e,isDate:t});return i.defaultValuesUsed?(n=i.min,o=i.max):!s||null!=e.avg&&e.stddev||(n=e.min,o=e.max),null!=n?[n,o]:null}function G(e){const t=("number"==typeof e?new Date(e):new Date).getUTCFullYear();let s=Date.UTC(t,0,1,12,0,0,0),n=Date.UTC(t,11,31,12,0,0,0);return"number"==typeof e&&(e<s&&(s=e),e>n&&(n=e)),[s,n]}function N(t,s){const n=[],o=t.length;for(let i=0;i<s;i++)n.push(new e(t[i%o]));return n}function H(e,t,s,n=!0){const{minDataValue:o,maxDataValue:i,defaultValuesUsed:a}=e;return a||"above"===s||"below"===s||"90-10"===s?Q(o,i,5):X(t,n)}function J(e){const{avg:t,stddev:s,min:n,max:o}=e;if(null==t||null==s)return Q(n,o,5);const a=Y(t,s,n),r=o-a,l=a-n,m=Math.max(r,l);return i([a-m,a-m/2,a,m/2+a,a+m],{strictBounds:!0})}function K(e,t){const{min:s,max:n}=t,[o,a,r,l,m]=e,u=null!=s&&o<s,c=null!=n&&m>n;if(null==s||null==n||!u&&!c)return e;const f=u?s:o,d=c?n:m;return i([f,u?f+(r-f)/2:a,r,c?r+(d-r)/2:l,d],{strictBounds:!0})}function Q(e,t,s){const n=(t-e)/(s-1),o=[e];for(let t=1;t<=s-2;t++)o.push(e+t*n);return o.push(t),i(o,{strictBounds:!0})}function X(e,t=!0){let s=e.avg,n=s-e.stddev,o=s+e.stddev;n<e.min&&(n=e.min),o>e.max&&(o=e.max),t&&(s=n+(o-n)/2);let a=i([n,o],{strictBounds:!0});return n=a[0],o=a[1],a=[n,n+(s-n)/2,s,s+(o-s)/2,o],i(a,{strictBounds:!0})}function Z(e,t,s){switch(t){case"point":case"multipoint":return s?"noDataSize"in e?e.noDataSize:null:"size"in e?e.size:null;case"polyline":return s?"noDataWidth"in e?e.noDataWidth:null:"width"in e?e.width:null;case"polygon":return"size"in e?e.size:null;default:return}}function _(e,t,s){switch(t){case"point":case"multipoint":case"polygon":{if(!("outline"in e))return null;const t={color:e.outline.color,width:e.outline.width};if(null!=s&&t.color){const e=t.color.clone();e.a=s,t.color=e}return t}default:return}}function ee(e,t){const{type:s,size:n,color:o,outline:i}=t;let a;switch(e){case"point":case"multipoint":if("2d"===s)a=new T({color:o,size:n,outline:{color:i.color,width:i.width}});else if("3d-flat"===s)a=new I({symbolLayers:[new F({size:n,resource:{primitive:"circle"},material:{color:o},outline:{color:i.color,size:i.width}})]});else if(s.indexOf("3d-volumetric")>-1){const e="3d-volumetric-uniform"===s,i=new M({height:n,resource:{primitive:e?"sphere":"cylinder"},material:{color:o}});e||(i.width=t.widthAndDepth,i.depth=t.widthAndDepth),a=new I({symbolLayers:[i]})}break;case"polyline":"2d"===s?a=new V({color:o,width:n}):"3d-flat"===s?a=new U({symbolLayers:[new k({size:n,material:{color:o}})]}):"3d-volumetric"===s&&(a=new U({symbolLayers:[new L({width:"number"==typeof n?n:parseFloat(n),height:"number"==typeof n?n:parseFloat(n),material:{color:o}})]}));break;case"polygon":"2d"===s?a=new S({color:o,outline:{color:i.color,width:i.width}}):"3d-flat"===s?a=new z({symbolLayers:[new D({material:{color:o},outline:{color:i.color,size:i.width}})]}):"3d-volumetric"===s&&(a=new z({symbolLayers:[new x({size:n,material:{color:o}})]}));break;case"mesh":{const e=t.meshInfo&&t.meshInfo.colorMixMode,s=t.meshInfo&&t.meshInfo.edgesType;a=new j({symbolLayers:[new D({material:{color:o,colorMixMode:e||null},edges:"solid"===s?new g({color:E}):"sketch"===s?new b({color:E}):null})]});break}}return a}function te(e,t,s){const n=function(e){const t=e.layer;return e.fields.filter((e=>!t.getField(e)))}({layer:e,fields:t});if(n.length)return O(s,"Unknown fields: "+n.join(", ")+". You can only use fields defined in the layer schema");const o=function(e){const t=e.layer;return e.fields.filter((e=>{const s=t.getFieldUsageInfo(e);return!s||!s.supportsRenderer}))}({layer:e,fields:t});return o.length?O(s,"Unsupported fields: "+o.join(", ")+". You can only use fields that are accessible to the renderer i.e. FieldUsageInfo.supportsRenderer must be true"):void 0}async function se(e,t){const s={layer:e.layer,view:e.view,signal:e.signal},[n,o]=await Promise.all([d(e),t?A(s):null]),i=W({min:n.minValue,max:n.maxValue,avg:null,stddev:null},!1,!1);return{result:i?await d({...e,classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:i[0],maxValue:i[1],normalizationTotal:i[0]+i[1]}):n,defaultValuesUsed:!!i,outlineResult:o}}function ne(e){return p(e)}function oe(e,t){let{minSize:s,maxSize:n}=e;if("height"===t){s=((n-s)/2+s)/(2*2.3),n*=2}return{minSize:s,maxSize:n}}function ie(e){return C.test(e)}function ae(e){const t=e.match(C),s=Number(t[1]);if("%"===t[3])return new a({scaleFactor:s/100})}function re(e,t,s,n){e.startTime=t instanceof Date?t.getTime():t,e.endTime=s instanceof Date?s.getTime():s,e.units=n,e.field="string"==typeof t?t:"string"==typeof s?s:null}async function le(e,s){let n=null,o=null;if(!e&&!s)return{basemapId:n,basemapTheme:o};var i;!e&&s&&(e=s&&(null==(i=s.map)?void 0:i.basemap));if(e&&(n=w(e,R,!1),n)){const e=h(n);t(e)&&(o=e)}return n||"2d"!==(null==s?void 0:s.type)||(o=await v(s),t(o)&&(n="dark"===o?"dark-gray":"gray")),{basemapId:n,basemapTheme:o}}export{se as a,ae as b,O as c,N as d,W as e,q as f,ne as g,Q as h,ie as i,X as j,$ as k,H as l,ee as m,Z as n,A as o,_ as p,le as q,oe as r,J as s,K as t,re as u,te as v};
