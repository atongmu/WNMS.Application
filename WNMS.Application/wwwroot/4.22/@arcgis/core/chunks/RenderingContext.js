/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{b as e,e as t,l as i,f as n,c as r,k as s}from"./mathUtils.js";import{throwIfAborted as a}from"../core/promiseUtils.js";import{r as l}from"./requestImageUtils.js";import{b as o,i as u}from"../core/lang.js";import{R as c,T as h,i as _,a as d,B as f}from"./Texture.js";import{m as g,n as p,S as E}from"./OrderIndependentTransparency.js";import{u as b}from"./floatRGBA.js";import{B as m,V as T,P as v}from"./Program.js";import{e as S}from"./doublePrecisionUtils.js";import{F as x}from"./FramebufferObject.js";import{L as F}from"./Logger.js";class A{constructor(e){this.gain=e}update(e){if(this.hasLastValue){const t=this.computeDelta(e);this.updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}get hasLastValue(){return void 0!==this.lastValue}get hasFilteredDelta(){return void 0!==this.filteredDelta}computeDelta(e){return e-this.lastValue}updateDelta(e){this.hasFilteredDelta?this.filteredDelta=(1-this.gain)*this.filteredDelta+this.gain*e:this.filteredDelta=e}}class R{constructor(e,t,i){this._initialVelocity=e,this._stopVelocity=t,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const i=this.value(e);return this.value(e+t)-i}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const i=1-this.friction;return e*(i**t-1)/Math.log(i)}}class O extends R{constructor(e,t,i,n,r){super(e,t,i),this.sceneVelocity=n,this.direction=r}value(e){return super.valueFromInitialVelocity(this.sceneVelocity,e)}}class B{constructor(t=300,i=12,n=.84){this.minimumInitialVelocity=t,this.stopVelocity=i,this.friction=n,this.enabled=!0,this.time=new A(.6),this.screen=[new A(.4),new A(.4)],this.scene=[new A(.6),new A(.6),new A(.6)],this.tmpDirection=e()}add(e,t,i){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.015)return}this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.scene[0].update(t[0]),this.scene[1].update(t[1]),this.scene[2].update(t[2]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.scene[0].reset(),this.scene[1].reset(),this.scene[2].reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const e=this.screen[0].filteredDelta,t=this.screen[1].filteredDelta,i=Math.sqrt(e*e+t*t)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(e,r,s){t(this.tmpDirection,this.scene[0].filteredDelta,this.scene[1].filteredDelta,this.scene[2].filteredDelta);const a=i(this.tmpDirection);a>0&&n(this.tmpDirection,this.tmpDirection,1/a);const l=a/this.time.filteredDelta;return new O(e,r,s,l,this.tmpDirection)}}class C{constructor(e=2.5,t=.01,i=.95,n=12){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.maxVelocity=n,this.enabled=!0,this.value=new A(.8),this.time=new A(.3)}add(e,t){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta){const t=this.value.computeDelta(e);this.value.filteredDelta*t<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta)return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=r(e,-this.maxVelocity,this.maxVelocity),Math.abs(e)<this.minimumInitialVelocity?null:this.createMomentum(e,this.stopVelocity,this.friction)}createMomentum(e,t,i){return new R(e,t,i)}}class w extends C{constructor(e=3,t=.01,i=.95,n=12){super(e,t,i,n)}add(e,t){if(this.value.hasLastValue){const t=this.value.lastValue;let i=e-t;for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;e=t+i}super.add(e,t)}}class y extends R{constructor(e,t,i){super(e,t,i)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const i=super.value(e),n=super.value(e+t)-i;return Math.exp(n)}}class M extends C{constructor(e=2.5,t=.01,i=.95,n=12){super(e,t,i,n)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,i){return new y(e,t,i)}}async function P(e){const t=import("./mask-svg.js"),i=import("./overlay-svg.js"),n=l((await t).default,{signal:e}),r=l((await i).default,{signal:e}),s={mask:await n,overlay:await r};return a(e),s}class D{constructor(e){this._allocations=new Map,e?Error.stackTraceLimit=1/0:(this.add=()=>{},this.remove=()=>{})}add(e){this._allocations.set(e,(new Error).stack)}remove(e){this._allocations.delete(e)}print(){if(this._allocations.size>0){console.log(`${this._allocations.size} live object allocations:`);const e=new Map;this._allocations.forEach((t=>{var i;e.set(t,(null!=(i=e.get(t))?i:0)+1)})),e.forEach(((e,t)=>{const i=t.split("\n");i.shift(),i.shift(),console.log(`${e}: ${i.shift()}`),i.forEach((e=>console.log("   ",e)))}))}}}class L{constructor(){for(this._current=new Array,this._max=new Array,this._allocations=new D(false);this._current.length<c.COUNT;)this._current.push(0),this._max.push(0)}resetMax(){for(this._max.length=0;this._max.length<this._current.length;)this._max.push(0)}increment(e,t){const i=++this._current[e];this._max[e]=Math.max(i,this._max[e]),this._allocations.add(t)}decrement(e,t){--this._current[e],this._allocations.remove(t)}get max(){return this._max}get current(){return this._current}get total(){return this.current.reduce(((e,t)=>e+t),0)}printResourceCount(){if(this.total>0){console.log("Live objects:");for(let e=0;e<c.COUNT;++e){const t=this._current[e];t>0&&console.log(`${c[e]}: ${t}`)}}this._allocations.print()}}function I(e,t){const i=new x(e,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1});const n=m.createVertex(e,35044,new Uint16Array([0,0,1,0,0,1,1,1])),r=new T(e,new Map([["position",0]]),{geometry:[{name:"position",count:2,type:5123,offset:0,stride:4,normalized:!1}]},{geometry:n}),a=s(5633261.287538229,2626832.878767164,1434988.0495278358),l=s(5633271.46742708,2626873.6381334523,1434963.231608387),o=function(i,n){const r=new v(e,`\n\n  precision highp float;\n\n  attribute vec2 position;\n\n  uniform vec3 u_highA;\n  uniform vec3 u_lowA;\n  uniform vec3 u_highB;\n  uniform vec3 u_lowB;\n\n  varying vec4 v_color;\n\n  ${t?"#define DOUBLE_PRECISION_REQUIRES_OBFUSCATION":""}\n\n  #ifdef DOUBLE_PRECISION_REQUIRES_OBFUSCATION\n\n  vec3 dpPlusFrc(vec3 a, vec3 b) {\n    return mix(a, a + b, vec3(notEqual(b, vec3(0))));\n  }\n\n  vec3 dpMinusFrc(vec3 a, vec3 b) {\n    return mix(vec3(0), a - b, vec3(notEqual(a, b)));\n  }\n\n  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {\n    vec3 t1 = dpPlusFrc(hiA, hiB);\n    vec3 e = dpMinusFrc(t1, hiA);\n    vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;\n    return t1 + t2;\n  }\n\n  #else\n\n  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {\n    vec3 t1 = hiA + hiB;\n    vec3 e = t1 - hiA;\n    vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;\n    return t1 + t2;\n  }\n\n  #endif\n\n  const float MAX_RGBA_FLOAT =\n    255.0 / 256.0 +\n    255.0 / 256.0 / 256.0 +\n    255.0 / 256.0 / 256.0 / 256.0 +\n    255.0 / 256.0 / 256.0 / 256.0 / 256.0;\n\n  const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);\n\n  vec4 float2rgba(const float value) {\n    // Make sure value is in the domain we can represent\n    float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);\n\n    // Decompose value in 32bit fixed point parts represented as\n    // uint8 rgba components. Decomposition uses the fractional part after multiplying\n    // by a power of 256 (this removes the bits that are represented in the previous\n    // component) and then converts the fractional part to 8bits.\n    vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);\n\n    // Convert uint8 values (from 0 to 255) to floating point representation for\n    // the shader\n    const float toU8AsFloat = 1.0 / 255.0;\n\n    return fixedPointU8 * toU8AsFloat;\n  }\n\n  void main() {\n    vec3 val = dpAdd(u_highA, u_lowA, -u_highB, -u_lowB);\n\n    v_color = float2rgba(val.z / 25.0);\n\n    gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);\n  }\n  `,"\n  precision highp float;\n\n  varying vec4 v_color;\n\n  void main() {\n    gl_FragColor = v_color;\n  }\n  ",new Map([["position",0]])),s=new Float32Array(6);S(i,s,3);const a=new Float32Array(6);return S(n,a,3),e.useProgram(r),r.setUniform3f("u_highA",s[0],s[2],s[4]),r.setUniform3f("u_lowA",s[1],s[3],s[5]),r.setUniform3f("u_highB",a[0],a[2],a[4]),r.setUniform3f("u_lowB",a[1],a[3],a[5]),r}(a,l),u=e.getBoundFramebufferObject(),{x:c,y:h,width:_,height:d}=e.getViewport();e.bindFramebuffer(i),e.setViewport(0,0,1,1),e.bindVAO(r),e.drawArrays(5,0,4);const f=new Uint8Array(4);i.readPixels(0,0,1,1,6408,5121,f),o.dispose(),r.dispose(!1),n.dispose(),i.dispose(),e.setViewport(c,h,_,d),e.bindFramebuffer(u);const g=(a[2]-l[2])/25,p=b(f);return Math.abs(g-p)}var U,G,V={exports:{}};U=V,G=function(){var e=function(e){window.console&&window.console.log&&window.console.log(e)},t=function(t){window.console&&window.console.error?window.console.error(t):e(t)},i={enable:{1:{0:!0}},disable:{1:{0:!0}},getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},texImage2D:{9:{0:!0,2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0}},bindBuffer:{2:{0:!0}},bufferData:{3:{0:!0,2:!0}},bufferSubData:{3:{0:!0}},getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},readPixels:{7:{4:!0,5:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}}},n=null,r=null;function s(e){if(null==n)for(var t in n={},r={},e)"number"==typeof e[t]&&(n[e[t]]=t,r[t]=e[t])}function a(){if(null==n)throw"WebGLDebugUtils.init(ctx) not called"}function l(e){return a(),void 0!==n[e]}function o(e){a();var t=n[e];return void 0!==t?"gl."+t:"/*UNKNOWN WebGL ENUM*/ 0x"+e.toString(16)}function u(e,t,n,s){var a;if(void 0!==(a=i[e])&&void 0!==(a=a[t])&&a[n]){if("object"==typeof a[n]&&void 0!==a[n].enumBitwiseOr){for(var l=a[n].enumBitwiseOr,u=0,c=[],h=0;h<l.length;++h){var _=r[l[h]];0!=(s&_)&&(u|=_,c.push(o(_)))}return u===s?c.join(" | "):o(s)}return o(s)}return null===s?"null":void 0===s?"undefined":s.toString()}function c(e,t){for(var i="",n=t.length,r=0;r<n;++r)i+=(0==r?"":", ")+u(e,n,r,t[r]);return i}function h(e,t,i){e.__defineGetter__(i,(function(){return t[i]})),e.__defineSetter__(i,(function(e){t[i]=e}))}function _(e,i,n,r){r=r||e,s(e),i=i||function(e,i,n){for(var r="",s=n.length,a=0;a<s;++a)r+=(0==a?"":", ")+u(i,s,a,n[a]);t("WebGL error "+o(e)+" in "+i+"("+r+")")};var a={};function l(e,t){return function(){n&&n(t,arguments);var s=e[t].apply(e,arguments),l=r.getError();return 0!=l&&(a[l]=!0,i(l,t,arguments)),s}}var c={};for(var d in e)if("function"==typeof e[d])if("getExtension"!=d)c[d]=l(e,d);else{var f=l(e,d);c[d]=function(){return _(f.apply(e,arguments),i,n,r)}}else h(c,e,d);return c.getError=function(){for(var t in a)if(a.hasOwnProperty(t)&&a[t])return a[t]=!1,t;return e.NO_ERROR},c}function d(e){var t=e.getParameter(e.MAX_VERTEX_ATTRIBS),i=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,i);for(var n=0;n<t;++n)e.disableVertexAttribArray(n),e.vertexAttribPointer(n,4,e.FLOAT,!1,0,0),e.vertexAttrib1f(n,0);e.deleteBuffer(i);var r=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);for(n=0;n<r;++n)e.activeTexture(e.TEXTURE0+n),e.bindTexture(e.TEXTURE_CUBE_MAP,null),e.bindTexture(e.TEXTURE_2D,null);for(e.activeTexture(e.TEXTURE0),e.useProgram(null),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.DITHER),e.disable(e.SCISSOR_TEST),e.blendColor(0,0,0,0),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.clearColor(0,0,0,0),e.clearDepth(1),e.clearStencil(-1),e.colorMask(!0,!0,!0,!0),e.cullFace(e.BACK),e.depthFunc(e.LESS),e.depthMask(!0),e.depthRange(0,1),e.frontFace(e.CCW),e.hint(e.GENERATE_MIPMAP_HINT,e.DONT_CARE),e.lineWidth(1),e.pixelStorei(e.PACK_ALIGNMENT,4),e.pixelStorei(e.UNPACK_ALIGNMENT,4),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.UNPACK_COLORSPACE_CONVERSION_WEBGL&&e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.BROWSER_DEFAULT_WEBGL),e.polygonOffset(0,0),e.sampleCoverage(1,!1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.stencilFunc(e.ALWAYS,0,4294967295),e.stencilMask(4294967295),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.viewport(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT);e.getError(););}function f(e){var t,i,n=[],r=[],s={},a=1,l=!1,o=[],u=0,c=0,_=!1,f=0,g={};function p(e){return"function"==typeof e?e:function(t){e.handleEvent(t)}}e.getContext=(i=e.getContext,function(){var n=i.apply(e,arguments);if(n instanceof WebGLRenderingContext){if(n!=t){if(t)throw"got different context";s=A(t=n)}return s}return n});var E=function(e){n.push(p(e))},b=function(e){r.push(p(e))};function m(e){var t=e.addEventListener;e.addEventListener=function(i,n,r){switch(i){case"webglcontextlost":E(n);break;case"webglcontextrestored":b(n);break;default:t.apply(e,arguments)}}}function T(){for(var e=Object.keys(g),t=0;t<e.length;++t)delete g[e]}function v(){++c,l||u==c&&e.loseContext()}function S(e,t){var i=e[t];return function(){if(v(),!l)return i.apply(e,arguments)}}function x(){for(var e=0;e<o.length;++e){var i=o[e];i instanceof WebGLBuffer?t.deleteBuffer(i):i instanceof WebGLFramebuffer?t.deleteFramebuffer(i):i instanceof WebGLProgram?t.deleteProgram(i):i instanceof WebGLRenderbuffer?t.deleteRenderbuffer(i):i instanceof WebGLShader?t.deleteShader(i):i instanceof WebGLTexture&&t.deleteTexture(i)}}function F(e){return{statusMessage:e,preventDefault:function(){_=!0}}}return m(e),e.loseContext=function(){if(!l){for(l=!0,u=0,++a;t.getError(););T(),g[t.CONTEXT_LOST_WEBGL]=!0;var i=F("context lost"),r=n.slice();setTimeout((function(){for(var t=0;t<r.length;++t)r[t](i);f>=0&&setTimeout((function(){e.restoreContext()}),f)}),0)}},e.restoreContext=function(){l&&r.length&&setTimeout((function(){if(!_)throw"can not restore. webglcontestlost listener did not call event.preventDefault";x(),d(t),l=!1,c=0,_=!1;for(var e=r.slice(),i=F("context restored"),n=0;n<e.length;++n)e[n](i)}),0)},e.loseContextInNCalls=function(e){if(l)throw"You can not ask a lost contet to be lost";u=c+e},e.getNumCalls=function(){return c},e.setRestoreTimeout=function(e){f=e},e;function A(e){for(var i in e)"function"==typeof e[i]?s[i]=S(e,i):h(s,e,i);s.getError=function(){if(v(),!l)for(;e=t.getError();)g[e]=!0;for(var e in g)if(g[e])return delete g[e],e;return s.NO_ERROR};for(var n=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],r=0;r<n.length;++r){var u=n[r];s[u]=function(t){return function(){if(v(),l)return null;var i=t.apply(e,arguments);return i.__webglDebugContextLostId__=a,o.push(i),i}}(e[u])}var c=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(r=0;r<c.length;++r)u=c[r],s[u]=function(t){return function(){return v(),l?null:t.apply(e,arguments)}}(s[u]);var _=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(r=0;r<_.length;++r)u=_[r],s[u]=function(t){return function(){return v(),!l&&t.apply(e,arguments)}}(s[u]);return s.checkFramebufferStatus=function(t){return function(){return v(),l?s.FRAMEBUFFER_UNSUPPORTED:t.apply(e,arguments)}}(s.checkFramebufferStatus),s.getAttribLocation=function(t){return function(){return v(),l?-1:t.apply(e,arguments)}}(s.getAttribLocation),s.getVertexAttribOffset=function(t){return function(){return v(),l?0:t.apply(e,arguments)}}(s.getVertexAttribOffset),s.isContextLost=function(){return l},s}}return{init:s,mightBeEnum:l,glEnumToString:o,glFunctionArgToString:u,glFunctionArgsToString:c,makeDebugContext:_,makeLostContextSimulatingCanvas:f,resetToInitialState:d}}(),void 0!==G&&(U.exports=G);const N=F.getLogger("esri.views.WebGLDriverTest");class X{constructor(e){this.context=e,this._floatBufferBlendWorking=function(e){var t,i,n,r,s;if(!e.gl)return!1;if("webgl"===e.webglVersion)return(null==(r=e.capabilities.textureFloat)?void 0:r.textureFloat)&&(null==(s=e.capabilities.colorBufferFloat)?void 0:s.textureFloat);if(!((null==(t=e.capabilities.textureFloat)?void 0:t.textureFloat)&&(null==(i=e.capabilities.colorBufferFloat)?void 0:i.textureFloat)&&(null==(n=e.capabilities.colorBufferFloat)?void 0:n.floatBlend)))return!1;const a=new x(e,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5126,internalFormat:34836,samplingMode:9728,width:1,height:1}),l=m.createVertex(e,35044,new Uint16Array([0,0,1,0,0,1,1,1])),o=new T(e,new Map([["a_pos",0]]),{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1}]},{geometry:l}),u=new v(e,"\n  precision highp float;\n  attribute vec2 a_pos;\n\n  void main() {\n    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n  }\n  ","\n   precision highp float;\n\n   void main() {\n    gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);\n   }\n  ",new Map([["a_pos",0]]));e.useProgram(u);const c=e.getBoundFramebufferObject(),{x:h,y:_,width:d,height:f}=e.getViewport();e.bindFramebuffer(a),e.setViewport(0,0,1,1),e.bindVAO(o),e.drawArrays(5,0,4);const E=g({blending:p});e.setPipelineState(E),e.drawArrays(5,0,4),V.exports.init(e);const b=e.gl.getError();return e.setViewport(h,_,d,f),e.bindFramebuffer(c),u.dispose(),o.dispose(!1),l.dispose(),a.dispose(),1282!==b||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}(e),async function(e){const t=new Image;if(t.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",t.width=5,t.height=5,await t.decode(),!e.gl)return!0;const i=new x(e,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1}),n=m.createVertex(e,35044,new Uint16Array([0,0,1,0,0,1,1,1])),r=new T(e,new Map([["a_pos",0]]),{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1}]},{geometry:n}),s=new v(e,"\n  precision highp float;\n\n  attribute vec2 a_pos;\n  varying vec2 v_uv;\n\n  void main() {\n    v_uv = a_pos;\n    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n  }\n  ","\n  precision highp float;\n\n  varying vec2 v_uv;\n  uniform sampler2D u_texture;\n\n  void main() {\n    gl_FragColor = texture2D(u_texture, v_uv);\n  }\n  ",new Map([["a_pos",0]]));e.useProgram(s);const a=new h(e,{dataType:5121,pixelFormat:6408,preMultiplyAlpha:!1,wrapMode:33071,samplingMode:9729},t);e.bindTexture(a,0),s.setUniform1i("u_texture",0);const l=e.getBoundFramebufferObject(),{x:o,y:u,width:c,height:_}=e.getViewport();e.bindFramebuffer(i),e.setViewport(0,0,1,1),e.setClearColor(0,0,0,0),e.setBlendingEnabled(!1),e.clearSafe(16384),e.bindVAO(r),e.drawArrays(5,0,4);const d=new Uint8Array(4);return i.readPixels(0,0,1,1,6408,5121,d),s.dispose(),r.dispose(!1),n.dispose(),i.dispose(),a.dispose(),e.setViewport(o,u,c,_),e.bindFramebuffer(l),t.src="",255===d[0]}(e).then((e=>this._svgAlwaysPremultipliesAlpha=!e))}get floatBufferBlendWorking(){if(o(this._floatBufferBlendWorking))throw new Error("floatBufferBlendWorking test not yet available");return this._floatBufferBlendWorking}get svgAlwaysPremultipliesAlpha(){if(o(this._svgAlwaysPremultipliesAlpha))throw new Error("svgAlwaysPremultipliesAlpha test not yet available");return this._svgAlwaysPremultipliesAlpha}get doublePrecisionRequiresObfuscation(){if(o(this._doublePrecisionRequiresObfuscation)){const e=I(this.context,!1),t=I(this.context,!0);this._doublePrecisionRequiresObfuscation=0!==e&&(0===t||e/t>5)}return this._doublePrecisionRequiresObfuscation}get ignoresSamplerPrecision(){return o(this._ignoresSamplerPrecision)&&(this._ignoresSamplerPrecision=(e=>{const t=new x(e,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1}),i=new Uint8Array(4),n=m.createVertex(e,35044,new Uint16Array([0,0,1,0,0,1,1,1])),r=new T(e,new Map([["a_position",0]]),{geometry:[{name:"a_position",count:2,type:5122,offset:0,stride:4,normalized:!1}]},{geometry:n}),s=new v(e,"\nprecision highp float;\nattribute vec2 a_pos;\nuniform highp sampler2D u_texture;\nvarying vec4 v_color;\n\nfloat getBit(in float bitset, in int bitIndex) {\n  float offset = pow(2.0, float(bitIndex));\n  return mod(floor(bitset / offset), 2.0);\n}\n\nvoid main() {\n  vec4 value = texture2D(u_texture, vec2(0.0));\n  float bit = getBit(value.x * 255.0, 1);\n\n  v_color = bit * vec4(1.0);\n  gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n}\n","\nprecision highp float;\nvarying vec4 v_color;\n\nvoid main() {\n  gl_FragColor = v_color;\n}\n",new Map([["a_pos",0]])),a=new h(e,{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([2,255,0,0]));s.setUniform1i("u_texture",0),e.bindTexture(a,0);const l=e.getBoundFramebufferObject();e.bindFramebuffer(t),e.useProgram(s);const{x:o,y:u,width:c,height:_}=e.getViewport();e.setViewport(0,0,1,1),e.bindVAO(r),e.drawArrays(5,0,4),e.setViewport(o,u,c,_),t.readPixels(0,0,1,1,6408,5121,i),s.dispose(),r.dispose(!1),n.dispose(),t.dispose();const d=255!==i[0]||255!==i[1]||255!==i[2]||255!==i[3];return d&&N.warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${i[0]}.${i[1]}.${i[2]}.${i[3]}]`),e.bindFramebuffer(l),d})(this.context)),this._ignoresSamplerPrecision}}class k{constructor(e,t,i,n,r,s,a,l){this.createQuery=e,this.resultAvailable=t,this.getResult=i,this.disjoint=n,this.beginTimeElapsed=r,this.endTimeElapsed=s,this.createTimestamp=a,this.timestampBits=l}}function W(e,t){if(t.disjointTimerQuery)return null;let i=e.getExtension("EXT_disjoint_timer_query_webgl2");return i&&_(e)?new k((()=>e.createQuery()),(t=>e.getQueryParameter(t,e.QUERY_RESULT_AVAILABLE)),(t=>e.getQueryParameter(t,e.QUERY_RESULT)),(()=>e.getParameter(i.GPU_DISJOINT_EXT)),(t=>e.beginQuery(i.TIME_ELAPSED_EXT,t)),(()=>e.endQuery(i.TIME_ELAPSED_EXT)),(e=>i.queryCounterEXT(e,i.TIMESTAMP_EXT)),(()=>e.getQuery(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT))):(i=e.getExtension("EXT_disjoint_timer_query"),i?new k((()=>i.createQueryEXT()),(e=>i.getQueryObjectEXT(e,i.QUERY_RESULT_AVAILABLE_EXT)),(e=>i.getQueryObjectEXT(e,i.QUERY_RESULT_EXT)),(()=>e.getParameter(i.GPU_DISJOINT_EXT)),(e=>i.beginQueryEXT(i.TIME_ELAPSED_EXT,e)),(()=>i.endQueryEXT(i.TIME_ELAPSED_EXT)),(e=>i.queryCounterEXT(e,i.TIMESTAMP_EXT)),(()=>i.getQueryEXT(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT))):null)}function j(e,t){const i=t.disabledExtensions||{},n=t.debugWebGLExtensions||{};let r,s,a,l,o,u,c,h,d,f,g,p,E=null,b=null,m=null,T=null;return{get drawBuffers(){return g||(g=function(e,t){if(t.disjointTimerQuery)return null;if(_(e))return{drawBuffers:e.drawBuffers.bind(e),MAX_DRAW_BUFFERS:e.MAX_DRAW_BUFFERS,MAX_COLOR_ATTACHMENTS:e.MAX_COLOR_ATTACHMENTS};if(t.drawBuffers)return null;const i=e.getExtension("WEBGL_draw_buffers");return i?{drawBuffers:i.drawBuffersWEBGL.bind(i),MAX_DRAW_BUFFERS:i.MAX_DRAW_BUFFERS_WEBGL,MAX_COLOR_ATTACHMENTS:i.MAX_COLOR_ATTACHMENTS_WEBGL}:null}(e,i)),g},get instancing(){return r||(r=function(e){if(_(e))return{drawArraysInstanced:e.drawArraysInstanced.bind(e),drawElementsInstanced:e.drawElementsInstanced.bind(e),vertexAttribDivisor:e.vertexAttribDivisor.bind(e)};const t=e.getExtension("ANGLE_instanced_arrays");return t?{drawArraysInstanced:t.drawArraysInstancedANGLE.bind(t),drawElementsInstanced:t.drawElementsInstancedANGLE.bind(t),vertexAttribDivisor:t.vertexAttribDivisorANGLE.bind(t)}:null}(e)),r},get vao(){return s||(s=function(e,t){if(_(e))return{createVertexArray:e.createVertexArray.bind(e),deleteVertexArray:e.deleteVertexArray.bind(e),bindVertexArray:e.bindVertexArray.bind(e)};if(t.vao)return null;const i=e.getExtension("OES_vertex_array_object")||e.getExtension("MOZ_OES_vertex_array_object")||e.getExtension("WEBKIT_OES_vertex_array_object");return i?{createVertexArray:i.createVertexArrayOES.bind(i),deleteVertexArray:i.deleteVertexArrayOES.bind(i),bindVertexArray:i.bindVertexArrayOES.bind(i)}:null}(e,i)),s},get compressedTextureETC(){return a||(a=function(e,t){if(t.compressedTextureETC)return null;const i=e.getExtension("WEBGL_compressed_texture_etc");if(!i)return null;return{COMPRESSED_R11_EAC:i.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:i.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:i.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:i.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:i.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:i.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}}(e,i)),a},get compressedTextureS3TC(){return l||(l=function(e,t){if(t.compressedTextureS3TC)return null;const i=e.getExtension("WEBGL_compressed_texture_s3tc");if(!i)return null;return{COMPRESSED_RGB_S3TC_DXT1:i.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:i.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:i.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:i.COMPRESSED_RGBA_S3TC_DXT5_EXT}}(e,i)),l},get textureFilterAnisotropic(){return o||(o=function(e,t){if(t.textureFilterAnisotropic)return null;const i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");if(!i)return null;return{MAX_TEXTURE_MAX_ANISOTROPY:i.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:i.TEXTURE_MAX_ANISOTROPY_EXT}}(e,i)),o},get disjointTimerQuery(){return u||(u=W(e,i)),u},get textureFloat(){return c||(c=function(e,t){if(_(e))return{textureFloat:!0,textureFloatLinear:!t.textureFloatLinear&&!!e.getExtension("OES_texture_float_linear"),textureHalfFloat:!0,textureHalfFloatLinear:!t.textureHalfFloatLinear&&!!e.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:e.HALF_FLOAT};if(e instanceof WebGLRenderingContext){const i=!t.textureHalfFloat&&e.getExtension("OES_texture_half_float");return{textureFloat:!t.textureFloat&&!!e.getExtension("OES_texture_float"),textureFloatLinear:!t.textureFloatLinear&&!!e.getExtension("OES_texture_float_linear"),textureHalfFloat:!!i,textureHalfFloatLinear:!t.textureHalfFloatLinear&&!!e.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:i?i.HALF_FLOAT_OES:void 0}}return null}(e,i)),c},get colorBufferFloat(){return h||(h=function(e,t){if(_(e)){const i=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_half_float"),n=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),r=!t.colorBufferFloat&&e.getExtension("EXT_float_blend");return i||n||r?{textureFloat:!!n,textureHalfFloat:!!i,floatBlend:!!r,R16F:e.R16F,RG16F:e.RG16F,RGBA16F:e.RGBA16F,R32F:e.R32F,RG32F:e.RG32F,RGBA32F:e.RGBA32F,R11F_G11F_B10F:e.R11F_G11F_B10F,RGB16F:e.RGB16F}:null}if(e instanceof WebGLRenderingContext){const i=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_half_float"),n=!t.colorBufferFloat&&e.getExtension("WEBGL_color_buffer_float"),r=!t.colorBufferFloat&&e.getExtension("EXT_float_blend");return i||n||r?{textureFloat:!!n,textureHalfFloat:!!i,floatBlend:!!r,RGBA16F:i?i.RGBA16F_EXT:void 0,RGB16F:i?i.RGB16F_EXT:void 0,RGBA32F:n?n.RGBA32F_EXT:void 0}:null}return null}(e,i)),h},get blendMinMax(){return d||(d=function(e,t){if(_(e))return{MIN:e.MIN,MAX:e.MAX};if(t.blendMinMax)return null;{const t=e.getExtension("EXT_blend_minmax");return t?{MIN:t.MIN_EXT,MAX:t.MAX_EXT}:null}}(e,i)),d},get depthTexture(){return null===E&&(E=H(e,i,"depthTexture",!0,["WEBGL_depth_texture","MOZ_WEBGL_depth_texture","WEBKIT_WEBGL_depth_texture"])),E},get standardDerivatives(){return null===b&&(b=H(e,i,"standardDerivatives",!0,["OES_standard_derivatives"])),b},get shaderTextureLOD(){return null===m&&(m=H(e,i,"shaderTextureLOD",!0,["EXT_shader_texture_lod"])),m},get fragDepth(){return null===T&&(T=H(e,i,"fragDepth",!0,["EXT_frag_depth"])),T},get loseContext(){return f||(f=function(e,t){const i=t.loseContext&&e.getExtension("WEBGL_lose_context");return i?{loseRenderingContext:()=>i.loseContext()}:null}(e,n)),f},get textureNorm16(){return p||(p=function(e,t){if(!_(e))return null;if(t.textureNorm16)return null;const i=e.getExtension("EXT_texture_norm16");if(!i)return null;return{R16:i.R16,RG16:i.RG16,RGB16:i.RGB16,RGBA16:i.RGBA16,R16_SNORM:i.R16_SNORM,RG16_SNORM:i.RG16_SNORM,RGB16_SNORM:i.RGB16_SNORM,RGBA16_SNORM:i.RGBA16_SNORM}}(e,i)),p},enable(e){return this[e]}}}function H(e,t,i,n,r){if(n&&_(e))return!0;if(t[i])return!1;for(const t of r)if(e.getExtension(t))return!0;return!1}class q{constructor(e,t){this.gl=e,this.instanceCounter=new L,this._blendEnabled=!1,this._blendColorState={r:0,g:0,b:0,a:0},this._blendFunctionState={srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0},this._blendEquationState={mode:32774,modeAlpha:32774},this._colorMaskState={r:!0,g:!0,b:!0,a:!0},this._polygonCullingEnabled=!1,this._cullFace=1029,this._frontFace=2305,this._scissorTestEnabled=!1,this._scissorRect={x:0,y:0,width:0,height:0},this._depthTestEnabled=!1,this._depthFunction=513,this._clearDepth=1,this._depthWriteEnabled=!0,this._depthRange={zNear:0,zFar:1},this._viewport=null,this._stencilTestEnabled=!1,this._polygonOffsetFillEnabled=!1,this._polygonOffset=[0,0],this._stencilFunction={face:1032,func:519,ref:0,mask:1},this._clearStencil=0,this._stencilWriteMask=1,this._stencilOperation={face:1032,fail:7680,zFail:7680,zPass:7680},this._clearColor={r:0,g:0,b:0,a:0},this._activeShaderProgram=null,this._activeVertexBuffer=null,this._activeIndexBuffer=null,this._activeFramebuffer=null,this._activeRenderbuffer=null,this._activeTextureUnit=0,this._textureUnitMap=new Array,this._numOfDrawCalls=0,this._numOfTriangles=0,this.webglVersion=_(e)?"webgl2":"webgl","webgl"===this.webglVersion&&this.gl.getExtension("OES_element_index_uint"),this._capabilities=j(e,t),this._parameters=this._loadParameters(t);const i=this.gl.getParameter(this.gl.VIEWPORT);this._viewport={x:i[0],y:i[1],width:i[2],height:i[3]},this._stateTracker=new E({setBlending:e=>{if(e){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(e.opRgb,e.opAlpha),this.setBlendFunctionSeparate(e.srcRgb,e.dstRgb,e.srcAlpha,e.dstAlpha);const t=e.color;this.setBlendColor(t.r,t.g,t.b,t.a)}else this.setBlendingEnabled(!1)},setCulling:e=>{e?(this.setFaceCullingEnabled(!0),this.setCullFace(e.face),this.setFrontFace(e.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:e=>{e?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(e.factor,e.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:e=>{e?(this.setDepthTestEnabled(!0),this.setDepthFunction(e.func)):this.setDepthTestEnabled(!1)},setStencilTest:e=>{if(e){this.setStencilTestEnabled(!0);const t=e.function;this.setStencilFunction(t.func,t.ref,t.mask);const i=e.operation;this.setStencilOp(i.fail,i.zFail,i.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:e=>{e?(this.setDepthWriteEnabled(!0),this.setDepthRange(e.zNear,e.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:e=>{e?this.setColorMask(e.r,e.g,e.b,e.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:e=>{e?this.setStencilWriteMask(e.mask):this.setStencilWriteMask(0)}}),this.enforceState(),this.driverTest=new X(this)}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}dispose(){this.bindVAO(null),this.unbindBuffer(34962),this.unbindBuffer(34963),this._textureUnitMap.length=0,d()&&this.instanceCounter.printResourceCount()}setPipelineState(e){this._stateTracker.setPipeline(e)}setBlendingEnabled(e){this._blendEnabled!==e&&(!0===e?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._blendEnabled=e,this._stateTracker.invalidateBlending())}externalProgramUpdate(){var e;null==(e=this._activeShaderProgram)||e.stop(),this._activeShaderProgram=null}externalTextureUnitUpdate(e,t){for(let t=0;t<e.length;++t)this._textureUnitMap[e[t]]=null;t>=0&&(this._activeTextureUnit=t)}externalVertexArrayObjectUpdate(){const e=this.capabilities.vao;e&&(e.bindVertexArray(null),this._activeVertexArrayObject=null),this._activeVertexBuffer=null,this._activeIndexBuffer=null}externalVertexBufferUpdate(){this._activeVertexBuffer=null}externalIndexBufferUpdate(){this._activeIndexBuffer=null}setBlendColor(e,t,i,n){e===this._blendColorState.r&&t===this._blendColorState.g&&i===this._blendColorState.b&&n===this._blendColorState.a||(this.gl.blendColor(e,t,i,n),this._blendColorState.r=e,this._blendColorState.g=t,this._blendColorState.b=i,this._blendColorState.a=n,this._stateTracker.invalidateBlending())}setBlendFunction(e,t){e===this._blendFunctionState.srcRGB&&t===this._blendFunctionState.dstRGB||(this.gl.blendFunc(e,t),this._blendFunctionState.srcRGB=e,this._blendFunctionState.srcAlpha=e,this._blendFunctionState.dstRGB=t,this._blendFunctionState.dstAlpha=t,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(e,t,i,n){this._blendFunctionState.srcRGB===e&&this._blendFunctionState.srcAlpha===i&&this._blendFunctionState.dstRGB===t&&this._blendFunctionState.dstAlpha===n||(this.gl.blendFuncSeparate(e,t,i,n),this._blendFunctionState.srcRGB=e,this._blendFunctionState.srcAlpha=i,this._blendFunctionState.dstRGB=t,this._blendFunctionState.dstAlpha=n,this._stateTracker.invalidateBlending())}setBlendEquation(e){this._blendEquationState.mode!==e&&(this.gl.blendEquation(e),this._blendEquationState.mode=e,this._blendEquationState.modeAlpha=e,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(e,t){this._blendEquationState.mode===e&&this._blendEquationState.modeAlpha===t||(this.gl.blendEquationSeparate(e,t),this._blendEquationState.mode=e,this._blendEquationState.modeAlpha=t,this._stateTracker.invalidateBlending())}setColorMask(e,t,i,n){this._colorMaskState.r===e&&this._colorMaskState.g===t&&this._colorMaskState.b===i&&this._colorMaskState.a===n||(this.gl.colorMask(e,t,i,n),this._colorMaskState.r=e,this._colorMaskState.g=t,this._colorMaskState.b=i,this._colorMaskState.a=n,this._stateTracker.invalidateColorWrite())}setClearColor(e,t,i,n){this._clearColor.r===e&&this._clearColor.g===t&&this._clearColor.b===i&&this._clearColor.a===n||(this.gl.clearColor(e,t,i,n),this._clearColor.r=e,this._clearColor.g=t,this._clearColor.b=i,this._clearColor.a=n)}setFaceCullingEnabled(e){this._polygonCullingEnabled!==e&&(!0===e?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._polygonCullingEnabled=e,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(e){this._polygonOffsetFillEnabled!==e&&(!0===e?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._polygonOffsetFillEnabled=e,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(e,t){this._polygonOffset[0]===e&&this._polygonOffset[1]===t||(this._polygonOffset[0]=e,this._polygonOffset[1]=t,this.gl.polygonOffset(e,t),this._stateTracker.invalidatePolygonOffset())}setCullFace(e){this._cullFace!==e&&(this.gl.cullFace(e),this._cullFace=e,this._stateTracker.invalidateCulling())}setFrontFace(e){this._frontFace!==e&&(this.gl.frontFace(e),this._frontFace=e,this._stateTracker.invalidateCulling())}setScissorTestEnabled(e){this._scissorTestEnabled!==e&&(!0===e?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._scissorTestEnabled=e)}setScissorRect(e,t,i,n){this._scissorRect.x===e&&this._scissorRect.y===t&&this._scissorRect.width===i&&this._scissorRect.height===n||(this.gl.scissor(e,t,i,n),this._scissorRect.x=e,this._scissorRect.y=t,this._scissorRect.width=i,this._scissorRect.height=n)}setDepthTestEnabled(e){this._depthTestEnabled!==e&&(!0===e?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._depthTestEnabled=e,this._stateTracker.invalidateDepthTest())}setClearDepth(e){this._clearDepth!==e&&(this.gl.clearDepth(e),this._clearDepth=e)}setDepthFunction(e){this._depthFunction!==e&&(this.gl.depthFunc(e),this._depthFunction=e,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(e){this._depthWriteEnabled!==e&&(this.gl.depthMask(e),this._depthWriteEnabled=e,this._stateTracker.invalidateDepthWrite())}setDepthRange(e,t){this._depthRange.zNear===e&&this._depthRange.zFar===t||(this.gl.depthRange(e,t),this._depthRange.zNear=e,this._depthRange.zFar=t,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(e){this._stencilTestEnabled!==e&&(!0===e?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._stencilTestEnabled=e,this._stateTracker.invalidateStencilTest())}setClearStencil(e){e!==this._clearStencil&&(this.gl.clearStencil(e),this._clearStencil=e)}setStencilFunction(e,t,i){this._stencilFunction.func===e&&this._stencilFunction.ref===t&&this._stencilFunction.mask===i||(this.gl.stencilFunc(e,t,i),this._stencilFunction.face=1032,this._stencilFunction.func=e,this._stencilFunction.ref=t,this._stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(e,t,i,n){this._stencilFunction.face===e&&this._stencilFunction.func===t&&this._stencilFunction.ref===i&&this._stencilFunction.mask===n||(this.gl.stencilFuncSeparate(e,t,i,n),this._stencilFunction.face=e,this._stencilFunction.func=t,this._stencilFunction.ref=i,this._stencilFunction.mask=n,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(e){this._stencilWriteMask!==e&&(this.gl.stencilMask(e),this._stencilWriteMask=e,this._stateTracker.invalidateStencilWrite())}setStencilOp(e,t,i){this._stencilOperation.fail===e&&this._stencilOperation.zFail===t&&this._stencilOperation.zPass===i||(this.gl.stencilOp(e,t,i),this._stencilOperation.face=1032,this._stencilOperation.fail=e,this._stencilOperation.zFail=t,this._stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(e,t,i,n){this._stencilOperation.face===e&&this._stencilOperation.fail===t&&this._stencilOperation.zFail===i&&this._stencilOperation.zPass===n||(this.gl.stencilOpSeparate(e,t,i,n),this._stencilOperation.face=e,this._stencilOperation.face=e,this._stencilOperation.fail=t,this._stencilOperation.zFail=i,this._stencilOperation.zPass=n,this._stateTracker.invalidateStencilTest())}setActiveTexture(e,t=!1){const i=this._activeTextureUnit;return e>=0&&(t||e!==this._activeTextureUnit)&&(this.gl.activeTexture(f+e),this._activeTextureUnit=e),i}clear(e){e&&this.gl.clear(e)}clearSafe(e,t=255){e&&(16384&e&&this.setColorMask(!0,!0,!0,!0),256&e&&this.setDepthWriteEnabled(!0),1024&e&&this.setStencilWriteMask(t),this.gl.clear(e))}drawArrays(e,t,i){d()&&(this._numOfDrawCalls++,this._numOfTriangles+=Q(e,i)),this.gl.drawArrays(e,t,i)}drawElements(e,t,i,n){d()&&(this._numOfDrawCalls++,this._numOfTriangles+=Q(e,t)),this.gl.drawElements(e,t,i,n)}logIno(){d()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}get capabilities(){return this._capabilities}setViewport(e,t,i,n){i=Math.max(Math.round(i),1),n=Math.max(Math.round(n),1);const r=this._viewport;r.x===e&&r.y===t&&r.width===i&&r.height===n||(r.x=e,r.y=t,r.width=i,r.height=n,this.gl.viewport(e,t,i,n))}getViewport(){return{x:this._viewport.x,y:this._viewport.y,width:this._viewport.width,height:this._viewport.height}}useProgram(e){var t,i;this._activeShaderProgram!==e&&(null==(t=this._activeShaderProgram)||t.stop(),this._activeShaderProgram=e,this.gl.useProgram(null!=(i=null==e?void 0:e.glName)?i:null))}bindTexture(e,t,i=!1){(t>=this.parameters.maxTextureImageUnits||t<0)&&console.error("Input texture unit is out of range of available units!");const n=this._textureUnitMap[t];return o(e)||null==e.glName?(u(n)&&(this.setActiveTexture(t,i),this.gl.bindTexture(n.descriptor.target,null)),this._textureUnitMap[t]=null,n):i||n!==e?(this.setActiveTexture(t,i),this.gl.bindTexture(e.descriptor.target,e.glName),e.applyChanges(),this._textureUnitMap[t]=e,n):(e.isDirty&&(this.setActiveTexture(t,i),e.applyChanges()),n)}unbindTextureAllUnits(e){for(let t=0;t<this.parameters.maxTextureImageUnits;t++)this._textureUnitMap[t]===e&&(this.bindTexture(null,t),this._textureUnitMap[t]=null)}bindFramebuffer(e,t=!1,i=3553){if(o(e))return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),void(this._activeFramebuffer=null);(t||this._activeFramebuffer!==e)&&(e.initializeAndBind(i),this._activeFramebuffer=e)}bindBuffer(e){e&&(34962===e.bufferType?this._activeVertexBuffer=z(this.gl,e,e.bufferType,this._activeVertexBuffer):this._activeIndexBuffer=z(this.gl,e,e.bufferType,this._activeIndexBuffer))}bindRenderbuffer(e){const t=this.gl;e||(t.bindRenderbuffer(t.RENDERBUFFER,null),this._activeRenderbuffer=null),this._activeRenderbuffer!==e&&(t.bindRenderbuffer(t.RENDERBUFFER,e.glName),this._activeRenderbuffer=e)}unbindBuffer(e){34962===e?this._activeVertexBuffer=z(this.gl,null,e,this._activeVertexBuffer):this._activeIndexBuffer=z(this.gl,null,e,this._activeIndexBuffer)}bindVAO(e=null){o(e)?this._activeVertexArrayObject&&(this._activeVertexArrayObject.unbind(),this._activeVertexArrayObject=null):this._activeVertexArrayObject!==e&&(e.bind(),this._activeVertexArrayObject=e)}getBoundFramebufferObject(){return this._activeFramebuffer}getBoundVAO(){return this._activeVertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null),this.unbindBuffer(34962),this.unbindBuffer(34963);for(let e=0;e<this.parameters.maxTextureImageUnits;++e)this.bindTexture(null,e);this.setBlendingEnabled(!1),this.setBlendFunction(1,0),this.setBlendEquation(32774),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(1029),this.setFrontFace(2305),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(513),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(519,0,0),this.setStencilOp(7680,7680,7680),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){var e,t,i,n;const r=this.gl,s=this.capabilities.vao;s&&s.bindVertexArray(null);for(let e=0;e<this.parameters.maxVertexAttributes;e++)r.disableVertexAttribArray(e);if(this._activeVertexBuffer?r.bindBuffer(this._activeVertexBuffer.bufferType,this._activeVertexBuffer.glName):r.bindBuffer(34962,null),this._activeIndexBuffer?r.bindBuffer(this._activeIndexBuffer.bufferType,this._activeIndexBuffer.glName):r.bindBuffer(34963,null),s&&this._activeVertexArrayObject){const e=this._activeVertexArrayObject;this._activeVertexArrayObject&&(this._activeVertexArrayObject.unbind(),this._activeVertexArrayObject=null),this.bindVAO(e)}r.bindFramebuffer(r.FRAMEBUFFER,null!=(e=null==(t=this._activeFramebuffer)?void 0:t.glName)?e:null),r.useProgram(null!=(i=null==(n=this._activeShaderProgram)?void 0:n.glName)?i:null),r.blendColor(this._blendColorState.r,this._blendColorState.g,this._blendColorState.b,this._blendColorState.a),r.bindRenderbuffer(r.RENDERBUFFER,this._activeRenderbuffer?this._activeRenderbuffer.glName:null),!0===this._blendEnabled?r.enable(this.gl.BLEND):r.disable(this.gl.BLEND),r.blendEquationSeparate(this._blendEquationState.mode,this._blendEquationState.modeAlpha),r.blendFuncSeparate(this._blendFunctionState.srcRGB,this._blendFunctionState.dstRGB,this._blendFunctionState.srcAlpha,this._blendFunctionState.dstAlpha),r.clearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a),r.clearDepth(this._clearDepth),r.clearStencil(this._clearStencil),r.colorMask(this._colorMaskState.r,this._colorMaskState.g,this._colorMaskState.b,this._colorMaskState.a),r.cullFace(this._cullFace),r.depthFunc(this._depthFunction),r.depthRange(this._depthRange.zNear,this._depthRange.zFar),!0===this._depthTestEnabled?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),r.depthMask(this._depthWriteEnabled),r.frontFace(this._frontFace),r.lineWidth(1),!0===this._polygonCullingEnabled?r.enable(r.CULL_FACE):r.disable(r.CULL_FACE),r.polygonOffset(this._polygonOffset[0],this._polygonOffset[1]),!0===this._polygonOffsetFillEnabled?r.enable(r.POLYGON_OFFSET_FILL):r.disable(r.POLYGON_OFFSET_FILL),r.scissor(this._scissorRect.x,this._scissorRect.y,this._scissorRect.width,this._scissorRect.height),!0===this._scissorTestEnabled?r.enable(r.SCISSOR_TEST):r.disable(r.SCISSOR_TEST),r.stencilFunc(this._stencilFunction.func,this._stencilFunction.ref,this._stencilFunction.mask),r.stencilOpSeparate(this._stencilOperation.face,this._stencilOperation.fail,this._stencilOperation.zFail,this._stencilOperation.zPass),!0===this._stencilTestEnabled?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),r.stencilMask(this._stencilWriteMask);for(let e=0;e<this.parameters.maxTextureImageUnits;e++){r.activeTexture(f+e),r.bindTexture(3553,null),r.bindTexture(34067,null),_(r)&&r.bindTexture(32879,null);const t=this._textureUnitMap[e];u(t)&&r.bindTexture(t.descriptor.target,t.glName)}r.activeTexture(f+this._activeTextureUnit),r.viewport(this._viewport.x,this._viewport.y,this._viewport.width,this._viewport.height),d()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}_loadParameters(e){var t;const i=this.capabilities.textureFilterAnisotropic,n=null!=(t=e.maxAnisotropy)?t:1/0,r={versionString:this.gl.getParameter(this.gl.VERSION),maxVertexTextureImageUnits:this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS),maxMaxAnisotropy:i?Math.min(this.gl.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY),n):1,maxTextureImageUnits:this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE)};return h.TEXTURE_UNIT_FOR_UPDATES=r.maxTextureImageUnits-1,r}}function z(e,t,i,n){return t?n!==t&&e.bindBuffer(i,t.glName):e.bindBuffer(i,null),t}function Q(e,t){switch(e){case 0:return 2*t;case 4:return t/3;case 5:case 6:return t-2;default:return 0}}export{A as F,R as M,B as P,w as R,M as Z,q as a,W as c,P as l};
