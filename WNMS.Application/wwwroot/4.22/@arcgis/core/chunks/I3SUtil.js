/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import e from"../request.js";import{h as t,i as r,b as a,B as n,S as o,_ as s,$ as i,F as l}from"../core/lang.js";import c from"../core/Error.js";import{eachAlways as f}from"../core/promiseUtils.js";import{d as u}from"./mat3.js";import{c as h}from"./quatf64.js";import{a as p}from"./mat4.js";import{c as m}from"./mat4f64.js";import{a as d,m as y,c as b}from"./quat.js";import{b as g}from"./quatf32.js";import{b as w,e as M,m as v,F as S,T as x,f as j,g as q,j as R}from"./mathUtils.js";import{c as T}from"./vec4f64.js";import{computeTranslationToOriginAndRotation as k,projectBoundingSphere as z,canProjectWithoutEngine as F,projectBuffer as W,projectVectorToVector as I}from"../geometry/projection.js";import{g as A,a as G}from"./projectionEllipsoid.js";import L,{k as C}from"../geometry/SpatialReference.js";import{a as K,g as E,n as O,k as P}from"./aaBoundingRect.js";import B from"../rest/support/Query.js";import{r as U}from"./I3SBinaryReader.js";import{i as $,p as V,h as D}from"./LayerView3D.js";import{a as Q,b as Z,d as _}from"../views/SceneView.js";function H(e,t,r,a){const n=J(e,t,r),o=m();return k(r,n,o,a),o}function J(e,t,r){const a=w(),n=e[3],o=2**(4*Math.ceil(Math.log(n)*Math.LOG2E/4)+1);if(r.isGeographic){const t=o/A(r).radius*180/Math.PI,n=Math.round(e[1]/t),s=Math.max(-90,Math.min(90,n*t)),i=t/Math.cos((Math.abs(s)-t/2)/180*Math.PI),l=Math.round(e[0]/i)*i;a[0]=l,a[1]=s}else{const t=Math.round(e[0]/o),r=Math.round(e[1]/o);a[0]=t*o,a[1]=r*o}const s=e[2]+t,i=Math.round(s/o);return a[2]=i*o,a}function N(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function X(e){if(t("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const e of t.geometryBuffers){var r;if("draco"===(null==(r=e.compressedAttributes)?void 0:r.encoding))return!0}return!1}function Y(e,t,r,a,n,o){n.traverse(r,(r=>{let n=r.mbs;t!==a&&(n=ne,z(r.mbs,a,n,t));const s=oe(e,n);return 0!==s&&(o(r,s),!0)}))}function ee(e,t,r){let a=0,n=0;for(let o=0;o<t.length&&a<e.length;o++)e[a]===t[o]&&(r(o)&&(e[n]=e[a],n++),a++);e.length=n}function te(e,t,r){let a=0,n=0;for(;a<r.length;){l(e,r[a])>=0===t&&(r[n]=r[a],n++),a++}r.length=n}const re=K();function ae(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return re[0]=(e[0]-t.position[0])/t.rotationScale[0],re[1]=(e[1]-t.position[1])/t.rotationScale[4],re[2]=(e[2]-t.position[0])/t.rotationScale[0],re[3]=(e[3]-t.position[1])/t.rotationScale[4],re}const ne=T();function oe(e,t){const r=t[0],a=t[1],n=t[3],o=e[0]-r,s=r-e[2],i=e[1]-a,l=a-e[3],c=Math.max(o,s,0),f=Math.max(i,l,0),u=c*c+f*f;if(u>n*n)return 0;if(u>0)return 1;return-Math.max(o,s,i,l)>n?3:2}function se(e,t,r){const a=[],n=r&&r.missingFields,o=r&&r.originalFields;for(const r of e){const e=r.toLowerCase();let s=!1;for(const n of t)if(e===n.name.toLowerCase()){a.push(n.name),s=!0,o&&o.push(r);break}!s&&n&&n.push(r)}return a}async function ie(t,o,s,i,l){if(0===o.length)return[];const u=t.attributeStorageInfo;if(r(t.associatedLayer))try{return await async function(e,t,r,a){t.sort(((e,t)=>e.attributes[r]-t.attributes[r]));const n=t.map((e=>e.attributes[r])),o=[],s=se(a,e.fields,{originalFields:o}),i=await le(e,n,s);for(let e=0;e<t.length;e++){const r=t[e],a=i[e],n={};if(r.attributes)for(const e in r.attributes)n[e]=r.attributes[e];for(let e=0;e<o.length;e++)n[o[e]]=a[s[e]];r.attributes=n}return t}(t.associatedLayer,o,s,i)}catch(e){if(t.associatedLayer.loaded)throw e}if(u){const r=function(e,t,r){const a=new Map,n=[],o=r();for(const r of e){const e=r.attributes[t];for(let t=0;t<o.length;t++){const s=o[t],i=s.featureIds.indexOf(e);if(i>=0){let e=a.get(s.node);e||(e={node:s.node,indices:[],graphics:[]},n.push(e),a.set(s.node,e)),e.indices.push(i),e.graphics.push(r);for(let e=t;e>0;e--)o[e]=o[e-1];o[0]=s;break}}}return n}(o,s,l);if(a(r))throw new c("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const h=t.parsedUrl.path,p=await Promise.all(r.map((t=>function(t,r,a,n,o){const s=[];for(const e of r)if(e&&-1!==o.indexOf(e.name)){const r=`${t}/nodes/${a.resources.attributes}/attributes/${e.key}/0`;s.push({url:r,storageInfo:e})}return f(s.map((t=>e(t.url,{responseType:"array-buffer"}).then((e=>U(t.storageInfo,e.data)))))).then((e=>{const t=[];for(const r of n){const a={};for(let t=0;t<e.length;t++)null!=e[t].value&&(a[s[t].storageInfo.name]=ce(e[t].value,r));t.push(a)}return t}))}(h,u,t.node,t.indices,i).then((e=>{for(let r=0;r<t.graphics.length;r++){const a=t.graphics[r],n=e[r];if(a.attributes)for(const e in a.attributes)e in n||(n[e]=a.attributes[e]);a.attributes=n}return t.graphics})))));return n(p)}throw new c("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function le(e,t,r){const a=e.capabilities.query.maxRecordCount;if(null!=a&&t.length>a){const s=o(t,a);return Promise.all(s.map((t=>le(e,t,r)))).then(n)}const s=new B({objectIds:t,outFields:r,orderByFields:[e.objectIdField]});return e.queryFeatures(s).then((e=>{if(e&&e.features&&e.features.length===t.length)return e.features.map((e=>e.attributes));throw new c("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}function ce(e,t){if(!e)return null;const r=e[t];if(s(e))return-32768===r?null:r;if(i(e))return-2147483648===r?null:r;return r!=r?null:r}function fe(e){const t=e.store.indexCRS||e.store.geographicCRS,r=void 0===t?e.store.indexWKT:void 0;if(r){if(!e.spatialReference)throw new c("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new c("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=t?new L(N(t)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function ue(e){const t=e.store.vertexCRS||e.store.projectedCRS,r=void 0===t?e.store.vertexWKT:void 0;if(r){if(!e.spatialReference)throw new c("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new c("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=t?new L(N(t)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function he(e,t){return a(t)?"@null":t===G(t)?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null}function pe(e,t,r){if(!F(e,t))throw new c("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===r&&!function(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}(e,t))throw new c("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function me(e,t,r){const a=fe(e),n=ue(e);pe(a,t,r),pe(n,t,r)}function de(e){if(null==e.store||null==e.store.defaultGeometrySchema||(null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes||null==t.vertexAttributes.position))throw new c("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t}function ye(e,t){me(e,t.spatialReference,t.viewingMode)}function be(e){if(null==e.store||null==e.store.defaultGeometrySchema||(null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes||null==t.vertexAttributes.position))throw new c("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t}function ge(e,t){pe(e.spatialReference,t.spatialReference,t.viewingMode)}function we(e){return"mesh-3d"===e.type}function Me(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.getSymbols();if(0===t.length)return!0;for(const e of t){if(!we(e)||0===e.symbolLayers.length)return!0;for(const t of e.symbolLayers.items)if("fill"!==t.type||a(t.material)||a(t.material.color)||"replace"!==t.material.colorMixMode)return!0}return!1}const ve=$({color:[0,0,0,0],opacity:0});class Se{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function xe(e){const t=new Se;let a=!1,n=!1;for(const o of e.symbolLayers.items)if("fill"===o.type&&o.enabled){const e=o.material,s=o.edges;if(r(e)&&!a){const n=e.color,s=V(e.colorMixMode);r(n)?t.material={color:[n.r/255,n.g/255,n.b/255],alpha:n.a,colorMixMode:s}:t.material={color:[1,1,1],alpha:1,colorMixMode:1},t.castShadows=o.castShadows,a=!0}r(s)&&!n&&(t.edgeMaterial=D(s,{}),n=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1}),t}function je(e,t){return(0|e)+(0|t)|0}function qe(e,t,r,a,n=0){a===G(a)?t.isGeographic?function(e,t,r,a){const n=A(r),o=1+Math.max(0,a)/(n.radius+e.center[2]);M(t.center,e.center[0],e.center[1],e.center[2]+a),W(t.center,r,0,t.center,G(r),0,1),d(t.quaternion,e.quaternion),b(Ge,e.quaternion),M(Oe,0,0,1),x(Oe,Oe,Ge),M(Oe,e.halfSize[0]*Math.abs(Oe[0]),e.halfSize[1]*Math.abs(Oe[1]),e.halfSize[2]*Math.abs(Oe[2])),j(Oe,Oe,n.inverseFlattening),q(t.halfSize,e.halfSize,Oe),j(t.halfSize,t.halfSize,o)}(e,r,t,n):function(e,t,r,a){_(e,Le),M(t.center,e.center[0],e.center[1],e.center[2]+a),k(r,t.center,Ae,G(r)),M(t.center,Ae[12],Ae[13],Ae[14]);const n=2*Math.sqrt(1+Ae[0]+Ae[5]+Ae[10]);Ge[0]=(Ae[6]-Ae[9])/n,Ge[1]=(Ae[8]-Ae[2])/n,Ge[2]=(Ae[1]-Ae[4])/n,Ge[3]=.25*n,y(t.quaternion,Ge,e.quaternion),b(Ge,t.quaternion);let o=0,s=0,i=0;for(const e of Le)e[2]+=a,W(e,r,0,e,G(r),0,1),S(Oe,e,t.center),x(Oe,Oe,Ge),o=Math.max(o,Math.abs(Oe[0])),s=Math.max(s,Math.abs(Oe[1])),i=Math.max(i,Math.abs(Oe[2]));M(t.halfSize,o,s,i)}(e,r,t,n):t.isWGS84&&(a.isWebMercator||C(a))?function(e,t,r,a,n){v(ze,t.center),ze[2]+=n;const o=G(r);W(ze,e,0,ze,o,0,1),We(o,t,ze,r,a)}(t,e,a,r,n):t.isWebMercator&&C(a)?function(e,t,r,a,n){v(ze,t.center),ze[2]+=n,We(e,t,ze,r,a)}(t,e,a,r,n):e===r?(r.center[2]+=n,W(r.center,t,0,r.center,a,0,1)):(M(r.center,e.center[0],e.center[1],e.center[2]+n),W(r.center,t,0,r.center,a,0,1),d(r.quaternion,e.quaternion),v(r.halfSize,e.halfSize))}const Re=new Float64Array(24),Te={data:Re,size:3},ke=w(),ze=w(),Fe=h();function We(e,t,r,a,n){const o=u(Fe,t.quaternion);for(let e=0;e<8;++e){for(let r=0;r<3;++r)ke[r]=t.halfSize[r]*(0!=(e&1<<r)?-1:1);for(let t=0;t<3;++t){let a=r[t];for(let e=0;e<3;++e)a+=ke[e]*o[3*e+t];Re[3*e+t]=a}}W(Re,e,0,Re,a,0,8),Z(Te,n)}function Ie(e,t,n,o,s,i){if(!i||0===i.length||a(t))return null;const l=H(e.mbs,s,n,t);let c;p(Be,l);let f=1/0,u=-1/0;const h=a=>{if("replace"!==a.type)return;const i=a.geometry;if(!i.hasZ)return;E(Ce);const l=i.spatialReference||o,h=i.rings.reduce(((e,r)=>r.reduce(((e,r)=>(I(r,l,Oe,t),R(Oe,Oe,Be),O(Ce,Oe),Math.min(Oe[2],e))),e)),1/0);(()=>{if(!c)if(c=Le,E(Ke),r(e.serviceObb)){qe(e.serviceObb,n,Ee,t,s),_(Ee,c);for(const e of c)R(e,e,Be),O(Ke,e)}else{const r=e.mbs,a=r[3];I(r,n,Oe,t),R(Oe,Oe,Be),Oe[2]+=s;for(let e=0;e<8;++e){const t=1&e?a:-a,r=2&e?a:-a,n=4&e?a:-a,o=c[e];v(o,[Oe[0]+t,Oe[1]+r,Oe[2]+n]),O(Ke,o)}}})(),P(Ke,Ce)&&(f=Math.min(f,h),u=Math.max(u,h))};if(i.forEach((e=>h(e))),f===1/0)return null;for(let e=0;e<8;++e)m=Pe.data,d=3*e,y=c[e],R(Oe,y,l),m[d+0]=Oe[0],m[d+1]=Oe[1],m[d+2]=Oe[2],d+=24,y[2]=f,R(Oe,y,l),m[d+0]=Oe[0],m[d+1]=Oe[1],m[d+2]=Oe[2],d+=24,y[2]=u,R(Oe,y,l),m[d+0]=Oe[0],m[d+1]=Oe[1],m[d+2]=Oe[2];var m,d,y;return Z(Pe)}const Ae=m(),Ge=g(),Le=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],Ce=K(),Ke=K(),Ee=Q(),Oe=[0,0,0],Pe={data:new Array(72),size:3},Be=m();export{de as a,ye as b,pe as c,he as d,H as e,se as f,fe as g,Ie as h,J as i,ee as j,oe as k,je as l,xe as m,ce as n,ae as o,te as p,qe as q,Me as r,ue as s,ve as t,Y as u,be as v,ie as w,ge as x,me as y,X as z};
