/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{i as e}from"../core/lang.js";import{urlToObject as n}from"../core/urlUtils.js";import{g as i}from"./scaleUtils.js";import{g as t,c as s}from"./floorFilterUtils.js";function r(e,n){return n?{...n,query:{...e,...n.query}}:{query:e}}function o(e){return"string"==typeof e?n(e):e}function l(e,n,i){const t={};for(const s in e){if("declaredClass"===s)continue;const r=e[s];if(null!=r&&"function"!=typeof r)if(Array.isArray(r)){t[s]=[];for(let e=0;e<r.length;e++)t[s][e]=l(r[e])}else if("object"==typeof r)if(r.toJSON){const e=r.toJSON(i&&i[s]);t[s]=n?e:JSON.stringify(e)}else t[s]=n?r:JSON.stringify(r);else t[s]=r}return t}function a({mapExtent:n,floors:r,width:o,sublayers:l,layerIds:a}){const f={},c={extent:n,width:o,spatialReference:null==n?void 0:n.spatialReference};let u=l;a&&a.length&&l&&(u=l.filter((e=>a.includes(e.id))));const y=i(c),p=[],d=e=>{const n=0===y,i=0===e.minScale||y<=e.minScale,t=0===e.maxScale||y>=e.maxScale;e.visible&&(n||i&&t)&&(e.sublayers?e.sublayers.forEach(d):p.unshift(e))};if(u&&u.forEach(d),u&&u.length){const n=p.map((e=>{const n=t(r,e);return e.toExportImageJSON(n)})),i=n.some((e=>"mapLayer"===e.source.type?e.source.mapLayerId!==e.id:"dataLayer"===e.source.type));if(i){let e=JSON.stringify(n);"[]"===e&&(e="[{}]"),f.dynamicLayers=e}else if(!i){if(a&&a.length)f.layerIds=a;else{const e=u.map((({id:e})=>e));e.length&&(f.layerIds=e)}const n=function({floors:n,visibleSublayers:i}){const r=!(null==n||!n.length),o=i.filter((e=>null!=e.definitionExpression||r&&null!=e.floorInfo));if(!o.length)return null;return o.map((i=>{const r=t(n,i),o=e(r)?s(r,i):i.definitionExpression,l={id:i.id,definitionExpression:null};return o&&(l.definitionExpression=o),l}))}({floors:r,visibleSublayers:p});if(n&&n.length){const e=n.reduce(((e,n)=>(n.definitionExpression&&(e[n.id]=n.definitionExpression),e)),{});Object.keys(e).length&&(f.layerDefs=JSON.stringify(e))}}}return f}export{r as a,l as e,o as p,a as t};
