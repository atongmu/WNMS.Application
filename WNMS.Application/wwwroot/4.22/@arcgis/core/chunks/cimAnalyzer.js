/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import e from"../Color.js";import{L as t}from"./Logger.js";import{i as o}from"../core/lang.js";import{a as i}from"./screenUtils.js";import{n as r}from"./string.js";import{a as n,A as a}from"./arcadeOnDemand.js";import{R as l,c as s,S as c,g as f,d as m,O as u,a as p}from"./CIMSymbolHelper.js";import{p as h}from"./floatRGBA.js";import{isExtent as y,isPolyline as g,isPolygon as d}from"../geometry/support/jsonUtils.js";import{f as S,h as v,j as b,_ as N,e as k}from"./utils5.js";import{c as C}from"./callExpressionWithFeature.js";function O(e){if(!e)return null;switch(e.type){case"CIMPointSymbol":{const t=e.symbolLayers;return t&&1===t.length?O(t[0]):null}case"CIMVectorMarker":{var t;const o=e.markerGraphics;if(!o||1!==o.length)return null;const i=o[0];if(!i)return null;const r=i.geometry;if(!r)return null;const n=i.symbol;return!n||"CIMPolygonSymbol"!==n.type&&"CIMLineSymbol"!==n.type||null!=(t=n.symbolLayers)&&t.some((e=>!!e.effects))?null:{geom:r,asFill:"CIMPolygonSymbol"===n.type}}case"sdf":return{geom:e.geom,asFill:e.asFill}}return null}function M(e){let t=1/0,o=-1/0,i=1/0,r=-1/0;for(const n of e)for(const e of n)e[0]<t&&(t=e[0]),e[0]>o&&(o=e[0]),e[1]<i&&(i=e[1]),e[1]>r&&(r=e[1]);return[t,i,o,r]}function x(e){return e?e.rings?M(e.rings):e.paths?M(e.paths):y(e)?[e.xmin,e.ymin,e.xmax,e.ymax]:null:null}function P(e,t,o,i,r){const[n,a,l,s]=e;if(l<n||s<a)return[0,0,0];const c=l-n,f=s-a,m=Math.floor(31.5),u=(128-2*(m+1))/Math.max(c,f),p=Math.round(c*u)+2*m,h=Math.round(f*u)+2*m;let y=1;if(t){y=h/u/(t.ymax-t.ymin)}let g=0,d=0;if(i)if(r){if(t&&o&&t.ymax-t.ymin>0){const e=(t.xmax-t.xmin)/(t.ymax-t.ymin);g=i.x/(o*e),d=i.y/o}}else g=i.x,d=i.y;g=.5*(t.xmax+t.xmin)+g*(t.xmax-t.xmin),d=.5*(t.ymax+t.ymin)+d*(t.ymax-t.ymin),g-=n,d-=a,g*=u,d*=u,g+=m,d+=m;return[y,g/p-.5,-(d/h-.5)]}function I(e){const t=(o=e.geom)?o.rings?o.rings:o.paths?o.paths:void 0!==o.xmin&&void 0!==o.ymin&&void 0!==o.xmax&&void 0!==o.ymax?[[[o.xmin,o.ymin],[o.xmin,o.ymax],[o.xmax,o.ymax],[o.xmax,o.ymin],[o.xmin,o.ymin]]]:null:null;var o;const i=function(e){let t=1/0,o=-1/0,i=1/0,r=-1/0;for(const n of e)for(const e of n)e[0]<t&&(t=e[0]),e[0]>o&&(o=e[0]),e[1]<i&&(i=e[1]),e[1]>r&&(r=e[1]);return new l(t,i,o-t,r-i)}(t),r=Math.floor(31.5),n=(128-2*(r+1))/Math.max(i.width,i.height),a=Math.round(i.width*n)+2*r,s=Math.round(i.height*n)+2*r,c=[];for(const o of t)if(o&&o.length>1){const t=[];for(const a of o){let[o,l]=a;o-=i.x,l-=i.y,o*=n,l*=n,o+=r-.5,l+=r-.5,e.asFill?t.push([o,l]):t.push([Math.round(o),Math.round(l)])}if(e.asFill){const e=t.length-1;t[0][0]===t[e][0]&&t[0][1]===t[e][1]||t.push(t[0])}c.push(t)}const f=function(e,t,o,i){const r=t*o,n=new Array(r),a=i*i+1;for(let e=0;e<r;++e)n[e]=a;for(const r of e){const e=r.length;for(let a=1;a<e;++a){const e=r[a-1],l=r[a];let s,c,f,m;e[0]<l[0]?(s=e[0],c=l[0]):(s=l[0],c=e[0]),e[1]<l[1]?(f=e[1],m=l[1]):(f=l[1],m=e[1]);let u=Math.floor(s)-i,p=Math.floor(c)+i,h=Math.floor(f)-i,y=Math.floor(m)+i;u<0&&(u=0),p>t&&(p=t),h<0&&(h=0),y>o&&(y=o);const g=l[0]-e[0],d=l[1]-e[1],S=g*g+d*d;for(let i=u;i<p;i++)for(let r=h;r<y;r++){let a,s,c=(i-e[0])*g+(r-e[1])*d;c<0?(a=e[0],s=e[1]):c>S?(a=l[0],s=l[1]):(c/=S,a=e[0]+c*g,s=e[1]+c*d);const f=(i-a)*(i-a)+(r-s)*(r-s),m=(o-r-1)*t+i;f<n[m]&&(n[m]=f)}}}for(let e=0;e<r;++e)n[e]=Math.sqrt(n[e]);return n}(c,a,s,r);return e.asFill&&function(e,t,o,i,r){for(const n of e){const e=n.length;for(let a=1;a<e;++a){const e=n[a-1],l=n[a];let s,c,f,m;e[0]<l[0]?(s=e[0],c=l[0]):(s=l[0],c=e[0]),e[1]<l[1]?(f=e[1],m=l[1]):(f=l[1],m=e[1]);let u=Math.floor(s),p=Math.floor(c)+1,h=Math.floor(f),y=Math.floor(m)+1;u<i&&(u=i),p>t-i&&(p=t-i),h<i&&(h=i),y>o-i&&(y=o-i);for(let n=h;n<y;++n){if(e[1]>n==l[1]>n)continue;const a=(o-n-1)*t;for(let t=u;t<p;++t)t<(l[0]-e[0])*(n-e[1])/(l[1]-e[1])+e[0]&&(r[a+t]=-r[a+t]);for(let e=i;e<u;++e)r[a+e]=-r[a+e]}}}}(c,a,s,r,f),[L(f,r),a,s]}function L(e,t){const o=2*t,i=e.length,r=new Uint8Array(4*i);for(let t=0;t<i;++t){const i=.5-e[t]/o;h(i,r,4*t)}return r}class w{static executeEffects(e,t){const o=s(t);let i=new c(o);for(const t of e){const e=f(t);e&&(i=e.execute(i,t,1.3333333333333333,!0))}return i}static next(e){const t=e.next();return m(t),t}static applyEffects(e,t){if(!e)return t;let o=new c(t);for(const t of e){const e=f(t);e&&(o=e.execute(o,t,1,!1))}let i,r=null;for(;i=o.next();)r?g(r)?g(i)&&r.paths.push(...i.paths):d(r)&&d(i)&&r.rings.push(...i.rings):r=i;return r}}const X=t.getLogger("esri.symbols.cim.cimAnalyzer");function z(e){switch(e){case"Butt":return 0;case"Square":return 2;default:return 1}}function J(e){switch(e){case"Bevel":return 0;case"Miter":return 2;default:return 1}}function H(e){switch(e){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return"justify"}}function Y(e){switch(e){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function R(e,t,o,i){let r;e[t]?r=e[t]:(r={},e[t]=r),r[o]=i}function A(e){const t=e.markerPlacement;return t&&t.angleToLine?1:0}async function F(e,t,o,i,r){const a=null!=i?i:[];if(!e)return a;let l,s;const c={};if("CIMSymbolReference"!==e.type)return X.error("Expect cim type to be 'CIMSymbolReference'"),a;if(l=e.symbol,s=e.primitiveOverrides,s){const e=[];for(const o of s){const i=o.valueExpressionInfo;if(i&&t){const r=i.expression,a=n(r,t.spatialReference,t.fields).then((e=>{e&&R(c,o.primitiveName,o.propertyName,e)}));e.push(a)}else null!=o.value&&R(c,o.primitiveName,o.propertyName,o.value)}e.length>0&&await Promise.all(e)}const f=[];switch(re(l,o,f),f.length>0&&await Promise.all(f),l.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":!function(e,t,o,i,r,n,a){if(!e)return;const l=e.symbolLayers;if(!l)return;const s=e.effects;let c;const f=p.getSize(e);"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(c=1);let m=l.length;for(;m--;){const p=l[m];if(!p||!1===p.enable)continue;let h;s&&s.length&&(h=[...s]);const y=p.effects;y&&y.length&&(s?h.push(...y):h=[...y]);const g=[];switch(u.findApplicableOverrides(p,t,g),p.type){case"CIMSolidFill":$(p,h,o,g,i,r);break;case"CIMPictureFill":j(p,h,o,g,i,n,r);break;case"CIMHatchFill":W(p,h,o,g,i,r);break;case"CIMGradientFill":T(p,h,o,g,i,r);break;case"CIMSolidStroke":E(p,h,o,g,i,r,"CIMPolygonSymbol"===e.type,f);break;case"CIMPictureStroke":G(p,h,o,g,i,r,"CIMPolygonSymbol"===e.type,f);break;case"CIMGradientStroke":D(p,h,o,g,i,r,"CIMPolygonSymbol"===e.type,f);break;case"CIMCharacterMarker":if(U(p,h,o,g,i,r))break;break;case"CIMPictureMarker":if(U(p,h,o,g,i,r))break;"CIMLineSymbol"===e.type&&(c=A(p)),B(p,h,o,g,i,n,r,c,f);break;case"CIMVectorMarker":if(U(p,h,o,g,i,r))break;"CIMLineSymbol"===e.type&&(c=A(p)),q(p,h,o,g,i,r,n,c,f,a);break;default:X.error("Cannot analyze CIM layer",p.type)}}}(l,s,c,t,a,o,r)}return a}function $(e,t,o,i,n,a){const l=e.primitiveName,s=S(e.color),[c,f]=ie(i,l),m=r(JSON.stringify(e)+f).toString();a.push({type:"fill",templateHash:m,materialHash:c?()=>m:m,cim:e,materialOverrides:null,colorLocked:e.colorLocked,color:ee(l,o,"Color",n,s,Z),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:t})}function j(e,t,i,n,a,l,s){const c=e.primitiveName,f=e.tintColor?S(e.tintColor):{r:255,g:255,b:255,a:1},[m,u]=ie(n,c),p=r(JSON.stringify(e)+u).toString(),h=r(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();let y=v(e.scaleX);if("width"in e){const t=e.width;let i=1;const r=l.getResource(e.url);o(r)&&(i=r.width/r.height),y/=i*(e.height/t)}s.push({type:"fill",templateHash:p,materialHash:m?()=>h:h,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,color:ee(c,i,"TintColor",a,f,Z),height:ee(c,i,"Height",a,e.height),scaleX:ee(c,i,"ScaleX",a,y),angle:ee(c,i,"Rotation",a,v(e.rotation)),offsetX:ee(c,i,"OffsetX",a,v(e.offsetX)),offsetY:ee(c,i,"OffsetY",a,v(e.offsetY)),url:e.url})}function W(e,t,o,i,n,a){const l=["Rotation","OffsetX","OffsetY"],s=i.filter((t=>t.primitiveName!==e.primitiveName&&-1===l.indexOf(t.propertyName))),c=e.primitiveName,[f,m]=ie(i,c),u=r(JSON.stringify(e)+m).toString(),p=r(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();a.push({type:"fill",templateHash:u,materialHash:f?te(p,o,s,n):p,cim:e,materialOverrides:s,colorLocked:e.colorLocked,effects:t,color:{r:255,g:255,b:255,a:1},height:ee(c,o,"Separation",n,e.separation),scaleX:1,angle:ee(c,o,"Rotation",n,v(e.rotation)),offsetX:ee(c,o,"OffsetX",n,v(e.offsetX)),offsetY:ee(c,o,"OffsetY",n,v(e.offsetY))})}function T(e,t,o,i,n,a){const l=e.primitiveName,[s,c]=ie(i,l),f=r(JSON.stringify(e)+c).toString();a.push({type:"fill",templateHash:f,materialHash:s?te(f,o,i,n):f,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1})}function E(e,t,o,i,n,a,l,s){const c=e.primitiveName,f=S(e.color),m=void 0!==e.width?e.width:4,u=z(e.capStyle),p=J(e.joinStyle),h=e.miterLimit,[y,g]=ie(i,c),d=r(JSON.stringify(e)+g).toString();let v,b;if(t&&t.length>0){const o=t[t.length-1];if("CIMGeometricEffectDashes"===o.type&&"NoConstraint"===o.lineDashEnding){const o=(t=[...e.effects]).pop();v=o.dashTemplate,b=o.scaleDash}}a.push({type:"line",templateHash:d,materialHash:y?()=>d:d,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:t,color:ee(c,o,"Color",n,f,Z),width:ee(c,o,"Width",n,m),cap:ee(c,o,"CapStyle",n,u),join:ee(c,o,"JoinStyle",n,p),miterLimit:ee(c,o,"MiterLimit",n,h),referenceWidth:s,zOrder:Q(e.name),dashTemplate:v,scaleDash:b})}function G(e,t,o,i,n,a,l,s){const c=r(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),f=e.primitiveName,m=S(e.tintColor),u=void 0!==e.width?e.width:4,p=z(e.capStyle),h=J(e.joinStyle),y=e.miterLimit,[g,d]=ie(i,f),v=r(JSON.stringify(e)+d).toString();a.push({type:"line",templateHash:v,materialHash:g?()=>c:c,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:t,color:ee(f,o,"TintColor",n,m,Z),width:ee(f,o,"Width",n,u),cap:ee(f,o,"CapStyle",n,p),join:ee(f,o,"JoinStyle",n,h),miterLimit:ee(f,o,"MiterLimit",n,y),referenceWidth:s,zOrder:Q(e.name),dashTemplate:null,scaleDash:!1,url:e.url})}function D(e,t,o,i,n,a,l,s){const c=e.primitiveName,f=void 0!==e.width?e.width:4,m=z(e.capStyle),u=J(e.joinStyle),p=e.miterLimit,[h,y]=ie(i,c),g=r(JSON.stringify(e)+y).toString();a.push({type:"line",templateHash:g,materialHash:h?te(g,o,i,n):g,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},width:ee(c,o,"Width",n,f),cap:ee(c,o,"CapStyle",n,m),join:ee(c,o,"JoinStyle",n,u),miterLimit:ee(c,o,"MiterLimit",n,p),referenceWidth:s,zOrder:Q(e.name),dashTemplate:null,scaleDash:!1})}function U(e,t,o,i,n,a){const l=e.markerPlacement;if(!l||"CIMMarkerPlacementInsidePolygon"!==l.type)return!1;const s=l,c=["Rotation","OffsetX","OffsetY"],f=i.filter((t=>t.primitiveName!==e.primitiveName&&-1===c.indexOf(t.propertyName))),m="url"in e?e.url:null,[u,p]=ie(i,s.primitiveName),h=r(JSON.stringify(e)+p).toString();let y=s.stepY,g=null,d=1;return l.shiftOddRows&&(y*=2,g=function(e){return e?2*e:0},d=.5),a.push({type:"fill",templateHash:h,materialHash:u?te(h,o,f,n):h,cim:e,materialOverrides:f,colorLocked:e.colorLocked,effects:t,color:{r:255,g:255,b:255,a:1},height:ee(s.primitiveName,o,"StepY",n,y,g),scaleX:d,angle:ee(s.primitiveName,o,"GridAngle",n,s.gridAngle),offsetX:ee(s.primitiveName,o,"OffsetX",n,v(s.offsetX)),offsetY:ee(s.primitiveName,o,"OffsetY",n,v(s.offsetY)),url:m}),!0}function B(e,t,i,n,a,l,s,c,f){var m;const u=e.primitiveName,p=v(e.size);let h=v(e.scaleX);const y=v(e.rotation),g=v(e.offsetX),d=v(e.offsetY),b=e.tintColor?S(e.tintColor):{r:255,g:255,b:255,a:1},N=r(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),[k,C]=ie(n,u),O=r(JSON.stringify(e)+C).toString(),M=null!=(m=e.anchorPoint)?m:{x:0,y:0};if("width"in e){const t=e.width;let i=1;const r=l.getResource(e.url);o(r)&&(i=r.width/r.height),h/=i*(p/t)}s.push({type:"marker",templateHash:O,materialHash:k?()=>N:N,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:!1,alignment:c,size:ee(u,i,"Size",a,p),scaleX:ee(u,i,"ScaleX",a,h),rotation:ee(u,i,"Rotation",a,y),offsetX:ee(u,i,"OffsetX",a,g),offsetY:ee(u,i,"OffsetY",a,d),color:ee(u,i,"TintColor",a,b,Z),anchorPoint:{x:M.x,y:-M.y},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:e.rotateClockwise,referenceSize:f,sizeRatio:1,markerPlacement:e.markerPlacement,url:e.url})}function q(e,t,o,i,r,n,a,l,s,c){const f=e.markerGraphics;if(!f)return;let m=0;if(e.scaleSymbolsProportionally){const t=e.frame;t&&(m=t.ymax-t.ymin)}for(const u of f)if(u){const f=u.symbol;if(!f)continue;switch(f.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":_(e,t,u,i,o,r,n,a,l,s,m,c);break;case"CIMTextSymbol":V(e,t,u,o,i,r,n,l,s,m)}}}function V(e,t,o,i,n,a,l,s,c,f){u.findApplicableOverrides(o,n,[]);const m=o.geometry;if(!("x"in m)||!("y"in m))return;const h=o.symbol,y=(g=h).underline?"underline":g.strikethrough?"line-through":"none";var g;const d=function(e){let t="",o="";if(e){const i=e.toLowerCase();-1!==i.indexOf("italic")?t="italic":-1!==i.indexOf("oblique")&&(t="oblique"),-1!==i.indexOf("bold")?o="bold":-1!==i.indexOf("light")&&(o="lighter")}return{style:t,weight:o}}(h.fontStyleName),C=b(h.fontFamilyName);h.font={family:C,decoration:y,...d};const O=e.frame,M=m.x-.5*(O.xmin+O.xmax),x=m.y-.5*(O.ymin+O.ymax),P=e.size/f,I=e.primitiveName,L=v(h.height)*P,w=v(h.angle),X=(v(h.offsetX)+M)*P,z=(v(h.offsetY)+x)*P,J=S(p.getFillColor(h));let R=S(p.getStrokeColor(h)),A=p.getStrokeWidth(h);A||(R=S(p.getFillColor(h.haloSymbol)),A=h.haloSize*P);const[F,$]=ie(n,I),j=JSON.stringify(e.effects)+Number(e.colorLocked)+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement),W=r(JSON.stringify(o)+j+$).toString(),T=r(JSON.stringify(h.font)).toString(),E=ee(o.primitiveName,i,"TextString",a,o.textString,N,h.textCase),{fontStyleName:G}=h,D=C+(G?"-"+G.toLowerCase():"-regular");l.push({type:"text",templateHash:W,materialHash:F||"function"==typeof E||E.match(/\[([\w]+)\]/)?(e,t,o)=>T+"-"+k(E,e,t,o):T+"-"+r(E),cim:h,materialOverrides:null,colorLocked:e.colorLocked,effects:t,alignment:s,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,fontName:D,decoration:y,weight:ee(I,i,"Weight",a,d.weight),style:ee(I,i,"Size",a,d.style),size:ee(I,i,"Size",a,L),angle:ee(I,i,"Rotation",a,w),offsetX:ee(I,i,"OffsetX",a,X),offsetY:ee(I,i,"OffsetY",a,z),horizontalAlignment:H(h.horizontalAlignment),verticalAlignment:Y(h.verticalAlignment),text:E,color:J,outlineColor:R,outlineSize:A,referenceSize:c,sizeRatio:1,markerPlacement:e.markerPlacement})}function _(e,t,o,i,n,a,l,s,c,f,m,u){const h=o.symbol,y=h.symbolLayers;if(!y)return;if(u)return void K(e,t,o,n,i,a,l,s,c,f,m);let g=y.length;if(ne(y))return void function(e,t,o,i,n,a,l,s,c,f){const m=t.geometry,u=o[0],h=o[1],y=x(m);if(!y)return;const[g,d,b]=P(y,e.frame,e.size,e.anchorPoint,"Relative"!==e.anchorPointUnits),N={type:"sdf",geom:m,asFill:!0},k=e.primitiveName,C=v(e.size),O=v(e.rotation),M=v(e.offsetX),I=v(e.offsetY),L=h.path,w=h.primitiveName,X=u.primitiveName,z=S(p.getFillColor(h)),J=S(p.getStrokeColor(u)),H=p.getStrokeWidth(u);let Y=!1,R="";for(const e of i)e.primitiveName!==w&&e.primitiveName!==X&&e.primitiveName!==k||(void 0!==e.value?R+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(Y=!0));const A=JSON.stringify({...e,markerGraphics:null}),F=r(JSON.stringify(N)+L).toString(),$={type:"marker",templateHash:r(JSON.stringify(t)+JSON.stringify(h)+JSON.stringify(u)+A+R).toString(),materialHash:Y?()=>F:F,cim:N,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:s,anchorPoint:{x:d,y:b},isAbsoluteAnchorPoint:!1,size:ee(e.primitiveName,n,"Size",a,C),rotation:ee(e.primitiveName,n,"Rotation",a,O),offsetX:ee(e.primitiveName,n,"OffsetX",a,M),offsetY:ee(e.primitiveName,n,"OffsetY",a,I),scaleX:1,frameHeight:f,rotateClockwise:e.rotateClockwise,referenceSize:c,sizeRatio:g,color:ee(w,n,"Color",a,z,Z),outlineColor:ee(X,n,"Color",a,J,Z),outlineWidth:ee(X,n,"Width",a,H),markerPlacement:e.markerPlacement,path:L};l.push($)}(e,o,y,i,n,a,l,c,f,m);const d=w.applyEffects(h.effects,o.geometry);if(d)for(;g--;){const u=y[g];if(u&&!1!==u.enable)switch(u.type){case"CIMSolidFill":case"CIMSolidStroke":{var b;const s=w.applyEffects(u.effects,d),h=x(s);if(!h)continue;const[y,g,N]=P(h,e.frame,e.size,e.anchorPoint,"Relative"!==e.anchorPointUnits),k="CIMSolidFill"===u.type,C={type:"sdf",geom:s,asFill:k},O=e.primitiveName,M=null!=(b=v(e.size))?b:10,I=v(e.rotation),L=v(e.offsetX),X=v(e.offsetY),z=u.path,J=u.primitiveName,H=S(k?p.getFillColor(u):p.getStrokeColor(u)),Y=k?{r:0,g:0,b:0,a:0}:S(p.getStrokeColor(u)),R=p.getStrokeWidth(u);if(!k&&!R)break;let A=!1,F="";for(const e of i)e.primitiveName!==J&&e.primitiveName!==O||(void 0!==e.value?F+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(A=!0));const $=JSON.stringify({...e,markerGraphics:null}),j=r(JSON.stringify(C)+z).toString(),W={type:"marker",templateHash:r(JSON.stringify(o)+JSON.stringify(u)+$+F).toString(),materialHash:A?()=>j:j,cim:C,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:c,anchorPoint:{x:g,y:N},isAbsoluteAnchorPoint:!1,size:ee(e.primitiveName,n,"Size",a,M),rotation:ee(e.primitiveName,n,"Rotation",a,I),offsetX:ee(e.primitiveName,n,"OffsetX",a,L),offsetY:ee(e.primitiveName,n,"OffsetY",a,X),scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:f,sizeRatio:y,color:ee(J,n,"Color",a,H,Z),outlineColor:ee(J,n,"Color",a,Y,Z),outlineWidth:ee(J,n,"Width",a,R),markerPlacement:e.markerPlacement,path:z};l.push(W);break}default:K(e,t,o,n,i,a,l,s,c,f,m)}}}function K(e,t,o,n,a,l,s,c,f,m,u){const h=function(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}(e,o);let y=[];const g=["Rotation","OffsetX","OffsetY"];y=a.filter((t=>t.primitiveName!==e.primitiveName||-1===g.indexOf(t.propertyName)));let d="";for(const e of a)void 0!==e.value&&(d+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`);const[S,b,N]=p.getTextureAnchor(h,c),k=e.primitiveName,C=v(e.rotation),O=v(e.offsetX),M=v(e.offsetY),x=r(JSON.stringify(h)+d).toString(),P={type:"marker",templateHash:x,materialHash:0===y.length?x:te(x,n,y,l),cim:h,materialOverrides:y,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:S,y:b},isAbsoluteAnchorPoint:!1,size:e.size,rotation:ee(k,n,"Rotation",l,C),offsetX:ee(k,n,"OffsetX",l,O),offsetY:ee(k,n,"OffsetY",l,M),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:u,rotateClockwise:e.rotateClockwise,referenceSize:m,sizeRatio:N/i(e.size),markerPlacement:e.markerPlacement};s.push(P)}function Q(e){if(e&&0===e.indexOf("Level_")){const t=parseInt(e.substr(6),10);if(NaN!==t)return t}return 0}function Z(t){if(!t||0===t.length)return null;const o=new e(t).toRgba();return{r:o[0],g:o[1],b:o[2],a:o[3]}}function ee(e,t,o,i,r,n,l){const s=t[e];if(s){const e=s[o];if("string"==typeof e||"number"==typeof e||e instanceof Array)return n?n.call(null,e,l):e;if(null!=e&&e instanceof a)return(t,o,a)=>{let s=C(e,t,{$view:a},i.geometryType,o);return null!==s&&n&&(s=n.call(null,s,l)),null!==s?s:r}}return r}function te(e,t,o,i){for(const e of o){if(e.valueExpressionInfo){const o=t[e.primitiveName]&&t[e.primitiveName][e.propertyName];o instanceof a&&(e.fn=(e,t,r)=>C(o,e,{$view:r},i.geometryType,t))}}return(t,i,n)=>{for(const e of o)e.fn&&(e.value=e.fn(t,i,n));return r(e+u.buildOverrideKey(o)).toString()}}function oe(e,t){if(!t||0===t.length)return e;const o=JSON.parse(JSON.stringify(e));return u.applyOverrides(o,t),o}function ie(e,t){let o=!1,i="";for(const r of e)r.primitiveName===t&&(void 0!==r.value?i+=`-${r.primitiveName}-${r.propertyName}-${JSON.stringify(r.value)}`:r.valueExpressionInfo&&(o=!0));return[o,i]}function re(e,t,o){if(e&&t)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{const i=e.symbolLayers;if(!i)return;for(const e of i)switch(e.type){case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMCharacterMarker":case"CIMPictureMarker":"url"in e&&e.url&&o.push(t.fetchResource(e.url,null));break;case"CIMVectorMarker":{const i=e.markerGraphics;if(!i)continue;for(const e of i)if(e){const i=e.symbol;i&&re(i,t,o)}}}}}}const ne=e=>e&&2===e.length&&e[0].enable&&e[1].enable&&"CIMSolidStroke"===e[0].type&&"CIMSolidFill"===e[1].type&&!e[0].effects&&!e[1].effects;export{w as C,F as a,oe as b,I as c,O as g};
