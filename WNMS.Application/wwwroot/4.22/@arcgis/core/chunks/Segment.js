/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{x as t,y as e,c as i,z as s,d as o}from"./unitUtils.js";import{i as r,u as n}from"../core/lang.js";import{d as a,f as h,b as l}from"./screenUtils.js";import{g as c,h as p,f as d,s as m,e as u,n as x,l as f}from"./vec2.js";import{e as _,g as y,f as g,b as v,h as b,s as S,n as w,m as P}from"./mathUtils.js";import{f as R,g as T,c as j,h as I,d as C,i as z}from"../widgets/Attachments.js";import k from"../core/Handles.js";import{s as A}from"./viewUtils.js";import{V as U}from"./VisualElement.js";import{_ as M}from"./tslib.es6.js";import $ from"../core/Accessor.js";import{property as L}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as X}from"../core/accessorSupport/decorators/subclass.js";import"./projector.js";import{canProjectWithoutEngine as Y,projectVectorToVector as B}from"../geometry/projection.js";import{a as E}from"./projectionEllipsoid.js";import{b as F}from"./vectorStacks.js";import{j as q,s as D}from"./mathUtils2.js";let O=(t,e,i)=>{for(let s=0,o=e.length;s<o;s++){let o=e[s];Array.isArray(o)?O(t,o,i):null!=o&&!1!==o&&("string"==typeof o&&(o={vnodeSelector:"",properties:void 0,children:void 0,text:o.toString(),domNode:null}),i.push(o))}};function N(t,e,i){if(Array.isArray(e))i=e,e=void 0;else if(e&&("string"==typeof e||e.hasOwnProperty("vnodeSelector"))||i&&("string"==typeof i||i.hasOwnProperty("vnodeSelector")))throw new Error("h called with invalid arguments");let s,o;return i&&1===i.length&&"string"==typeof i[0]?s=i[0]:i&&(o=[],O(t,i,o),0===o.length&&(o=void 0)),{vnodeSelector:t,properties:e,children:o,text:""===s?void 0:s,domNode:null}}class V{constructor(e,i){this.measure=t(i),this.value=e,this.unit=i}get isBaseUnit(){return e(this.unit)}toUnit(t){return new V(i(this.value,this.unit,t),t)}toBaseUnit(){return this.toUnit(s(this.unit))}}function G(t,e){if(_(e,0,0,0),t.length>0){for(let i=0;i<t.length;++i)y(e,e,t[i]);g(e,e,1/t.length)}}function H(t,e,i,s){s.projectToRenderScreen(t,J),s.projectToRenderScreen(e,W),c(i,K,Q),p(i,i)}const J=a(),Q=J,W=a(),K=W;class Z{constructor(t=null){this.spatialReference=t}get spatialReference(){return this._spatialReference}set spatialReference(t){t!==this._spatialReference&&(this._spatialReference=t,this._updateNormalizationFactors())}normalizeDistance(t){return t*this._metersPerDistanceUnit}normalizeElevation(t){return t*this._metersPerElevationUnit}normalizeArea(t){return t*this._squareMetersPerAreaUnit}_updateNormalizationFactors(){this._metersPerDistanceUnit=o(this._spatialReference,1),this._metersPerElevationUnit=o(this._spatialReference,1),this._squareMetersPerAreaUnit=this._metersPerDistanceUnit*this._metersPerDistanceUnit}}function tt(t,e,i,s=2,o="abbr"){return R(t,e.toUnit(i).value,i,s,o)}function et(t,e,i=2,s="abbr"){if("length"!==e.measure)throw new Error("quantity is not a length");return C(t,e.value,e.unit,i,s)}function it(t,e,i=2,s="abbr"){if("length"!==e.measure)throw new Error("quantity is not a length");return z(t,e.value,e.unit,i,s)}function st(t,e,i=2,s="abbr"){if("length"!==e.measure)throw new Error("quantity is not a length");return j(t,e.value,e.unit,i,s)}function ot(t,e,i=2,s="abbr"){if("length"!==e.measure)throw new Error("quantity is not a length");return I(t,e.value,e.unit,i,s)}function rt(t){if("angle"!==t.measure)throw new Error("quantity is not an angle");return T(t.value,t.unit)}let nt=class extends ${constructor(t){super(t),this.startX=0,this.startY=0,this.endX=0,this.endY=0,this.width=1,this.color=[0,0,0,.5],this.visible=!0}get startPosition(){return[this.startX,this.startY]}set startPosition(t){this._set("startX",t[0]),this._set("startY",t[1])}get endPosition(){return[this.endX,this.endY]}set endPosition(t){this._set("endX",t[0]),this._set("endY",t[1])}get strokeStyle(){const t=this.color;return`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${t[3]})`}get lineCap(){return"round"}render(){const{height:t,left:e,top:i,width:s,x1:o,x2:r,y1:n,y2:a}=this.calculateCoordinates(at),h=`stroke: ${this.strokeStyle}; stroke-width: ${this.width}; stroke-linecap: ${this.lineCap};`;return N("div",{classes:{"esri-line-overlay-item":!0},styles:{left:e+"px",top:i+"px",width:s+"px",height:t+"px",visibility:this.visible?"visible":"hidden"}},[N("svg",{width:s,height:t},[N("line",{x1:o,y1:n,x2:r,y2:a,style:h})])])}renderCanvas(t){if(!this.visible)return;t.strokeStyle=this.strokeStyle,t.lineWidth=this.width,t.lineCap=this.lineCap;const e=this.calculateCoordinates(at);t.beginPath(),t.moveTo(e.left+e.x1,e.top+e.y1),t.lineTo(e.left+e.x2,e.top+e.y2),t.stroke()}calculateCoordinates(t){const e=Math.min(this.startX,this.endX),i=Math.max(this.startX,this.endX),s=Math.min(this.startY,this.endY),o=Math.max(this.startY,this.endY),r=this.width;return t.left=e-r,t.top=s-r,t.width=i-e+2*r,t.height=Math.max(20,o-s+2*r),t.x1=this.startX-e+r,t.y1=this.startY-s+r,t.x2=this.endX-e+r,t.y2=this.endY-s+r,t}};M([L()],nt.prototype,"startX",void 0),M([L()],nt.prototype,"startY",void 0),M([L()],nt.prototype,"endX",void 0),M([L()],nt.prototype,"endY",void 0),M([L()],nt.prototype,"startPosition",null),M([L()],nt.prototype,"endPosition",null),M([L()],nt.prototype,"width",void 0),M([L()],nt.prototype,"color",void 0),M([L()],nt.prototype,"visible",void 0),M([L({readOnly:!0})],nt.prototype,"strokeStyle",null),nt=M([X("esri.views.overlay.LineOverlayItem")],nt);const at={left:0,top:0,width:0,height:0,x1:0,y1:0,x2:0,y2:0},ht=nt,lt={bottom:"esri-text-overlay-item-anchor-bottom","bottom-right":"esri-text-overlay-item-anchor-bottom-right","bottom-left":"esri-text-overlay-item-anchor-bottom-left",top:"esri-text-overlay-item-anchor-top","top-right":"esri-text-overlay-item-anchor-top-right","top-left":"esri-text-overlay-item-anchor-top-left",center:"esri-text-overlay-item-anchor-center",right:"esri-text-overlay-item-anchor-right",left:"esri-text-overlay-item-anchor-left"};let ct=class extends ${constructor(t){super(t),this.x=0,this.y=0,this.text="-",this.fontSize=14,this.anchor="center",this.visible=!0,this.backgroundColor="rgba(0, 0, 0, 0.6)",this.textColor="white",this.textShadowColor=[0,0,0],this.textShadowSize=1}get position(){return[this.x,this.y]}set position(t){this._set("x",t[0]),this._set("y",t[1])}get padding(){return.5*this.fontSize}render(){return N("div",{classes:this._cssClasses(),styles:{left:Math.floor(this.x)+"px",top:Math.floor(this.y)+"px",visibility:this.visible?"visible":"hidden",fontSize:this.fontSize+"px",backgroundColor:this.backgroundColor,color:this.textColor,padding:this.padding+"px",borderRadius:this.padding+"px",textShadow:`0 0 ${this.textShadowSize}px rgb(${this.textShadowColor[0]}, ${this.textShadowColor[1]}, ${this.textShadowColor[2]})`}},[this.text])}renderCanvas(t){if(!this.visible)return;const e=t.font.replace(/^(.*?)px/,"");t.font=`${this.fontSize}px ${e}`;const i=this.padding,s=this.padding,o=t.measureText(this.text).width,r=this.fontSize,n=pt[this.anchor];t.textAlign="center",t.textBaseline="middle";const a=o+2*i,h=r+2*i,l=this.x+n.x*a,c=this.y+n.y*h;this.roundedRect(t,l,c,a,h,s),t.fillStyle=this.backgroundColor,t.fill();const p=this.x+(n.x+.5)*a,d=this.y+(n.y+.5)*h;this._renderTextShadow(t,this.text,p,d),t.fillStyle=this.textColor,t.fillText(this.text,p,d)}_renderTextShadow(t,e,i,s){t.lineJoin="miter",t.fillStyle=`rgba(${this.textShadowColor[0]}, ${this.textShadowColor[1]}, ${this.textShadowColor[2]}, ${1/dt.length})`;const o=this.textShadowSize;for(const[r,n]of dt)t.fillText(e,i+o*r,s+o*n)}roundedRect(t,e,i,s,o,r){t.beginPath(),t.moveTo(e,i+r),t.arcTo(e,i,e+r,i,r),t.lineTo(e+s-r,i),t.arcTo(e+s,i,e+s,i+r,r),t.lineTo(e+s,i+o-r),t.arcTo(e+s,i+o,e+s-r,i+o,r),t.lineTo(e+r,i+o),t.arcTo(e,i+o,e,i+o-r,r),t.closePath()}_cssClasses(){const t={"esri-text-overlay-item":!0};for(const e in lt)t[lt[e]]=this.anchor===e;return t}};M([L()],ct.prototype,"x",void 0),M([L()],ct.prototype,"y",void 0),M([L()],ct.prototype,"position",null),M([L()],ct.prototype,"text",void 0),M([L()],ct.prototype,"fontSize",void 0),M([L()],ct.prototype,"anchor",void 0),M([L()],ct.prototype,"visible",void 0),M([L()],ct.prototype,"padding",null),ct=M([X("esri.views.overlay.TextOverlayItem")],ct);const pt={bottom:{x:-.5,y:-1,textAlign:"center",textBaseline:"bottom"},"bottom-left":{x:0,y:-1,textAlign:"left",textBaseline:"bottom"},"bottom-right":{x:-1,y:-1,textAlign:"right",textBaseline:"bottom"},center:{x:-.5,y:-.5,textAlign:"center",textBaseline:"middle"},left:{x:0,y:-.5,textAlign:"left",textBaseline:"middle"},right:{x:-1,y:-.5,textAlign:"right",textBaseline:"middle"},top:{x:-.5,y:0,textAlign:"center",textBaseline:"top"},"top-left":{x:0,y:0,textAlign:"left",textBaseline:"top"},"top-right":{x:-1,y:0,textAlign:"right",textBaseline:"top"}},dt=[];{const t=16;for(let e=0;e<360;e+=360/t)dt.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)])}const mt=ct;class ut extends U{constructor(t){super(t.view),this._handles=new k,this._textItem=null,this._calloutItem=null,this._showCallout=!0,this._showText=!0,this._geometry=null,this._text=null,this._fontSize=14,this._distance=25,this._anchor="right",this.applyProps(t)}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this._updateLabelPosition()}get textItem(){return this._textItem}get text(){return this._text}set text(t){this._text=t,this.attached&&(this._textItem.text=this._text)}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize=t,this.attached&&(this._textItem.fontSize=this._fontSize)}get distance(){return this._distance}set distance(t){this._distance!==t&&(this._distance=t,this._updateLabelPosition())}get anchor(){return this._anchor}set anchor(t){this._anchor!==t&&(this._anchor=t,this._updateLabelPosition())}overlaps(t){return!!this.attached&&(this.textItem.visible&&t.textItem.visible&&this.view.overlay.overlaps(this._textItem,t.textItem))}_updateLabelPosition(){if(this.attached){if(this._showText=!1,this._showCallout=!1,r(this.geometry)&&this.view._stage)switch(this.geometry.type){case"point":if(this._computeLabelPositionFromPoint(this.geometry.point,Rt)){if(this.geometry.callout){const t=this.view.state.camera,e=this.geometry.callout.distance;d(Pt,Pt,[0,this.geometry.callout.offset]),t.renderToScreen(Pt,Rt),m(St,0,1),u(St,St,e*t.pixelRatio),d(St,St,Pt),t.renderToScreen(St,Tt),this._showCallout=this._updatePosition(Rt,Tt)}else this._textItem.position=[Rt[0],Rt[1]],this._textItem.anchor="center";this._showText=!0}break;case"corner":this._computeLabelPositionFromCorner(this.geometry,this._distance,Rt,Tt)&&(this._showCallout=this._updatePosition(Rt,Tt),this._showText=!0);break;case"segment":this._computeLabelPositionFromSegment(this.geometry,this._distance,this._anchor,Rt,Tt)&&(this._showText=!0,this._showCallout=this._updatePosition(Rt,Tt))}this.updateVisibility(this.visible)}}_computeLabelPositionFromPoint(t,e){const i=this.view.state.camera;return i.projectToRenderScreen(t,Pt),!(Pt[2]<0||Pt[2]>1)&&(i.renderToScreen(Pt,e),!0)}_computeLabelPositionFromCorner(t,e,i,s){if(!t)return!1;const o=this.view.state.camera;return xt(t.left,1,o,vt),x(vt,vt),xt(t.right,0,o,bt),d(St,vt,bt),x(St,St),p(St,St),o.projectToRenderScreen(t.left.endRenderSpace,Pt),!(Pt[2]<0||Pt[2]>1)&&(o.renderToScreen(Pt,i),u(St,St,e*o.pixelRatio),d(St,St,Pt),o.renderToScreen(St,s),!0)}_computeLabelPositionFromSegment(t,e,i,s,o){if(!t)return!1;const r=t.segment,n=this.view.state.camera;A(r.startRenderSpace,r.endRenderSpace,vt,n),m(St,-vt[1],vt[0]);let a=!1;switch(i){case"top":a=St[1]<0;break;case"bottom":a=St[1]>0;break;case"left":a=St[0]>0;break;case"right":a=St[0]<0}if(a&&x(St,St),0===f(St))switch(i){case"top":St[1]=1;break;case"bottom":St[1]=-1;break;case"left":St[0]=-1;break;case"right":St[0]=1}return r.eval(kt[t.sampleLocation],wt),n.projectToRenderScreen(wt,Pt),!(Pt[2]<0||Pt[2]>1)&&(n.renderToScreen(Pt,s),u(St,St,e*n.pixelRatio),d(St,St,Pt),n.renderToScreen(St,o),!0)}_updatePosition(t,e){if(e){const i=e[0]-t[0],s=e[1]-t[1];return this._textItem.position=[e[0],e[1]],this._textItem.anchor=Math.abs(i)>Math.abs(s)?i>0?"left":"right":s>0?"top":"bottom",this._calloutItem.startPosition=[t[0],t[1]],this._calloutItem.endPosition=[e[0],e[1]],!0}return this._textItem.position=[t[0],t[1]],this._textItem.anchor="center",!1}createResources(){this._textItem=new mt({visible:!0}),this._textItem.text=n(this._text),this._textItem.fontSize=this._fontSize,this._calloutItem=new ht({visible:!0,width:2}),this._updateLabelPosition(),this.view.overlay.items.addMany([this._textItem,this._calloutItem]),this._handles.add(this.view.state.watch("camera",(()=>this._updateLabelPosition())))}destroyResources(){this.view.overlay&&!this.view.overlay.destroyed&&this.view.overlay.items.removeMany([this._textItem,this._calloutItem]),this._handles.removeAll()}updateVisibility(t){this._textItem.visible=this._showText&&t,this._calloutItem.visible=this._showCallout&&t}}function xt(t,e,i,s){t.eval(e,_t,gt),y(yt,_t,gt),i.projectToRenderScreen(_t,jt),i.projectToRenderScreen(yt,Ct),c(s,zt,It),p(s,s)}function ft(t){switch(t){case"top":return"bottom";case"right":return"left";case"bottom":return"top";case"left":return"right"}}const _t=v(),yt=v(),gt=v(),vt=h(),bt=h(),St=h(),wt=v(),Pt=a(),Rt=l(),Tt=l(),jt=a(),It=jt,Ct=a(),zt=Ct,kt={start:0,center:.5,end:1};class At{constructor(t=v(),e=v()){this.startRenderSpace=t,this.endRenderSpace=e,this.type="euclidean"}eval(t,e,i){return b(e,this.startRenderSpace,this.endRenderSpace,t),i&&(S(i,this.endRenderSpace,this.startRenderSpace),w(i,i)),e}createRenderGeometry(t,e){const i=[],s=[],o=(e,o)=>{const r=$t;S(r,e,t),i.push([r[0],r[1],r[2]]),s.push([o[0],o[1],o[2]])},r=e.worldUpAtPosition(this.eval(.5,Mt),F.get());return o(this.startRenderSpace,r),o(this.endRenderSpace,r),{points:i,normals:s}}}class Ut{constructor(t,e,i){this.startRenderSpace=t,this.endRenderSpace=e,this.renderSpatialReference=i,this.type="geodesic",this._start=v(),this._end=v(),this._pcpf=E(i),this._project=Y(i,this._pcpf),this._projectIn(t,this._start),this._projectIn(e,this._end)}_projectIn(t,e){this._project?B(t,this.renderSpatialReference,e,this._pcpf):P(e,t)}eval(t,e,i){if(this._project)if(i){const s=$t;q(this._start,this._end,t,e,s),y(Lt,e,s),B(e,this._pcpf,e,this.renderSpatialReference),B(Lt,this._pcpf,Lt,this.renderSpatialReference),S(i,Lt,e),w(i,i)}else D(this._start,this._end,t,e),B(e,this._pcpf,e,this.renderSpatialReference);else b(e,this._start,this._end,t),i&&(S(i,this._end,this._start),w(i,i));return e}createRenderGeometry(t,e){const i=[],s=[],o=(e,o)=>{const r=Lt;S(r,e,t),i.push([r[0],r[1],r[2]]),s.push([o[0],o[1],o[2]])};for(let t=0;t<128;++t){const i=t/127,s=Mt,r=$t;this.eval(i,s),e.worldUpAtPosition(s,r),o(s,r)}return{points:i,normals:s}}}const Mt=v(),$t=v(),Lt=v();export{At as E,Ut as G,ut as L,V as Q,Z as U,rt as a,st as b,ot as c,et as d,it as e,tt as f,ft as g,G as m,H as s};
