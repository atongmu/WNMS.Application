/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import"../geometry.js";import{n as e}from"./compilerUtils.js";import{L as t}from"./Logger.js";import{o as r,w as s,m as i,l as a,e as o,g as n,f as c,s as d,b as l,n as u,d as g,a as m,M as p,q as h,k as f,r as b,F as w}from"./mathUtils.js";import{h as y,u as v,i as M,b as j,o as C}from"../core/lang.js";import{e as P}from"./screenUtils.js";import{i as _,j as k,s as x,m as S,k as O,t as U,w as R}from"./mat4.js";import{c as T}from"./mat4f64.js";import{r as W}from"./quat.js";import{tryProjectWithZConversion as E}from"../geometry/projection.js";import{f as L,i as F,c as I,r as A,n as G,u as z}from"./boundedPlane.js";import{e as H,m as q}from"./plane.js";import{c as D}from"./ray.js";import{h as V}from"./sphere.js";import{b as B,s as N,d as Z}from"./vectorStacks.js";import{M as J,d as K}from"./manipulatorUtils.js";import{O as Q,L as $}from"./LineVisualElement.js";import{f as X}from"./vec4f32.js";import{G as Y,C as ee}from"./ColorMaterial.js";import{S as te,g as re,a as se,c as ie,P as ae,D as oe,h as ne,Q as ce,a1 as de,b as le,a4 as ue,a2 as ge,a0 as me,a3 as pe}from"./StencilUtils.js";import{D as he,P as fe}from"./ScreenSpacePass.js";import{m as be,s as we,d as ye}from"./OrderIndependentTransparency.js";import{g as ve}from"./ElevationProvider.js";import{R as Me}from"./RenderCoordsHelper.js";import{c as je}from"./ray2.js";import{I as Ce}from"./ImageMaterial.js";import{N as Pe}from"./NativeLineMaterial.js";import{y as _e}from"./lineUtils.js";import ke from"../widgets/Slice/SlicePlane.js";import xe from"../geometry/Extent.js";const Se=y("mac")?"Meta":"Control",Oe="Shift",Ue=2500,Re=.02,Te=Math.cos(r(45)),We=Math.cos(r(5)),Ee=.95,Le=.3,Fe=[1,.5,0],Ie=2,Ae=1,Ge=[...Fe,.7],ze=[0,0,0,.04],He=[...Fe,.5],qe=[...Fe,1],De=[1,1,1,1],Ve=[1,.8,.6,1],Be=[1,.93,.86,1],Ne=[...Fe,1],Ze=[...Fe,1],Je=[...Fe,1];const Ke=Object.freeze({__proto__:null,build:function(){const e=new te;return e.extensions.add("GL_OES_standard_derivatives"),e.vertex.uniforms.add("proj","mat4").add("view","mat4"),e.attributes.add("position","vec3"),e.attributes.add("uv0","vec2"),e.varyings.add("vUV","vec2"),e.vertex.code.add(re`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),e.fragment.uniforms.add("backgroundColor","vec4").add("gridColor","vec4").add("ratio","float").add("gridWidth","float"),e.fragment.code.add(re`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
gl_FragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),e}});class Qe extends ie{initializeProgram(e){const t=Qe.shader.get().build();return new ae(e.rctx,t,oe)}bindPass(e,t){ne(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("backgroundColor",e.backgroundColor),this.program.setUniform4fv("gridColor",e.gridColor),this.program.setUniform1f("gridWidth",e.gridWidth)}bindDraw(e){ce(this.program,e),this.program.rebindTextures()}initializePipeline(){return be({blending:we(1,1,771,771),depthTest:{func:513},colorWrite:ye})}}Qe.shader=new se(Ke,(()=>Promise.resolve().then((()=>Ke))));class $e extends de{constructor(e){super(e,Ye),this._config=new le}intersect(e,t,r,s,i,a,o){return ue(e,t,s,i,a,void 0,o)}createBufferWriter(){return new he(fe)}requiresSlot(e){return 7===e}createGLMaterial(e){return 0===e.output?new Xe(e):null}getTechniqueConfig(){return this._config}}class Xe extends ge{constructor(e){super(e),this.ensureTechnique(Qe,null)}updateParameters(){return v(this.technique)}beginSlot(){return v(this.technique)}bind(e,t){t.bindPass(this._material.parameters,e)}}const Ye={backgroundColor:[1,0,0,.5],gridColor:[0,1,0,.5],gridWidth:4,...me};class et extends Q{constructor(e){super(e),this._material=null,this._renderOccluded=4,this._gridWidth=1,this._gridColor=X(1,0,0,1),this._backgroundColor=X(1,0,0,1),this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get gridWidth(){return this._gridWidth}set gridWidth(e){this._gridWidth!==e&&(this._gridWidth=e,this._updateMaterial())}get gridColor(){return this._gridColor}set gridColor(e){s(this._gridColor,e),this._updateMaterial()}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){s(this._backgroundColor,e),this._updateMaterial()}createExternalResources(){this._material=new $e(this.materialParameters)}destroyExternalResources(){this._material=null}forEachExternalMaterial(e){M(this._material)&&e(this._material)}createGeometries(e){if(M(this._material)){const t=Y.createSquareGeometry();e.addGeometry(t,this._material)}}get materialParameters(){return{backgroundColor:this._backgroundColor,gridWidth:this._gridWidth,gridColor:this._gridColor,renderOccluded:this._renderOccluded}}_updateMaterial(){M(this._material)&&this._material.setParameters(this.materialParameters)}}const tt=t.getLogger("esri.views.3d.interactive.analysisTools.slice.sliceToolUtils");function rt(e,t,r,s,a,o,n,d){return function(e,t,r,s,a,o){const n=g(e,t),d=B.get(),l=B.get();switch(0===s?Math.abs(n)>Te?1:2:s){case 2:{const s=Math.abs(n)<=We?e:r.viewUp;m(d,s,t),i(l,t);break}case 1:m(d,r.viewUp,t),m(l,t,d);break;case 3:{const s=Math.abs(n)<=We?t:r.viewUp;m(d,s,e),m(l,e,d);break}}const p=m(B.get(),d,l);g(p,r.viewForward)>0&&c(l,l,-1);u(a,d),u(o,l)}(t,n.worldUpAtPosition(e,B.get()),a,o,d.basis1,d.basis2),c(d.basis1,d.basis1,r),c(d.basis2,d.basis2,s),i(d.origin,e),q(d.basis2,d.basis1,d.origin,d.plane),d}function st(e,t,r,s,o,l){const u=i(B.get(),o.origin);n(u,u,c(B.get(),o.basis1,e.direction[0]<0?1:-1)),n(u,u,c(B.get(),o.basis2,e.direction[1]<0?1:-1));const m=a(o.basis1),p=a(o.basis2),h=d(B.get(),r,u),f=d(B.get(),t,u);let b=0,w=0;if(ft(e)){const t=ht(o),r=ht(l);b=m-.5*e.direction[0]*g(o.basis1,f)/m,w=p-.5*e.direction[1]*g(o.basis2,f)/p;const s=r/t;b*=s,w*=s}const y=b+.5*e.direction[0]*g(o.basis1,h)/m,v=w+.5*e.direction[1]*g(o.basis2,h)/p,M=c(B.get(),o.basis1,y/m),j=c(B.get(),o.basis2,v/p);(y<=0||mt(l.origin,M,s)<=1600)&&i(M,l.basis1),(v<=0||mt(l.origin,j,s)<=1600)&&i(j,l.basis2);const C=i(B.get(),u);return n(C,C,c(B.get(),M,e.direction[0]<0?-1:1)),n(C,C,c(B.get(),j,e.direction[1]<0?-1:1)),L(C,M,j,l)}function it(e,t){return.4*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function at(e,t,r,s){const i=m(B.get(),t,r);return m(i,i,t),H(e,i,s)}function ot(e,t){return K(e.basis1,e.basis2,e.origin,t)}function nt(e,t,r,s){const a=t.worldUpAtPosition(e.origin,B.get()),o=B.get();switch(r){case 1:i(o,a);break;case 2:i(o,e.basis1)}return H(e.origin,o,s)}function ct(e,t,r,s){const i=gt(r,2),a=N.get();k(a,t,i.edge*Math.PI/2);const o=u(B.get(),i.basis);let d=c(B.get(),o,i.direction*s.computeScreenPixelSizeAt(i.position)*40);n(d,d,i.position);const l=s.projectToRenderScreen(d,P(B.get())),g=function(e,t){const[r,s,i,a]=e.viewport,o=Math.min(i,a)/16;let n=!0;t[0]<r+o?(t[0]=r+o,n=!1):t[0]>r+i-o&&(t[0]=r+i-o,n=!1);t[1]<s+o?(t[1]=s+o,n=!1):t[1]>s+a-o&&(t[1]=s+a-o,n=!1);return n}(s,l);je(s,l,Ut),u(Ut.direction,Ut.direction);const m=B.get();!g&&F(r,Ut,m)&&(d=m),a[12]=0,a[13]=0,a[14]=0,e.modelTransform=a,e.renderLocation=h(d),g?e.state|=Ot:e.state&=~Ot}function dt(e,t,r,s){const i=a(s.basis1),d=a(s.basis2),l=pt(s),u=ht(s),g=o(B.get(),0,0,0);n(g,c(B.get(),s.basis1,t.direction[0]),c(B.get(),s.basis2,t.direction[1])),n(g,s.origin,g);let m=0,p=1;if(ft(t))1===t.direction[0]&&-1===t.direction[1]?m=Rt:1===t.direction[0]&&1===t.direction[1]?m=Math.PI:-1===t.direction[0]&&1===t.direction[1]&&(m=3*Math.PI/2),p=u;else{const e=0!==t.direction[0]?1:2;m=1===e?Rt:0,p=(1===e?d:i)-l}const h=_(N.get());k(h,h,m),x(h,h,o(B.get(),p,p,p)),S(h,r,h),h[12]=0,h[13]=0,h[14]=0,e.modelTransform=h,e.renderLocation=g}function lt(e,t,r,s){const i=s.worldUpAtPosition(r.origin,B.get()),a=gt(r,0),o=_(N.get());k(o,o,a.edge*Math.PI/2),O(o,o,-Pt(r,i)),S(o,t,o),o[12]=0,o[13]=0,o[14]=0,e.modelTransform=o,e.renderLocation=a.position}function ut(e,t,r){const s=gt(r,1),i=_(N.get());k(i,i,s.edge*Math.PI/2),O(i,i,Rt),S(i,t,i),i[12]=0,i[13]=0,i[14]=0,e.modelTransform=i,e.renderLocation=s.position}function gt(e,t){switch(t){case 0:return{basis:e.basis1,direction:1,position:n(B.get(),e.origin,e.basis1),edge:t};case 1:return{basis:e.basis2,direction:1,position:n(B.get(),e.origin,e.basis2),edge:t};case 2:return{basis:e.basis1,direction:-1,position:d(B.get(),e.origin,e.basis1),edge:t};case 3:return{basis:e.basis2,direction:-1,position:d(B.get(),e.origin,e.basis2),edge:t}}}function mt(e,t,r){const s=r.projectToRenderScreen(n(B.get(),e,t),P(B.get())),i=r.projectToRenderScreen(d(B.get(),e,t),P(B.get()));return p(d(s,s,i))}function pt(e){const t=a(e.basis1),r=a(e.basis2);return.3*Math.min(t,r)}function ht(e){return pt(e)}function ft(e){return 0!==e.direction[0]&&0!==e.direction[1]}function bt(e,t=1){const r=0===t?40:0,s=[f(r,0,-24),f(r,0,24)],i=function(e,t){const r=d(l(),e[e.length-1],e[e.length-2]);if(u(r,r),c(r,r,12),n(r,r,e[e.length-1]),t){const t=d(l(),e[0],e[1]);return u(t,t),c(t,t,12),n(t,t,e[0]),[t,...e,r]}return[...e,r]}(s,!0),a=(e,t)=>function(e,t,r){const s=s=>{const i=(s?t:e).slice(0),a=d(B.get(),i[0],i[1]);u(a,a);const g=d(B.get(),i[i.length-1],i[i.length-2]);if(u(g,g),r.padding>0){const e=c(l(),g,-r.padding);if(i[i.length-1]=n(e,e,i[i.length-1]),r.bothEnds){const e=c(l(),a,-r.padding);i[0]=n(e,e,i[0])}}const m=s?r.tipFocusMultiplier:1,p=r.tipLength*(r.focusTipLength?m:1),h=r.tipRadius*m,b=_(N.get());if(r.padding>0){const e=p/4,t=o(B.get(),0,e,0),s=1+r.padding/e;U(b,b,t),x(b,b,o(B.get(),s,s,s)),U(b,b,c(t,t,-1/s))}const w=_(T()),y=f(0,1,0),v=R(T(),W(Z.get(),y,g));v[12]=i[i.length-1][0],v[13]=i[i.length-1][1],v[14]=i[i.length-1][2],S(v,v,b);const j=function(e,t,r){const s=[];if(M(t))s.push([e,t.thickness/2],[-e,t.thickness/2],[-e,-t.thickness/2],[e,-t.thickness/2]);else{const t=12;for(let r=0;r<t;r++){const i=r/t*2*Math.PI;s.push([Math.cos(i)*e,Math.sin(i)*e])}}return Y.createPathExtrusionGeometry(s,r,[],[],!1)}(r.tubeRadius*(s?r.tubeFocusMultiplier:1)+r.padding,r.flat,i),C=[{part:"tube",geometry:j,transform:w}];let P,k;if(M(r.flat)?P=Y.createExtrudedTriangle(p,h,h,r.flat.thickness):(P=Y.createConeGeometry(p,h,24,!1,!1,!0),k=Y.createConeGeometry(p,h,24,!1,!0,!1)),C.push({part:"tip",geometry:P,transform:v}),k&&C.push({part:"cap",geometry:k,transform:v}),r.bothEnds){const e=R(T(),W(Z.get(),y,a));e[12]=i[0][0],e[13]=i[0][1],e[14]=i[0][2],S(e,e,b),C.push({part:"tip",geometry:P,transform:e}),k&&C.push({part:"cap",geometry:k,transform:e})}return C};return{normal:s(!1),focused:s(!0)}}(s,s,{tubeRadius:3,tipRadius:11,tipLength:22.5,tubeFocusMultiplier:1.15,tipFocusMultiplier:1.15,padding:e,bothEnds:!0,flat:null,focusTipLength:!0,addCap:t}),g=a(0,!1),m=a(2.25,!0),p=new ee({color:De,cullFace:2,renderOccluded:16}),h=new ee({color:Ve,cullFace:2,renderOccluded:16}),b=new ee({color:Be,cullFace:2,renderOccluded:16}),w=new ee({color:Ze,transparent:!0,writeDepth:!1,cullFace:1,renderOccluded:2}),y=Y.createPolylineGeometry([[r,0,0],[r-40,0,0]]),v=Y.createPolylineGeometry([[r,0,0],[r-40,0,0]]),j=new Pe({color:Ne,renderOccluded:4});return new J({view:e,renderObjects:[...g.normal.map((({part:e,geometry:t,transform:r})=>({geometry:t,material:"tip"===e?p:"cap"===e?h:b,transform:r,stateMask:1|St}))),...m.normal.map((({geometry:e,transform:t})=>({geometry:e,material:w,transform:t,stateMask:1|St}))),{geometry:y,material:j,stateMask:1|St|Ot},...g.focused.map((({part:e,geometry:t,transform:r})=>({geometry:t,material:"tip"===e?p:"cap"===e?h:b,transform:r,stateMask:2|St}))),...m.focused.map((({geometry:e,transform:t})=>({geometry:e,material:w,transform:t,stateMask:2|St}))),{geometry:v,material:j,stateMask:2|St|Ot}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[i]},collisionPriority:1,radius:11,state:St})}function wt(e,t){const r=new Ce({transparent:!0,writeDepth:!1,textureId:t.id,renderOccluded:16}),s=40,i=27*1.1,a=e=>{const t=new Uint32Array([0,1,2,2,3,0]);return new pe([["position",{size:3,data:[s-e,-e,0,s+e,-e,0,s+e,e,0,s-e,e,0],exclusive:!0}],["uv0",{size:2,data:[0,0,1,0,1,1,0,1]}]],[["position",t],["uv0",t]])},o=Y.createPolylineGeometry([[0,0,0],[13,0,0]]),n=Y.createPolylineGeometry([[0,0,0],[10.299999999999997,0,0]]),c=new Pe({color:qe,renderOccluded:4}),d=[{geometry:a(27),material:r,stateMask:1|St},{geometry:o,material:c,stateMask:1|St},{geometry:a(i),material:r,stateMask:2|St},{geometry:n,material:c,stateMask:2|St}];return new J({view:e,renderObjects:d,autoScaleRenderObjects:!1,collisionType:{type:"disc",direction:[0,0,1],offset:[s,0,0]},collisionPriority:1,radius:13.5,state:St})}function yt(e){return new $({view:e,attached:!0,color:Ge,width:1,writeDepthEnabled:!1,renderOccluded:4,geometry:[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]]})}function vt(e){return new et({view:e,attached:!0,backgroundColor:[...ze],gridColor:He,gridWidth:4,renderOccluded:4})}function Mt(e,t){const r=ft(t),s=r?[f(1,0,0),f(0,0,0),f(0,1,0)]:[f(1,0,0),f(-1,0,0)],i=Y.createPolylineGeometry(s),a=Je,o=r?4:1,n=2*o,c=e=>e>1?(e=>new _e({color:a,width:e,renderOccluded:4}))(e):new Pe({color:a,renderOccluded:4}),d=[{geometry:i,material:c(o),stateMask:1|Tt},{geometry:i,material:c(n),stateMask:2|Tt},{geometry:i,material:c(1),stateMask:Wt}],l=new J({view:e,renderObjects:d,collisionType:{type:"line",paths:[s]},autoScaleRenderObjects:!1,worldSized:!0,radius:r?6:4});return l.state=Tt,l}function jt(e,t,r,s=new ke){if(j(e))return null;const{renderCoordsHelper:i}=t,o=i.fromRenderCoords(e.origin,t.spatialReference);if(j(o))return null;const n=E(o,r);if(j(n))return null;s.position=n;const c=i.worldUpAtPosition(e.origin,B.get()),d=i.worldBasisAtPosition(e.origin,1,B.get()),l=2*a(e.basis1),u=2*a(e.basis2),g=Me.renderUnitScaleFactor(t.spatialReference,r);return s.width=l*g,s.height=u*g,s.tilt=b(Pt(e,c)),s.heading=b(function(e,t,r){return V(e.basis1,r,t)-Rt}(e,c,d)),s}function Ct(e,t,r){if(j(e)||j(e.position))return null;const{spatialReference:s}=e.position,i=function(e,t,r,s=I()){const i=_t(e,t.spatialReference);if(j(i))return null;return kt(i,t,r,s)}(e,{renderCoordsHelper:t,spatialReference:s},r),a=function(e,t,r){if(j(e))return null;const s=e.origin,i=B.get(),a=B.get(),o=B.get(),c=B.get();let d,l,u,g,m,p;n(i,s,e.basis1),n(i,i,e.basis2),n(a,s,e.basis1),w(a,a,e.basis2),w(o,s,e.basis1),w(o,o,e.basis2),w(c,s,e.basis1),n(c,c,e.basis2);for(const e of[i,a,o,c]){const s=t.fromRenderCoords(e,e,r);if(j(s))return null;d=null==d?s[0]:Math.min(d,s[0]),l=null==l?s[0]:Math.max(l,s[0]),u=null==u?s[1]:Math.min(u,s[1]),g=null==g?s[1]:Math.max(g,s[1]),m=null==m?s[2]:Math.min(m,s[2]),p=null==p?s[2]:Math.max(p,s[2])}return new xe({xmin:d,xmax:l,ymin:u,ymax:g,zmin:m,zmax:p,spatialReference:r})}(i,t,s);return!e.position.hasZ&&M(a)&&(a.zmin=null,a.zmax=null),a}function Pt(e,t){return V(t,e.basis2,e.basis1)+Rt}function _t(e,t){if(j(e)||j(e.position))return null;const r=E(e.position,t);if(j(r))return null;const s=Me.renderUnitScaleFactor(e.position.spatialReference,t),i=e.width*s,a=e.height*s;return{position:r,heading:e.heading,tilt:e.tilt,renderWidth:i,renderHeight:a}}function kt(e,t,s,i=I()){if(j(e))return null;let a=e.position;!e.position.hasZ&&M(t.elevationProvider)&&(a=e.position.clone(),a.z=C(ve(t.elevationProvider,e.position),0));const o=function(e,t,s,i,a,o,n=I()){return o.toRenderCoords(e,n.origin)?(o.worldBasisAtPosition(n.origin,0,n.basis1),o.worldBasisAtPosition(n.origin,1,n.basis2),q(n.basis2,n.basis1,n.origin,n.plane),A(n,-r(t),G(n),n),A(n,r(s),n.basis1,n),c(n.basis1,n.basis1,i/2),c(n.basis2,n.basis2,a/2),z(n),n):(tt.error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}(a,e.heading,e.tilt,e.renderWidth,e.renderHeight,t.renderCoordsHelper,i);return!s.tiltEnabled&&M(o)&&function(e,t,r){const s=t.worldUpAtPosition(e.origin,B.get()),i=e.basis1,a=Pt(e,s),o=Math.round(a/Rt)*Rt;A(e,o-a,i,r)}(o,t.renderCoordsHelper,o),o}function xt(t){switch(t.type){case"analysis":case"building-scene":case"csv":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"kml":case"map-notes":case"ogc-feature":case"point-cloud":case"route":case"scene":case"stream":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"open-street-map":case"tile":case"vector-tile":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return e(t.type),!1}}const St=16,Ot=32,Ut=D(),Rt=Math.PI/2,Tt=16,Wt=32;function Et(e){const t="building-scene-3d"===e.type?e:null;return M(t)}export{_t as A,kt as B,Ae as C,St as D,ft as E,Ot as F,He as G,Tt as H,Re as I,Wt as J,ht as K,Ie as P,wt as a,Mt as b,bt as c,vt as d,yt as e,Oe as f,Se as g,nt as h,Le as i,it as j,rt as k,Ue as l,ot as m,lt as n,ut as o,jt as p,dt as q,st as r,Ct as s,Ge as t,ct as u,ze as v,at as w,Ee as x,xt as y,Et as z};
