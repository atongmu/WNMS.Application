/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{J as t}from"./jsonMap.js";import{i as e}from"../core/lang.js";import n from"../layers/support/PixelBlock.js";import{i as r}from"./pixelUtils.js";const a=new Map;a.set("meter-per-second",1),a.set("kilometer-per-hour",.277778),a.set("knots",.514444),a.set("feet-per-second",.3048),a.set("mile-per-hour",.44704);const o=180/Math.PI,s=new t({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function i(t,e){return a.get(t)/a.get(e)||1}function h(t){return(450-t)%360}function l(t,e="geographic"){const[n,r]=t,a=Math.sqrt(n*n+r*r);let s=Math.atan2(r,n)*o;return s=(360+s)%360,"geographic"===e&&(s=h(s)),[a,s]}function c(t,e="geographic"){let n=t[1];"geographic"===e&&(n=h(n)),n%=360;const r=t[0];return[r*Math.cos(n/o),r*Math.sin(n/o)]}function u(t,e,a="geographic",o=1){if(!r(t))return t;const{pixels:s,width:i,height:h}=t,u=i*h,f=s[0],p=s[1],m=n.createEmptyBand(t.pixelType,u),M=n.createEmptyBand(t.pixelType,u);let d=0;for(let t=0;t<h;t++)for(let t=0;t<i;t++)"vector-uv"===e?([m[d],M[d]]=l([f[d],p[d]],a),m[d]*=o):([m[d],M[d]]=c([f[d],p[d]],a),m[d]*=o,M[d]*=o),d++;const x=new n({pixelType:t.pixelType,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:[m,M]});return x.updateStatistics(),x}function f(t,e,n=1){if(1===n||!r(t))return t;const a=t.clone(),{pixels:o,width:s,height:i}=a,h=o[0],l=o[1];let c=0;for(let t=0;t<i;t++)for(let t=0;t<s;t++)"vector-uv"===e?(h[c]*=n,l[c]*=n):h[c]*=n,c++;return a.updateStatistics(),a}function p(t,n,r,a,o){if(!e(o)||!o.spatialReference.equals(t.spatialReference))return{extent:t,width:n,height:r,resolution:t.width/n};const s=o.xmin,i=o.ymax;a=Math.max(a||0,30);const h=Math.ceil(n*(1/a)),l=Math.ceil(r*(1/a)),c=((t.xmax-t.xmin)/h+(t.ymax-t.ymin)/l)/2;return t.xmin=s+Math.floor((t.xmin-s)/c)*c,t.xmax=s+Math.ceil((t.xmax-s)/c)*c,t.ymin=i+Math.floor((t.ymin-i)/c)*c,t.ymax=i+Math.ceil((t.ymax-i)/c)*c,{extent:t,width:Math.round(t.width/c),height:Math.round(t.height/c),resolution:c}}const m=function(t=0,e=0,n=Math.PI,r=!0){r&&(n=(2*Math.PI-n)%(2*Math.PI));const a=r?-1:1,o=13*a,s=-7*a,i=-2*a,h=-16*a,l=29,[c,u]=d(0,e+o,n,l),[f,p]=d(t-5.5,e+s,n,l),[m,M]=d(t+5.5,e+s,n,l),[x,g]=d(t-1.5,e+i,n,l),[k,w]=d(t+1.5,e+i,n,l),[y,P]=d(t-1.5,e+h,n,l),[b,I]=d(t+1.5,e+h,n,l);return[c,u,f,p,x,g,k,w,m,M,y,P,b,I]}(0,0,0);function M(t=0,e=Math.PI,n=!0){n&&(e=(2*Math.PI-e)%(2*Math.PI));const r=n?-1:1,a=5*r,o=20*r,s=25*r,i=45,h=2*r;let[l,c]=[5,0-o],[u,f]=[l+2,c],[p,m]=[u-0,f+h],[M,x]=[-5,0-s],[g,k]=[M+0,x-h],w=Math.ceil(t/5),y=Math.floor(w/10);w-=8*y;const P=[],b=[];for(let t=0;t<w/2;t++,y--){y<=0&&w%2==1&&t===(w-1)/2&&(M=0,g=M+0,x=(x+c)/2,k=x-h);const[n,r]=d(M,x,e,i);if(y>0){const[t,a]=d(u,x,e,i),[o,s]=d(l,c,e,i);P.push(t),P.push(a),P.push(n),P.push(r),P.push(o),P.push(s)}else{const[t,a]=d(u,f,e,i),[o,s]=d(p,m,e,i),[h,l]=d(g,k,e,i);b.push(n),b.push(r),b.push(h),b.push(l),b.push(o),b.push(s),b.push(t),b.push(a)}x+=a,c+=a,f+=a,m+=a,k+=a}const[I,v]=d(5,0+o,e,i),[A,_]=d(7,0+o,e,i),[U,S]=d(5,0-s,e,i),[D,F]=d(7,0-s,e,i);return{pennants:P,barbs:b,shaft:[I,v,A,_,U,S,D,F]}}function d(t,e,n,r=1){const a=Math.sqrt(t*t+e*e)/r,o=(2*Math.PI+Math.atan2(e,t))%(2*Math.PI);return[a,(2*Math.PI+o-n)%(2*Math.PI)]}const x=[0,1,3,6,10,16,21,27,33,40,47,55,63],g=[0,.5,1,1.5,2],k=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function w(t,e,n,r){const a=i(r||"knots",n);let o;for(o=1;o<e.length;o++)if(o===e.length-1){if(t<e[o]*a)break}else if(t<=e[o]*a)break;return Math.min(o-1,e.length-2)}function y(t,e,n,r,a){let o=0;switch(e){case"beaufort_kn":o=w(t,x,"knots",n);break;case"beaufort_km":o=w(t,x,"kilometer-per-hour",n);break;case"beaufort_ft":o=w(t,x,"feet-per-second",n);break;case"beaufort_m":o=w(t,x,"meter-per-second",n);break;case"classified_arrow":o=w(t,a,r,n);break;case"ocean_current_m":o=w(t,g,"meter-per-second",n);break;case"ocean_current_kn":o=w(t,k,"knots",n)}return o}const P=[];function b(t,e){let n=0,r=0;const{width:a,height:o,mask:s}=t,i=t.pixels[0],h=[],l=[],c="wind_speed"===e.style?5:Number.MAX_VALUE;for(let t=0;t<o;t++)for(let e=0;e<a;e++){const u=t*a+e;if((!s||s[t*a+e])&&i[u]<c){for(let r=0;r<4;r++)h[n++]=(e+.5)/a,h[n++]=(t+.5)/o,h[n++]=r<2?-.5:.5,h[n++]=r%2==0?-.5:.5,h[n++]=0,h[n++]=i[u];const s=4*(n/24-1);l[r++]=s,l[r++]=s+1,l[r++]=s+2,l[r++]=s+1,l[r++]=s+2,l[r++]=s+3}}return{vertexData:new Float32Array(h),indexData:new Uint32Array(l)}}function I(t,e){return"simple_scalar"===e.style?b(t,e):"wind_speed"===e.style?function(t,e){if(0===P.length)for(let t=0;t<30;t++)P.push(M(5*t,0));const n=i(s.fromJSON(e.inputUnit),"knots"),{width:r,height:a,mask:o}=t,h=t.pixels[0],l=t.pixels[1],c=[],u=[];let f=0,p=0;for(let t=0;t<a;t++)for(let e=0;e<r;e++){const s=t*r+e,i=h[s]*n;if((!o||o[t*r+e])&&i>=5){var m;const n=null!=(m=(l[s]+360)%360/180*Math.PI)?m:2*Math.PI*Math.random(),{pennants:o,barbs:h,shaft:M}=P[Math.min(Math.floor(i/5),29)];if(o.length+h.length===0)continue;let d=c.length/6;const x=(e+.5)/r,g=(t+.5)/a;for(let t=0;t<o.length;t+=2)c[f++]=x,c[f++]=g,c[f++]=o[t],c[f++]=o[t+1]+n,c[f++]=0,c[f++]=i;for(let t=0;t<h.length;t+=2)c[f++]=x,c[f++]=g,c[f++]=h[t],c[f++]=h[t+1]+n,c[f++]=0,c[f++]=i;for(let t=0;t<M.length;t+=2)c[f++]=x,c[f++]=g,c[f++]=M[t],c[f++]=M[t+1]+n,c[f++]=0,c[f++]=i;for(let t=0;t<o.length/6;t++)u[p++]=d,u[p++]=d+1,u[p++]=d+2,d+=3;for(let t=0;t<h.length/8;t++)u[p++]=d,u[p++]=d+1,u[p++]=d+2,u[p++]=d+1,u[p++]=d+2,u[p++]=d+3,d+=4;u[p++]=d+0,u[p++]=d+1,u[p++]=d+2,u[p++]=d+1,u[p++]=d+3,u[p++]=d+2,d+=4}}return{vertexData:new Float32Array(c),indexData:new Uint32Array(u)}}(t,e):function(t,e){const{style:n,inputUnit:r,outputUnit:a,breakValues:o}=e,i=s.fromJSON(r),h=s.fromJSON(a);let l=0,c=0;const{width:u,height:f,mask:p}=t,M=t.pixels[0],d=t.pixels[1],x=p?p.filter((t=>t>0)).length:u*f,g=new Float32Array(42*x),k=new Uint32Array(15*x);for(let t=0;t<f;t++)for(let e=0;e<u;e++){const r=t*u+e;if(!p||p[t*u+e]){var w;const a=null!=(w=(d[r]+360)%360/180*Math.PI)?w:2*Math.PI*Math.random(),s=y(M[r],n,i,h,o);for(let n=0;n<m.length;n+=2)g[l++]=(e+.5)/u,g[l++]=(t+.5)/f,g[l++]=m[n],g[l++]=m[n+1]+a,g[l++]=s,g[l++]=M[r];const p=7*(l/42-1);k[c++]=p,k[c++]=p+1,k[c++]=p+2,k[c++]=p+0,k[c++]=p+4,k[c++]=p+3,k[c++]=p+0,k[c++]=p+2,k[c++]=p+3,k[c++]=p+2,k[c++]=p+5,k[c++]=p+3,k[c++]=p+5,k[c++]=p+6,k[c++]=p+3}}return{vertexData:g,indexData:k}}(t,e)}function v(t,e,r,a=[0,0],o=.5){const{width:s,height:i,mask:h}=t,[u,f]=t.pixels,[p,m]=a,M=Math.round((s-p)/r),d=Math.round((i-m)/r),x=M*d,g=new Float32Array(x),k=new Float32Array(x),w=new Uint8Array(x),y="vector-uv"===e;for(let t=0;t<d;t++)for(let e=0;e<M;e++){let n=0;const a=t*M+e,d=Math.max(0,t*r+m),x=Math.max(0,e*r+p),P=Math.min(i,d+r),b=Math.min(s,x+r);for(let t=d;t<P;t++)for(let e=x;e<b;e++){const r=t*s+e;if(!h||h[r]){n++;const t=y?[u[r],f[r]]:[u[r],(360+f[r])%360],[e,o]=y?t:c(t);g[a]+=e,k[a]+=o}}if(n>=(P-d)*(b-x)*(1-o)){w[a]=1;const[t,e]=l([g[a]/n,k[a]/n]);g[a]=t,k[a]=e}else w[a]=0,g[a]=0,k[a]=0}const P=new n({width:M,height:d,pixels:[g,k],mask:w});return P.updateStatistics(),P}export{s as a,f as b,u as c,I as d,b as e,v as f,i as g,p as s,l as u};
